<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Agent Orchestrator — RISE RE</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#0f172a;--bg2:#1e293b;--bg3:#334155;--border:#475569;
  --text:#f1f5f9;--text2:#94a3b8;--text3:#64748b;
  --blue:#3B82F6;--green:#10B981;--orange:#F59E0B;--purple:#8B5CF6;
  --gold:#F5A623;--teal:#14B8A6;--red:#EF4444;
  --panel-w:420px;
  --brand:#3B82F6;
  --library-w:380px;
}
html{font-family:'Inter',system-ui,sans-serif;background:var(--bg);color:var(--text);font-size:14px;scroll-behavior:smooth}
body{min-height:100vh;padding:0}
button{font-family:inherit;cursor:pointer;border:none;background:none;color:inherit}
input,select,textarea{font-family:inherit;background:var(--bg);color:var(--text);border:1px solid var(--border);border-radius:6px;padding:6px 10px;font-size:13px}
textarea{resize:vertical}

/* HEADER */
.header{display:flex;align-items:center;justify-content:space-between;padding:12px 24px;background:var(--bg2);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:100;flex-wrap:wrap;gap:8px}
.header h1{font-size:18px;font-weight:700;display:flex;align-items:center;gap:8px}
.header h1 .diamond{width:20px;height:20px;background:var(--brand);transform:rotate(45deg);border-radius:3px;display:inline-block;flex-shrink:0}
.header-left{display:flex;align-items:center;gap:12px}
.header-logo{height:32px;max-width:120px;object-fit:contain;display:none}
.header-actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.btn{padding:7px 14px;border-radius:6px;font-size:12px;font-weight:600;transition:all .15s}
.btn-primary{background:var(--brand);color:#fff}.btn-primary:hover{filter:brightness(0.85)}
.btn-danger{background:var(--red);color:#fff}.btn-danger:hover{background:#DC2626}
.btn-outline{border:1px solid var(--border);color:var(--text2)}.btn-outline:hover{border-color:var(--text);color:var(--text)}
.btn-green{background:var(--green);color:#000;font-weight:700}.btn-green:hover{background:#059669}
.btn-brand{background:var(--brand);color:#fff}.btn-brand:hover{filter:brightness(0.85)}
.btn-sm{padding:4px 10px;font-size:11px}

/* NAV TABS */
.nav-tabs{display:flex;gap:0;background:var(--bg2);border-bottom:1px solid var(--border);padding:0 24px;overflow-x:auto}
.nav-tab{padding:10px 18px;font-size:13px;font-weight:600;color:var(--text3);cursor:pointer;border-bottom:2px solid transparent;transition:all .15s;white-space:nowrap}
.nav-tab:hover{color:var(--text)}
.nav-tab.active{color:var(--brand);border-bottom-color:var(--brand)}

/* LEGEND */
.legend-bar{display:flex;align-items:center;gap:12px;flex-wrap:wrap;font-size:11px;color:var(--text2);padding:0 4px}
.legend-bar .legend-item{display:flex;align-items:center;gap:4px;white-space:nowrap}
.legend-bar .legend-color{width:10px;height:10px;border-radius:3px;flex-shrink:0}
.legend-toggle{cursor:pointer;font-size:12px;color:var(--text3);border:1px solid var(--border);border-radius:6px;padding:4px 10px;user-select:none}
.legend-toggle:hover{color:var(--text);border-color:var(--text)}
.legend-dropdown{display:none;position:absolute;top:100%;right:0;background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:12px;z-index:200;min-width:260px;font-size:11px}
.legend-dropdown.show{display:block}
.legend-wrapper{position:relative}

/* MAIN */
.main{padding:24px;max-width:1600px;margin:0 auto;transition:margin-left .3s,margin-right .3s}
.main.panel-open{margin-right:var(--panel-w)}
.main.library-open{margin-left:var(--library-w)}

/* EXECUTIVE ROW */
.exec-row{display:flex;flex-direction:column;align-items:center;gap:0;margin-bottom:8px}
.exec-line{width:2px;height:24px;background:var(--text3)}

/* NODE */
.node{padding:10px 16px;border-radius:10px;cursor:pointer;transition:transform .18s,box-shadow .18s,border-color .18s,opacity .2s;position:relative;user-select:none;text-align:center;min-width:120px}
.node:hover{transform:scale(1.05)}
.node .node-name{font-weight:600;font-size:13px;line-height:1.3;word-break:break-word}
.node .node-sub{font-size:11px;color:var(--text2);margin-top:2px}
.node .phase-badge{display:inline-block;font-size:10px;font-weight:700;padding:1px 6px;border-radius:4px;margin-top:4px}
.node .delete-btn{position:absolute;top:-6px;right:-6px;width:18px;height:18px;border-radius:50%;background:var(--red);color:#fff;font-size:11px;display:none;align-items:center;justify-content:center;line-height:1;z-index:5}
.node:hover .delete-btn{display:flex}
.node.selected{outline:2px solid #fff;outline-offset:2px}
.node.inactive-node{opacity:0.4;filter:grayscale(0.6)}
.node.lead-node{min-width:156px;padding:13px 20px;border-width:3px!important;border-style:double!important}
.node.lead-node .node-name{font-size:14px}
.node.lead-node .lead-badge{display:inline-block;font-size:9px;font-weight:800;background:var(--gold);color:#000;padding:1px 5px;border-radius:3px;margin-left:4px;vertical-align:middle}
.node-avatar{width:36px;height:36px;border-radius:50%;object-fit:cover;border:2px solid rgba(255,255,255,.3);margin:0 auto 4px auto;display:block}
.node-exec{background:linear-gradient(135deg,#78350f,#92400e);border:2px solid var(--gold);color:#fef3c7}
.node-exec:hover{box-shadow:0 0 16px rgba(245,166,35,.4);border-color:#fbbf24}
.node-exec .phase-badge{background:var(--gold);color:#000}
.node-orch{background:linear-gradient(135deg,#1e3a5f,#1e40af);border:2px solid var(--brand);color:#dbeafe}
.node-orch:hover{box-shadow:0 0 16px rgba(59,130,246,.5);border-color:#60a5fa}
.node-orch .phase-badge{background:var(--brand);color:#fff}

/* SHARED SERVICES */
.shared-bar{display:flex;justify-content:center;gap:16px;padding:16px;background:var(--bg2);border:1px dashed var(--teal);border-radius:12px;margin-bottom:8px;flex-wrap:wrap}
.shared-bar .node{background:var(--bg);border:2px solid var(--teal)}
.shared-bar .node:hover{box-shadow:0 0 14px rgba(20,184,166,.4);border-color:#2dd4bf}
.shared-bar .phase-badge{background:var(--teal);color:#000}

/* TEAMS GRID */
.teams-grid{display:flex;flex-wrap:wrap;gap:16px;margin-bottom:24px;justify-content:center}
.team-box{border:2px solid;border-radius:12px;padding:14px;background:rgba(0,0,0,.2);min-height:120px;flex:0 1 calc(20% - 13px);min-width:220px;transition:opacity .2s}
.team-box .team-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;gap:8px;cursor:grab;user-select:none;padding:4px;border-radius:6px}
.team-box .team-header:active{cursor:grabbing;background:rgba(255,255,255,.05)}
.team-box .team-title{font-weight:700;font-size:14px}
.team-box .team-nodes{display:flex;flex-direction:column;gap:8px}
.team-node{display:flex;align-items:center;gap:8px}
.team-node .node{flex:1;text-align:left;padding:8px 12px}
.team-node .drag-handle{cursor:grab;color:var(--text3);font-size:16px;padding:0 4px;user-select:none}
.team-node .drag-handle:active{cursor:grabbing}
.team-box.drag-over-team{outline:2px dashed var(--brand);outline-offset:4px}
.team-box.drop-target{outline:2px dashed var(--green);outline-offset:4px;background:rgba(16,185,129,.05)}
.team-blue{border-color:var(--blue)}.team-blue .team-title{color:var(--blue)}
.team-blue .node{background:rgba(59,130,246,.08);border:1.5px solid rgba(59,130,246,.3)}
.team-blue .node:hover{box-shadow:0 0 12px rgba(59,130,246,.3);border-color:var(--blue)}
.team-blue .phase-badge{background:var(--blue);color:#fff}
.team-green{border-color:var(--green)}.team-green .team-title{color:var(--green)}
.team-green .node{background:rgba(16,185,129,.08);border:1.5px solid rgba(16,185,129,.3)}
.team-green .node:hover{box-shadow:0 0 12px rgba(16,185,129,.3);border-color:var(--green)}
.team-green .phase-badge{background:var(--green);color:#000}
.team-orange{border-color:var(--orange)}.team-orange .team-title{color:var(--orange)}
.team-orange .node{background:rgba(245,158,11,.08);border:1.5px solid rgba(245,158,11,.3)}
.team-orange .node:hover{box-shadow:0 0 12px rgba(245,158,11,.3);border-color:var(--orange)}
.team-orange .phase-badge{background:var(--orange);color:#000}
.team-purple{border-color:var(--purple)}.team-purple .team-title{color:var(--purple)}
.team-purple .node{background:rgba(139,92,246,.08);border:1.5px solid rgba(139,92,246,.3)}
.team-purple .node:hover{box-shadow:0 0 12px rgba(139,92,246,.3);border-color:var(--purple)}
.team-purple .phase-badge{background:var(--purple);color:#fff}

/* INFRA BAR */
.infra-section{margin-bottom:24px}
.infra-section h3{font-size:14px;font-weight:700;margin-bottom:8px;color:var(--text2)}
.infra-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.infra-col{background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:14px;min-height:80px}
.infra-col h4{font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--text3);margin-bottom:10px;display:flex;align-items:center;gap:6px}
.infra-col h4 .dot{width:8px;height:8px;border-radius:50%}
.infra-col.approved h4 .dot{background:var(--green)}
.infra-col.review h4 .dot{background:var(--orange)}
.infra-items{display:flex;flex-wrap:wrap;gap:6px}
.infra-chip{padding:5px 10px;border-radius:6px;font-size:12px;font-weight:500;cursor:pointer;transition:all .15s;position:relative;user-select:none}
.infra-chip:hover{transform:scale(1.05)}
.infra-chip .delete-btn{position:absolute;top:-5px;right:-5px;width:16px;height:16px;border-radius:50%;background:var(--red);color:#fff;font-size:10px;display:none;align-items:center;justify-content:center;z-index:5}
.infra-chip:hover .delete-btn{display:flex}
.approved .infra-chip{background:rgba(16,185,129,.15);border:1px solid rgba(16,185,129,.3);color:#6ee7b7}
.review .infra-chip{background:rgba(245,158,11,.15);border:1px solid rgba(245,158,11,.3);color:#fcd34d}
.drop-zone-active{background:rgba(16,185,129,.08)!important;border-color:var(--green)!important}
.drop-zone-review-active{background:rgba(245,158,11,.08)!important;border-color:var(--orange)!important}

/* DETAIL PANEL */
.detail-panel{position:fixed;top:0;right:0;width:var(--panel-w);height:100vh;background:var(--bg2);border-left:1px solid var(--border);transform:translateX(100%);transition:transform .3s;z-index:200;overflow-y:auto;padding:20px}
.detail-panel.open{transform:translateX(0)}
.panel-close{position:absolute;top:12px;right:12px;font-size:20px;color:var(--text3);cursor:pointer}
.panel-close:hover{color:var(--text)}
.panel-header{margin-bottom:20px}
.panel-header h2{font-size:18px;font-weight:700;margin-bottom:4px}
.panel-header .panel-type{font-size:12px;color:var(--text2);text-transform:uppercase;letter-spacing:.5px}
.panel-section{margin-bottom:16px}
.panel-section h4{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--text3);margin-bottom:6px}
.panel-section p,.panel-section li{font-size:13px;color:var(--text2);line-height:1.5}
.panel-section ul{list-style:none;padding:0}
.panel-section li{padding:3px 0;padding-left:12px;position:relative}
.panel-section li::before{content:'•';position:absolute;left:0;color:var(--text3)}
.panel-status{display:inline-block;padding:3px 10px;border-radius:4px;font-size:11px;font-weight:600;text-transform:uppercase}
.status-active{background:rgba(16,185,129,.2);color:#6ee7b7}
.status-planned{background:rgba(245,158,11,.2);color:#fcd34d}
.status-inactive{background:rgba(100,116,139,.2);color:#94a3b8}
.view-field{padding:6px 10px;font-size:13px;color:var(--text);background:var(--bg);border:1px solid transparent;border-radius:6px;min-height:28px;line-height:1.5;word-break:break-word}
.view-field.multiline{white-space:pre-wrap;max-height:100px;overflow-y:auto}
.chip-container{display:flex;flex-wrap:wrap;gap:6px;align-items:center;min-height:28px}
.chip{display:inline-flex;align-items:center;gap:4px;padding:3px 10px;border-radius:16px;font-size:12px;background:var(--bg3);color:var(--text);cursor:default;user-select:none;transition:background .15s}
.chip:hover{background:var(--border)}
.chip .chip-x{cursor:pointer;font-size:14px;color:var(--text3);line-height:1;display:none}
.chip .chip-x:hover{color:var(--red)}
.edit-mode .chip{cursor:grab}
.edit-mode .chip .chip-x{display:inline}
.chip-add{display:none;align-items:center;gap:2px;padding:3px 8px;border-radius:16px;font-size:11px;background:transparent;border:1px dashed var(--border);color:var(--text3);cursor:pointer}
.edit-mode .chip-add{display:inline-flex}
.chip-add:hover{border-color:var(--text);color:var(--text)}
.chip.dragging{opacity:.4}
.profile-upload-area{display:flex;align-items:center;gap:12px;margin-bottom:12px}
.profile-pic-preview{width:64px;height:64px;border-radius:50%;object-fit:cover;border:2px solid var(--border);background:var(--bg3);display:flex;align-items:center;justify-content:center;overflow:hidden}
.profile-pic-preview img{width:100%;height:100%;object-fit:cover;border-radius:50%}
.status-toggle{display:flex;gap:0;border-radius:6px;overflow:hidden;border:1px solid var(--border)}
.status-toggle button{padding:6px 14px;font-size:12px;font-weight:600;border:none;background:var(--bg);color:var(--text3);cursor:pointer;transition:all .15s}
.status-toggle button.active-btn.sel{background:var(--green);color:#000;font-weight:800}
.status-toggle button.inactive-btn.sel{background:var(--red);color:#fff;font-weight:800;opacity:0.8}

/* MODALS */
.modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.6);z-index:300;display:none;align-items:center;justify-content:center}
.modal-overlay.show{display:flex}
.modal{background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:24px;width:420px;max-width:90vw;max-height:90vh;overflow-y:auto}
.modal h3{font-size:16px;font-weight:700;margin-bottom:16px}
.form-group{margin-bottom:12px}
.form-group label{display:block;font-size:12px;font-weight:600;color:var(--text2);margin-bottom:4px}
.form-group input,.form-group select,.form-group textarea{width:100%}
.form-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:16px}

.jd-modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.7);z-index:350;display:none;align-items:center;justify-content:center}
.jd-modal-overlay.show{display:flex}
.jd-modal{background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:24px;width:640px;max-width:90vw;max-height:80vh;display:flex;flex-direction:column}
.jd-modal h3{font-size:16px;font-weight:700;margin-bottom:12px}
.jd-modal textarea{flex:1;min-height:300px;width:100%;resize:vertical;font-size:14px;line-height:1.6}
.jd-modal .jd-view{flex:1;min-height:300px;overflow-y:auto;font-size:14px;line-height:1.6;color:var(--text2);white-space:pre-wrap;padding:8px;background:var(--bg);border-radius:6px}
.jd-modal .form-actions{margin-top:12px}

.branding-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.6);z-index:300;display:none;align-items:center;justify-content:center}
.branding-overlay.show{display:flex}
.branding-modal{background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:24px;width:380px;max-width:90vw}
.branding-modal h3{font-size:16px;font-weight:700;margin-bottom:16px}
.color-row{display:flex;align-items:center;gap:10px}
.color-row input[type=color]{width:40px;height:32px;padding:2px;border:1px solid var(--border);border-radius:4px;cursor:pointer}
.color-row input[type=text]{width:100px}
.brand-upload-zone{border:2px dashed var(--border);border-radius:8px;padding:16px;text-align:center;cursor:pointer;transition:border-color .2s;margin-bottom:12px}
.brand-upload-zone:hover{border-color:var(--brand)}
.brand-upload-zone .upload-label{font-size:12px;color:var(--text2)}
.brand-upload-zone .file-name{font-size:13px;color:var(--text);font-weight:600;margin-top:4px}
.brand-color-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px}
.brand-color-grid .form-group{margin-bottom:0}
.mcp-dropdown{position:absolute;background:var(--bg2);border:1px solid var(--border);border-radius:8px;max-height:200px;overflow-y:auto;z-index:10;width:250px;box-shadow:0 8px 24px rgba(0,0,0,.4)}
.mcp-dropdown-item{padding:6px 12px;font-size:12px;cursor:pointer;color:var(--text2)}
.mcp-dropdown-item:hover{background:var(--bg3);color:var(--text)}

/* ====== LIBRARY DRAWER ====== */
.library-toggle{position:fixed;left:0;top:50%;transform:translateY(-50%);z-index:201;background:var(--brand);color:#fff;border:none;padding:12px 6px;border-radius:0 8px 8px 0;font-size:14px;cursor:pointer;writing-mode:vertical-rl;text-orientation:mixed;letter-spacing:1px;font-weight:700;transition:all .2s;box-shadow:2px 2px 8px rgba(0,0,0,.3)}
.library-toggle:hover{filter:brightness(1.2);padding-right:10px}
.library-toggle.lib-open{left:var(--library-w)}
.library-drawer{position:fixed;left:0;top:0;width:var(--library-w);height:100vh;background:var(--bg2);border-right:1px solid var(--border);z-index:199;transform:translateX(-100%);transition:transform .3s ease;display:flex;flex-direction:column;overflow:hidden}
.library-drawer.open{transform:translateX(0)}
.library-header{padding:16px;border-bottom:1px solid var(--border);flex-shrink:0}
.library-header h2{font-size:16px;font-weight:700;margin-bottom:10px;display:flex;align-items:center;gap:8px}
.library-search{width:100%;padding:8px 12px;border-radius:8px;background:var(--bg);border:1px solid var(--border);color:var(--text);font-size:13px}
.library-search:focus{outline:none;border-color:var(--brand)}
.library-tabs{display:flex;border-bottom:1px solid var(--border);flex-shrink:0;overflow-x:auto}
.library-tab{flex:1;padding:8px 4px;font-size:11px;font-weight:600;color:var(--text3);text-align:center;cursor:pointer;border-bottom:2px solid transparent;transition:all .15s;white-space:nowrap;min-width:0}
.library-tab:hover{color:var(--text)}
.library-tab.active{color:var(--brand);border-bottom-color:var(--brand)}
.library-content{flex:1;overflow-y:auto;padding:12px}
.library-item{display:flex;align-items:flex-start;gap:10px;padding:10px;border-radius:8px;border:1px solid var(--border);margin-bottom:8px;cursor:grab;transition:all .15s;background:var(--bg)}
.library-item:hover{border-color:var(--brand);background:rgba(59,130,246,.05);transform:translateX(2px)}
.library-item:active{cursor:grabbing}
.library-item.dragging{opacity:.4}
.library-item .lib-icon{font-size:20px;flex-shrink:0;width:32px;text-align:center;line-height:32px}
.library-item .lib-info{flex:1;min-width:0}
.library-item .lib-name{font-weight:600;font-size:13px;margin-bottom:2px}
.library-item .lib-desc{font-size:11px;color:var(--text3);line-height:1.3;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.library-item .lib-badge{font-size:9px;font-weight:700;padding:2px 6px;border-radius:3px;background:var(--brand);color:#fff;flex-shrink:0}
.library-item .lib-badge.rec{background:var(--green);color:#000}

/* Industry template card */
.industry-card{padding:14px;border-radius:10px;border:1px solid var(--border);margin-bottom:10px;background:var(--bg);cursor:pointer;transition:all .2s}
.industry-card:hover{border-color:var(--brand);background:rgba(59,130,246,.05)}
.industry-card.expanded{border-color:var(--brand)}
.industry-card .ind-header{display:flex;align-items:center;gap:10px}
.industry-card .ind-icon{font-size:28px}
.industry-card .ind-title{font-weight:700;font-size:14px}
.industry-card .ind-sub{font-size:11px;color:var(--text3)}
.industry-card .ind-details{margin-top:12px;display:none}
.industry-card.expanded .ind-details{display:block}
.ind-section{margin-bottom:8px}
.ind-section-title{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--text3);margin-bottom:4px}
.ind-tags{display:flex;flex-wrap:wrap;gap:4px}
.ind-tag{font-size:11px;padding:2px 8px;border-radius:4px;background:var(--bg3);color:var(--text2)}
.ind-apply-btn{width:100%;margin-top:8px;padding:8px;border-radius:6px;background:var(--brand);color:#fff;font-weight:700;font-size:13px;border:none;cursor:pointer;transition:filter .15s}
.ind-apply-btn:hover{filter:brightness(.85)}

/* Skills writer */
.skills-writer{padding:4px}
.sw-tabs{display:flex;gap:0;margin-bottom:12px;border-radius:8px;overflow:hidden;border:1px solid var(--border)}
.sw-tab{flex:1;padding:8px;font-size:12px;font-weight:600;text-align:center;cursor:pointer;background:var(--bg);color:var(--text3);transition:all .15s}
.sw-tab.active{background:var(--brand);color:#fff}
.sw-form .form-group{margin-bottom:10px}
.sw-preview{background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:10px;font-size:12px;color:var(--text2);min-height:60px;line-height:1.5}

/* MCP Hub */
.mcp-hub{padding:24px}
.mcp-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px}
.mcp-card{background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:14px;transition:all .15s}
.mcp-card:hover{border-color:var(--brand)}
.mcp-card .mcp-name{font-weight:700;font-size:14px;margin-bottom:4px;display:flex;align-items:center;gap:8px}
.mcp-status{display:inline-block;width:8px;height:8px;border-radius:50%}
.mcp-status.active{background:var(--green)}
.mcp-status.inactive{background:var(--text3)}
.mcp-status.planned{background:var(--blue)}
.mcp-card .mcp-users{font-size:11px;color:var(--text3);margin-top:4px}
.mcp-card .mcp-toggle{margin-top:8px}

/* Export/Import */
.export-menu{position:absolute;top:100%;right:0;background:var(--bg2);border:1px solid var(--border);border-radius:8px;padding:4px;z-index:300;min-width:180px;box-shadow:0 8px 24px rgba(0,0,0,.4);display:none}
.export-menu.show{display:block}
.export-menu button{display:block;width:100%;text-align:left;padding:8px 12px;border-radius:4px;font-size:12px;color:var(--text2)}
.export-menu button:hover{background:var(--bg3);color:var(--text)}

/* TABS CONTENT */
.tab-content{display:none}
.tab-content.active{display:block}

/* DASHBOARD */
.dashboard-container{padding:4px;max-width:1400px;margin:0 auto}
.dash-status-row{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:20px}
.dash-card{background:rgba(30,41,59,.7);backdrop-filter:blur(16px);border:1px solid var(--border);border-radius:14px;padding:20px;cursor:pointer;transition:transform .2s,box-shadow .2s}
.dash-card:hover{transform:translateY(-4px);box-shadow:0 8px 24px rgba(0,0,0,.3)}
.dash-card-number{font-size:36px;font-weight:800;line-height:1}
.dash-card-label{font-size:13px;color:var(--text2);margin:4px 0 8px}
.dash-card-mini{font-size:11px;color:var(--text3)}
.dash-card-amber{border-color:rgba(245,158,11,.4);background:rgba(245,158,11,.06)}
.dash-card-amber .dash-card-mini{color:var(--orange)}
.dash-card-anim{opacity:0;animation:dashFadeUp .4s ease forwards;animation-delay:calc(var(--anim-i) * .08s)}
@keyframes dashFadeUp{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}
.dash-middle{display:grid;grid-template-columns:3fr 2fr;gap:16px;margin-bottom:20px}
.dash-feed{background:rgba(30,41,59,.7);backdrop-filter:blur(16px);border:1px solid var(--border);border-radius:14px;padding:16px;position:relative;display:flex;flex-direction:column}
.dash-feed-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;flex-wrap:wrap;gap:8px}
.dash-feed-header h3{font-size:15px;font-weight:700}
.dash-feed-filters{display:flex;gap:6px}
.dash-feed-filters select{font-size:11px;padding:4px 8px;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text2)}
.dash-feed-list{max-height:340px;overflow-y:auto;display:flex;flex-direction:column;gap:2px}
.dash-feed-list::-webkit-scrollbar{width:4px}.dash-feed-list::-webkit-scrollbar-thumb{background:var(--border);border-radius:4px}
.dash-feed-fade{position:absolute;bottom:0;left:0;right:0;height:40px;background:linear-gradient(transparent,rgba(30,41,59,.95));border-radius:0 0 14px 14px;pointer-events:none}
.dash-feed-item{display:flex;align-items:flex-start;gap:10px;padding:8px 10px;border-radius:8px;font-size:12px;border-left:3px solid transparent;transition:background .15s}
.dash-feed-item:nth-child(odd){background:rgba(255,255,255,.02)}
.dash-feed-item:hover{background:rgba(255,255,255,.05)}
.dash-feed-time{color:var(--text3);font-size:11px;white-space:nowrap;min-width:52px}
.dash-feed-body{color:var(--text);line-height:1.4}
.dash-right{display:flex;flex-direction:column;gap:16px}
.dash-actions{background:rgba(30,41,59,.7);backdrop-filter:blur(16px);border:1px solid var(--border);border-radius:14px;padding:16px}
.dash-actions h3{font-size:15px;font-weight:700;margin-bottom:12px}
.dash-actions-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.dash-action-card{background:rgba(255,255,255,.04);border:1px solid var(--border);border-radius:10px;padding:14px;cursor:pointer;transition:all .2s;text-align:center}
.dash-action-card:hover{background:rgba(59,130,246,.1);border-color:var(--brand);transform:translateY(-2px)}
.dash-action-icon{font-size:24px;margin-bottom:4px}
.dash-action-title{font-size:13px;font-weight:600}
.dash-action-desc{font-size:11px;color:var(--text3);margin-top:2px}
.dash-alerts{background:rgba(30,41,59,.7);backdrop-filter:blur(16px);border:1px solid var(--border);border-radius:14px;padding:16px;flex:1}
.dash-alerts h3{font-size:15px;font-weight:700;margin-bottom:12px;display:flex;align-items:center;gap:8px}
.dash-alert-badge{background:var(--red);color:#fff;font-size:11px;font-weight:700;padding:2px 8px;border-radius:10px}
.dash-alert-list{display:flex;flex-direction:column;gap:8px}
.dash-alert{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px 12px;border-radius:8px;background:rgba(0,0,0,.2);border-left:3px solid transparent}
.dash-alert-red{border-left-color:var(--red)}
.dash-alert-amber{border-left-color:var(--orange)}
.dash-alert-text{font-size:12px;flex:1}
.dash-perf-row{display:grid;grid-template-columns:repeat(3,1fr);gap:16px}
.dash-perf-card{background:rgba(30,41,59,.7);backdrop-filter:blur(16px);border:1px solid var(--border);border-radius:14px;padding:20px;text-align:center}
.dash-perf-label{font-size:11px;color:var(--text3);text-transform:uppercase;letter-spacing:.5px}
.dash-perf-value{font-size:28px;font-weight:800;margin:4px 0 8px}
.dash-sparkline-svg{width:100%;height:40px}
.dash-progress-ring{width:80px;height:80px;margin:0 auto;display:block}
.dash-stars{font-size:22px;color:var(--gold);letter-spacing:2px}
.dash-sparkline{display:inline-block}
@media(max-width:900px){
  .dash-status-row{grid-template-columns:1fr 1fr}
  .dash-middle{grid-template-columns:1fr}
  .dash-perf-row{grid-template-columns:1fr}
}

/* RESPONSIVE */
@media(max-width:1200px){
  .teams-grid{justify-content:center}
  .team-box{flex:0 1 calc(33.333% - 11px);min-width:240px}
  .main.panel-open{margin-right:0}
  .detail-panel{width:340px}
  .infra-grid{grid-template-columns:1fr}
  .main.library-open{margin-left:0}
}
@media(max-width:768px){
  .team-box{flex:1 1 100%;min-width:100%}
  .header{flex-direction:column;gap:10px;text-align:center}
  .header-actions{justify-content:center}
  .detail-panel{width:100%}
  .main{padding:12px}
  .shared-bar{flex-direction:column;align-items:center}
  .infra-grid{grid-template-columns:1fr}
  html{font-size:13px}
  .legend-bar{display:none}
  .library-drawer{width:100vw}
  .library-toggle.lib-open{left:100vw}
  .main.library-open{margin-left:0}
  .nav-tabs{padding:0 12px}
}

/* TOAST */
.toast{position:fixed;bottom:24px;right:24px;background:var(--green);color:#000;padding:10px 20px;border-radius:8px;font-weight:600;font-size:13px;z-index:400;transform:translateY(80px);opacity:0;transition:all .3s}
.toast.show{transform:translateY(0);opacity:1}

/* RELATIONSHIP TYPE BADGES & ENGAGEMENT ICONS */
.rel-badge{display:inline-block;font-size:9px;font-weight:700;padding:1px 6px;border-radius:3px;margin-right:2px}
.rel-badge.rel-tool{background:rgba(148,163,184,.3);color:#cbd5e1;border:1px solid rgba(148,163,184,.4)}
.rel-badge.rel-sidekick{background:rgba(59,130,246,.2);color:#93c5fd;border:1px solid rgba(59,130,246,.4)}
.rel-badge.rel-persona{background:rgba(139,92,246,.2);color:#c4b5fd;border:1px solid rgba(139,92,246,.4)}
.node-badges{display:flex;align-items:center;justify-content:center;gap:3px;margin-top:3px;flex-wrap:wrap;font-size:11px}
.starter-chip{display:block;padding:8px 12px;margin:5px 0;border-radius:16px;background:rgba(59,130,246,0.08);border:1px solid rgba(59,130,246,0.25);font-size:13px;color:var(--text);cursor:default;text-align:left;line-height:1.4;transition:background .15s}
.starter-chip:hover{background:rgba(59,130,246,0.15)}
.grace-field{margin-bottom:12px}
.grace-field label{display:flex;align-items:center;gap:6px;font-size:12px;font-weight:600;color:var(--text2);margin-bottom:4px}
.grace-field label .grace-letter{display:inline-flex;align-items:center;justify-content:center;width:24px;height:24px;border-radius:50%;color:#fff;font-weight:800;font-size:13px;flex-shrink:0}
.grace-field:nth-child(1) .grace-letter,.grace-field label .grace-letter[data-l="G"]{background:#10B981}
.grace-field:nth-child(2) .grace-letter,.grace-field label .grace-letter[data-l="R"]{background:#3B82F6}
.grace-field:nth-child(3) .grace-letter,.grace-field label .grace-letter[data-l="A"]{background:#F59E0B}
.grace-field:nth-child(4) .grace-letter,.grace-field label .grace-letter[data-l="C"]{background:#8B5CF6}
.grace-field:nth-child(5) .grace-letter,.grace-field label .grace-letter[data-l="E"]{background:#EC4899}

.expand-btn{display:inline-flex;align-items:center;gap:4px;padding:2px 8px;font-size:11px;color:var(--brand);background:rgba(59,130,246,0.1);border:1px solid rgba(59,130,246,0.2);border-radius:4px;cursor:pointer;margin-left:8px;transition:all .15s}
.expand-btn:hover{background:rgba(59,130,246,0.2)}
.expand-modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.7);z-index:400;display:none;align-items:center;justify-content:center;padding:20px}
.expand-modal-overlay.show{display:flex}
.expand-modal{background:var(--bg2);border-radius:12px;width:90vw;max-width:800px;height:80vh;display:flex;flex-direction:column;padding:20px;box-shadow:0 20px 60px rgba(0,0,0,.5)}
.expand-modal h3{margin:0 0 12px;font-size:16px;color:var(--text)}
.expand-modal textarea{flex:1;width:100%;resize:none;font-size:14px;line-height:1.6;background:var(--bg);color:var(--text);border:1px solid var(--border);border-radius:8px;padding:12px}
.expand-modal .expand-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}

/* ====== PHASE 3-5 CSS ====== */

/* Testing Banner */
.testing-banner{background:rgba(245,166,35,.08);border-bottom:1px solid rgba(245,166,35,.2);color:var(--gold);text-align:center;padding:6px 16px;font-size:11px;font-weight:600;letter-spacing:.3px}

/* Settings Container */
.settings-container{max-width:1200px;margin:0 auto;padding:24px}
.settings-section{margin-bottom:36px}
.settings-section>h2{font-size:18px;font-weight:700;margin-bottom:16px;display:flex;align-items:center;gap:8px}
.settings-section>h3{font-size:15px;font-weight:600;margin-bottom:12px;color:var(--text2)}

/* Subscription Cards */
.sub-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:16px}
.sub-card{background:var(--bg);border:2px solid var(--border);border-radius:12px;padding:20px;position:relative;transition:all .2s}
.sub-card:hover{border-color:var(--brand)}
.sub-card.current{border-color:var(--green);box-shadow:0 0 20px rgba(16,185,129,.15)}
.sub-card.popular{border-color:var(--brand);box-shadow:0 0 25px rgba(59,130,246,.2),0 0 50px rgba(59,130,246,.08);transform:scale(1.02)}
.sub-card.popular:hover{box-shadow:0 0 30px rgba(59,130,246,.3),0 0 60px rgba(59,130,246,.12)}
.sub-card.popular .current-badge{animation:popularGlow 2s ease-in-out infinite alternate}
@keyframes popularGlow{from{box-shadow:0 2px 8px rgba(59,130,246,.3)}to{box-shadow:0 2px 16px rgba(59,130,246,.6)}}
.deploy-wizard .dw-progress{display:flex;gap:8px;margin-bottom:20px}.deploy-wizard .dw-step{flex:1;height:4px;border-radius:2px;background:var(--bg3)}.deploy-wizard .dw-step.active{background:var(--brand)}.deploy-wizard .dw-step.done{background:var(--green)}
.deploy-wizard .dw-step-label{display:flex;justify-content:space-between;font-size:11px;color:var(--text3);margin-bottom:12px}
.deploy-wizard .dw-bots-list{display:flex;flex-wrap:wrap;gap:6px;margin:10px 0}.deploy-wizard .dw-bot-tag{background:var(--bg3);padding:3px 10px;border-radius:4px;font-size:11px;color:var(--text)}
.deploy-wizard .dw-integration{display:flex;align-items:center;justify-content:space-between;padding:8px 12px;background:var(--bg);border-radius:8px;margin-bottom:6px}
.deploy-wizard .dw-toggle{width:36px;height:20px;border-radius:10px;background:var(--bg3);position:relative;cursor:pointer;transition:.2s}.deploy-wizard .dw-toggle.on{background:var(--green)}.deploy-wizard .dw-toggle::after{content:'';position:absolute;top:2px;left:2px;width:16px;height:16px;border-radius:50%;background:#fff;transition:.2s}.deploy-wizard .dw-toggle.on::after{left:18px}
.deploy-wizard .dw-summary{background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:16px;margin:12px 0}
.kpi-row{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:16px}
.kpi-card{background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:14px 16px}
.kpi-card .kpi-label{font-size:11px;color:var(--text3);text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px}
.kpi-card .kpi-value{font-size:22px;font-weight:700;color:var(--text)}
.kpi-card .kpi-sub{font-size:11px;color:var(--text3);margin-top:2px}
.sub-card .sub-tier{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--text3);margin-bottom:4px}
.sub-card .sub-price{font-size:28px;font-weight:800;margin-bottom:12px}.sub-card .sub-price span{font-size:14px;font-weight:400;color:var(--text3)}
.sub-card .sub-features{list-style:none;padding:0;margin-bottom:16px}
.sub-card .sub-features li{font-size:12px;color:var(--text2);padding:4px 0;border-bottom:1px solid rgba(71,85,105,.3);display:flex;align-items:center;gap:6px}
.sub-card .current-badge{position:absolute;top:-1px;right:16px;background:var(--green);color:#000;font-size:10px;font-weight:800;padding:3px 10px;border-radius:0 0 6px 6px}

/* White-Label Config */
.wl-grid{display:grid;grid-template-columns:1fr 1fr;gap:24px}
.wl-form{display:flex;flex-direction:column;gap:12px}
.wl-preview{background:var(--bg);border:1px solid var(--border);border-radius:12px;padding:20px;min-height:300px;display:flex;flex-direction:column}
.wl-preview-header{display:flex;align-items:center;gap:10px;padding:10px 16px;border-radius:8px;margin-bottom:12px}
.wl-preview-body{flex:1;display:flex;flex-direction:column;gap:8px}
.wl-preview-card{padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,.1)}
.wl-preview-footer{text-align:center;font-size:11px;margin-top:auto;padding-top:12px;border-top:1px solid rgba(255,255,255,.1)}

/* Organization Selector */
.org-selector{display:flex;align-items:center;gap:8px;margin-left:16px}
.org-selector select{background:var(--bg);color:var(--text);border:1px solid var(--border);border-radius:6px;padding:4px 8px;font-size:12px;font-weight:600}

/* Share Section */
.share-list{display:flex;flex-direction:column;gap:8px;margin-top:12px}
.share-item{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;background:var(--bg);border:1px solid var(--border);border-radius:8px;font-size:12px}
.share-item .share-meta{display:flex;align-items:center;gap:8px}
.share-badge{font-size:10px;font-weight:700;padding:2px 8px;border-radius:4px}
.share-badge.view{background:rgba(59,130,246,.2);color:#93c5fd}
.share-badge.edit{background:rgba(245,158,11,.2);color:#fcd34d}

/* Analytics Container */
.analytics-container{max-width:1400px;margin:0 auto;padding:24px}
.analytics-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:12px}
.analytics-header h2{font-size:20px;font-weight:700}
.analytics-toggle{display:flex;align-items:center;gap:8px;font-size:12px;color:var(--text2)}
.analytics-toggle label{cursor:pointer;display:flex;align-items:center;gap:6px}
.toggle-switch{position:relative;width:36px;height:20px;background:var(--bg3);border-radius:10px;cursor:pointer;transition:background .2s}
.toggle-switch.on{background:var(--green)}
.toggle-switch::after{content:'';position:absolute;top:2px;left:2px;width:16px;height:16px;background:#fff;border-radius:50%;transition:transform .2s}
.toggle-switch.on::after{transform:translateX(16px)}
.analytics-sub{font-size:14px;font-weight:700;margin:24px 0 12px;color:var(--text2);text-transform:uppercase;letter-spacing:.5px;display:flex;align-items:center;gap:8px}

/* Stat Cards */
.stat-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:24px}
.stat-card{background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:16px}
.stat-card .stat-label{font-size:11px;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px}
.stat-card .stat-value{font-size:24px;font-weight:800;margin-bottom:2px}
.stat-card .stat-change{font-size:11px;font-weight:600}
.stat-card .stat-change.up{color:var(--green)}
.stat-card .stat-change.down{color:var(--red)}

/* CSS Bar Chart */
.bar-chart{display:flex;align-items:flex-end;gap:6px;height:160px;padding:8px 0;border-bottom:1px solid var(--border)}
.bar-chart .bar-col{flex:1;display:flex;flex-direction:column;align-items:center;gap:4px;min-width:0}
.bar-chart .bar{width:100%;border-radius:4px 4px 0 0;min-height:4px;transition:height .5s;cursor:pointer;position:relative}
.bar-chart .bar:hover{filter:brightness(1.2)}
.bar-chart .bar-label{font-size:9px;color:var(--text3);text-align:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:100%}
.bar-chart .bar-val{font-size:9px;color:var(--text2);font-weight:600}

/* Data Table */
.data-table{width:100%;border-collapse:collapse;font-size:12px}
.data-table th{text-align:left;padding:8px 10px;font-size:11px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:.5px;border-bottom:2px solid var(--border);cursor:pointer;user-select:none;white-space:nowrap}
.data-table th:hover{color:var(--text)}
.data-table th .sort-arrow{margin-left:4px;font-size:10px}
.data-table td{padding:8px 10px;border-bottom:1px solid rgba(71,85,105,.3);color:var(--text2)}
.data-table tr:hover td{background:rgba(59,130,246,.03)}
.data-table .status-dot{display:inline-block;width:8px;height:8px;border-radius:50%;margin-right:6px}

/* Sparkline */
.sparkline{display:inline-flex;align-items:flex-end;gap:1px;height:20px;vertical-align:middle}
.sparkline .spark-bar{width:3px;border-radius:1px;min-height:2px}

/* Team Perf Cards */
.team-perf-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px;margin-bottom:24px}
.team-perf-card{padding:14px;border-radius:10px;border:2px solid;background:rgba(0,0,0,.2)}
.team-perf-card .tpc-name{font-size:14px;font-weight:700;margin-bottom:8px}
.team-perf-card .tpc-stats{display:grid;grid-template-columns:1fr 1fr;gap:6px}
.team-perf-card .tpc-stat{font-size:11px;color:var(--text2)}
.team-perf-card .tpc-stat strong{display:block;font-size:16px;color:var(--text)}

/* SVG Line Chart */
.line-chart-container{background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:16px;margin-bottom:16px}
.line-chart-container h4{font-size:13px;font-weight:700;margin-bottom:12px;color:var(--text2)}

/* Budget Progress */
.budget-bar{height:8px;background:var(--bg3);border-radius:4px;overflow:hidden;margin-top:4px}
.budget-fill{height:100%;border-radius:4px;transition:width .5s}
.budget-alert{display:inline-flex;align-items:center;gap:4px;font-size:11px;font-weight:600;padding:2px 8px;border-radius:4px;margin-top:4px}

/* Token Table */
.token-cost-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:24px}

/* Marketplace */
.mp-container{max-width:1400px;margin:0 auto;padding:24px}
.mp-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:12px}
.mp-filters{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.mp-filters select,.mp-filters input{background:var(--bg);border:1px solid var(--border);border-radius:6px;padding:6px 10px;font-size:12px;color:var(--text)}
.mp-featured{margin-bottom:24px}
.mp-featured h3{font-size:14px;font-weight:700;color:var(--text2);margin-bottom:12px}
.mp-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:16px}
.mp-card{background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:18px;transition:all .2s;cursor:default}
.mp-card:hover{border-color:var(--brand);transform:translateY(-2px);box-shadow:0 8px 24px rgba(0,0,0,.3)}
.mp-card .mp-icon{font-size:32px;margin-bottom:8px}
.mp-card .mp-name{font-size:15px;font-weight:700;margin-bottom:4px}
.mp-card .mp-author{font-size:11px;color:var(--text3);margin-bottom:8px}
.mp-card .mp-desc{font-size:12px;color:var(--text2);line-height:1.4;margin-bottom:10px;display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden}
.mp-card .mp-meta{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;font-size:11px;color:var(--text3)}
.mp-stars{color:var(--gold)}
.mp-price{font-weight:700;padding:2px 8px;border-radius:4px;font-size:11px}
.mp-price.free{background:rgba(16,185,129,.15);color:#6ee7b7}
.mp-price.paid{background:rgba(139,92,246,.15);color:#c4b5fd}

/* Workflows */
.wf-container{display:flex;height:calc(100vh - 120px);overflow:hidden}
.wf-sidebar{width:280px;background:var(--bg2);border-right:1px solid var(--border);display:flex;flex-direction:column;flex-shrink:0;overflow:hidden}
.wf-sidebar-header{padding:14px;border-bottom:1px solid var(--border)}
.wf-sidebar-header h3{font-size:14px;font-weight:700;margin-bottom:8px}
.wf-sidebar-content{flex:1;overflow-y:auto;padding:12px}
.wf-sidebar-section{margin-bottom:16px}
.wf-sidebar-section h4{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--text3);margin-bottom:8px}
.wf-bot-item{display:flex;align-items:center;gap:8px;padding:8px 10px;background:var(--bg);border:1px solid var(--border);border-radius:8px;margin-bottom:6px;cursor:grab;font-size:12px;transition:all .15s}
.wf-bot-item:hover{border-color:var(--brand);background:rgba(59,130,246,.05)}
.wf-bot-item:active{cursor:grabbing}
.wf-bot-item .wf-bot-icon{font-size:16px}
.wf-bot-item .wf-bot-name{flex:1;font-weight:600}
.wf-bot-item .wf-bot-team{font-size:10px;color:var(--text3)}
.wf-tpl-item{padding:10px;background:var(--bg);border:1px solid var(--border);border-radius:8px;margin-bottom:6px;cursor:pointer;transition:all .15s}
.wf-tpl-item:hover{border-color:var(--brand);background:rgba(59,130,246,.05)}
.wf-tpl-item .wf-tpl-name{font-size:13px;font-weight:600;margin-bottom:2px}
.wf-tpl-item .wf-tpl-flow{font-size:11px;color:var(--text3)}
.wf-main{flex:1;position:relative;overflow:auto;background:var(--bg)}
.wf-toolbar{position:absolute;top:12px;left:12px;z-index:10;display:flex;gap:6px}
.wf-toolbar .btn{background:var(--bg2);border:1px solid var(--border)}
.wf-canvas-area{width:3000px;height:2000px;position:relative}
.wf-node{position:absolute;min-width:140px;padding:10px 16px;border-radius:10px;background:var(--bg2);border:2px solid var(--border);cursor:move;z-index:5;user-select:none;transition:box-shadow .15s}
.wf-node:hover{box-shadow:0 4px 16px rgba(0,0,0,.3)}
.wf-node.selected{outline:2px solid #fff;outline-offset:2px}
.wf-node .wf-node-name{font-size:13px;font-weight:600;text-align:center;margin-bottom:2px}
.wf-node .wf-node-type{font-size:10px;color:var(--text3);text-align:center}
.wf-node .wf-node-status{text-align:center;font-size:14px;margin-top:4px}
.wf-node .wf-handle{position:absolute;width:12px;height:12px;background:var(--brand);border:2px solid var(--bg2);border-radius:50%;cursor:crosshair;z-index:6}
.wf-node .wf-handle-in{left:-6px;top:50%;transform:translateY(-50%)}
.wf-node .wf-handle-out{right:-6px;top:50%;transform:translateY(-50%)}
.wf-node .wf-node-delete{position:absolute;top:-8px;right:-8px;width:18px;height:18px;border-radius:50%;background:var(--red);color:#fff;font-size:11px;display:none;align-items:center;justify-content:center;cursor:pointer;z-index:7}
.wf-node:hover .wf-node-delete{display:flex}
.wf-node.human-node{background:linear-gradient(135deg,#78350f,#92400e);border-color:var(--gold)}
.wf-node.human-node .wf-handle{background:var(--gold)}
.wf-conn-label{position:absolute;background:var(--bg2);border:1px solid var(--border);border-radius:6px;padding:3px 8px;font-size:10px;color:var(--text2);cursor:pointer;z-index:4;white-space:nowrap}
.wf-conn-label:hover{border-color:var(--brand)}

/* Simulation */
.wf-sim-bar{position:absolute;bottom:12px;left:50%;transform:translateX(-50%);z-index:10;display:flex;align-items:center;gap:8px;background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:8px 16px}

/* Chat */
.chat-fab{position:fixed;bottom:24px;right:24px;width:56px;height:56px;border-radius:50%;background:var(--brand);color:#fff;font-size:24px;display:flex;align-items:center;justify-content:center;cursor:pointer;z-index:250;box-shadow:0 4px 16px rgba(59,130,246,.4);transition:all .2s;border:none}
.chat-fab:hover{transform:scale(1.1);box-shadow:0 6px 24px rgba(59,130,246,.5)}
.chat-fab.open{background:var(--red)}
.chat-panel{position:fixed;bottom:90px;right:24px;width:380px;max-height:70vh;background:var(--bg2);border:1px solid var(--border);border-radius:12px;z-index:250;display:none;flex-direction:column;box-shadow:0 12px 40px rgba(0,0,0,.5);overflow:hidden}
.chat-panel.open{display:flex}
.chat-header{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;border-bottom:1px solid var(--border)}
.chat-header h3{font-size:14px;font-weight:700}
.chat-messages{flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:10px;min-height:300px;max-height:50vh}
.chat-bubble{max-width:85%;padding:10px 14px;border-radius:12px;font-size:13px;line-height:1.5;word-break:break-word}
.chat-bubble.assistant{background:var(--bg3);color:var(--text);align-self:flex-start;border-bottom-left-radius:4px}
.chat-bubble.user{background:var(--brand);color:#fff;align-self:flex-end;border-bottom-right-radius:4px}
.chat-bubble .chat-actions{display:flex;gap:6px;margin-top:8px}
.chat-bubble .chat-actions button{padding:5px 12px;border-radius:6px;font-size:11px;font-weight:600;border:none;cursor:pointer;transition:all .15s}
.chat-bubble .chat-action-apply{background:var(--green);color:#000}
.chat-bubble .chat-action-cancel{background:var(--bg);color:var(--text2);border:1px solid var(--border)!important}
.chat-input-area{display:flex;gap:8px;padding:12px 16px;border-top:1px solid var(--border)}
.chat-input-area input{flex:1;background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:8px 12px;color:var(--text);font-size:13px}
.chat-input-area button{background:var(--brand);color:#fff;border:none;border-radius:8px;padding:8px 14px;font-weight:600;cursor:pointer;font-size:13px}
.chat-typing{display:flex;gap:4px;padding:4px 0;align-self:flex-start}
.chat-typing span{width:8px;height:8px;background:var(--text3);border-radius:50%;animation:chatTyping 1.2s infinite}
.chat-typing span:nth-child(2){animation-delay:.2s}
.chat-typing span:nth-child(3){animation-delay:.4s}
@keyframes chatTyping{0%,80%,100%{transform:scale(.6);opacity:.4}40%{transform:scale(1);opacity:1}}

/* Canvas flash animation */
@keyframes greenFlash{0%{box-shadow:0 0 0 rgba(16,185,129,0)}50%{box-shadow:0 0 20px rgba(16,185,129,.6)}100%{box-shadow:0 0 0 rgba(16,185,129,0)}}
.flash-green{animation:greenFlash .8s ease}

/* ======================== PHASE 5: BOT CONFIG & INTEGRATIONS ======================== */
.bot-config-panel{position:fixed;top:0;right:-440px;width:420px;height:100vh;background:rgba(30,41,59,.92);backdrop-filter:blur(20px);border-left:1px solid var(--border);z-index:300;transition:right .3s ease;display:flex;flex-direction:column;overflow:hidden}
.bot-config-panel.open{right:0}
.bcp-header{display:flex;align-items:center;justify-content:space-between;padding:16px 20px;border-bottom:1px solid var(--border)}
.bcp-header h3{font-size:16px;font-weight:700;display:flex;align-items:center;gap:8px}
.bcp-close{font-size:18px;cursor:pointer;color:var(--text3);transition:.15s}.bcp-close:hover{color:var(--text)}
.bcp-tabs{display:flex;border-bottom:1px solid var(--border);padding:0 12px;overflow-x:auto}
.bcp-tab{padding:8px 12px;font-size:11px;font-weight:600;color:var(--text3);cursor:pointer;border-bottom:2px solid transparent;white-space:nowrap;transition:.15s}
.bcp-tab:hover{color:var(--text)}.bcp-tab.active{color:var(--brand);border-bottom-color:var(--brand)}
.bcp-body{flex:1;overflow-y:auto;padding:16px 20px}
.bcp-section{margin-bottom:20px}
.bcp-section h4{font-size:12px;font-weight:700;color:var(--text2);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px}
.bcp-status-badge{display:inline-flex;align-items:center;gap:6px;padding:6px 14px;border-radius:20px;font-size:12px;font-weight:700}
.bcp-status-badge.ready{background:rgba(16,185,129,.15);color:var(--green);border:1px solid rgba(16,185,129,.3)}
.bcp-status-badge.needs-setup{background:rgba(245,158,11,.15);color:var(--orange);border:1px solid rgba(245,158,11,.3);animation:needsSetupPulse 2s infinite}
@keyframes needsSetupPulse{0%,100%{box-shadow:0 0 0 rgba(245,158,11,0)}50%{box-shadow:0 0 12px rgba(245,158,11,.3)}}
.bcp-stat-row{display:flex;gap:12px;margin:12px 0}
.bcp-stat{flex:1;background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:10px;text-align:center}
.bcp-stat .val{font-size:18px;font-weight:700;color:var(--text)}.bcp-stat .lbl{font-size:10px;color:var(--text3);margin-top:2px}
.bcp-cap-list{list-style:none;padding:0}.bcp-cap-list li{padding:4px 0;font-size:12px;color:var(--text2);display:flex;align-items:center;gap:6px}
.bcp-cap-list li::before{content:'•';color:var(--brand)}
.bcp-name-input{background:transparent;border:1px solid transparent;font-size:16px;font-weight:700;color:var(--text);padding:4px 8px;border-radius:6px;width:100%;transition:.15s}
.bcp-name-input:hover,.bcp-name-input:focus{border-color:var(--border);background:var(--bg)}
.bcp-role-input{background:transparent;border:1px solid transparent;font-size:12px;color:var(--text2);padding:3px 8px;border-radius:6px;width:100%;transition:.15s}
.bcp-role-input:hover,.bcp-role-input:focus{border-color:var(--border);background:var(--bg)}
.bcp-template-badge{display:inline-block;font-size:10px;font-weight:700;background:var(--purple);color:#fff;padding:2px 8px;border-radius:10px;margin-left:8px}
/* Status toggle */
.bcp-status-toggle{display:flex;gap:0;border:1px solid var(--border);border-radius:8px;overflow:hidden;margin:8px 0}
.bcp-status-opt{padding:6px 14px;font-size:11px;font-weight:600;cursor:pointer;transition:.15s;color:var(--text3);text-align:center;flex:1}
.bcp-status-opt:hover{color:var(--text)}.bcp-status-opt.active-status{background:var(--green);color:#000}
.bcp-status-opt.paused-status{background:var(--orange);color:#000}.bcp-status-opt.draft-status{background:var(--bg3);color:var(--text)}
/* Personality */
.bcp-personality-ta{width:100%;min-height:100px;background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:10px;font-size:12px;color:var(--text);resize:vertical;line-height:1.5}
.bcp-tone-slider{display:flex;align-items:center;gap:10px;margin:10px 0}
.bcp-tone-slider .tone-label{font-size:11px;color:var(--text3);width:70px;text-align:right;flex-shrink:0}
.bcp-tone-slider .tone-label-r{font-size:11px;color:var(--text3);width:70px;flex-shrink:0}
.bcp-tone-slider input[type=range]{flex:1;-webkit-appearance:none;height:6px;border-radius:3px;outline:none;cursor:pointer}
.bcp-tone-slider input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:16px;height:16px;border-radius:50%;background:#fff;border:2px solid var(--brand);cursor:pointer;box-shadow:0 1px 4px rgba(0,0,0,.3)}
.tone-formal input[type=range]{background:linear-gradient(90deg,var(--blue),var(--green))}
.tone-detail input[type=range]{background:linear-gradient(90deg,var(--orange),var(--purple))}
.tone-auton input[type=range]{background:linear-gradient(90deg,var(--teal),var(--red))}
.bcp-chips{display:flex;flex-wrap:wrap;gap:6px;margin:8px 0}
.bcp-chip{padding:5px 12px;border-radius:20px;font-size:11px;font-weight:600;border:1px solid var(--border);color:var(--text3);cursor:pointer;transition:.15s;user-select:none}
.bcp-chip.on{background:var(--brand);color:#fff;border-color:var(--brand)}
.bcp-preview{background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:12px;font-size:12px;color:var(--text2);font-style:italic;margin-top:10px;min-height:40px}
/* Skills cards */
.bcp-skill-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
.bcp-skill-card{background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:10px;display:flex;flex-direction:column;gap:4px}
.bcp-skill-card .sk-top{display:flex;justify-content:space-between;align-items:center}
.bcp-skill-card .sk-icon{font-size:20px}.bcp-skill-card .sk-name{font-size:11px;font-weight:600}
.bcp-skill-card .sk-status{font-size:10px}
/* iOS toggle */
.ios-toggle{width:40px;height:22px;border-radius:11px;background:var(--bg3);position:relative;cursor:pointer;transition:.2s;flex-shrink:0}
.ios-toggle.on{background:var(--green)}.ios-toggle::after{content:'';position:absolute;top:2px;left:2px;width:18px;height:18px;border-radius:50%;background:#fff;transition:.2s}.ios-toggle.on::after{left:20px}
/* Connection cards */
.bcp-conn-card{display:flex;align-items:center;justify-content:space-between;padding:12px;background:var(--bg);border:1px solid var(--border);border-radius:10px;margin-bottom:8px;transition:.2s}
.bcp-conn-card.connected{border-color:var(--green)}
.bcp-conn-card .cc-left{display:flex;align-items:center;gap:10px}
.bcp-conn-card .cc-icon{font-size:22px}.bcp-conn-card .cc-name{font-size:12px;font-weight:600}.bcp-conn-card .cc-desc{font-size:10px;color:var(--text3)}
.bcp-conn-btn{padding:5px 12px;border-radius:6px;font-size:11px;font-weight:600;background:var(--brand);color:#fff;cursor:pointer;transition:.15s}.bcp-conn-btn:hover{filter:brightness(.85)}
.bcp-conn-status{font-size:11px;color:var(--green);font-weight:600}
/* Guardrails */
.bcp-guard{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:var(--bg);border:1px solid var(--border);border-radius:8px;margin-bottom:6px}
.bcp-guard .g-label{font-size:12px;font-weight:500}
.bcp-guard .g-sub{font-size:10px;color:var(--text3)}
.bcp-spend-input{width:80px;padding:4px 8px;font-size:12px;border-radius:6px;background:var(--bg2);border:1px solid var(--border);color:var(--text);margin-left:8px}
.bcp-confidence{margin:12px 0}
.bcp-confidence .conf-val{font-size:24px;font-weight:700;color:var(--brand);text-align:center}
.bcp-confidence input[type=range]{width:100%;-webkit-appearance:none;height:8px;border-radius:4px;background:linear-gradient(90deg,var(--red),var(--orange),var(--green));outline:none}
.bcp-confidence input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:20px;height:20px;border-radius:50%;background:#fff;border:2px solid var(--brand);cursor:pointer}
/* API Connect Modal */
.api-connect-modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.6);backdrop-filter:blur(4px);z-index:400;display:none;align-items:center;justify-content:center}
.api-connect-modal.show{display:flex}
.acm-card{background:var(--bg2);border:1px solid var(--border);border-radius:16px;padding:28px;width:420px;max-width:90vw;max-height:80vh;overflow-y:auto}
.acm-icon{font-size:40px;text-align:center;margin-bottom:8px}
.acm-title{font-size:18px;font-weight:700;text-align:center;margin-bottom:4px}
.acm-desc{font-size:13px;color:var(--text2);text-align:center;margin-bottom:20px}
.acm-step{margin-bottom:16px}
.acm-step-num{font-size:10px;font-weight:700;color:var(--brand);text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px}
.acm-input{width:100%;padding:10px 14px;font-size:13px;border-radius:8px;background:var(--bg);border:1px solid var(--border);color:var(--text)}
.acm-help-toggle{font-size:11px;color:var(--brand);cursor:pointer;margin-top:6px;display:inline-block}.acm-help-toggle:hover{text-decoration:underline}
.acm-help-content{display:none;background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:10px;margin-top:8px;font-size:11px;color:var(--text2)}
.acm-help-content.show{display:block}
.acm-oauth-btn{display:block;width:100%;padding:12px;border-radius:8px;font-size:14px;font-weight:700;background:var(--brand);color:#fff;text-align:center;cursor:pointer;transition:.15s}.acm-oauth-btn:hover{filter:brightness(.85)}
.acm-test-btn{display:block;width:100%;padding:10px;border-radius:8px;font-size:13px;font-weight:600;background:var(--bg3);color:var(--text);text-align:center;cursor:pointer;margin-top:12px;transition:.15s}.acm-test-btn:hover{background:var(--border)}
.acm-result{text-align:center;margin-top:12px;font-size:13px;font-weight:600;min-height:20px}
.acm-result.success{color:var(--green)}.acm-result.error{color:var(--red)}
.acm-wiring{background:rgba(16,185,129,.1);border:1px solid rgba(16,185,129,.3);border-radius:8px;padding:10px;font-size:12px;color:var(--green);text-align:center;margin-top:12px;display:none}
.acm-actions{display:flex;justify-content:flex-end;gap:8px;margin-top:16px}
/* Setup Checklist */
.setup-checklist{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:var(--bg2);border:1px solid var(--border);border-radius:16px;padding:28px;width:460px;max-width:90vw;z-index:350;display:none;box-shadow:0 20px 60px rgba(0,0,0,.5)}
.setup-checklist.show{display:block}
.scl-banner{font-size:20px;font-weight:700;text-align:center;margin-bottom:16px}
.scl-progress{height:6px;background:var(--bg3);border-radius:3px;margin-bottom:4px;overflow:hidden}
.scl-progress-fill{height:100%;background:var(--green);border-radius:3px;transition:width .5s ease}
.scl-progress-label{font-size:11px;color:var(--text3);text-align:center;margin-bottom:16px}
.scl-item{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:8px;cursor:pointer;transition:.15s;margin-bottom:4px}
.scl-item:hover{background:rgba(255,255,255,.05)}
.scl-item .scl-icon{font-size:16px;width:24px;text-align:center;flex-shrink:0}
.scl-item .scl-text{font-size:13px;font-weight:500;flex:1}.scl-item .scl-text.done{color:var(--green)}.scl-item .scl-text.pending{color:var(--orange)}
.scl-done-msg{text-align:center;font-size:16px;font-weight:700;color:var(--green);margin-top:16px;display:none}
.scl-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.4);z-index:349;display:none}
.scl-overlay.show{display:block}
/* Workflow popover */
.wf-popover{position:absolute;background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:14px;width:280px;z-index:50;box-shadow:0 8px 24px rgba(0,0,0,.4);display:none}
.wf-popover.show{display:block}
.wf-popover::before{content:'';position:absolute;top:-6px;left:50%;transform:translateX(-50%) rotate(45deg);width:12px;height:12px;background:var(--bg2);border-left:1px solid var(--border);border-top:1px solid var(--border)}
.wf-popover h4{font-size:13px;font-weight:700;margin-bottom:8px;display:flex;align-items:center;gap:6px}
.wfp-row{display:flex;justify-content:space-between;align-items:center;font-size:11px;color:var(--text2);margin-bottom:6px}
.wfp-row .wfp-label{font-weight:600;color:var(--text3)}
.wfp-link{font-size:11px;color:var(--brand);cursor:pointer;text-align:center;margin-top:8px}.wfp-link:hover{text-decoration:underline}
/* Configure tab */
.cfg-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px;margin-bottom:24px}
.cfg-bot-card{background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:14px;cursor:pointer;transition:.15s}
.cfg-bot-card:hover{border-color:var(--brand);transform:translateY(-2px)}
.cfg-bot-card .cfg-icon{font-size:24px;margin-bottom:6px}
.cfg-bot-card .cfg-name{font-size:13px;font-weight:600}
.cfg-bot-card .cfg-team{font-size:10px;color:var(--text3)}
.cfg-bot-card .cfg-badge{margin-top:8px}
.cfg-filters{display:flex;gap:8px;margin-bottom:16px}
.cfg-filter{padding:5px 14px;border-radius:20px;font-size:11px;font-weight:600;border:1px solid var(--border);color:var(--text3);cursor:pointer;transition:.15s}
.cfg-filter.active{background:var(--brand);color:#fff;border-color:var(--brand)}
.cfg-int-section{margin-top:24px}
.cfg-int-section h3{font-size:14px;font-weight:700;margin-bottom:12px;display:flex;align-items:center;gap:8px}
.cfg-int-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:10px}
.cfg-int-card{display:flex;align-items:center;gap:10px;padding:12px;background:var(--bg2);border:1px solid var(--border);border-radius:10px;transition:.15s;cursor:pointer}
.cfg-int-card:hover{border-color:var(--brand)}
.cfg-int-card.connected{border-color:var(--green)}
.cfg-int-card .ci-icon{font-size:22px}
.cfg-int-card .ci-info{flex:1}.cfg-int-card .ci-name{font-size:12px;font-weight:600}.cfg-int-card .ci-status{font-size:10px}
/* Millie Copilot */
.millie-fab{position:fixed;bottom:24px;right:24px;width:52px;height:52px;border-radius:50%;background:linear-gradient(135deg,var(--brand),var(--purple));color:#fff;font-size:22px;display:flex;align-items:center;justify-content:center;cursor:pointer;z-index:310;box-shadow:0 4px 16px rgba(59,130,246,.4);transition:.2s;border:none}
.millie-fab:hover{transform:scale(1.1);box-shadow:0 6px 24px rgba(59,130,246,.6)}
.millie-copilot{position:fixed;top:0;right:-380px;width:360px;height:100vh;background:rgba(30,41,59,.94);backdrop-filter:blur(20px);border-left:1px solid var(--border);z-index:320;transition:right .3s ease;display:flex;flex-direction:column}
.millie-copilot.open{right:0}
.mc-header{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--border)}
.mc-header h3{font-size:14px;font-weight:700;display:flex;align-items:center;gap:8px}
.mc-ctx{padding:6px 16px;font-size:10px;color:var(--text3);background:rgba(0,0,0,.2);display:flex;align-items:center;gap:4px}
.mc-messages{flex:1;overflow-y:auto;padding:12px 16px;display:flex;flex-direction:column;gap:8px}
.mc-msg{max-width:85%;padding:8px 12px;border-radius:12px;font-size:12px;line-height:1.5;word-wrap:break-word}
.mc-msg.user{align-self:flex-end;background:var(--brand);color:#fff;border-bottom-right-radius:4px}
.mc-msg.millie{align-self:flex-start;background:var(--bg);border:1px solid var(--border);color:var(--text);border-bottom-left-radius:4px}
.mc-msg.millie .mc-avatar{display:inline;margin-right:4px}
.mc-msg.action{align-self:center;background:rgba(16,185,129,.1);color:var(--green);font-size:11px;border-radius:8px;text-align:center}
.mc-typing{align-self:flex-start;padding:8px 14px;font-size:12px;color:var(--text3)}
.mc-typing span{animation:chatTyping 1.4s infinite both}
.mc-typing span:nth-child(2){animation-delay:.2s}.mc-typing span:nth-child(3){animation-delay:.4s}
.mc-quick{display:flex;flex-wrap:wrap;gap:6px;padding:8px 16px;border-top:1px solid rgba(71,85,105,.3)}
.mc-quick-btn{padding:5px 10px;border-radius:14px;font-size:10px;font-weight:600;background:var(--bg);border:1px solid var(--border);color:var(--text2);cursor:pointer;transition:.15s;white-space:nowrap}
.mc-quick-btn:hover{border-color:var(--brand);color:var(--brand)}
.mc-input-area{display:flex;gap:6px;padding:10px 16px;border-top:1px solid var(--border)}
.mc-input-area input{flex:1;padding:8px 12px;border-radius:8px;background:var(--bg);border:1px solid var(--border);color:var(--text);font-size:12px}
.mc-input-area button{padding:8px 14px;border-radius:8px;background:var(--brand);color:#fff;font-size:12px;font-weight:600;cursor:pointer;border:none}

/* Responsive additions */
@media(max-width:1200px){.sub-grid{grid-template-columns:repeat(2,1fr)}.stat-grid{grid-template-columns:repeat(2,1fr)}.token-cost-grid{grid-template-columns:repeat(2,1fr)}.wl-grid{grid-template-columns:1fr}.wf-sidebar{width:240px}}
@media(max-width:768px){.sub-grid{grid-template-columns:1fr}.stat-grid{grid-template-columns:1fr}.token-cost-grid{grid-template-columns:1fr}.mp-grid{grid-template-columns:1fr}.wf-container{flex-direction:column}.wf-sidebar{width:100%;max-height:200px}.chat-panel{width:calc(100vw - 32px);right:16px;bottom:80px}.bot-config-panel{width:100vw;right:-100vw}.millie-copilot{width:100vw;right:-100vw}.cfg-grid{grid-template-columns:1fr}.cfg-int-grid{grid-template-columns:1fr}}

/* ======================== PHASE 6: SECURITY, GUARDRAILS & VALIDATION ======================== */

/* Vault indicator */
.vault-icon{display:inline-flex;align-items:center;font-size:11px;color:var(--text3);cursor:help;margin-left:4px;position:relative}
.vault-icon:hover::after{content:'Credentials encrypted at rest (AES-256)';position:absolute;bottom:calc(100% + 6px);left:50%;transform:translateX(-50%);background:var(--bg2);border:1px solid var(--border);border-radius:6px;padding:6px 10px;font-size:10px;white-space:nowrap;color:var(--text);z-index:50;pointer-events:none}

/* Connection status badges */
.conn-status-badge{display:inline-flex;align-items:center;gap:5px;padding:4px 10px;border-radius:12px;font-size:11px;font-weight:600;cursor:pointer;transition:all .15s;border:1px solid transparent}
.conn-status-badge:hover{filter:brightness(1.1)}
.conn-status-badge.csb-connected{background:rgba(16,185,129,.12);color:var(--green);border-color:rgba(16,185,129,.25)}
.conn-status-badge.csb-attention{background:rgba(245,158,11,.12);color:var(--orange);border-color:rgba(245,158,11,.25)}
.conn-status-badge.csb-failed{background:rgba(239,68,68,.12);color:var(--red);border-color:rgba(239,68,68,.25)}
.conn-status-badge.csb-none{background:rgba(100,116,139,.12);color:var(--text3);border-color:rgba(100,116,139,.25)}

/* Connection detail popover */
.conn-detail-pop{position:fixed;background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:16px;width:280px;z-index:400;box-shadow:0 12px 40px rgba(0,0,0,.5);display:none}
.conn-detail-pop.show{display:block}
.conn-detail-pop h4{font-size:13px;font-weight:700;margin-bottom:10px;display:flex;align-items:center;gap:6px}
.cdp-row{display:flex;justify-content:space-between;font-size:11px;color:var(--text2);margin-bottom:6px}
.cdp-row .cdp-label{color:var(--text3);font-weight:600}
.cdp-actions{display:flex;gap:6px;margin-top:12px}

/* Rotation reminder banner */
.rotation-banner{background:rgba(245,158,11,.08);border:1px solid rgba(245,158,11,.2);border-radius:8px;padding:10px 14px;display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:12px;font-size:12px;color:var(--orange)}
.rotation-banner .rb-text{flex:1}.rotation-banner button{flex-shrink:0}

/* Audit log */
.audit-table{width:100%;border-collapse:collapse;font-size:12px;margin-top:12px}
.audit-table th{text-align:left;padding:8px 10px;font-size:10px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:.5px;border-bottom:2px solid var(--border)}
.audit-table td{padding:8px 10px;border-bottom:1px solid rgba(71,85,105,.3);color:var(--text2)}
.audit-table tr:hover td{background:rgba(59,130,246,.03)}
.audit-filters{display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap}
.audit-filters select{background:var(--bg);border:1px solid var(--border);border-radius:6px;padding:5px 8px;font-size:11px;color:var(--text2)}

/* Completeness score ring */
.completeness-ring{position:relative;width:36px;height:36px;flex-shrink:0;cursor:pointer}
.completeness-ring svg{width:36px;height:36px;transform:rotate(-90deg)}
.completeness-ring .cr-text{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:9px;font-weight:800}

/* Workflow lint badge */
.wf-lint-badge{position:absolute;top:-6px;left:-6px;width:18px;height:18px;border-radius:50%;background:var(--orange);color:#000;font-size:10px;display:flex;align-items:center;justify-content:center;z-index:8;cursor:pointer;font-weight:700}
.wf-lint-badge:hover::after{content:attr(data-tip);position:absolute;bottom:calc(100%+4px);left:50%;transform:translateX(-50%);background:var(--bg2);border:1px solid var(--border);border-radius:6px;padding:5px 8px;font-size:10px;white-space:nowrap;color:var(--orange);z-index:50}
.wf-lint-bar{background:rgba(245,158,11,.08);border:1px solid rgba(245,158,11,.2);border-radius:8px;padding:8px 14px;font-size:12px;color:var(--orange);display:flex;align-items:center;gap:8px;margin-bottom:12px}

/* Pre-deploy checklist modal */
.predeploy-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.6);z-index:400;display:none;align-items:center;justify-content:center}
.predeploy-overlay.show{display:flex}
.predeploy-modal{background:var(--bg2);border:1px solid var(--border);border-radius:14px;padding:24px;width:460px;max-width:90vw;max-height:80vh;overflow-y:auto}
.predeploy-modal h3{font-size:16px;font-weight:700;margin-bottom:16px}
.pd-item{display:flex;align-items:center;gap:10px;padding:8px 10px;border-radius:6px;margin-bottom:4px;font-size:13px}
.pd-item.pass{color:var(--green)}.pd-item.warn{color:var(--orange)}.pd-item.fail{color:var(--red)}
.pd-item .pd-icon{font-size:16px;width:24px;text-align:center}
.pd-item .pd-label{flex:1}
.pd-item .pd-tag{font-size:9px;font-weight:700;padding:1px 6px;border-radius:3px}
.pd-item .pd-tag.required{background:rgba(239,68,68,.2);color:var(--red)}
.pd-item .pd-tag.recommended{background:rgba(245,158,11,.2);color:var(--orange)}
.pd-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:16px}
.pd-actions .btn.disabled{opacity:.4;pointer-events:none}

/* Best practice nudge */
.bp-nudge{background:rgba(59,130,246,.06);border:1px solid rgba(59,130,246,.2);border-radius:8px;padding:10px 14px;font-size:12px;color:var(--blue);display:flex;align-items:center;gap:10px;margin-bottom:12px;transition:opacity .3s}
.bp-nudge .bp-text{flex:1}.bp-nudge .bp-dismiss{font-size:11px;color:var(--text3);cursor:pointer;white-space:nowrap}.bp-nudge .bp-dismiss:hover{color:var(--text)}

/* Setup wizard progress */
.setup-wizard-bar{background:rgba(59,130,246,.06);border:1px solid rgba(59,130,246,.15);border-radius:10px;padding:12px 16px;margin-bottom:16px;cursor:pointer;transition:all .2s}
.setup-wizard-bar:hover{border-color:rgba(59,130,246,.3)}
.swb-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
.swb-title{font-size:13px;font-weight:600;color:var(--text)}
.swb-pct{font-size:12px;font-weight:700;color:var(--brand)}
.swb-track{height:6px;background:var(--bg3);border-radius:3px;overflow:hidden}
.swb-fill{height:100%;background:var(--brand);border-radius:3px;transition:width .5s}
.swb-details{display:none;margin-top:12px}
.swb-details.show{display:block}
.swb-detail-item{display:flex;align-items:center;gap:8px;padding:6px 0;font-size:12px;color:var(--text2);cursor:pointer}
.swb-detail-item:hover{color:var(--brand)}

/* Encrypt animation */
.encrypt-anim{display:flex;flex-direction:column;align-items:center;gap:12px;padding:24px}
.encrypt-spinner{width:48px;height:48px;border:3px solid var(--bg3);border-top-color:var(--brand);border-radius:50%;animation:encSpin .8s linear infinite}
@keyframes encSpin{to{transform:rotate(360deg)}}
.encrypt-msg{font-size:14px;font-weight:600;color:var(--text)}
.encrypt-success{color:var(--green);font-size:16px;font-weight:700;display:flex;align-items:center;gap:8px}

/* Settings Phase 6 sections */
.s6-section{margin-bottom:32px}
.s6-section>h2{font-size:16px;font-weight:700;margin-bottom:14px;display:flex;align-items:center;gap:8px}
.s6-org-card{background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:18px;display:flex;align-items:center;gap:16px}
.s6-org-card .org-logo-area{width:64px;height:64px;border-radius:10px;background:var(--bg3);display:flex;align-items:center;justify-content:center;font-size:28px;cursor:pointer;border:2px dashed var(--border);transition:.15s}
.s6-org-card .org-logo-area:hover{border-color:var(--brand)}
.s6-org-fields{flex:1;display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
.s6-security-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.s6-security-card{background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:16px}
.s6-security-card h4{font-size:12px;font-weight:700;color:var(--text2);margin-bottom:8px}
.s6-user-table{width:100%;border-collapse:collapse;font-size:12px}
.s6-user-table th{text-align:left;padding:8px 10px;font-size:10px;font-weight:700;color:var(--text3);text-transform:uppercase;border-bottom:2px solid var(--border)}
.s6-user-table td{padding:8px 10px;border-bottom:1px solid rgba(71,85,105,.3);color:var(--text2)}
.s6-user-table tr:hover td{background:rgba(59,130,246,.03)}
.s6-role-badge{padding:2px 8px;border-radius:4px;font-size:10px;font-weight:700}
.s6-role-badge.admin{background:rgba(139,92,246,.2);color:#c4b5fd}
.s6-role-badge.manager{background:rgba(59,130,246,.2);color:#93c5fd}
.s6-role-badge.viewer{background:rgba(100,116,139,.2);color:#94a3b8}
.s6-notif-row{display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid rgba(71,85,105,.2);font-size:13px}
.s6-notif-row:last-child{border-bottom:none}

@media(max-width:768px){.s6-org-fields{grid-template-columns:1fr}.s6-security-grid{grid-template-columns:1fr}}
</style>
</head>
<body>

<!-- Library Toggle -->
<button class="library-toggle" id="libraryToggle" onclick="toggleLibrary()">📚 Library</button>

<!-- Library Drawer -->
<div class="library-drawer" id="libraryDrawer">
  <div class="library-header">
    <h2>📚 Component Library</h2>
    <input class="library-search" id="librarySearch" placeholder="Search industries, teams, bots, skills..." oninput="filterLibrary()">
  </div>
  <div class="library-tabs">
    <div class="library-tab active" data-lib-tab="industries" onclick="switchLibTab('industries')">🏢 Industries</div>
    <div class="library-tab" data-lib-tab="teams" onclick="switchLibTab('teams')">👥 Teams</div>
    <div class="library-tab" data-lib-tab="bots" onclick="switchLibTab('bots')">🤖 Bots</div>
    <div class="library-tab" data-lib-tab="skills" onclick="switchLibTab('skills')">⚡ Skills</div>
    <div class="library-tab" data-lib-tab="infra" onclick="switchLibTab('infra')">🔌 Infra</div>
  </div>
  <div class="library-content" id="libraryContent"></div>
</div>

<div class="header" id="headerBar">
  <div class="header-left">
    <img class="header-logo" id="brandLogo" src="" alt="Logo">
    <h1><span class="diamond" id="headerDiamond"></span> Agent Orchestrator — <span id="companyName">RISE RE</span></h1>
    <div class="org-selector" id="orgSelector" style="display:none">
      <select id="orgSelect" onchange="switchOrganization(this.value)"></select>
      <button class="btn btn-sm btn-outline" onclick="showAddOrgModal()">+ Org</button>
    </div>
  </div>
  <div class="header-actions">
    <button class="btn btn-primary" onclick="showAddModal()">+ Add New</button>
    <button class="btn btn-outline" onclick="reorganizeTeams()">⟳ Reorganize</button>
    <button class="btn btn-outline" onclick="resetToDefaults()">Reset</button>
    <div class="legend-wrapper">
      <span class="legend-toggle" onclick="toggleLegend()" id="legendToggle">◈ Legend ▾</span>
      <div class="legend-dropdown" id="legendDropdown"></div>
    </div>
    <div style="position:relative">
      <button class="btn btn-outline" onclick="toggleExportMenu()">📤 Export</button>
      <div class="export-menu" id="exportMenu">
        <button onclick="exportAsImage()">🖼️ Export as PNG</button>
        <button onclick="exportAsPdf()">📄 Export as PDF</button>
        <button onclick="exportAsJson()">💾 Export as JSON</button>
        <hr style="border-color:var(--border);margin:4px 0">
        <button onclick="importJson()">📥 Import JSON</button>
      </div>
    </div>
    <button class="btn btn-outline" onclick="showBranding()" title="Settings">⚙️</button>
  </div>
</div>

<!-- Testing Mode Banner -->
<div class="testing-banner" id="testingBanner" style="display:none">🔓 All features unlocked (testing mode)</div>

<!-- Nav Tabs -->
<div class="nav-tabs" id="navTabs">
  <div class="nav-tab active" data-tab="home" onclick="switchTab('home')">🏠 Home</div>
  <div class="nav-tab" data-tab="canvas" onclick="switchTab('canvas')">🎯 Canvas</div>
  <div class="nav-tab" data-tab="analytics" onclick="switchTab('analytics')">📊 Analytics</div>
  <div class="nav-tab" data-tab="marketplace" onclick="switchTab('marketplace')">🏪 Marketplace</div>
  <div class="nav-tab" data-tab="workflows" onclick="switchTab('workflows')">🔀 Workflows</div>
  <div class="nav-tab" data-tab="mcphub" onclick="switchTab('mcphub')">🔗 MCP Hub</div>
  <div class="nav-tab" data-tab="skillswriter" onclick="switchTab('skillswriter')">✍️ Skills Writer</div>
  <div class="nav-tab" data-tab="configure" onclick="switchTab('configure')">🔧 Configure</div>
  <div class="nav-tab" data-tab="settings" onclick="switchTab('settings')">⚙️ Settings</div>
</div>

<!-- Canvas Tab -->
<div class="tab-content active" id="tab-home">
<div class="dashboard-container">
  <!-- Status Cards Row -->
  <div class="dash-status-row">
    <div class="dash-card dash-card-anim" onclick="switchTab('canvas')" style="--anim-i:0">
      <div class="dash-card-number">12</div>
      <div class="dash-card-label">agents running</div>
      <div class="dash-card-mini">🟢 10 healthy &nbsp; 🟡 1 warning &nbsp; 🔴 1 error</div>
    </div>
    <div class="dash-card dash-card-anim" onclick="switchTab('workflows')" style="--anim-i:1">
      <div class="dash-card-number">8</div>
      <div class="dash-card-label">workflows active</div>
      <div class="dash-card-mini">3 paused, 2 completed today</div>
    </div>
    <div class="dash-card dash-card-anim dash-card-amber" onclick="switchTab('configure')" style="--anim-i:2">
      <div class="dash-card-number">6</div>
      <div class="dash-card-label">connected</div>
      <div class="dash-card-mini">⚠ 2 need attention</div>
    </div>
    <div class="dash-card dash-card-anim" style="--anim-i:3">
      <div class="dash-card-number">1,247</div>
      <div class="dash-card-label">handled today</div>
      <div class="dash-card-mini"><span class="dash-sparkline" id="msgSparkline"></span> <span style="color:var(--green)">▲ 12%</span> vs yesterday</div>
    </div>
  </div>

  <!-- Middle Section -->
  <div class="dash-middle">
    <!-- Activity Feed -->
    <div class="dash-feed dash-card-anim" style="--anim-i:4">
      <div class="dash-feed-header">
        <h3>📡 Activity Feed</h3>
        <div class="dash-feed-filters">
          <select id="dashAgentFilter" onchange="filterDashFeed()">
            <option>All Agents</option>
            <option>🏢 Leasing Agent</option>
            <option>🔧 Maintenance Coordinator</option>
            <option>💰 Rent Collection</option>
            <option>📋 Compliance Monitor</option>
            <option>👋 Resident Comms</option>
            <option>📧 Email Responder</option>
          </select>
          <select id="dashTimeFilter" onchange="filterDashFeed()">
            <option>Today</option>
            <option>7 Days</option>
            <option>30 Days</option>
          </select>
        </div>
      </div>
      <div class="dash-feed-list" id="dashFeedList"></div>
      <div class="dash-feed-fade"></div>
    </div>

    <!-- Right Column -->
    <div class="dash-right">
      <!-- Quick Actions -->
      <div class="dash-actions dash-card-anim" style="--anim-i:5">
        <h3>⚡ Quick Actions</h3>
        <div class="dash-actions-grid">
          <div class="dash-action-card" onclick="switchTab('marketplace')">
            <div class="dash-action-icon">🚀</div>
            <div class="dash-action-title">Deploy Template</div>
            <div class="dash-action-desc">Launch from marketplace</div>
          </div>
          <div class="dash-action-card" onclick="switchTab('configure')">
            <div class="dash-action-icon">🤖</div>
            <div class="dash-action-title">Configure Bots</div>
            <div class="dash-action-desc">Setup & connections</div>
          </div>
          <div class="dash-action-card" onclick="switchTab('analytics')">
            <div class="dash-action-icon">📊</div>
            <div class="dash-action-title">View Analytics</div>
            <div class="dash-action-desc">Performance & usage</div>
          </div>
          <div class="dash-action-card" onclick="switchTab('workflows')">
            <div class="dash-action-icon">⚡</div>
            <div class="dash-action-title">Build Workflow</div>
            <div class="dash-action-desc">Automate processes</div>
          </div>
        </div>
      </div>

      <!-- Alerts -->
      <div class="dash-alerts dash-card-anim" style="--anim-i:6">
        <h3>⚠️ Needs Attention <span class="dash-alert-badge">4</span></h3>
        <div class="dash-alert-list">
          <div class="dash-alert dash-alert-red">
            <div class="dash-alert-text">🔴 <strong>Invoice Bot</strong> — Microsoft 365 connection failed 2h ago</div>
            <button class="btn btn-sm btn-danger" onclick="switchTab('configure')">Fix Now</button>
          </div>
          <div class="dash-alert dash-alert-amber">
            <div class="dash-alert-text">🟡 <strong>Leasing Agent</strong> — Setup only 60% complete</div>
            <button class="btn btn-sm btn-outline" onclick="switchTab('configure')">Complete Setup</button>
          </div>
          <div class="dash-alert dash-alert-amber">
            <div class="dash-alert-text">🟡 API key for <strong>Stripe</strong> expires in 3 days</div>
            <button class="btn btn-sm btn-outline" onclick="switchTab('configure')">Rotate Now</button>
          </div>
          <div class="dash-alert dash-alert-red">
            <div class="dash-alert-text">🔴 <strong>Daily Report</strong> workflow failed at 6:00 AM</div>
            <button class="btn btn-sm btn-danger" onclick="switchTab('workflows')">View Error</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Performance Row -->
  <div class="dash-perf-row">
    <div class="dash-perf-card dash-card-anim" style="--anim-i:7">
      <div class="dash-perf-label">Agent Response Time</div>
      <div class="dash-perf-value">Avg 1.2s</div>
      <svg class="dash-sparkline-svg" id="perfSparkline1" viewBox="0 0 120 40"></svg>
    </div>
    <div class="dash-perf-card dash-card-anim" style="--anim-i:8">
      <div class="dash-perf-label">First-Contact Resolution</div>
      <div class="dash-perf-value">94%</div>
      <svg class="dash-progress-ring" viewBox="0 0 80 80">
        <circle cx="40" cy="40" r="34" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="6"/>
        <circle cx="40" cy="40" r="34" fill="none" stroke="var(--green)" stroke-width="6" stroke-dasharray="213.6 213.6" stroke-dashoffset="12.8" stroke-linecap="round" transform="rotate(-90 40 40)"/>
      </svg>
    </div>
    <div class="dash-perf-card dash-card-anim" style="--anim-i:9">
      <div class="dash-perf-label">Based on 128 ratings</div>
      <div class="dash-perf-value">4.7/5</div>
      <div class="dash-stars">★★★★★</div>
    </div>
  </div>
</div>
</div>

<div class="tab-content" id="tab-canvas">
<div class="main" id="mainContent">
  <div class="exec-row" id="execRow"></div>
  <div style="text-align:center;margin-bottom:4px">
    <div style="width:2px;height:20px;background:var(--text3);margin:0 auto"></div>
  </div>
  <div style="text-align:center;font-size:11px;color:var(--text3);margin-bottom:6px;font-weight:600;text-transform:uppercase;letter-spacing:1px">Shared Services</div>
  <div class="shared-bar" id="sharedBar"></div>
  <div style="text-align:center;margin:8px 0">
    <svg width="100%" height="40" id="linesSvg"></svg>
  </div>
  <div class="teams-grid" id="teamsGrid"></div>
  <div class="infra-section">
    <h3>🔌 Infrastructure & Integrations</h3>
    <div class="infra-grid">
      <div class="infra-col approved" id="infraApproved" ondragover="infraDragOver(event,'approved')" ondragleave="infraDragLeave(event)" ondrop="infraDrop(event,'approved')">
        <h4><span class="dot"></span> Approved & Managed</h4>
        <div class="infra-items" id="approvedItems"></div>
      </div>
      <div class="infra-col review" id="infraReview" ondragover="infraDragOver(event,'review')" ondragleave="infraDragLeave(event)" ondrop="infraDrop(event,'underReview')">
        <h4><span class="dot"></span> Under Review</h4>
        <div class="infra-items" id="reviewItems"></div>
      </div>
    </div>
  </div>
</div>
</div>

<!-- MCP Hub Tab -->
<div class="tab-content" id="tab-mcphub">
  <div class="mcp-hub">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:8px">
      <h2 style="font-size:20px;font-weight:700">🔗 MCP Hub — Connectors</h2>
      <div style="display:flex;gap:8px;align-items:center">
        <input id="mcpSearch" placeholder="Search connectors..." style="padding:6px 12px;border-radius:6px;width:200px" oninput="renderMcpHub()">
        <button class="btn btn-primary" onclick="addConnector()">+ Add Connector</button>
      </div>
    </div>
    <div class="mcp-grid" id="mcpGrid"></div>
  </div>
</div>

<!-- Skills Writer Tab -->
<div class="tab-content" id="tab-skillswriter">
  <div style="max-width:700px;margin:24px auto;padding:0 16px">
    <h2 style="font-size:20px;font-weight:700;margin-bottom:16px">✍️ Skills Writer</h2>
    <div class="sw-tabs">
      <div class="sw-tab active" onclick="switchSwTab('template')">📝 Template Mode</div>
      <div class="sw-tab" onclick="switchSwTab('ai')">🤖 AI Mode</div>
    </div>
    <div id="sw-template" class="sw-form">
      <div style="font-size:12px;color:var(--text2);background:rgba(59,130,246,0.08);border:1px solid rgba(59,130,246,0.2);border-radius:8px;padding:10px 14px;margin-bottom:14px">📝 Build a skill step-by-step using the GRACE framework</div>
      <div class="form-group"><label>Skill Name</label><input id="swName" placeholder="e.g. Lease Expiration Monitor"></div>
      <div class="form-group"><label>Category</label>
        <select id="swCategory">
          <option>Communication</option><option>Analysis</option><option>Automation</option><option>Compliance</option><option>Research</option><option>Custom/Advanced</option>
        </select>
      </div>
      <div class="grace-field"><label><span class="grace-letter">G</span> Goal — What is this skill trying to achieve?</label><input id="swGoal" placeholder="e.g. Monitor all lease expirations and ensure timely renewals" oninput="updateGracePreview()"></div>
      <div class="grace-field"><label><span class="grace-letter">R</span> Role — What role does the bot play?</label><input id="swRole" placeholder="e.g. Lease compliance monitor and renewal coordinator" oninput="updateGracePreview()"></div>
      <div class="grace-field"><label><span class="grace-letter">A</span> Actions <button class="expand-btn" onclick="openExpandModal('swActions','Actions')">↗ Expand</button></label><textarea id="swActions" rows="3" placeholder="1. Pull lease data from Entrata&#10;2. Identify leases expiring within 90 days&#10;3. Generate renewal recommendations" oninput="updateGracePreview()"></textarea></div>
      <div class="grace-field"><label><span class="grace-letter">C</span> Context <button class="expand-btn" onclick="openExpandModal('swContext','Context')">↗ Expand</button></label><textarea id="swContext" rows="2" placeholder="e.g. Access to Entrata lease data, market rent comparisons" oninput="updateGracePreview()"></textarea></div>
      <div class="grace-field"><label><span class="grace-letter">E</span> Examples <button class="expand-btn" onclick="openExpandModal('swExamples','Examples')">↗ Expand</button></label><textarea id="swExamples" rows="2" placeholder="e.g. Input: Lease #1234 expiring in 45 days → Output: Alert with renewal recommendation" oninput="updateGracePreview()"></textarea></div>
      <div class="form-group"><label>Preview</label><div class="sw-preview" id="swPreview">Fill in the GRACE fields above to preview your skill description.</div></div>
      <div class="form-actions">
        <button class="btn btn-outline" onclick="clearSkillWriter()">Clear</button>
        <button class="btn btn-green" onclick="saveSkillFromWriter()">💾 Save to Library</button>
      </div>
    </div>
    <div id="sw-ai" style="display:none">
      <div style="font-size:12px;color:var(--text2);background:rgba(139,92,246,0.08);border:1px solid rgba(139,92,246,0.2);border-radius:8px;padding:10px 14px;margin-bottom:14px">🤖 Describe what you need and AI will write the skill for you</div>
      <div class="form-group">
        <label>Describe the skill you need in plain language</label>
        <textarea id="swAiPrompt" rows="4" placeholder="I need a skill that monitors our lease expirations and alerts the team 90 days before renewal deadlines"></textarea>
        <div style="font-size:11px;color:var(--text3);margin-top:4px">💡 Example: "I need a skill that monitors our lease expirations and alerts the team 90 days before renewal deadlines"</div>
      </div>
      <div class="form-group">
        <label>API Provider</label>
        <select id="swAiProvider" onchange="toggleCustomEndpoint()">
          <option value="anthropic">Anthropic (Claude)</option>
          <option value="openai">OpenAI (GPT)</option>
          <option value="google">Google (Gemini)</option>
          <option value="mistral">Mistral</option>
          <option value="meta">Meta (Llama)</option>
          <option value="cohere">Cohere</option>
          <option value="xai">xAI (Grok)</option>
          <option value="custom">Custom</option>
        </select>
      </div>
      <div class="form-group" id="customEndpointGroup" style="display:none">
        <label>API Endpoint URL</label>
        <input id="swAiEndpoint" placeholder="https://your-api-endpoint.com/v1/chat/completions">
      </div>
      <div class="form-group">
        <label>API Key</label>
        <input id="swAiKey" type="password" placeholder="Enter your API key">
        <div style="font-size:11px;color:var(--text3);margin-top:4px">
          <strong>Get your API key:</strong>
          <a href="https://console.anthropic.com/settings/keys" target="_blank" style="color:var(--brand)">Anthropic</a> ·
          <a href="https://platform.openai.com/api-keys" target="_blank" style="color:var(--brand)">OpenAI</a> ·
          <a href="https://aistudio.google.com/apikey" target="_blank" style="color:var(--brand)">Google</a> ·
          <a href="https://console.mistral.ai/api-keys" target="_blank" style="color:var(--brand)">Mistral</a> ·
          <a href="https://dashboard.cohere.com/api-keys" target="_blank" style="color:var(--brand)">Cohere</a> ·
          <a href="https://console.x.ai" target="_blank" style="color:var(--brand)">xAI</a>
        </div>
      </div>
      <div class="form-actions">
        <button class="btn btn-primary" onclick="generateSkillAI()">🤖 Generate Skill</button>
      </div>
      <div id="swAiResult" style="margin-top:16px;display:none">
        <div class="form-group"><label>Generated Name</label><input id="swAiName"></div>
        <div class="form-group"><label>Category</label><input id="swAiCategory"></div>
        <div class="form-group"><label>Description <button class="expand-btn" onclick="openExpandModal('swAiDesc','Description')">↗ Expand</button></label><textarea id="swAiDesc" rows="3"></textarea></div>
        <div class="form-group"><label>Suggested Bots</label><input id="swAiBots" placeholder="Comma-separated"></div>
        <div class="form-actions">
          <button class="btn btn-green" onclick="saveAiSkill()">💾 Save to Library</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Analytics Tab -->
<div class="tab-content" id="tab-analytics">
  <div class="analytics-container">
    <div class="analytics-header">
      <h2>📊 Analytics Dashboard</h2>
      <div style="display:flex;gap:16px;align-items:center">
        <div class="analytics-toggle">
          <span>📊 Mock Data</span>
          <div class="toggle-switch on" id="analyticsDataToggle" onclick="toggleAnalyticsData()"></div>
        </div>
        <select id="analyticsTeamFilter" onchange="renderAnalytics()" style="background:var(--bg);border:1px solid var(--border);border-radius:6px;padding:6px 10px;font-size:12px;color:var(--text)">
          <option value="all">All Teams</option>
        </select>
      </div>
    </div>

    <!-- KPI Summary Row -->
    <div class="kpi-row" id="analyticsKpiRow"></div>

    <!-- Usage Analytics Section -->
    <div class="analytics-sub">📈 Usage Analytics</div>
    <div class="stat-grid" id="usageStatGrid"></div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:24px">
      <div style="background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:16px">
        <h4 style="font-size:13px;font-weight:700;margin-bottom:12px;color:var(--text2)">Top 10 Most-Used Bots</h4>
        <div class="bar-chart" id="botBarChart"></div>
      </div>
      <div style="background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:16px">
        <h4 style="font-size:13px;font-weight:700;margin-bottom:12px;color:var(--text2)">Adoption Metrics</h4>
        <div id="adoptionMetrics"></div>
      </div>
    </div>

    <div style="background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:16px;margin-bottom:24px">
      <h4 style="font-size:13px;font-weight:700;margin-bottom:12px;color:var(--text2)">Bot Activity</h4>
      <div style="overflow-x:auto"><table class="data-table" id="botActivityTable"></table></div>
    </div>

    <div class="analytics-sub">👥 Team Performance</div>
    <div class="team-perf-grid" id="teamPerfGrid"></div>

    <!-- Token Cost Analytics Section -->
    <div class="analytics-sub">💰 Token Cost Analytics</div>
    <div class="token-cost-grid" id="tokenStatGrid"></div>

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:24px">
      <div style="background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:16px">
        <h4 style="font-size:13px;font-weight:700;margin-bottom:12px;color:var(--text2)">Per-Team Cost Breakdown</h4>
        <div class="bar-chart" id="teamCostChart" style="height:180px"></div>
      </div>
      <div class="line-chart-container">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
          <h4 style="font-size:13px;font-weight:700;color:var(--text2);margin:0">Daily Costs (Last 30 Days)</h4>
          <div style="display:flex;gap:4px">
            <button class="btn btn-sm btn-outline" onclick="setTokenPeriod('week')">Week</button>
            <button class="btn btn-sm btn-primary" onclick="setTokenPeriod('month')">Month</button>
            <button class="btn btn-sm btn-outline" onclick="setTokenPeriod('quarter')">Quarter</button>
          </div>
        </div>
        <svg id="costLineChart" width="100%" height="160" style="display:block"></svg>
      </div>
    </div>

    <div style="background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:16px;margin-bottom:24px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
        <h4 style="font-size:13px;font-weight:700;color:var(--text2);margin:0">Per-Bot Cost Table</h4>
      </div>
      <div style="overflow-x:auto"><table class="data-table" id="tokenCostTable"></table></div>
    </div>

    <div style="background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:16px;margin-bottom:24px">
      <h4 style="font-size:13px;font-weight:700;margin-bottom:12px;color:var(--text2)">💸 Budget & Alerts</h4>
      <div id="budgetSection"></div>
    </div>
  </div>
</div>

<!-- Marketplace Tab -->
<div class="tab-content" id="tab-marketplace">
  <div class="mp-container">
    <div class="mp-header">
      <div>
        <h2>🏪 Skill Pack Marketplace</h2>
        <div style="font-size:12px;color:var(--text3);margin-top:4px">Deploy a fully configured agent team in under 60 seconds — no AI expertise required.</div>
      </div>
      <div class="mp-filters">
        <input id="mpSearch" placeholder="Search skill packs..." oninput="renderMarketplace()" style="width:200px">
        <select id="mpCategoryFilter" onchange="renderMarketplace()"><option value="all">All Categories</option><option value="Real Estate">🏢 Real Estate</option><option value="Technology">☁️ Technology</option><option value="Healthcare">🏥 Healthcare</option><option value="Professional Services">📋 Professional</option><option value="Education">🎓 Education</option><option value="Operations">🚛 Operations</option><option value="Hospitality">🏨 Hospitality</option><option value="Retail">🛒 Retail</option><option value="Non-Profit">🤝 Non-Profit</option><option value="Manufacturing">🏭 Manufacturing</option></select>
        <select id="mpPriceFilter" onchange="renderMarketplace()"><option value="all">All Prices</option><option value="free">Free</option><option value="paid">Pro</option></select>
        <select id="mpRatingFilter" onchange="renderMarketplace()"><option value="all">Any Rating</option><option value="4">4+ Stars</option><option value="3">3+ Stars</option></select>
        <button class="btn btn-primary" onclick="showPublishTemplateModal()">📤 Publish Skill Pack</button>
      </div>
    </div>
    <div class="mp-featured" id="mpFeatured"></div>
    <div class="mp-grid" id="mpGrid"></div>
  </div>
</div>

<!-- Workflows Tab -->
<div class="tab-content" id="tab-workflows">
  <div class="wf-container">
    <div class="wf-sidebar">
      <div class="wf-sidebar-header">
        <h3>🔀 Workflow Builder</h3>
        <input placeholder="Search bots..." oninput="filterWfBots(this.value)" style="width:100%;padding:6px 10px;border-radius:6px;background:var(--bg);border:1px solid var(--border);color:var(--text);font-size:12px">
      </div>
      <div class="wf-sidebar-content">
        <div class="wf-sidebar-section">
          <h4>Bots</h4>
          <div id="wfBotList"></div>
        </div>
        <div class="wf-sidebar-section">
          <h4 style="display:flex;justify-content:space-between;align-items:center">Special Nodes <button class="btn btn-sm btn-outline" onclick="addHumanNode()">+ Human Review</button></h4>
        </div>
        <div class="wf-sidebar-section">
          <h4>Templates</h4>
          <div id="wfTplList"></div>
        </div>
        <div class="wf-sidebar-section">
          <h4 style="display:flex;justify-content:space-between;align-items:center">Saved Workflows <button class="btn btn-sm btn-outline" onclick="showSaveWorkflowModal()">💾 Save</button></h4>
          <div id="wfSavedList"></div>
        </div>
      </div>
    </div>
    <div class="wf-main" id="wfMain">
      <div class="wf-toolbar">
        <button class="btn btn-sm" onclick="clearWorkflow()" title="Clear canvas">🗑️ Clear</button>
        <button class="btn btn-sm" onclick="autoLayoutWorkflow()" title="Auto-layout">📐 Layout</button>
        <button class="btn btn-sm" id="wfSimBtn" onclick="toggleSimulation()" title="Simulation">▶️ Simulate</button>
      </div>
      <svg id="wfSvg" style="position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:3"></svg>
      <div class="wf-canvas-area" id="wfCanvasArea" ondragover="wfCanvasDragOver(event)" ondrop="wfCanvasDrop(event)"></div>
      <div class="wf-sim-bar" id="wfSimBar" style="display:none">
        <span style="font-size:12px;font-weight:600">Simulation</span>
        <button class="btn btn-sm btn-primary" onclick="simStep()">⏭️ Step</button>
        <button class="btn btn-sm btn-green" onclick="simRun()">▶️ Run All</button>
        <button class="btn btn-sm btn-outline" onclick="simReset()">⟳ Reset</button>
        <span id="wfSimStatus" style="font-size:11px;color:var(--text3)">Ready</span>
      </div>
    </div>
  </div>
</div>

<!-- Configure Tab -->
<div class="tab-content" id="tab-configure">
  <div style="max-width:1200px;margin:0 auto;padding:24px">
    <h2 style="font-size:20px;font-weight:700;margin-bottom:4px">🔧 Configure Your Agents</h2>
    <p style="font-size:13px;color:var(--text2);margin-bottom:20px">Click any bot to configure its personality, skills, and connections.</p>
    <div class="cfg-filters" id="cfgFilters"></div>
    <div class="cfg-grid" id="cfgBotGrid"></div>
    <div class="cfg-int-section">
      <h3>🔌 Integrations <button class="btn btn-sm btn-primary" onclick="connectAllIntegrations()" style="margin-left:12px">Connect All</button></h3>
      <div class="cfg-int-grid" id="cfgIntGrid"></div>
    </div>
  </div>
</div>

<!-- Settings Tab -->
<div class="tab-content" id="tab-settings">
  <div class="settings-container">
    <!-- Subscription Tiers -->
    <div class="settings-section">
      <h2>💳 Subscription Plan</h2>
      <div class="sub-grid" id="subGrid"></div>
    </div>

    <!-- White-Label Config -->
    <div class="settings-section" id="wlSection">
      <h2>🎨 White-Label Configuration</h2>
      <div class="wl-grid">
        <div class="wl-form">
          <div class="form-group"><label>Company Name</label><input id="wlCompany" placeholder="Your Company" oninput="updateWlPreview()"></div>
          <div class="form-group"><label>Logo</label>
            <div style="display:flex;gap:8px;align-items:center">
              <input type="file" accept="image/*" id="wlLogoUpload" style="display:none" onchange="handleWlLogoUpload()">
              <button class="btn btn-outline" onclick="document.getElementById('wlLogoUpload').click()">Upload Logo</button>
              <button class="btn btn-outline" id="wlRemoveLogo" style="display:none" onclick="removeWlLogo()">Remove</button>
            </div>
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px">
            <div class="form-group"><label>Primary</label><input type="color" id="wlPrimary" value="#3B82F6" onchange="updateWlPreview()"></div>
            <div class="form-group"><label>Secondary</label><input type="color" id="wlSecondary" value="#1e293b" onchange="updateWlPreview()"></div>
            <div class="form-group"><label>Accent</label><input type="color" id="wlAccent" value="#F5A623" onchange="updateWlPreview()"></div>
          </div>
          <div class="form-group"><label>Custom Favicon URL</label><input id="wlFavicon" placeholder="https://..." oninput="updateWlPreview()"></div>
          <div class="form-group"><label>Footer Text</label><input id="wlFooter" placeholder="© 2026 Your Company" oninput="updateWlPreview()"></div>
          <div class="form-group"><label style="display:flex;align-items:center;gap:8px"><input type="checkbox" id="wlPoweredBy" checked onchange="updateWlPreview()"> Show "Powered by Agent Orchestrator"</label></div>
          <button class="btn btn-green" onclick="saveWhiteLabel()">💾 Save White-Label Settings</button>
        </div>
        <div>
          <h4 style="font-size:12px;font-weight:700;color:var(--text3);margin-bottom:8px;text-transform:uppercase">Live Preview</h4>
          <div class="wl-preview" id="wlPreviewPane"></div>
        </div>
      </div>
    </div>

    <!-- Multi-Organization -->
    <div class="settings-section" id="orgSection">
      <h2>🏢 Organizations</h2>
      <div id="orgList"></div>
      <button class="btn btn-primary" style="margin-top:12px" onclick="showAddOrgModal()">+ Add Organization</button>
    </div>

    <!-- Shareable Links -->
    <div class="settings-section">
      <h2>🔗 Shareable Links</h2>
      <div style="display:flex;gap:8px;align-items:center;margin-bottom:12px">
        <select id="shareAccess" style="width:130px"><option value="view">View-only</option><option value="edit">Editable</option></select>
        <button class="btn btn-primary" onclick="generateShareLink()">🔗 Generate Share Link</button>
      </div>
      <div id="shareLinkResult" style="display:none;margin-bottom:16px;padding:12px;background:var(--bg);border:1px solid var(--border);border-radius:8px">
        <div style="display:flex;gap:8px;align-items:center">
          <input id="shareLinkUrl" readonly style="flex:1;font-size:11px">
          <button class="btn btn-sm btn-primary" onclick="copyShareLink()">📋 Copy</button>
        </div>
      </div>
      <h3>Shared Architectures</h3>
      <div class="share-list" id="shareList"></div>
    </div>
  </div>
</div>

<!-- Chat Panel -->
<button class="chat-fab" id="chatFab" onclick="toggleChat()">💬</button>
<div class="chat-panel" id="chatPanel">
  <div class="chat-header">
    <h3>🤖 Architecture Assistant</h3>
    <button onclick="toggleChat()" style="font-size:18px;color:var(--text3);cursor:pointer;background:none;border:none">✕</button>
  </div>
  <div class="chat-messages" id="chatMessages"></div>
  <div class="chat-input-area">
    <input id="chatInput" placeholder="Type a command or answer..." onkeydown="if(event.key==='Enter')sendChat()">
    <button onclick="sendChat()">Send</button>
  </div>
</div>

<!-- Add Organization Modal -->
<div class="modal-overlay" id="addOrgModal">
  <div class="modal">
    <h3>Add Organization</h3>
    <div class="form-group"><label>Name</label><input id="orgName" placeholder="Organization name"></div>
    <div class="form-group"><label>Description</label><textarea id="orgDesc" rows="3" placeholder="What is this organization for?"></textarea></div>
    <div class="form-actions">
      <button class="btn btn-outline" onclick="closeAddOrgModal()">Cancel</button>
      <button class="btn btn-primary" onclick="addOrganization()">Add</button>
    </div>
  </div>
</div>

<!-- Publish Template Modal -->
<div class="modal-overlay" id="publishTplModal">
  <div class="modal">
    <h3>📤 Publish Skill Pack</h3>
    <div class="form-group"><label>Template Name</label><input id="pubTplName" placeholder="My Custom Architecture"></div>
    <div class="form-group"><label>Description</label><textarea id="pubTplDesc" rows="3" placeholder="Describe your architecture template..."></textarea></div>
    <div style="display:grid;grid-template-columns:60px 1fr 1fr;gap:10px">
      <div class="form-group"><label>Icon</label><input id="pubTplIcon" placeholder="🏢" style="width:60px"></div>
      <div class="form-group"><label>Category</label><select id="pubTplCategory"><option value="Real Estate">🏢 Real Estate</option><option value="Technology">☁️ Technology</option><option value="Healthcare">🏥 Healthcare</option><option value="Professional Services">📋 Professional</option><option value="Education">🎓 Education</option><option value="Operations">🚛 Operations</option><option value="Hospitality">🏨 Hospitality</option><option value="Retail">🛒 Retail</option><option value="Non-Profit">🤝 Non-Profit</option><option value="Manufacturing">🏭 Manufacturing</option></select></div>
      <div class="form-group"><label>Price</label><select id="pubTplPrice"><option value="Free">Free</option><option value="Pro">Pro ($9.99)</option></select></div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
      <div class="form-group"><label>Setup Time</label><select id="pubTplSetup"><option value="30 sec">⚡ 30 sec</option><option value="45 sec" selected>⚡ 45 sec</option><option value="60 sec">⚡ 60 sec</option><option value="2 min">⚡ 2 min</option></select></div>
      <div class="form-group"><label>Bots Included</label><input id="pubTplBots" type="number" readonly style="background:var(--bg3)"></div>
    </div>
    <div class="form-actions">
      <button class="btn btn-outline" onclick="closePublishTplModal()">Cancel</button>
      <button class="btn btn-green" onclick="publishTemplate()">📤 Publish</button>
    </div>
  </div>
</div>

<!-- Deploy Wizard Modal -->
<div class="modal-overlay" id="deployWizardModal">
  <div class="modal deploy-wizard" style="max-width:520px">
    <h3 id="dwTitle">⚡ Deploy Skill Pack</h3>
    <div class="dw-progress"><div class="dw-step" id="dwStep1"></div><div class="dw-step" id="dwStep2"></div><div class="dw-step" id="dwStep3"></div></div>
    <div class="dw-step-label"><span id="dwStepLabel">Step 1 of 3</span><span id="dwStepName">Name Your Agent</span></div>
    <div id="dwContent"></div>
    <div class="form-actions" style="margin-top:16px">
      <button class="btn btn-outline" id="dwBack" onclick="deployWizardBack()" style="display:none">← Back</button>
      <button class="btn btn-outline" onclick="closeDeployWizard()">Cancel</button>
      <button class="btn btn-primary" id="dwNext" onclick="deployWizardNext()">Next →</button>
    </div>
  </div>
</div>

<!-- Save Workflow Modal -->
<div class="modal-overlay" id="saveWfModal">
  <div class="modal">
    <h3>💾 Save Workflow</h3>
    <div class="form-group"><label>Workflow Name</label><input id="saveWfName" placeholder="My Workflow"></div>
    <div class="form-actions">
      <button class="btn btn-outline" onclick="closeSaveWfModal()">Cancel</button>
      <button class="btn btn-green" onclick="saveWorkflow()">Save</button>
    </div>
  </div>
</div>

<!-- Connection Label Modal -->
<div class="modal-overlay" id="connLabelModal">
  <div class="modal" style="width:320px">
    <h3>Connection Label</h3>
    <div class="form-group"><label>Label</label><input id="connLabelInput" placeholder="e.g., sends report"></div>
    <div class="form-actions">
      <button class="btn btn-outline" onclick="closeConnLabelModal()">Cancel</button>
      <button class="btn btn-danger" onclick="deleteSelectedConnection()">🗑️ Delete</button>
      <button class="btn btn-green" onclick="saveConnLabel()">Save</button>
    </div>
  </div>
</div>

<!-- Budget Settings Modal -->
<div class="modal-overlay" id="budgetModal">
  <div class="modal">
    <h3>💸 Budget Settings</h3>
    <div class="form-group"><label>Monthly Budget ($)</label><input id="budgetMonthly" type="number" placeholder="5000"></div>
    <div class="form-group"><label>Alert at 50%</label><input type="checkbox" id="budgetAlert50" checked></div>
    <div class="form-group"><label>Alert at 75%</label><input type="checkbox" id="budgetAlert75" checked></div>
    <div class="form-group"><label>Alert at 90%</label><input type="checkbox" id="budgetAlert90" checked></div>
    <div class="form-group"><label>Alert at 100%</label><input type="checkbox" id="budgetAlert100" checked></div>
    <div class="form-actions">
      <button class="btn btn-outline" onclick="closeBudgetModal()">Cancel</button>
      <button class="btn btn-green" onclick="saveBudgetSettings()">Save</button>
    </div>
  </div>
</div>

<!-- Detail Panel -->
<div class="detail-panel" id="detailPanel">
  <span class="panel-close" onclick="closePanel()">✕</span>
  <div id="panelContent"></div>
</div>

<!-- Add Modal -->
<div class="modal-overlay" id="addModal">
  <div class="modal">
    <h3>Add New</h3>
    <div class="form-group"><label>Category</label>
      <select id="addCategory" onchange="updateAddForm()">
        <option value="bot">Bot</option><option value="agent">Agent</option><option value="team">Team</option><option value="infrastructure">Infrastructure</option>
      </select>
    </div>
    <div class="form-group" id="addTeamGroup"><label>Team</label><select id="addTeam"></select></div>
    <div class="form-group"><label>Name</label><input id="addName" placeholder="Name"></div>
    <div class="form-group" id="addDescGroup"><label>Description <button class="expand-btn" onclick="openExpandModal('addDesc','Description')">↗ Expand</button></label><textarea id="addDesc" rows="3" placeholder="Job description"></textarea></div>
    <div class="form-group" id="addPhaseGroup"><label>Phase</label><select id="addPhase"></select></div>
    <div class="form-group" id="addColorGroup" style="display:none"><label>Team Color</label><input id="addColor" type="color" value="#6366F1"></div>
    <div class="form-group" id="addInfraSectionGroup" style="display:none"><label>Section</label>
      <select id="addInfraSection"><option value="approved">Approved</option><option value="underReview">Under Review</option></select>
    </div>
    <div class="form-actions">
      <button class="btn btn-outline" onclick="closeAddModal()">Cancel</button>
      <button class="btn btn-primary" onclick="addItem()">Add</button>
    </div>
  </div>
</div>

<!-- Job Description Popout -->
<div class="jd-modal-overlay" id="jdModal">
  <div class="jd-modal">
    <h3 id="jdModalTitle">Job Description</h3>
    <div id="jdModalContent"></div>
    <div class="form-actions">
      <button class="btn btn-outline" onclick="closeJdModal()">Close</button>
      <button class="btn btn-green" id="jdSaveBtn" style="display:none" onclick="saveJdModal()">Apply</button>
    </div>
  </div>
</div>

<!-- Branding Panel -->
<div class="branding-overlay" id="brandingModal">
  <div class="branding-modal" style="max-height:90vh;overflow-y:auto;width:440px">
    <h3>⚙️ Branding & Settings</h3>
    <div class="form-group"><label>Company Name</label><input id="brandCompany" placeholder="Company name"></div>
    <div class="form-group"><label>Logo</label>
      <div style="display:flex;align-items:center;gap:8px">
        <input type="file" accept="image/*" id="brandLogoUpload" style="display:none" onchange="handleLogoUpload()">
        <button class="btn btn-outline" onclick="document.getElementById('brandLogoUpload').click()">Upload Logo</button>
        <button class="btn btn-outline" id="removeLogoBtn" style="display:none" onclick="removeLogo()">Remove</button>
      </div>
    </div>
    <div class="form-group"><label>Upload Brand Guidelines</label>
      <input type="file" accept=".pdf,.docx,.png,.jpg,.jpeg" id="brandGuidelinesUpload" style="display:none" onchange="handleGuidelinesUpload()">
      <div class="brand-upload-zone" onclick="document.getElementById('brandGuidelinesUpload').click()">
        <div class="upload-label">📄 Drop or click to upload brand guidelines<br><span style="font-size:10px;color:var(--text3)">PDF, DOCX, PNG, JPG</span></div>
        <div class="file-name" id="guidelinesFileName" style="display:none"></div>
      </div>
    </div>
    <div class="brand-color-grid">
      <div class="form-group"><label>Primary Color</label>
        <div class="color-row"><input type="color" id="brandColorPicker" value="#3B82F6" onchange="this.nextElementSibling.value=this.value;previewAllBrandColors()"><input type="text" id="brandColorHex" value="#3B82F6" onchange="this.previousElementSibling.value=this.value;previewAllBrandColors()"></div>
      </div>
      <div class="form-group"><label>Secondary Color</label>
        <div class="color-row"><input type="color" id="brandSecondaryPicker" value="#1e293b" onchange="this.nextElementSibling.value=this.value;previewAllBrandColors()"><input type="text" id="brandSecondaryHex" value="#1e293b" onchange="this.previousElementSibling.value=this.value;previewAllBrandColors()"></div>
      </div>
      <div class="form-group"><label>Accent Color</label>
        <div class="color-row"><input type="color" id="brandAccentPicker" value="#F5A623" onchange="this.nextElementSibling.value=this.value;previewAllBrandColors()"><input type="text" id="brandAccentHex" value="#F5A623" onchange="this.previousElementSibling.value=this.value;previewAllBrandColors()"></div>
      </div>
      <div class="form-group"><label>Font Family</label>
        <select id="brandFontSelect" onchange="previewAllBrandColors()" style="width:100%">
          <option value="'Inter',system-ui,sans-serif">Inter (default)</option>
          <option value="'Helvetica Neue',Helvetica,Arial,sans-serif">Helvetica</option>
          <option value="'Segoe UI',Tahoma,Geneva,sans-serif">Segoe UI</option>
          <option value="'Roboto',sans-serif">Roboto</option>
          <option value="'Poppins',sans-serif">Poppins</option>
          <option value="Georgia,'Times New Roman',serif">Georgia (serif)</option>
          <option value="__custom">Custom…</option>
        </select>
        <input type="text" id="brandFontCustom" placeholder="Custom font family" style="display:none;margin-top:4px;width:100%" onchange="previewAllBrandColors()">
      </div>
    </div>
    <div class="form-actions">
      <button class="btn btn-outline" onclick="closeBranding()">Cancel</button>
      <button class="btn btn-green" onclick="saveBranding()">Save</button>
    </div>
  </div>
</div>

<!-- Import modal -->
<div class="modal-overlay" id="importModal">
  <div class="modal">
    <h3>📥 Import Configuration</h3>
    <p style="font-size:13px;color:var(--text2);margin-bottom:12px">Choose how to handle the imported data:</p>
    <div class="form-actions" style="flex-direction:column;gap:8px">
      <button class="btn btn-primary" style="width:100%" onclick="doImport('replace')">Replace current setup</button>
      <button class="btn btn-outline" style="width:100%" onclick="doImport('merge')">Merge with current</button>
      <button class="btn btn-outline" style="width:100%" onclick="closeImportModal()">Cancel</button>
    </div>
  </div>
</div>


<!-- Bot Library Detail Modal -->
<div class="modal-overlay" id="botLibModal">
  <div class="modal" style="width:520px;max-height:90vh;overflow-y:auto">
    <h3 id="botLibModalTitle">Bot Details</h3>
    <div id="botLibModalContent"></div>
    <div class="form-actions" id="botLibModalActions"></div>
  </div>
</div>

<!-- Skill Edit Modal -->
<div class="modal-overlay" id="skillEditModal">
  <div class="modal" style="width:420px">
    <h3>Edit Skill</h3>
    <div class="form-group"><label>Name</label><input id="skillEditName"></div>
    <div class="form-group"><label>Description <button class="expand-btn" onclick="openExpandModal('skillEditDesc','Skill Description')">↗ Expand</button></label><textarea id="skillEditDesc" rows="3"></textarea></div>
    <div class="form-group"><label>Category</label>
      <select id="skillEditCat">
        <option>Communication</option><option>Analysis</option><option>Automation</option><option>Compliance</option><option>Research</option><option>Custom/Advanced</option>
      </select>
    </div>
    <div class="form-actions">
      <button class="btn btn-outline" onclick="closeSkillEditModal()">Cancel</button>
      <button class="btn btn-green" onclick="saveSkillEdit()">Save Changes</button>
    </div>
  </div>
</div>

<!-- Expand Modal -->
<div class="expand-modal-overlay" id="expandModalOverlay">
  <div class="expand-modal">
    <h3 id="expandModalTitle">Edit Description</h3>
    <textarea id="expandModalTextarea"></textarea>
    <div class="expand-actions">
      <button class="btn btn-outline" onclick="closeExpandModal(false)">Cancel</button>
      <button class="btn btn-green" onclick="closeExpandModal(true)">Apply</button>
    </div>
  </div>
</div>
<!-- Toast -->
<div class="toast" id="toast"></div>
<input type="file" id="importFileInput" accept=".json" style="display:none" onchange="handleImportFile(event)">

<script>
// ======================== LIBRARY DATA ========================

const INDUSTRY_TEMPLATES = [
  {
    id:'prop-mgmt', name:'Property Management / Multifamily', icon:'🏢',
    teams:[
      {name:'Operations',color:'#3B82F6',bots:['Report Generator','Lease Auditor','Rent Optimizer']},
      {name:'Leasing & Marketing',color:'#10B981',bots:['Market Analyst','Resident Comms']},
      {name:'Maintenance',color:'#F59E0B',bots:['Work Order Router','Vendor Manager']},
      {name:'Finance',color:'#8B5CF6',bots:['Budget Tracker','NOI Calculator','Collections']},
      {name:'Resident Services',color:'#EC4899',bots:['Resident Comms']}
    ],
    infra:['Entrata','Yardi','RealPage','Microsoft 365','Egnyte','CoStar','Apartment IQ','RingCentral','Paycor']
  },
  {
    id:'construction', name:'Construction / Development', icon:'🏗️',
    teams:[
      {name:'Project Management',color:'#3B82F6',bots:['Schedule Tracker','Daily Log Writer']},
      {name:'Safety & Compliance',color:'#EF4444',bots:['Safety Inspector','Permit Tracker']},
      {name:'Estimating',color:'#F59E0B',bots:['Cost Estimator']},
      {name:'Procurement',color:'#8B5CF6',bots:['Submittal Router','Change Order Manager']},
      {name:'Field Operations',color:'#10B981',bots:['RFI Processor','Punch List Manager']}
    ],
    infra:['Procore','Bluebeam','PlanGrid','Microsoft 365','DocuSign','Sage']
  },
  {
    id:'healthcare', name:'Healthcare / Medical Practice', icon:'🏥',
    teams:[
      {name:'Patient Services',color:'#3B82F6',bots:['Appointment Scheduler','Patient Intake']},
      {name:'Clinical Operations',color:'#10B981',bots:['Chart Summarizer','Referral Manager']},
      {name:'Billing & Revenue',color:'#8B5CF6',bots:['Insurance Verifier','Claim Processor','Prior Auth Bot']},
      {name:'Compliance',color:'#EF4444',bots:['Compliance Monitor']},
      {name:'Staff Management',color:'#F59E0B',bots:['Staff Scheduler']}
    ],
    infra:['Epic Systems','Cerner (Oracle Health)','DrChrono','athenahealth','Microsoft 365','DocuSign','Salesforce Health Cloud','Zoom']
  },
  {
    id:'prof-services', name:'Professional Services', icon:'⚖️',
    teams:[
      {name:'Client Management',color:'#3B82F6',bots:['CRM Updater','Conflict Checker']},
      {name:'Project Delivery',color:'#10B981',bots:['Time Tracker','Deadline Monitor']},
      {name:'Business Development',color:'#F59E0B',bots:['Proposal Writer','Engagement Letter Writer']},
      {name:'Operations',color:'#8B5CF6',bots:['Invoice Generator','Document Reviewer']},
      {name:'Knowledge Management',color:'#14B8A6',bots:['Research Assistant']}
    ],
    infra:['Microsoft 365','Salesforce','Clio/Practice Mgmt','QuickBooks','DocuSign','SharePoint']
  },
  {
    id:'ecommerce', name:'E-commerce / Retail', icon:'🛒',
    teams:[
      {name:'Sales & Marketing',color:'#3B82F6',bots:['Ad Campaign Manager','Price Optimizer']},
      {name:'Customer Service',color:'#10B981',bots:['Customer Support','Review Monitor']},
      {name:'Inventory',color:'#F59E0B',bots:['Inventory Tracker']},
      {name:'Fulfillment',color:'#8B5CF6',bots:['Order Processor','Shipping Coordinator']},
      {name:'Analytics',color:'#14B8A6',bots:['Fraud Detector','Return Handler']}
    ],
    infra:['Shopify','Amazon','Stripe','Gumroad','PayPal','Zendesk','Google Analytics','Meta Ads','Klaviyo']
  },
  {
    id:'financial', name:'Financial Services', icon:'🏦',
    teams:[
      {name:'Client Advisory',color:'#3B82F6',bots:['Portfolio Analyzer','Client Onboarding']},
      {name:'Risk & Compliance',color:'#EF4444',bots:['Risk Assessor','KYC Processor','Regulatory Monitor']},
      {name:'Operations',color:'#10B981',bots:['Trade Executor','Audit Trail Logger']},
      {name:'Research',color:'#F59E0B',bots:['Market Scanner','Report Generator']},
      {name:'Technology',color:'#8B5CF6',bots:[]}
    ],
    infra:['Bloomberg','Salesforce','Microsoft 365','DocuSign','Plaid','Coinbase Commerce','Juniper Networks','Power BI']
  },
  {
    id:'marketing', name:'Marketing & Content', icon:'📢',
    teams:[
      {name:'Content Creation',color:'#3B82F6',bots:['Content Writer','Content Calendar Manager']},
      {name:'Social Media',color:'#10B981',bots:['Social Scheduler','Influencer Tracker']},
      {name:'SEO & Analytics',color:'#F59E0B',bots:['SEO Auditor','Analytics Reporter']},
      {name:'Campaign Management',color:'#8B5CF6',bots:['Email Campaign Manager','A/B Test Manager']},
      {name:'Brand Management',color:'#EC4899',bots:['Brand Monitor']}
    ],
    infra:['HubSpot','Google Analytics','Meta Business','Canva','Hootsuite','Mailchimp','SEMrush']
  },
  {
    id:'personal', name:'Personal Life Management', icon:'🏠',
    teams:[
      {name:'Productivity',color:'#3B82F6',bots:['Task Manager','Calendar Optimizer']},
      {name:'Finance',color:'#8B5CF6',bots:['Budget Tracker','Goal Tracker']},
      {name:'Health & Wellness',color:'#10B981',bots:['Meal Planner','Fitness Tracker']},
      {name:'Home Management',color:'#F59E0B',bots:['Home Maintenance Scheduler']},
      {name:'Learning & Growth',color:'#14B8A6',bots:['Learning Path Manager','Travel Planner']}
    ],
    infra:['Google Workspace','Apple ecosystem','Banking APIs','Fitness apps','Smart home']
  }
];

const BOT_LIBRARY = [
  {name:'Report Generator',cat:'Operations',desc:'Produces recurring operational reports including daily, weekly, monthly summaries. Pulls data from connected systems and formats per standards.',skills:['Data Extraction','Report Writing','Document Processing'],mcps:['Entrata','Egnyte'],team:'Operations',relType:'Tool',engStyle:'Answer Machine',humanCheckpoint:'Review report accuracy before publishing',starters:['Generate today\'s DLR for Bartram Park','Create a weekly performance report for all properties','Compare occupancy rates across the portfolio']},
  {name:'Lease Auditor',cat:'Operations',desc:'Reviews lease agreements for compliance, identifies discrepancies between terms and system data, flags expiring leases.',skills:['Document Review','Policy Monitoring','Data Extraction'],mcps:['Entrata','Egnyte'],team:'Operations',relType:'Tool',engStyle:'Answer Machine',humanCheckpoint:'Review flagged discrepancies before sending to legal',starters:['Audit all leases expiring in the next 90 days','Flag any lease-rent mismatches','Show me non-compliant lease terms']},
  {name:'Rent Optimizer',cat:'Finance',desc:'Analyzes market data and occupancy trends to recommend optimal rent pricing across the portfolio.',skills:['Trend Analysis','Financial Modeling','Market Research'],mcps:['CoStar','RealPage'],team:'Finance',relType:'Sidekick',engStyle:'Thinking Partner',humanCheckpoint:'Approve rent adjustment recommendations before implementation',starters:['What rent adjustments do you recommend for Q2?','Compare our pricing to market','Model a 3% rent increase impact on occupancy']},
  {name:'Work Order Router',cat:'Operations',desc:'Classifies incoming maintenance requests, assigns priority, routes to appropriate vendor or team member.',skills:['Workflow Orchestration','Notification Management','Data Entry'],mcps:['Entrata','Brightly'],team:'Maintenance',relType:'Tool',engStyle:'Answer Machine',humanCheckpoint:'Spot-check routing accuracy weekly',starters:['Route today\'s open work orders','Show me unassigned maintenance requests','Prioritize emergency work orders']},
  {name:'Vendor Manager',cat:'Operations',desc:'Tracks vendor contracts, insurance certificates, performance metrics, and compliance documentation.',skills:['Document Processing','Schedule Management','Policy Monitoring'],mcps:['Egnyte','Entrata'],team:'Operations',relType:'Tool',engStyle:'Answer Machine',humanCheckpoint:'Review vendor compliance flags before action',starters:['Show expiring vendor contracts this month','Pull insurance certificates due for renewal','Rate vendor performance for Q1']},
  {name:'Resident Comms',cat:'Communications',desc:'Manages resident-facing communications including notices, newsletters, and response handling.',skills:['Customer Response','Email Drafting','Notification Management'],mcps:['Entrata','RingCentral'],team:'Resident Services',relType:'Sidekick',engStyle:'Answer Machine',humanCheckpoint:'Approve community-wide notices before sending',starters:['Draft a maintenance notice for building 3','Send rent reminder to delinquent residents','Create a community newsletter for March']},
  {name:'Collections',cat:'Finance',desc:'Automates delinquency tracking, payment reminders, and collections workflow per policy guidelines.',skills:['Notification Management','Policy Monitoring','Schedule Management'],mcps:['Entrata','Paycor'],team:'Finance',relType:'Tool',engStyle:'Answer Machine',humanCheckpoint:'Review escalation actions before sending to collections',starters:['Show all accounts 30+ days delinquent','Send payment reminders for this week','Generate delinquency report by property']},
  {name:'Budget Tracker',cat:'Finance',desc:'Monitors budget vs. actuals, flags overruns, generates variance reports with trend analysis.',skills:['Financial Modeling','Trend Analysis','Report Writing'],mcps:['Entrata','Egnyte'],team:'Finance',relType:'Tool',engStyle:'Answer Machine',humanCheckpoint:'Review variance explanations before board presentation',starters:['Show budget vs actuals for January','Flag any line items over 10% variance','Generate monthly budget summary']},
  {name:'NOI Calculator',cat:'Finance',desc:'Calculates Net Operating Income at property and portfolio levels with pro-forma modeling.',skills:['Financial Modeling','Data Extraction','Report Writing'],mcps:['Entrata','RealPage'],team:'Finance',relType:'Tool',engStyle:'Answer Machine',humanCheckpoint:'Validate NOI assumptions before investor reporting',starters:['Calculate NOI for Bartram Park this quarter','Run pro-forma for the new acquisition','Compare NOI trends year-over-year']},
  {name:'Market Analyst',cat:'Analytics',desc:'Monitors real estate market conditions, competitor pricing, and economic indicators.',skills:['Market Research','Competitive Intelligence','Trend Analysis'],mcps:['CoStar','Apartment IQ'],team:'Analytics',relType:'Sidekick',engStyle:'Thinking Partner',humanCheckpoint:'Validate market assumptions before strategy decisions',starters:['What are current market trends in Jacksonville?','Compare our submarket to competing areas','Analyze rent growth projections for 2026']},
  {name:'Schedule Tracker',cat:'Operations',desc:'Monitors construction project schedules, identifies delays, updates critical path analysis.',skills:['Schedule Management','Notification Management','Report Writing'],mcps:['Procore','PlanGrid'],team:'Project Management',relType:'Tool',engStyle:'Answer Machine',humanCheckpoint:'Review critical path changes before updating stakeholders',starters:['Show tasks behind schedule this week','Update the critical path for Phase 2','Flag any milestone delays']},
  {name:'RFI Processor',cat:'Operations',desc:'Routes and tracks Requests for Information, ensures timely responses and documentation.',skills:['Document Processing','Workflow Orchestration','Notification Management'],mcps:['Procore'],team:'Operations',relType:'Tool',engStyle:'Answer Machine',humanCheckpoint:'Review RFI responses before sending to contractor',starters:['Show all open RFIs awaiting response','Route this RFI to the structural engineer','Generate RFI status report']},
  {name:'Change Order Manager',cat:'Operations',desc:'Processes change orders, calculates cost impact, routes for approval, maintains audit trail.',skills:['Document Processing','Financial Modeling','Audit Trail Generation'],mcps:['Procore','Sage'],team:'Operations',relType:'Tool',engStyle:'Answer Machine',humanCheckpoint:'Approve change orders above threshold before processing',starters:['Process this change order for electrical work','Show total change order impact on budget','List pending change orders by cost']},
  {name:'Safety Inspector',cat:'Compliance',desc:'Monitors safety compliance, tracks incidents, generates inspection reports and corrective actions.',skills:['Policy Monitoring','Risk Assessment','Report Writing'],mcps:['Procore'],team:'Safety & Compliance',relType:'Tool',engStyle:'Answer Machine',humanCheckpoint:'Review safety violations before issuing corrective actions',starters:['Run today\'s safety compliance check','Generate weekly safety report','Flag any overdue safety inspections']},
  {name:'Cost Estimator',cat:'Finance',desc:'Generates cost estimates from project specs using historical data and current material pricing.',skills:['Financial Modeling','Data Extraction','Market Research'],mcps:['Procore','Sage'],team:'Estimating',relType:'Tool',engStyle:'Answer Machine',humanCheckpoint:'Review estimates before submitting bids',starters:['Estimate costs for the renovation project','Compare material prices to last quarter','Generate cost breakdown for Phase 3']},
  {name:'Submittal Router',cat:'Operations',desc:'Manages construction submittal workflow — routing, review tracking, and approval documentation.',skills:['Document Processing','Workflow Orchestration','Schedule Management'],mcps:['Procore','Bluebeam'],team:'Operations',relType:'Tool',engStyle:'Answer Machine',humanCheckpoint:'Verify submittal completeness before routing',starters:['Route pending submittals for review','Show submittal status for all trades','Flag overdue submittal reviews']},
  {name:'Punch List Manager',cat:'Operations',desc:'Tracks punch list items through completion, assigns responsibility, monitors resolution timelines.',skills:['Schedule Management','Notification Management','Data Entry'],mcps:['Procore','PlanGrid'],team:'Field Operations',relType:'Tool',engStyle:'Answer Machine',humanCheckpoint:'Verify completion before closing punch list items',starters:['Show open punch list items by unit','Assign remaining items to contractors','Generate punch list completion report']},
  {name:'Daily Log Writer',cat:'Operations',desc:'Compiles daily construction logs from field data, weather, labor, and activity reports.',skills:['Report Writing','Data Extraction','Document Processing'],mcps:['Procore'],team:'Field Operations',relType:'Tool',engStyle:'Answer Machine',humanCheckpoint:'Review daily log before filing',starters:['Compile today\'s construction daily log','Add weather delay to today\'s report','Show this week\'s daily log summaries']},
  {name:'Permit Tracker',cat:'Compliance',desc:'Monitors permit application status, renewal deadlines, and compliance requirements across jurisdictions.',skills:['Schedule Management','Regulatory Scanning','Notification Management'],mcps:['Procore'],team:'Safety & Compliance',relType:'Tool',engStyle:'Answer Machine',humanCheckpoint:'Verify permit status before project milestones',starters:['Show permits expiring this month','Check application status for building permit','List all pending permit renewals']},
  {name:'Appointment Scheduler',cat:'Operations',desc:'Manages patient appointment booking, rescheduling, and automated reminders.',skills:['Schedule Management','Notification Management','Customer Response'],mcps:['Epic/Cerner'],team:'Patient Services',relType:'Tool',engStyle:'Answer Machine',humanCheckpoint:'Review double-bookings weekly',starters:['Schedule a follow-up for patient #1234','Show available slots for next Tuesday','Send appointment reminders for tomorrow']},
  {name:'Patient Intake',cat:'Operations',desc:'Automates patient intake forms, insurance verification, and pre-visit documentation.',skills:['Document Processing','Data Entry','Data Extraction'],mcps:['Epic/Cerner'],team:'Patient Services',relType:'Tool',engStyle:'Answer Machine',humanCheckpoint:'Verify patient information accuracy before chart entry',starters:['Process intake for new patient','Show incomplete intake forms','Verify insurance for today\'s patients']},
  {name:'Insurance Verifier',cat:'Finance',desc:'Verifies insurance eligibility, benefits, and coverage before patient visits.',skills:['Data Extraction','API Integration','Document Processing'],mcps:['Epic/Cerner'],team:'Billing & Revenue',relType:'Tool',engStyle:'Answer Machine',humanCheckpoint:'Review coverage denials before patient notification',starters:['Verify insurance for tomorrow\'s appointments','Check eligibility for procedure code 99213','Flag patients with expired coverage']},
  {name:'Claim Processor',cat:'Finance',desc:'Processes insurance claims, tracks submission status, handles denials and resubmissions.',skills:['Document Processing','Workflow Orchestration','Audit Trail Generation'],mcps:['Epic/Cerner'],team:'Billing & Revenue',relType:'Tool',engStyle:'Answer Machine',humanCheckpoint:'Review denied claims before resubmission',starters:['Process pending claims batch','Show denied claims for this week','Resubmit claim with corrections']},
  {name:'Prior Auth Bot',cat:'Compliance',desc:'Manages prior authorization requests, tracks approvals, and expedites urgent cases.',skills:['Document Processing','Regulatory Scanning','Notification Management'],mcps:['Epic/Cerner'],team:'Billing & Revenue',relType:'Tool',engStyle:'Answer Machine',humanCheckpoint:'Review urgent prior auth requests before submission',starters:['Submit prior auth for MRI procedure','Check status of pending authorizations','Flag expiring authorizations this week']},
  {name:'Chart Summarizer',cat:'Analytics',desc:'Generates concise patient chart summaries for referrals, consultations, and care transitions.',skills:['Data Extraction','Report Writing','Document Review'],mcps:['Epic/Cerner'],team:'Clinical Operations',relType:'Tool',engStyle:'Answer Machine',humanCheckpoint:'Physician reviews summary before referral',starters:['Summarize chart for patient referral','Generate care transition summary','Pull key findings from last 3 visits']},
  {name:'Compliance Monitor',cat:'Compliance',desc:'Monitors regulatory compliance across all operations, flags violations, tracks corrective actions.',skills:['Policy Monitoring','Regulatory Scanning','Audit Trail Generation'],mcps:['Epic/Cerner'],team:'Compliance',relType:'Tool',engStyle:'Answer Machine',humanCheckpoint:'Review compliance violations before reporting',starters:['Run compliance check for this quarter','Show outstanding corrective actions','Generate compliance report']},
  {name:'Staff Scheduler',cat:'HR',desc:'Optimizes staff scheduling based on demand, qualifications, availability, and labor rules.',skills:['Schedule Management','Data Extraction','Notification Management'],mcps:['Paycor'],team:'Staff Management',relType:'Tool',engStyle:'Answer Machine',humanCheckpoint:'Review schedule before publishing to staff',starters:['Generate next week\'s staff schedule','Show shift coverage gaps','Optimize weekend staffing']},
  {name:'Referral Manager',cat:'Operations',desc:'Tracks patient referrals, ensures follow-up, and monitors referral network performance.',skills:['Workflow Orchestration','Notification Management','Report Writing'],mcps:['Epic/Cerner','Salesforce Health Cloud'],team:'Clinical Operations',relType:'Tool',engStyle:'Answer Machine',humanCheckpoint:'Verify referral appropriateness before sending',starters:['Track pending referrals','Send follow-up for overdue referrals','Show referral network performance']},
  {name:'Time Tracker',cat:'Operations',desc:'Tracks billable hours, generates time reports, ensures accurate client billing.',skills:['Data Entry','Report Writing','Schedule Management'],mcps:['Clio/Practice Mgmt'],team:'Project Delivery',relType:'Tool',engStyle:'Answer Machine',humanCheckpoint:'Review time entries before billing',starters:['Show my unbilled hours this week','Generate time report for client ABC','Flag entries missing project codes']},
  {name:'Invoice Generator',cat:'Finance',desc:'Generates invoices from time entries and expense data, routes for approval, tracks payment.',skills:['Document Processing','Financial Modeling','Notification Management'],mcps:['QuickBooks','Clio/Practice Mgmt'],team:'Operations',relType:'Tool',engStyle:'Answer Machine',humanCheckpoint:'Review invoice amounts before sending to client',starters:['Generate invoice for project XYZ','Show overdue invoices','Create monthly billing summary']},
  {name:'Proposal Writer',cat:'Communications',desc:'Drafts client proposals using templates, firm credentials, and project specifications.',skills:['Report Writing','Email Drafting','Document Review'],mcps:['Microsoft 365','SharePoint'],team:'Business Development',relType:'Sidekick',engStyle:'Thinking Partner',humanCheckpoint:'Review proposal content before client delivery',starters:['Draft a proposal for the Johnson engagement','Help me structure the scope section','Review pricing for competitive positioning']},
  {name:'Conflict Checker',cat:'Compliance',desc:'Screens new matters for conflicts of interest against existing client and matter databases.',skills:['Data Extraction','Risk Assessment','Audit Trail Generation'],mcps:['Clio/Practice Mgmt','Salesforce'],team:'Client Management',relType:'Tool',engStyle:'Answer Machine',humanCheckpoint:'Attorney reviews flagged conflicts before engagement',starters:['Run conflict check for new client Acme Corp','Show all conflicts flagged this month','Check matter against existing clients']},
  {name:'Document Reviewer',cat:'Analytics',desc:'Analyzes contracts, legal documents, and agreements for key terms, risks, and obligations.',skills:['Document Review','Risk Assessment','Data Extraction'],mcps:['Egnyte','SharePoint'],team:'Knowledge Management',relType:'Persona',engStyle:'Thinking Partner',humanCheckpoint:'Attorney validates key findings before client communication',starters:['Review this contract for key risk terms','Compare these two agreement versions','Summarize obligations in this lease']},
  {name:'Research Assistant',cat:'Analytics',desc:'Conducts legal, market, and competitive research. Synthesizes findings into actionable briefs.',skills:['Web Research','Academic Research','Report Writing'],mcps:['Brave Search'],team:'Knowledge Management',relType:'Persona',engStyle:'Thinking Partner',humanCheckpoint:'Validate research conclusions before relying on findings',starters:['Research recent case law on tenant rights','What are the latest market trends?','Compile competitive analysis for our pitch']},
  {name:'CRM Updater',cat:'Operations',desc:'Keeps CRM records current with client interactions, deal progress, and contact changes.',skills:['Data Entry','API Integration','Workflow Orchestration'],mcps:['Salesforce','HubSpot'],team:'Client Management',relType:'Tool',engStyle:'Answer Machine',humanCheckpoint:'Spot-check data accuracy monthly',starters:['Update CRM with this week\'s meetings','Show stale records needing updates','Sync contact changes from email']},
  {name:'Engagement Letter Writer',cat:'Communications',desc:'Generates engagement letters from templates with proper scope, fees, and terms.',skills:['Document Processing','Email Drafting','Policy Monitoring'],mcps:['Microsoft 365','DocuSign'],team:'Business Development',relType:'Tool',engStyle:'Answer Machine',humanCheckpoint:'Partner reviews engagement letter before sending',starters:['Draft engagement letter for new matter','Update fee schedule in template','Generate letter with standard terms']},
  {name:'Deadline Monitor',cat:'Operations',desc:'Tracks critical deadlines, filing dates, and statute of limitations across all matters.',skills:['Schedule Management','Notification Management','Risk Assessment'],mcps:['Clio/Practice Mgmt'],team:'Project Delivery',relType:'Tool',engStyle:'Answer Machine',humanCheckpoint:'Review critical deadline alerts daily',starters:['Show all deadlines in the next 7 days','Flag any overdue filing dates','Set reminder for statute of limitations']},
  {name:'Order Processor',cat:'Operations',desc:'Processes incoming orders, validates payment, triggers fulfillment workflow.',skills:['Workflow Orchestration','Data Entry','Notification Management'],mcps:['Shopify/WooCommerce','Stripe'],team:'Fulfillment',relType:'Tool',engStyle:'Answer Machine',humanCheckpoint:'Review flagged orders before processing',starters:['Process today\'s pending orders','Show orders with payment issues','Generate daily order summary']},
  {name:'Return Handler',cat:'Operations',desc:'Manages return requests, generates RMA labels, processes refunds per policy.',skills:['Customer Response','Workflow Orchestration','Policy Monitoring'],mcps:['Shopify/WooCommerce','Stripe'],team:'Customer Service',relType:'Tool',engStyle:'Answer Machine',humanCheckpoint:'Review high-value returns before approving',starters:['Process return request #4567','Show return rate trends this month','Generate RMA for defective item']},
  {name:'Review Monitor',cat:'Analytics',desc:'Monitors product reviews across platforms, analyzes sentiment, flags urgent issues.',skills:['Sentiment Analysis','Web Research','Notification Management'],mcps:['Shopify/WooCommerce'],team:'Customer Service',relType:'Sidekick',engStyle:'Answer Machine',humanCheckpoint:'Review negative sentiment alerts before responding',starters:['Show new reviews from today','Alert me to any 1-star reviews','Analyze review sentiment trends']},
  {name:'Inventory Tracker',cat:'Operations',desc:'Monitors stock levels, predicts reorder points, generates purchase orders.',skills:['Trend Analysis','Data Extraction','Notification Management'],mcps:['Shopify/WooCommerce'],team:'Inventory',relType:'Tool',engStyle:'Answer Machine',humanCheckpoint:'Approve reorder recommendations above threshold',starters:['Show items below reorder point','Generate purchase order for low stock','Forecast inventory needs for next month']},
  {name:'Price Optimizer',cat:'Analytics',desc:'Analyzes competitor pricing, demand trends, and margins to recommend optimal pricing.',skills:['Competitive Intelligence','Financial Modeling','Market Research'],mcps:['Google Analytics'],team:'Sales & Marketing',relType:'Sidekick',engStyle:'Thinking Partner',humanCheckpoint:'Approve pricing changes before implementation',starters:['Recommend pricing adjustments for top sellers','Compare our pricing to competitors','Model impact of a 10% price increase']},
  {name:'Ad Campaign Manager',cat:'Marketing',desc:'Manages ad campaigns across platforms, optimizes spend, generates performance reports.',skills:['Trend Analysis','Report Writing','API Integration'],mcps:['Meta Ads','Google Analytics'],team:'Sales & Marketing',relType:'Sidekick',engStyle:'Answer Machine',humanCheckpoint:'Review ad creative and budget before launch',starters:['Show campaign performance this week','Optimize ad spend across channels','Launch retargeting campaign']},
  {name:'Customer Support',cat:'Communications',desc:'Handles customer inquiries via chat and email with contextual, helpful responses.',skills:['Customer Response','Email Drafting','Data Extraction'],mcps:['Zendesk'],team:'Customer Service',relType:'Sidekick',engStyle:'Answer Machine',humanCheckpoint:'Review escalated tickets before resolution',starters:['Show open support tickets by priority','Draft response for ticket #789','Analyze common support issues this week']},
  {name:'Shipping Coordinator',cat:'Operations',desc:'Coordinates shipping across carriers, generates tracking info, handles delivery exceptions.',skills:['Workflow Orchestration','Notification Management','API Integration'],mcps:['Shopify/WooCommerce'],team:'Fulfillment',relType:'Tool',engStyle:'Answer Machine',humanCheckpoint:'Review shipping exceptions daily',starters:['Show shipments with delivery exceptions','Generate shipping labels for today','Compare carrier rates for bulk shipment']},
  {name:'Fraud Detector',cat:'Compliance',desc:'Monitors transactions for fraud patterns, flags suspicious activity, generates alerts.',skills:['Risk Assessment','Trend Analysis','Audit Trail Generation'],mcps:['Stripe','Plaid'],team:'Analytics',relType:'Tool',engStyle:'Answer Machine',humanCheckpoint:'Review flagged transactions before blocking',starters:['Show flagged transactions today','Analyze fraud patterns this month','Review suspicious account activity']},
  {name:'Portfolio Analyzer',cat:'Analytics',desc:'Analyzes investment portfolios, tracks performance, generates allocation recommendations.',skills:['Financial Modeling','Trend Analysis','Report Writing'],mcps:['Bloomberg'],team:'Client Advisory',relType:'Persona',engStyle:'Thinking Partner',humanCheckpoint:'Validate recommendations before client presentation',starters:['Analyze portfolio performance vs benchmark','Recommend rebalancing strategy','Show risk exposure by sector']},
  {name:'Risk Assessor',cat:'Compliance',desc:'Evaluates risk factors across clients and transactions, generates risk scores and reports.',skills:['Risk Assessment','Financial Modeling','Audit Trail Generation'],mcps:['Bloomberg','Salesforce'],team:'Risk & Compliance',relType:'Tool',engStyle:'Answer Machine',humanCheckpoint:'Review high-risk flags before escalation',starters:['Run risk assessment for new client','Show portfolio risk score trends','Flag accounts exceeding thresholds']},
  {name:'KYC Processor',cat:'Compliance',desc:'Processes Know Your Customer documentation, verifies identity, ensures regulatory compliance.',skills:['Document Processing','Data Extraction','Regulatory Scanning'],mcps:['Plaid','Salesforce'],team:'Risk & Compliance',relType:'Tool',engStyle:'Answer Machine',humanCheckpoint:'Review incomplete KYC cases before approval',starters:['Process KYC for new account opening','Show pending KYC verifications','Flag expired identity documents']},
  {name:'Trade Executor',cat:'Operations',desc:'Executes trades based on approved parameters, monitors execution quality, maintains logs.',skills:['API Integration','Audit Trail Generation','Notification Management'],mcps:['Bloomberg'],team:'Operations',relType:'Tool',engStyle:'Answer Machine',humanCheckpoint:'Approve trades above threshold before execution',starters:['Execute approved trade batch','Show pending trade orders','Report on execution quality today']},
  {name:'Regulatory Monitor',cat:'Compliance',desc:'Monitors regulatory changes, assesses impact, generates compliance action items.',skills:['Regulatory Scanning','Report Writing','Notification Management'],mcps:['Bloomberg'],team:'Risk & Compliance',relType:'Tool',engStyle:'Answer Machine',humanCheckpoint:'Review regulatory impact assessments before distributing',starters:['Show new regulations affecting our business','Generate compliance impact report','Flag upcoming regulatory deadlines']},
  {name:'Client Onboarding',cat:'Operations',desc:'Manages client onboarding workflow from documentation through account setup.',skills:['Workflow Orchestration','Document Processing','Notification Management'],mcps:['Salesforce','DocuSign'],team:'Client Advisory',relType:'Tool',engStyle:'Answer Machine',humanCheckpoint:'Review account setup before activation',starters:['Start onboarding for new client','Show onboarding tasks in progress','Send welcome package to new account']},
  {name:'Market Scanner',cat:'Analytics',desc:'Scans markets for opportunities, trends, and anomalies. Generates real-time alerts.',skills:['Market Research','Trend Analysis','Notification Management'],mcps:['Bloomberg'],team:'Research',relType:'Sidekick',engStyle:'Thinking Partner',humanCheckpoint:'Validate market signals before acting',starters:['Scan for market opportunities today','Show unusual market activity','Analyze sector rotation trends']},
  {name:'Audit Trail Logger',cat:'Compliance',desc:'Maintains comprehensive audit trails for all system actions and decisions.',skills:['Audit Trail Generation','Data Entry','Report Writing'],mcps:['Microsoft 365'],team:'Operations',relType:'Tool',engStyle:'Answer Machine',humanCheckpoint:'Review audit logs monthly for completeness',starters:['Generate audit report for this quarter','Show all actions by user this week','Flag any gaps in the audit trail']},
  {name:'Content Writer',cat:'Marketing',desc:'Creates blog posts, articles, and marketing copy optimized for target audiences.',skills:['Email Drafting','Web Research','Sentiment Analysis'],mcps:['HubSpot'],team:'Content Creation',relType:'Sidekick',engStyle:'Thinking Partner',humanCheckpoint:'Review content before publishing',starters:['Draft a blog post about industry trends','Write product description for new launch','Help me outline a thought leadership piece']},
  {name:'Social Scheduler',cat:'Marketing',desc:'Schedules and publishes social media content across platforms with optimal timing.',skills:['Schedule Management','API Integration','Trend Analysis'],mcps:['Hootsuite','Meta Business'],team:'Social Media',relType:'Tool',engStyle:'Answer Machine',humanCheckpoint:'Review social posts before scheduling',starters:['Schedule this week\'s social posts','Show best posting times','Queue content for all platforms']},
  {name:'SEO Auditor',cat:'Analytics',desc:'Audits website SEO, identifies improvement opportunities, tracks keyword rankings.',skills:['Web Research','Data Extraction','Report Writing'],mcps:['SEMrush','Google Analytics'],team:'SEO & Analytics',relType:'Tool',engStyle:'Answer Machine',humanCheckpoint:'Review SEO recommendations before implementation',starters:['Run SEO audit on our homepage','Show keyword ranking changes','Identify top technical SEO issues']},
  {name:'Analytics Reporter',cat:'Analytics',desc:'Generates analytics reports from multiple data sources with actionable insights.',skills:['Data Extraction','Trend Analysis','Report Writing'],mcps:['Google Analytics'],team:'SEO & Analytics',relType:'Tool',engStyle:'Answer Machine',humanCheckpoint:'Validate data accuracy before distributing reports',starters:['Generate weekly analytics dashboard','Show traffic trends this month','Compare conversion rates by channel']},
  {name:'Email Campaign Manager',cat:'Marketing',desc:'Manages email marketing campaigns — segmentation, A/B testing, performance tracking.',skills:['Email Drafting','Trend Analysis','API Integration'],mcps:['Mailchimp','HubSpot'],team:'Campaign Management',relType:'Sidekick',engStyle:'Answer Machine',humanCheckpoint:'Review email content and segments before sending',starters:['Set up drip campaign for new subscribers','Show email performance metrics','A/B test subject lines for next send']},
  {name:'Brand Monitor',cat:'Analytics',desc:'Monitors brand mentions across web and social media, analyzes sentiment and reach.',skills:['Sentiment Analysis','Web Research','Notification Management'],mcps:['Hootsuite'],team:'Brand Management',relType:'Sidekick',engStyle:'Answer Machine',humanCheckpoint:'Review brand alerts before responding',starters:['Show brand mentions this week','Analyze sentiment trends','Alert me to any PR issues']},
  {name:'Influencer Tracker',cat:'Marketing',desc:'Identifies and tracks influencer partnerships, engagement metrics, and ROI.',skills:['Web Research','Trend Analysis','Report Writing'],mcps:['Meta Business'],team:'Social Media',relType:'Tool',engStyle:'Answer Machine',humanCheckpoint:'Review influencer partnerships before commitment',starters:['Show top influencer partnerships by ROI','Find influencers in our niche','Track campaign performance by influencer']},
  {name:'A/B Test Manager',cat:'Analytics',desc:'Designs, manages, and analyzes A/B tests for campaigns, pages, and messaging.',skills:['Trend Analysis','Data Extraction','Report Writing'],mcps:['Google Analytics'],team:'Campaign Management',relType:'Tool',engStyle:'Thinking Partner',humanCheckpoint:'Review test results before implementing winner',starters:['Set up A/B test for landing page','Show results of current tests','Recommend what to test next']},
  {name:'Content Calendar Manager',cat:'Marketing',desc:'Manages editorial calendar across all content channels, tracks deadlines and dependencies.',skills:['Schedule Management','Notification Management','Workflow Orchestration'],mcps:['HubSpot','Hootsuite'],team:'Content Creation',relType:'Tool',engStyle:'Answer Machine',humanCheckpoint:'Review editorial calendar weekly',starters:['Show content calendar for this month','Flag any missed deadlines','Plan next quarter\'s content themes']},
  {name:'Task Manager',cat:'Personal',desc:'Manages personal tasks, priorities, and to-do lists with smart scheduling.',skills:['Schedule Management','Notification Management','Workflow Orchestration'],mcps:['Google Workspace'],team:'Productivity',relType:'Tool',engStyle:'Answer Machine',humanCheckpoint:'Review weekly priorities',starters:['Show my tasks for today','Prioritize this week\'s to-do list','Move overdue tasks to tomorrow']},
  {name:'Calendar Optimizer',cat:'Personal',desc:'Optimizes daily schedule, blocks focus time, suggests meeting arrangements.',skills:['Schedule Management','Trend Analysis','Notification Management'],mcps:['Google Workspace'],team:'Productivity',relType:'Sidekick',engStyle:'Thinking Partner',humanCheckpoint:'Approve schedule changes before rearranging',starters:['Optimize my schedule for focus time','Find a slot for a 1-hour meeting','Show my busiest days this week']},
  {name:'Meal Planner',cat:'Personal',desc:'Plans weekly meals based on preferences, nutrition goals, and budget. Generates shopping lists.',skills:['Web Research','Schedule Management','Data Entry'],mcps:['Google Workspace'],team:'Health & Wellness',relType:'Tool',engStyle:'Answer Machine',humanCheckpoint:'Review meal plan before shopping',starters:['Plan meals for next week','Generate a shopping list','Suggest high-protein dinner options']},
  {name:'Fitness Tracker',cat:'Personal',desc:'Tracks workouts, monitors progress toward fitness goals, suggests routines.',skills:['Trend Analysis','Data Entry','Notification Management'],mcps:['Fitness apps'],team:'Health & Wellness',relType:'Sidekick',engStyle:'Answer Machine',humanCheckpoint:'Review fitness plan monthly',starters:['Log today\'s workout','Show my progress this month','Suggest a workout for tomorrow']},
  {name:'Home Maintenance Scheduler',cat:'Personal',desc:'Tracks home maintenance tasks, seasonal checklists, and service provider contacts.',skills:['Schedule Management','Notification Management','Data Entry'],mcps:['Smart home'],team:'Home Management',relType:'Tool',engStyle:'Answer Machine',humanCheckpoint:'Review service appointments before confirming',starters:['Show upcoming maintenance tasks','Schedule HVAC filter replacement','What seasonal maintenance is due?']},
  {name:'Learning Path Manager',cat:'Personal',desc:'Creates learning plans, tracks course progress, recommends resources.',skills:['Web Research','Schedule Management','Report Writing'],mcps:['Google Workspace'],team:'Learning & Growth',relType:'Sidekick',engStyle:'Thinking Partner',humanCheckpoint:'Review learning goals quarterly',starters:['Suggest courses for AI skills','Track my learning progress','Create a 30-day learning plan']},
  {name:'Travel Planner',cat:'Personal',desc:'Plans trips including flights, hotels, itineraries, and budget tracking.',skills:['Web Research','Schedule Management','Financial Modeling'],mcps:['Google Workspace'],team:'Learning & Growth',relType:'Sidekick',engStyle:'Thinking Partner',humanCheckpoint:'Review itinerary before booking',starters:['Plan a weekend trip to Miami','Compare flight options for next month','Build an itinerary for 3 days in NYC']},
  {name:'Goal Tracker',cat:'Personal',desc:'Tracks personal and professional goals with milestones, progress, and accountability.',skills:['Trend Analysis','Notification Management','Report Writing'],mcps:['Google Workspace'],team:'Productivity',relType:'Tool',engStyle:'Answer Machine',humanCheckpoint:'Review goal progress monthly',starters:['Show progress on my Q1 goals','Add a new financial goal','Which goals are at risk?']}
];

const SKILLS_LIBRARY = [
  {id:'email-drafting',name:'Email Drafting',cat:'Communication',desc:'Compose professional emails matching organizational tone and style guidelines.'},
  {id:'report-writing',name:'Report Writing',cat:'Communication',desc:'Generate structured reports from data with executive summaries and actionable insights.'},
  {id:'meeting-summarization',name:'Meeting Summarization',cat:'Communication',desc:'Create actionable meeting summaries with key decisions, action items, and follow-ups.'},
  {id:'executive-briefing',name:'Executive Briefing',cat:'Communication',desc:'Prepare concise executive-level communications and briefing documents.'},
  {id:'customer-response',name:'Customer Response',cat:'Communication',desc:'Craft contextual, helpful customer-facing responses across channels.'},
  {id:'data-extraction',name:'Data Extraction',cat:'Analysis',desc:'Pull structured data from documents, APIs, and databases for analysis.'},
  {id:'trend-analysis',name:'Trend Analysis',cat:'Analysis',desc:'Identify patterns and trends in datasets with statistical significance.'},
  {id:'financial-modeling',name:'Financial Modeling',cat:'Analysis',desc:'Build and run financial models, scenarios, and projections.'},
  {id:'competitive-intelligence',name:'Competitive Intelligence',cat:'Analysis',desc:'Research and analyze competitor activity, positioning, and strategy.'},
  {id:'sentiment-analysis',name:'Sentiment Analysis',cat:'Analysis',desc:'Evaluate tone and sentiment in text data across channels.'},
  {id:'workflow-orchestration',name:'Workflow Orchestration',cat:'Automation',desc:'Coordinate multi-step automated processes across systems.'},
  {id:'schedule-management',name:'Schedule Management',cat:'Automation',desc:'Manage calendars, appointments, deadlines, and recurring events.'},
  {id:'document-processing',name:'Document Processing',cat:'Automation',desc:'Parse, classify, and route documents based on content and rules.'},
  {id:'data-entry',name:'Data Entry',cat:'Automation',desc:'Extract and input data across systems with validation.'},
  {id:'notification-management',name:'Notification Management',cat:'Automation',desc:'Send contextual alerts and reminders based on triggers and rules.'},
  {id:'policy-monitoring',name:'Policy Monitoring',cat:'Compliance',desc:'Check actions against organizational policies and flag violations.'},
  {id:'audit-trail',name:'Audit Trail Generation',cat:'Compliance',desc:'Maintain detailed logs of all actions, decisions, and changes.'},
  {id:'regulatory-scanning',name:'Regulatory Scanning',cat:'Compliance',desc:'Monitor regulatory changes and assess impact on operations.'},
  {id:'risk-assessment',name:'Risk Assessment',cat:'Compliance',desc:'Evaluate and score risk factors with mitigation recommendations.'},
  {id:'data-privacy',name:'Data Privacy Enforcement',cat:'Compliance',desc:'Ensure PII handling compliance with privacy regulations.'},
  {id:'web-research',name:'Web Research',cat:'Research',desc:'Find and synthesize information from online sources.'},
  {id:'market-research',name:'Market Research',cat:'Research',desc:'Analyze market conditions, pricing, competitors, and trends.'},
  {id:'document-review',name:'Document Review',cat:'Research',desc:'Analyze contracts, legal docs, and agreements for key terms and risks.'},
  {id:'patent-search',name:'Patent/IP Search',cat:'Research',desc:'Research intellectual property landscape and prior art.'},
  {id:'academic-research',name:'Academic Research',cat:'Research',desc:'Find and summarize research papers and academic publications.'},
  {id:'code-generation',name:'Code Generation',cat:'Custom/Advanced',desc:'Write, debug, and review code across languages.'},
  {id:'image-analysis',name:'Image Analysis',cat:'Custom/Advanced',desc:'Interpret and describe visual content from images and documents.'},
  {id:'translation',name:'Translation',cat:'Custom/Advanced',desc:'Translate text between languages with context preservation.'},
  {id:'voice-transcription',name:'Voice Transcription',cat:'Custom/Advanced',desc:'Convert audio to text with speaker identification.'},
  {id:'api-integration',name:'API Integration',cat:'Custom/Advanced',desc:'Connect to and interact with external APIs and services.'}
];

const INFRA_LIBRARY = [
  {name:'Microsoft 365',cat:'Productivity',icon:'📧',desc:'Email, calendar, collaboration suite.',users:'All teams'},
  {name:'Google Workspace',cat:'Productivity',icon:'🔵',desc:'Gmail, Drive, Calendar, Docs, Sheets.',users:'All teams'},
  {name:'Notion',cat:'Productivity',icon:'📝',desc:'All-in-one workspace for notes, docs, and project management.',users:'All teams'},
  {name:'Airtable',cat:'Productivity',icon:'📊',desc:'Flexible database and project tracker.',users:'Operations, Marketing'},
  {name:'Slack',cat:'Communication',icon:'💬',desc:'Team messaging and collaboration platform.',users:'All teams'},
  {name:'Microsoft Teams',cat:'Communication',icon:'👥',desc:'Chat, video, and collaboration hub.',users:'All teams'},
  {name:'Zoom',cat:'Communication',icon:'📹',desc:'Video conferencing and webinar platform.',users:'All teams'},
  {name:'RingCentral',cat:'Communication',icon:'📞',desc:'Business phone, messaging, and video.',users:'Operations, Sales'},
  {name:'Twilio',cat:'Communication',icon:'📱',desc:'Programmable communications API.',users:'Development'},
  {name:'Salesforce',cat:'CRM',icon:'☁️',desc:'Customer relationship management platform.',users:'Sales, Marketing'},
  {name:'HubSpot',cat:'CRM',icon:'🟠',desc:'Inbound marketing, sales, and CRM platform.',users:'Marketing, Sales'},
  {name:'Pipedrive',cat:'CRM',icon:'🟢',desc:'Sales pipeline management CRM.',users:'Sales'},
  {name:'Entrata',cat:'PropTech',icon:'🏢',desc:'Property management — leasing, accounting, resident portal.',users:'Property Operations'},
  {name:'Yardi',cat:'PropTech',icon:'🏠',desc:'Real estate management and accounting.',users:'Property Operations'},
  {name:'RealPage',cat:'PropTech',icon:'📈',desc:'Revenue management and leasing platform.',users:'Leasing, Revenue'},
  {name:'AppFolio',cat:'PropTech',icon:'🏘️',desc:'Property management for small-mid portfolios.',users:'Property Operations'},
  {name:'CoStar',cat:'PropTech',icon:'🌐',desc:'Commercial real estate data and analytics.',users:'Research, Finance'},
  {name:'Apartment IQ',cat:'PropTech',icon:'📊',desc:'Competitive intelligence for multifamily.',users:'Marketing, Research'},
  {name:'Procore',cat:'Construction',icon:'🏗️',desc:'Construction project management platform.',users:'Project Management'},
  {name:'PlanGrid',cat:'Construction',icon:'📐',desc:'Construction blueprint and document management.',users:'Field Operations'},
  {name:'Bluebeam',cat:'Construction',icon:'🔵',desc:'PDF markup and collaboration for AEC.',users:'Estimating, Design'},
  {name:'QuickBooks',cat:'Finance',icon:'💰',desc:'Accounting and financial management.',users:'Finance'},
  {name:'Sage',cat:'Finance',icon:'🟩',desc:'Enterprise accounting and business management.',users:'Finance'},
  {name:'Stripe',cat:'Finance',icon:'💳',desc:'Payment processing and financial infrastructure.',users:'E-commerce, Finance'},
  {name:'Plaid',cat:'Finance',icon:'🔗',desc:'Financial data connectivity and verification.',users:'Finance, Compliance'},
  {name:'Paycor',cat:'HR',icon:'👤',desc:'Payroll, HR, and benefits administration.',users:'HR'},
  {name:'Workday',cat:'HR',icon:'🌅',desc:'Enterprise HR and finance management.',users:'HR, Finance'},
  {name:'BambooHR',cat:'HR',icon:'🎋',desc:'HR management for SMBs.',users:'HR'},
  {name:'ADP',cat:'HR',icon:'📋',desc:'Payroll and HR solutions.',users:'HR'},
  {name:'GitHub',cat:'Development',icon:'🐙',desc:'Code hosting and version control.',users:'Development'},
  {name:'GitLab',cat:'Development',icon:'🦊',desc:'DevOps platform with CI/CD.',users:'Development'},
  {name:'Jira',cat:'Development',icon:'📌',desc:'Project and issue tracking.',users:'Development, PM'},
  {name:'n8n',cat:'Automation',icon:'⚡',desc:'Workflow automation platform.',users:'Operations, Development'},
  {name:'Zapier',cat:'Automation',icon:'⚡',desc:'No-code automation connectors.',users:'All teams'},
  {name:'Make',cat:'Automation',icon:'🔄',desc:'Visual automation and integration.',users:'Operations'},
  {name:'DocuSign',cat:'Document',icon:'✍️',desc:'Electronic signature and agreement management.',users:'Legal, Operations'},
  {name:'Adobe Acrobat',cat:'Document',icon:'📄',desc:'PDF creation, editing, and signing.',users:'All teams'},
  {name:'Egnyte',cat:'Document',icon:'📁',desc:'Cloud content governance and collaboration.',users:'All teams'},
  {name:'SharePoint',cat:'Document',icon:'📂',desc:'Document management and team collaboration.',users:'All teams'},
  {name:'Box',cat:'Document',icon:'📦',desc:'Cloud content management and file sharing.',users:'All teams'},
  // --- Finance & Payments ---
  {name:'ElevenLabs',cat:'AI & Voice',icon:'🔊',desc:'AI voice synthesis, text-to-speech, and voice cloning.',users:'Communications, Marketing'},
  {name:'Juniper Networks',cat:'Finance & Networking',icon:'🌲',desc:'Network infrastructure, SD-WAN, and enterprise security.',users:'IT, Finance'},
  {name:'Bitcoin',cat:'Payments & Crypto',icon:'₿',desc:'Bitcoin payments and treasury management.',users:'Finance'},
  {name:'Ethereum',cat:'Payments & Crypto',icon:'⟠',desc:'Ethereum and smart contract payments.',users:'Finance, Development'},
  {name:'Solana',cat:'Payments & Crypto',icon:'◎',desc:'Solana high-speed blockchain payments.',users:'Finance'},
  {name:'Coinbase Commerce',cat:'Payments & Crypto',icon:'🪙',desc:'Crypto payment gateway for business transactions.',users:'Finance, E-commerce'},
  {name:'Shopify',cat:'E-commerce',icon:'🛍️',desc:'E-commerce platform for online stores and retail.',users:'Sales, Marketing'},
  {name:'Gumroad',cat:'E-commerce',icon:'💖',desc:'Digital product sales — ebooks, courses, templates.',users:'Marketing, Revenue'},
  {name:'Amazon',cat:'E-commerce',icon:'📦',desc:'Amazon marketplace, FBA, and AWS services.',users:'Sales, IT'},
  {name:'WooCommerce',cat:'E-commerce',icon:'🛒',desc:'WordPress-based e-commerce platform.',users:'Sales, Marketing'},
  {name:'PayPal',cat:'Payments & Crypto',icon:'💸',desc:'Online payment processing and money transfers.',users:'Finance, E-commerce'},
  {name:'Square',cat:'Payments & Crypto',icon:'⬜',desc:'Payment processing, POS, and business tools.',users:'Finance, Operations'},
  // --- Vibe Coding / AI Development ---
  {name:'Lovable',cat:'Vibe Coding',icon:'💜',desc:'AI-powered full-stack web app builder from prompts.',users:'Development, Product'},
  {name:'Replit',cat:'Vibe Coding',icon:'💻',desc:'Browser-based IDE with AI coding agent.',users:'Development'},
  {name:'Antigravity',cat:'Vibe Coding',icon:'🚀',desc:'AI-native app builder with OAuth and deployment.',users:'Development'},
  {name:'Cursor',cat:'Vibe Coding',icon:'▶️',desc:'AI-first code editor with inline generation and refactoring.',users:'Development'},
  {name:'Bolt',cat:'Vibe Coding',icon:'⚡',desc:'AI full-stack web app builder by StackBlitz.',users:'Development, Product'},
  {name:'v0 by Vercel',cat:'Vibe Coding',icon:'🔺',desc:'AI UI component generator from text prompts.',users:'Development, Design'},
  {name:'Windsurf',cat:'Vibe Coding',icon:'🏄',desc:'AI-powered IDE with agentic coding flows.',users:'Development'},
  {name:'Claude Code',cat:'Vibe Coding',icon:'🖥️',desc:'Anthropic terminal-based agentic coding tool.',users:'Development'},
  {name:'GitHub Copilot',cat:'Vibe Coding',icon:'🤖',desc:'AI pair programmer integrated into VS Code and IDEs.',users:'Development'},
  // --- Medical / Healthcare ---
  {name:'DrChrono',cat:'Healthcare',icon:'⚕️',desc:'Cloud-based EHR, practice management, and medical billing.',users:'Clinical, Billing'},
  {name:'Epic Systems',cat:'Healthcare',icon:'🏥',desc:'Enterprise EHR for hospitals and health systems.',users:'Clinical, Administration'},
  {name:'Cerner (Oracle Health)',cat:'Healthcare',icon:'🩺',desc:'EHR and health information technology platform.',users:'Clinical, IT'},
  {name:'athenahealth',cat:'Healthcare',icon:'🔬',desc:'Cloud-based EHR, billing, and patient engagement.',users:'Clinical, Billing'},
  {name:'Kareo',cat:'Healthcare',icon:'💊',desc:'Practice management and billing for independent practices.',users:'Clinical, Billing'},
  {name:'SimplePractice',cat:'Healthcare',icon:'🧠',desc:'Practice management for therapists and wellness professionals.',users:'Clinical, Administration'},
  {name:'Meditech',cat:'Healthcare',icon:'🏨',desc:'EHR and health information management for hospitals.',users:'Clinical, IT'},
  {name:'NextGen Healthcare',cat:'Healthcare',icon:'🩻',desc:'Ambulatory EHR and practice management.',users:'Clinical, Operations'},
  // --- AI Platforms & LLMs ---
  {name:'OpenAI',cat:'AI Platform',icon:'🟢',desc:'GPT models, DALL-E, Whisper — API and ChatGPT Enterprise.',users:'All teams'},
  {name:'Anthropic / Claude',cat:'AI Platform',icon:'🟤',desc:'Claude models — reasoning, analysis, coding, and agents.',users:'All teams'},
  {name:'Google Gemini',cat:'AI Platform',icon:'💎',desc:'Gemini models, Vertex AI, and Google AI Studio.',users:'All teams'},
  {name:'Microsoft Azure AI',cat:'AI Platform',icon:'☁️',desc:'Azure OpenAI Service, Copilot, and enterprise AI.',users:'IT, All teams'},
  {name:'xAI / Grok',cat:'AI Platform',icon:'🤘',desc:'Grok models for real-time reasoning and analysis.',users:'Research, Development'},
  {name:'OpenRouter',cat:'AI Platform',icon:'🔀',desc:'Unified API gateway to 100+ AI models.',users:'Development'},
  {name:'Hugging Face',cat:'AI Platform',icon:'🤗',desc:'Open-source model hub, inference API, and Spaces.',users:'Development, Research'},
  {name:'Perplexity',cat:'AI Platform',icon:'🔍',desc:'AI-powered search and research assistant.',users:'Research, All teams'},
  {name:'Mistral',cat:'AI Platform',icon:'🌬️',desc:'Open-weight European AI models for enterprise.',users:'Development'},
  {name:'Cohere',cat:'AI Platform',icon:'🔷',desc:'Enterprise LLMs for search, RAG, and classification.',users:'Development, Operations'},
  {name:'DeepSeek',cat:'AI Platform',icon:'🐋',desc:'High-performance open-source reasoning models.',users:'Development, Research'},
  // --- Additional Essentials ---
  {name:'Vercel',cat:'Development',icon:'▲',desc:'Frontend deployment, edge functions, and serverless.',users:'Development'},
  {name:'Supabase',cat:'Development',icon:'⚡',desc:'Open-source Firebase alternative — Postgres, auth, storage.',users:'Development'},
  {name:'Twilio SendGrid',cat:'Communication',icon:'📨',desc:'Email delivery and marketing campaigns at scale.',users:'Marketing, Communications'},
  {name:'Deepgram',cat:'AI & Voice',icon:'🎙️',desc:'AI speech-to-text transcription and voice intelligence.',users:'Communications, Operations'},
  {name:'Canva',cat:'Design',icon:'🎨',desc:'Design platform for presentations, graphics, and content.',users:'Marketing, All teams'},
  {name:'Figma',cat:'Design',icon:'🖌️',desc:'Collaborative UI/UX design and prototyping.',users:'Design, Development'},
  {name:'Tableau',cat:'Analytics',icon:'📊',desc:'Business intelligence and data visualization.',users:'Finance, Operations'},
  {name:'Power BI',cat:'Analytics',icon:'📈',desc:'Microsoft business analytics and reporting.',users:'Finance, Operations'},
  {name:'Snowflake',cat:'Data',icon:'❄️',desc:'Cloud data warehouse and analytics platform.',users:'Data, Finance'},
  {name:'Monday.com',cat:'Productivity',icon:'📅',desc:'Work management and project tracking.',users:'All teams'},
  {name:'Asana',cat:'Productivity',icon:'🔶',desc:'Project management and team coordination.',users:'All teams'},
  {name:'Linear',cat:'Development',icon:'🔵',desc:'Issue tracking and project management for dev teams.',users:'Development'},
  {name:'OpenClaw',cat:'AI Platform',icon:'🦞',desc:'AI agent gateway — multi-model orchestration and deployment.',users:'Development, Operations'},
  {name:'Latch',cat:'PropTech',icon:'🔐',desc:'Smart access and intercom systems for multifamily.',users:'Property Operations'},
  {name:'DoorKing',cat:'PropTech',icon:'🚪',desc:'Access control and entry management systems.',users:'Property Operations'},
  {name:'Brightly (Dude Solutions)',cat:'PropTech',icon:'🔧',desc:'Maintenance and facilities management platform.',users:'Maintenance, Operations'},
  {name:'Nurture Boss',cat:'PropTech',icon:'🤝',desc:'AI-powered lead nurturing for multifamily.',users:'Marketing, Leasing'},
  {name:'Geovision',cat:'PropTech',icon:'📷',desc:'Video surveillance and security camera systems.',users:'Security, Operations'},
  {name:'Nflow',cat:'PropTech',icon:'📋',desc:'Inspection and compliance workflow platform.',users:'Operations, Compliance'}
];

const TEAM_TEMPLATES = [
  {name:'Operations',color:'#3B82F6',desc:'Core operations, reporting, and process management'},
  {name:'Communications',color:'#10B981',desc:'Email, messaging, and internal/external comms'},
  {name:'Finance',color:'#8B5CF6',desc:'Accounting, budgeting, financial analysis'},
  {name:'HR & Recruitment',color:'#F59E0B',desc:'Hiring, onboarding, employee management'},
  {name:'Sales & Marketing',color:'#EC4899',desc:'Lead gen, campaigns, revenue growth'},
  {name:'Compliance',color:'#EF4444',desc:'Regulatory monitoring, policy enforcement'},
  {name:'Analytics',color:'#14B8A6',desc:'Data analysis, reporting, business intelligence'},
  {name:'Customer Service',color:'#6366F1',desc:'Support tickets, customer communication'},
  {name:'IT & Development',color:'#F97316',desc:'Software development, infrastructure management'},
  {name:'Knowledge Management',color:'#84CC16',desc:'Research, documentation, institutional memory'}
];

// ======================== DEFAULT DATA ========================
const DEFAULT_DATA = {
  version: "2.0",
  branding: { company: "RISE RE", primaryColor: "#3B82F6", logo: "" },
  executive: { name: "Courtney Gordon", title: "COO", description: "Chief Operating Officer — Human in the Loop. Final authority on all decisions. Oversees RISE RE's ~30,000 multifamily unit portfolio across multiple states.", skills: ["Strategic leadership","Portfolio oversight","Decision authority","Vendor relationships"], mcps: [], status: "active", phase: "P1", profilePic: "" },
  orchestrator: { name: "Millie", title: "Executive AI Agent", description: "Executive AI orchestrator and strategic partner. Coordinates all agent teams, synthesizes intelligence across operations, communications, HR, and finance. Decomposes business objectives into agent workflows, monitors execution quality, detects drift, and ensures all outputs meet executive standards.", skills: ["Multi-agent coordination","Strategic analysis","Workflow orchestration","Decision support","Cross-team synthesis","Quality assurance"], mcps: ["OpenClaw Gateway","n8n","Microsoft Graph API","Gmail API","Egnyte","Supabase","GitHub"], status: "active", phase: "P1", profilePic: "" },
  sharedServices: [
    { id: "research-agent", name: "Research Agent", type: "agent", description: "Cross-functional research agent serving all teams. Performs market research, competitive analysis, regulatory research, vendor evaluations, and ad-hoc deep dives.", skills: ["Web research","Data synthesis","Competitive analysis","Regulatory monitoring","Report generation","Source verification"], mcps: ["Brave Search","Web Fetch","Egnyte","Supabase"], status: "active", phase: "P1", relType: "Persona", engStyle: "Thinking Partner", humanCheckpoint: "Validate research conclusions before acting on findings", starters: ["What's the competitive landscape for our submarket?","Pull recent CoStar data for Jacksonville multifamily","Research AI trends in property management"] },
    { id: "scheduler-bot", name: "Scheduler Bot", type: "bot", description: "Centralized scheduling service for all teams. Manages calendar coordination across multiple executives and external parties.", skills: ["Calendar management","Conflict resolution","Timezone handling","Recurring event setup","Availability checking"], mcps: ["Microsoft Graph API","Google Calendar API"], status: "active", phase: "P1", relType: "Tool", engStyle: "Answer Machine", humanCheckpoint: "Review scheduling conflicts weekly", starters: ["Schedule the DLR for daily delivery at 7am","Set up a recurring weekly report for Mondays","Show all active scheduled tasks"] },
    { id: "compliance-bot", name: "Compliance Bot", type: "bot", description: "Monitors regulatory compliance, fair housing requirements, OSHA standards, and internal policy adherence across all teams.", skills: ["Regulatory monitoring","Fair housing compliance","Policy tracking","Deadline management","Violation flagging","Audit trail maintenance"], mcps: ["Entrata","Egnyte","Microsoft Graph API"], status: "planned", phase: "P2", relType: "Tool", engStyle: "Answer Machine", humanCheckpoint: "Review compliance flags before reporting violations", starters: ["Run a compliance check on our fair housing practices","Audit our lease agreement templates","Flag any overdue regulatory filings"] },
    { id: "calendar-bot", name: "Calendar Bot", type: "bot", description: "Manages executive calendar, meeting scheduling, and availability coordination across time zones.", skills: ["Calendar management","Conflict resolution","Timezone handling","Meeting scheduling"], mcps: ["Microsoft Graph API","Google Calendar API"], status: "active", phase: "P1", relType: "Tool", engStyle: "Answer Machine", humanCheckpoint: "Review scheduling conflicts weekly", starters: ["What's on my calendar tomorrow?","Find scheduling conflicts this week","Block 2 hours for deep work on Thursday"] },
    { id: "meeting-prep-bot", name: "Meeting Prep Bot", type: "bot", description: "Prepares briefing documents, attendee backgrounds, and agenda materials for upcoming meetings.", skills: ["Research","Document preparation","Attendee analysis","Action item tracking"], mcps: ["Microsoft Graph API","Egnyte","Brave Search"], status: "active", phase: "P1", relType: "Sidekick", engStyle: "Thinking Partner", humanCheckpoint: "Review prep materials before meetings", starters: ["Prep me for my 10am with the regionals","Pull background on today's meeting attendees","Summarize action items from last week's ops call"] }
  ],
  teams: [
    {
      id: "ops", name: "Ops & Reporting", color: "#3B82F6", colorClass: "blue",
      members: [
        { id: "ops-agent", name: "Ops Agent", type: "agent", isLead: true, description: "Operations team lead. Oversees all reporting workflows, property performance tracking, and operational data synthesis.", skills: ["Operational analysis","KPI tracking","Portfolio oversight","Report coordination","Data quality assurance"], mcps: ["Entrata","RealPage","Egnyte","Microsoft Graph API","Supabase","n8n"], status: "active", phase: "P1", relType: "Persona", engStyle: "Thinking Partner", humanCheckpoint: "Review strategic recommendations before implementation", starters: ["What's the status of all active reports?","Show me this week's operational metrics","Flag any properties with declining occupancy"] },
        { id: "report-gen-bot", name: "Report Generator Bot", type: "bot", isLead: false, description: "Produces all recurring operational reports: DLR, Portfolio Scorecards, WPO reports, Monthly Summaries, and Quarterly Investor Reports.", skills: ["DLR generation","Scorecard compilation","WPO reports","Data extraction","Template formatting"], mcps: ["Entrata","RealPage","Egnyte","Microsoft Graph API","Supabase"], status: "active", phase: "P1", relType: "Tool", engStyle: "Answer Machine", humanCheckpoint: "Review report accuracy before publishing", starters: ["Generate today's DLR for Bartram Park","Create a weekly performance report for all properties","Pull Q1 occupancy trends across the portfolio"] }
      ]
    },
    {
      id: "comms", name: "Comms & Email", color: "#10B981", colorClass: "green",
      members: [
        { id: "comms-agent", name: "Comms Agent", type: "agent", isLead: true, description: "Communications team lead. Manages all inbound/outbound communication workflows, email triage, and executive copywriting.", skills: ["Communication strategy","Email management","Tone calibration","Priority assessment"], mcps: ["Microsoft Graph API","Gmail API","RingCentral","Egnyte"], status: "active", phase: "P1", relType: "Persona", engStyle: "Thinking Partner", humanCheckpoint: "Review communication strategy before execution", starters: ["Summarize today's email activity","What messages need my attention?","Draft the weekly update for leadership"] },
        { id: "email-triage-bot", name: "Email Triage Bot", type: "bot", isLead: false, description: "Monitors and categorizes inbound email. Classifies by urgency and routes to appropriate agents.", skills: ["Email classification","Priority scoring","Sender recognition","Routing logic"], mcps: ["Microsoft Graph API","Gmail API"], status: "active", phase: "P1", relType: "Tool", engStyle: "Answer Machine", humanCheckpoint: "Review urgent email classifications daily", starters: ["Show me unread emails flagged as urgent","Categorize today's inbox by priority","List all emails from risere.com in the last 24 hours"] },
        { id: "auto-reply-bot", name: "Auto-Reply Bot", type: "bot", isLead: false, description: "Generates contextual responses to routine correspondence. Drafts staged for review or auto-sent.", skills: ["Response generation","Tone matching","Template management","Draft staging"], mcps: ["Microsoft Graph API"], status: "active", phase: "P1", relType: "Tool", engStyle: "Answer Machine", humanCheckpoint: "Spot-check replies weekly for tone and accuracy", starters: ["Draft a reply to this vendor inquiry","Show me auto-replies sent today","Review replies flagged for tone check"] },
        { id: "copywriting-bot", name: "Copywriting Bot", type: "bot", isLead: false, description: "Drafts executive communications: investor updates, announcements, marketing copy, LinkedIn posts.", skills: ["Executive writing","Brand voice","Investor communications","Audience adaptation"], mcps: ["Microsoft Graph API","Egnyte"], status: "active", phase: "P1", relType: "Sidekick", engStyle: "Answer Machine", humanCheckpoint: "Approve all external communications before sending", starters: ["Draft an email to the regional team about Q1 results","Write a response to this vendor proposal","Help me write a memo on the Florence Villa evaluation"] }
      ]
    },
    {
      id: "hr", name: "Recruitment & HR", color: "#F59E0B", colorClass: "orange",
      members: [
        { id: "hr-agent", name: "HR Agent", type: "agent", isLead: true, description: "HR team lead. Manages the full employee lifecycle from recruitment through onboarding.", skills: ["HR strategy","Recruitment coordination","Compliance oversight","Employee lifecycle management"], mcps: ["Paycor","Microsoft Graph API","Egnyte"], status: "planned", phase: "P2", relType: "Persona", engStyle: "Thinking Partner", humanCheckpoint: "Review HR recommendations before action", starters: ["Show open positions and pipeline status","How many interviews scheduled this week?","Flag any onboarding tasks past due"] },
        { id: "job-posting-bot", name: "Job Posting Bot", type: "bot", isLead: false, description: "Creates and distributes job postings across multiple platforms.", skills: ["Job description writing","Multi-platform posting","SEO optimization"], mcps: ["Microsoft Graph API","Egnyte"], status: "planned", phase: "P2", relType: "Tool", engStyle: "Answer Machine", humanCheckpoint: "Review job descriptions before posting", starters: ["Create a posting for a Leasing Consultant","Update the Maintenance Tech listing","Which job boards have our active postings?"] },
        { id: "bonus-bot", name: "Bonus & Commissions Bot", type: "bot", isLead: false, description: "Calculates commission structures and bonus payouts for property management staff.", skills: ["Commission calculation","Bonus computation","Performance data extraction"], mcps: ["Entrata","RealPage","Paycor","Egnyte"], status: "active", phase: "P1", relType: "Tool", engStyle: "Answer Machine", humanCheckpoint: "Review bonus calculations before payroll submission", starters: ["Calculate commissions for February","Show the leasing leaderboard this month","Pull PAF status for all eligible staff"] },
        { id: "resume-screening-bot", name: "Resume Screening Bot", type: "bot", isLead: false, description: "Screens incoming resumes and applications against job requirements, scores candidates, and flags top matches.", skills: ["Resume parsing","Candidate scoring","Requirements matching","Certification verification"], mcps: ["Microsoft Graph API","Egnyte","Paycor"], status: "planned", phase: "P2", relType: "Tool", engStyle: "Answer Machine", humanCheckpoint: "Review top candidates before advancing", starters: ["Screen today's applicants for the PM role","Show top 5 candidates by score","Flag any applications missing required certs"] },
        { id: "interview-scheduler-bot", name: "Interview Scheduler Bot", type: "bot", isLead: false, description: "Coordinates interview scheduling between candidates and hiring panels, sends confirmations and reminders.", skills: ["Calendar coordination","Candidate communication","Panel availability","Reminder management"], mcps: ["Microsoft Graph API","Google Calendar API","Paycor"], status: "planned", phase: "P2", relType: "Tool", engStyle: "Answer Machine", humanCheckpoint: "Confirm interview panels before sending invites", starters: ["Schedule interviews for shortlisted PM candidates","Find availability for the hiring panel this week","Send confirmation to tomorrow's interviewees"] },
        { id: "offer-letter-bot", name: "Offer Letter Writer Bot", type: "bot", isLead: false, description: "Generates offer letters from approved templates with correct compensation, benefits, and terms.", skills: ["Document generation","Template management","Compensation formatting","Approval routing"], mcps: ["Microsoft Graph API","Egnyte","Paycor"], status: "planned", phase: "P2", relType: "Tool", engStyle: "Answer Machine", humanCheckpoint: "Review offer letters before sending to candidates", starters: ["Generate an offer letter for the Leasing Consultant position","Update the salary in the draft offer for John Smith","Show pending offer letters awaiting approval"] },
        { id: "onboarding-bot", name: "Onboarding Bot", type: "bot", isLead: false, description: "Manages new hire onboarding checklists, system access requests, and orientation scheduling.", skills: ["Checklist management","System provisioning","Orientation scheduling","Progress tracking"], mcps: ["Microsoft Graph API","Paycor","Egnyte"], status: "planned", phase: "P2", relType: "Tool", engStyle: "Answer Machine", humanCheckpoint: "Verify onboarding completion before end of first week", starters: ["Start onboarding checklist for new hire Sarah Jones","What onboarding tasks are overdue?","Show system access requests pending IT"] },
        { id: "training-bot", name: "Training Bot", type: "bot", isLead: false, description: "Assigns and tracks employee training, certifications, and compliance education requirements.", skills: ["Training assignment","Certification tracking","Completion monitoring","Expiration alerts"], mcps: ["Paycor","Egnyte","Microsoft Graph API"], status: "planned", phase: "P2", relType: "Tool", engStyle: "Answer Machine", humanCheckpoint: "Review training compliance reports monthly", starters: ["Assign fair housing training to all new hires","Show training completion rates by property","Which certifications are expiring this month?"] }
      ]
    },
    {
      id: "finance", name: "Finance & Analytics", color: "#8B5CF6", colorClass: "purple",
      members: [
        { id: "finance-agent", name: "Finance Agent", type: "agent", isLead: true, description: "Finance team lead. Oversees all financial operations including invoice processing, budget tracking, and market intelligence.", skills: ["Financial analysis","Budget management","Forecasting","Portfolio strategy"], mcps: ["Entrata","RealPage","Paycor","Egnyte","Microsoft Graph API","CoStar"], status: "planned", phase: "P2", relType: "Persona", engStyle: "Thinking Partner", humanCheckpoint: "Validate financial analysis before presenting to leadership", starters: ["Pull this month's NOI across all properties","Show budget vs actuals for Q1","Flag invoices pending approval"] },
        { id: "market-intel-bot", name: "Market Intel Bot", type: "bot", isLead: false, description: "Tracks real estate market conditions, competitor pricing, occupancy trends, and economic indicators.", skills: ["Market monitoring","Competitor analysis","Pricing intelligence","Occupancy tracking"], mcps: ["CoStar","Apartment IQ","Brave Search","Egnyte"], status: "active", phase: "P1", relType: "Sidekick", engStyle: "Thinking Partner", humanCheckpoint: "Validate market data before strategic decisions", starters: ["What's the average rent for 2BR in our submarket?","Show competitor occupancy trends","Pull latest Apartment IQ data for Jacksonville"] },
        { id: "invoice-processing-bot", name: "Invoice Processing Bot", type: "bot", isLead: false, description: "Processes incoming invoices, validates against purchase orders, routes for approval, and tracks payment status.", skills: ["Invoice parsing","PO matching","Approval routing","Payment tracking"], mcps: ["Entrata","Egnyte","Microsoft Graph API"], status: "planned", phase: "P2", relType: "Tool", engStyle: "Answer Machine", humanCheckpoint: "Review invoices over $5K before approval", starters: ["Show invoices pending approval over $5K","Process today's incoming invoices","Flag any duplicate invoices this month"] },
        { id: "budget-tracker-bot", name: "Budget Tracker Bot", type: "bot", isLead: false, description: "Monitors budget vs actuals across properties, flags overruns, and generates variance reports.", skills: ["Budget monitoring","Variance analysis","Trend tracking","Alert management"], mcps: ["Entrata","RealPage","Egnyte"], status: "planned", phase: "P2", relType: "Tool", engStyle: "Answer Machine", humanCheckpoint: "Review variance explanations before board presentation", starters: ["Compare actuals to budget for Bartram Park","Show properties over budget on maintenance","Pull YTD variance report"] },
        { id: "noi-bot", name: "NOI Bot", type: "bot", isLead: false, description: "Calculates Net Operating Income at property and portfolio levels with trend analysis and projections.", skills: ["NOI calculation","Trend analysis","Pro-forma modeling","Portfolio aggregation"], mcps: ["Entrata","RealPage","Egnyte"], status: "planned", phase: "P2", relType: "Tool", engStyle: "Answer Machine", humanCheckpoint: "Validate NOI assumptions before investor reporting", starters: ["Calculate NOI for Bartram Park this quarter","Show NOI trends across the portfolio","Compare NOI vs underwriting projections"] },
        { id: "financial-analysis-bot", name: "Financial Analysis Bot", type: "bot", isLead: false, description: "Performs financial modeling including rent scenarios, sensitivity analysis, IRR calculations, and acquisition modeling.", skills: ["Financial modeling","Scenario analysis","IRR calculation","Sensitivity analysis"], mcps: ["Entrata","RealPage","CoStar","Egnyte"], status: "planned", phase: "P2", relType: "Persona", engStyle: "Thinking Partner", humanCheckpoint: "Review financial models before presenting to leadership", starters: ["Model a rent increase scenario for Prosper","Run sensitivity analysis on the Moody AFB deal","Calculate IRR for the proposed acquisition"] }
      ]
    }
  ],
  infrastructure: {
    approved: [
      { id: "m365", name: "Microsoft 365", description: "Email, calendar, collaboration, and productivity suite." },
      { id: "entrata", name: "Entrata", description: "Property management — leasing, accounting, resident portal." },
      { id: "egnyte", name: "Egnyte", description: "Cloud file storage and collaboration." },
      { id: "realpage", name: "RealPage/Knock", description: "Leasing, revenue management, and lead management." },
      { id: "procore", name: "Procore", description: "Construction project management." },
      { id: "paycor", name: "Paycor", description: "Payroll, HR, and benefits." },
      { id: "ringcentral", name: "RingCentral", description: "Business phone system." },
      { id: "costar", name: "CoStar", description: "Commercial real estate data and analytics." },
      { id: "apartmentiq", name: "Apartment IQ", description: "Competitive intelligence for multifamily." }
    ],
    underReview: [
      { id: "chatgpt-ent", name: "ChatGPT Enterprise", description: "Enterprise AI assistant under evaluation." },
      { id: "canva", name: "Canva", description: "Design tool for marketing materials." }
    ]
  },
  phases: ["P1","P2","P3","P4"],
  mcpHub: [
    {name:"OpenClaw Gateway",status:"active"},{name:"n8n",status:"active"},{name:"Microsoft Graph API",status:"active"},
    {name:"Gmail API",status:"active"},{name:"Google Calendar API",status:"active"},{name:"Egnyte",status:"active"},
    {name:"Supabase",status:"active"},{name:"GitHub",status:"active"},{name:"Entrata",status:"active"},
    {name:"RealPage",status:"active"},{name:"Paycor",status:"planned"},{name:"CoStar",status:"active"},
    {name:"Apartment IQ",status:"active"},{name:"Brave Search",status:"active"},{name:"Web Fetch",status:"active"},
    {name:"RingCentral",status:"inactive"},{name:"LinkedIn API",status:"planned"},{name:"Adobe Acrobat",status:"inactive"},
    {name:"Procore",status:"planned"},{name:"Brightly",status:"planned"},{name:"DocuSign",status:"planned"}
  ],
  customSkills: [],
  customInfra: []
};

// ======================== BLANK STATE (for fresh start) ========================
const BLANK_STATE = {
  version: "2.0",
  branding: { company: "My Company", primaryColor: "#3B82F6", logo: "" },
  executive: { name: "Your Name", title: "CEO / COO", description: "Executive leader — Human in the Loop. Final authority on all decisions.", skills: ["Strategic leadership","Decision authority"], mcps: [], status: "active", phase: "P1", profilePic: "" },
  orchestrator: { name: "AI Orchestrator", title: "Executive AI Agent", description: "AI orchestrator coordinating all agent teams and workflows.", skills: ["Multi-agent coordination","Workflow orchestration","Decision support"], mcps: [], status: "active", phase: "P1", profilePic: "" },
  sharedServices: [],
  teams: [],
  infrastructure: { approved: [], underReview: [] },
  phases: ["P1","P2","P3","P4"],
  mcpHub: [],
  customSkills: [],
  customInfra: []
};

// ======================== PHASE COLORS ========================
const PHASE_COLORS = { P1: '#3B82F6', P2: '#10B981', P3: '#F59E0B', P4: '#8B5CF6' };
function getPhaseColor(p) { return PHASE_COLORS[p] || '#EF4444'; }

// ======================== STATE ========================
let state;
let selectedNode = null;
let panelEditMode = false;
let panelSnapshot = null;
let libraryOpen = false;
let currentLibTab = 'industries';
let currentTab = 'canvas';
let pendingImportData = null;
let isFirstVisit = false;

function loadState() {
  const saved = localStorage.getItem('agent-orchestrator-state-v2');
  if (saved) { try { state = JSON.parse(saved); return; } catch(e) {} }
  // Try migrating v1
  const v1 = localStorage.getItem('agent-orchestrator-state');
  if (v1) { try { state = JSON.parse(v1); if (!state.mcpHub || !Array.isArray(state.mcpHub) || typeof state.mcpHub[0] === 'string') { state.mcpHub = DEFAULT_DATA.mcpHub; } if (!state.customSkills) state.customSkills = []; if (!state.customInfra) state.customInfra = []; state.version = "2.0"; saveState(); return; } catch(e) {} }
  // First visit — show template picker instead of loading RISE defaults
  state = JSON.parse(JSON.stringify(BLANK_STATE));
  isFirstVisit = true;
  saveState();
}
function saveState() { localStorage.setItem('agent-orchestrator-state-v2', JSON.stringify(state)); }

function resetToDefaults() {
  if (!confirm('Reset canvas? This will clear everything and let you choose a new template.')) return;
  state = JSON.parse(JSON.stringify(BLANK_STATE));
  // Preserve Phase 3+ settings
  if(!state.subscription)state.subscription={tier:'free',testingMode:true};
  if(!state.whiteLabel)state.whiteLabel={};
  if(!state.shareLinks)state.shareLinks=[];
  if(!state.marketplace)state.marketplace={published:[]};
  if(!state.tokenBudget)state.tokenBudget={monthly:5000,alerts:[50,75,90,100]};
  saveState(); selectedNode = null; closePanel(); render();
  showTemplatePicker();
}

// ======================== RENDER ========================
function render() {
  applyBranding();
  renderExec();
  renderShared();
  renderTeams();
  renderInfra();
  renderLegend();
  drawLines();
  document.getElementById('companyName').textContent = state.branding.company;
}

function applyBranding() {
  const b = state.branding;
  document.documentElement.style.setProperty('--brand', b.primaryColor || '#3B82F6');
  if (b.secondaryColor) document.documentElement.style.setProperty('--bg2', b.secondaryColor);
  if (b.accentColor) document.documentElement.style.setProperty('--gold', b.accentColor);
  if (b.fontFamily) document.documentElement.style.fontFamily = b.fontFamily;
  const logo = document.getElementById('brandLogo');
  if (b.logo) { logo.src = b.logo; logo.style.display = 'block'; } else { logo.style.display = 'none'; }
}

function renderExec() {
  const row = document.getElementById('execRow');
  const ex = state.executive, or = state.orchestrator;
  const exPic = ex.profilePic ? `<img class="node-avatar" src="${ex.profilePic}" alt="">` : '';
  const orPic = or.profilePic ? `<img class="node-avatar" src="${or.profilePic}" alt="">` : '';
  row.innerHTML = `
    <div class="node node-exec ${ex.status!=='active'?'inactive-node':''} ${selectedNode==='executive'?'selected':''}" onclick="selectNode('executive')">
      ${exPic}<div class="node-name">${ex.name}</div><div class="node-sub">${ex.title}</div><span class="phase-badge">${ex.phase||'P1'}</span>
    </div>
    <div class="exec-line"></div>
    <div class="node node-orch ${or.status!=='active'?'inactive-node':''} ${selectedNode==='orchestrator'?'selected':''}" onclick="selectNode('orchestrator')">
      ${orPic}<div class="node-name">◆ ${or.name}</div><div class="node-sub">${or.title}</div><span class="phase-badge">${or.phase}</span>
    </div>`;
}

function renderShared() {
  document.getElementById('sharedBar').innerHTML = state.sharedServices.map(s => `
    <div class="node ${s.status!=='active'?'inactive-node':''} ${selectedNode===s.id?'selected':''}" onclick="selectNode('${s.id}')">
      <div class="node-name">${s.type==='agent'?'🤖':'⚙️'} ${s.name}</div><div class="node-sub">${s.type}</div>
      <span class="phase-badge">${s.phase}</span>
      <div class="node-badges">${s.relType?'<span class="rel-badge rel-'+(s.relType||'Tool').toLowerCase()+'">'+s.relType+'</span>':''}${s.engStyle==='Thinking Partner'?'🧠':'⚡'}${s.humanCheckpoint?'👤':''}</div><span class="delete-btn" onclick="event.stopPropagation();deleteShared('${s.id}')">✕</span>
    </div>`).join('');
}

function renderTeams() {
  const grid = document.getElementById('teamsGrid');
  grid.innerHTML = state.teams.map(team => {
    const cls = team.colorClass || 'blue';
    const members = team.members.map((m, i) => `
      <div class="team-node" draggable="true" ondragstart="botDragStart(event,'${team.id}',${i})" ondragover="botDragOver(event)" ondrop="botDrop(event,'${team.id}',${i})" ondragend="botDragEnd(event)">
        <span class="drag-handle">⠿</span>
        <div class="node ${m.isLead?'lead-node':''} ${m.status!=='active'?'inactive-node':''} ${selectedNode===m.id?'selected':''}" onclick="selectNode('${m.id}')">
          <div class="node-name">${m.isLead?'👑 ':m.type==='agent'?'🤖 ':'⚙️ '}${m.name}${m.isLead?'<span class="lead-badge">LEAD</span>':''}</div>
          <div class="node-sub">${m.isLead?'Team Lead — ':''}${m.type}</div><span class="phase-badge">${m.phase}</span>
          <div class="node-badges">${m.relType?'<span class="rel-badge rel-'+(m.relType||'Tool').toLowerCase()+'">'+m.relType+'</span>':''}${m.engStyle==='Thinking Partner'?'🧠':'⚡'}${m.humanCheckpoint?'👤':''}</div>
          <span class="delete-btn" onclick="event.stopPropagation();deleteMember('${team.id}','${m.id}')">✕</span>
        </div>
      </div>`).join('');
    return `
      <div class="team-box team-${cls}" style="border-color:${team.color}" data-team-id="${team.id}"
           ondragover="teamBoxDragOver(event)" ondragleave="teamBoxDragLeave(event)" ondrop="teamBoxDrop(event,'${team.id}')">
        <div class="team-header" draggable="true" ondragstart="teamDragStart(event,'${team.id}')" ondragend="teamDragEnd(event)">
          <span class="team-title" style="color:${team.color}">☰ ${team.name}</span>
          <span class="delete-btn" style="display:inline-flex;position:static;width:20px;height:20px;font-size:12px" onclick="deleteTeam('${team.id}')">✕</span>
        </div>
        <div class="team-nodes">${members}</div>
      </div>`;
  }).join('');
}

function renderInfra() {
  document.getElementById('approvedItems').innerHTML = state.infrastructure.approved.map(i => `
    <span class="infra-chip" draggable="true" ondragstart="infraChipDragStart(event,'${i.id}','approved')" onclick="selectInfra('${i.id}','approved')">
      ${i.name}<span class="delete-btn" onclick="event.stopPropagation();deleteInfra('${i.id}','approved')">✕</span>
    </span>`).join('');
  document.getElementById('reviewItems').innerHTML = state.infrastructure.underReview.map(i => `
    <span class="infra-chip" draggable="true" ondragstart="infraChipDragStart(event,'${i.id}','underReview')" onclick="selectInfra('${i.id}','underReview')">
      ${i.name}<span class="delete-btn" onclick="event.stopPropagation();deleteInfra('${i.id}','underReview')">✕</span>
    </span>`).join('');
}

function renderLegend() {
  const dd = document.getElementById('legendDropdown');
  const phaseItems = state.phases.map(p => `<div style="margin-bottom:4px;display:flex;align-items:center;gap:4px"><span style="background:${getPhaseColor(p)};color:${['P3','P2'].includes(p)?'#000':'#fff'};padding:1px 6px;border-radius:3px;font-size:9px;font-weight:700">${p}</span> Phase ${p}</div>`).join('');
  dd.innerHTML = `
    <div style="margin-bottom:8px">
      <div style="margin-bottom:4px;display:flex;align-items:center;gap:4px"><div style="background:var(--gold);width:10px;height:10px;border-radius:3px"></div> Executive</div>
      <div style="margin-bottom:4px;display:flex;align-items:center;gap:4px"><div style="background:var(--brand);width:10px;height:10px;border-radius:3px"></div> Orchestrator</div>
      <div style="margin-bottom:4px;display:flex;align-items:center;gap:4px"><div style="background:var(--teal);width:10px;height:10px;border-radius:3px"></div> Shared Service</div>
      ${state.teams.map(t => `<div style="margin-bottom:4px;display:flex;align-items:center;gap:4px"><div style="background:${t.color};width:10px;height:10px;border-radius:3px"></div> ${t.name}</div>`).join('')}
    </div>
    <div style="padding-top:6px;border-top:1px solid var(--border)"><div style="font-size:10px;font-weight:700;color:var(--text3);margin-bottom:4px;text-transform:uppercase">Phases</div>${phaseItems}</div>`;
}

function toggleLegend() { document.getElementById('legendDropdown').classList.toggle('show'); }
document.addEventListener('click', e => { if (!e.target.closest('.legend-wrapper')) document.getElementById('legendDropdown').classList.remove('show'); });

function drawLines() {
  const svg = document.getElementById('linesSvg');
  const count = state.teams.length;
  const w = svg.clientWidth, h = 40, cx = w / 2;
  let paths = '';
  if (count > 0) {
    const spacing = Math.min(w * 0.7 / count, 200);
    const startX = cx - (count - 1) * spacing / 2;
    for (let i = 0; i < count; i++) {
      const ex = startX + i * spacing;
      paths += `<line x1="${cx}" y1="0" x2="${ex}" y2="${h}" stroke="#94a3b8" stroke-width="2"/>`;
      paths += `<line x1="${cx}" y1="2" x2="${ex}" y2="${h}" stroke="#14B8A6" stroke-width="1.5" stroke-dasharray="6,4" opacity="0.5"/>`;
    }
  }
  svg.innerHTML = paths;
}

// ======================== DETAIL PANEL ========================
function selectNode(nodeId) {
  selectedNode = nodeId; panelEditMode = false; panelSnapshot = null;
  if (nodeId === 'executive' || nodeId === 'orchestrator') renderExecPanel(nodeId);
  else {
    const ss = state.sharedServices.find(s => s.id === nodeId);
    if (ss) renderBotPanel(ss, 'shared', null);
    else {
      for (const t of state.teams) { const m = t.members.find(m => m.id === nodeId); if (m) { renderBotPanel(m, 'team', t.id); break; } }
    }
  }
  document.getElementById('detailPanel').classList.add('open');
  document.getElementById('mainContent').classList.add('panel-open');
  render();
}

function esc(s) { return (s||'').replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

function renderExecPanel(nodeId) {
  const data = nodeId === 'executive' ? state.executive : state.orchestrator;
  const label = nodeId === 'executive' ? 'Executive' : 'Orchestrator';
  const content = document.getElementById('panelContent');
  const picSrc = data.profilePic || '';
  const editing = panelEditMode;
  content.innerHTML = `
    <div class="${editing?'edit-mode':''}">
    <div class="panel-header"><div class="panel-type">${label}</div></div>
    <div class="panel-section"><h4>Profile Picture</h4>
      <div class="profile-upload-area">
        <div class="profile-pic-preview">${picSrc?`<img src="${picSrc}">`:'<span style="color:var(--text3);font-size:20px">👤</span>'}</div>
        ${editing?`<div><input type="file" accept="image/*" id="ppUpload" style="display:none" onchange="handleProfileUpload('${nodeId}')">
          <button class="btn btn-outline" onclick="document.getElementById('ppUpload').click()">Upload</button>
          ${picSrc?`<button class="btn btn-outline" style="margin-left:4px" onclick="removeProfilePic('${nodeId}')">Remove</button>`:''}</div>`:''}
      </div>
    </div>
    <div class="form-group"><label>Name</label>${editing?`<input id="pName" value="${esc(data.name)}">`:`<div class="view-field">${esc(data.name)}</div>`}</div>
    <div class="form-group"><label>Title</label>${editing?`<input id="pTitle" value="${esc(data.title)}">`:`<div class="view-field">${esc(data.title)}</div>`}</div>
    <div class="panel-section"><h4>Status</h4>
      ${editing?`<div class="status-toggle" id="statusToggle"><button class="active-btn ${data.status==='active'?'sel':''}" onclick="toggleStatus('active')" data-val="active">Active</button><button class="inactive-btn ${data.status!=='active'?'sel':''}" onclick="toggleStatus('inactive')" data-val="inactive">Inactive</button></div>`:`<span class="panel-status ${data.status==='active'?'status-active':'status-inactive'}">${data.status||'active'}</span>`}
    </div>
    <div class="form-group"><label>Phase</label>${editing?`<select id="pPhase">${state.phases.map(p=>`<option value="${p}" ${data.phase===p?'selected':''}>${p}</option>`).join('')}</select>`:`<div class="view-field">${esc(data.phase||'P1')}</div>`}</div>
    <div class="form-group"><label>Job Description <button class="btn btn-outline" style="padding:2px 6px;font-size:10px;margin-left:6px" onclick="openJdModal('${nodeId}')">↗</button></label>
      ${editing?`<textarea id="pDesc" rows="4" style="margin-bottom:4px">${esc(data.description)}</textarea>`:`<div class="view-field multiline">${esc(data.description)}</div>`}
    </div>
    <div class="panel-section"><h4>Skills</h4><div class="chip-container" id="pSkills"></div></div>
    <div class="panel-section"><h4>MCP / Connectors</h4><div class="chip-container" id="pMcps"></div></div>
    <div class="form-actions" style="margin-top:20px">
      ${editing?`<button class="btn btn-outline" onclick="cancelEdit('${nodeId}')">Cancel</button><button class="btn btn-green" onclick="acceptExecPanel('${nodeId}')">✔ Accept</button>`:`<button class="btn btn-primary" onclick="enterEditMode('${nodeId}')">✏️ Edit</button>`}
    </div></div>`;
  renderChips('pSkills', data.skills || [], editing);
  renderMcpChips('pMcps', data.mcps || [], editing);
}

function renderBotPanel(data, location, teamId) {
  const content = document.getElementById('panelContent');
  const editing = panelEditMode;
  const teamOptions = state.teams.map(t => `<option value="${t.id}" ${teamId===t.id?'selected':''}>${t.name}</option>`).join('');
  content.innerHTML = `
    <div class="${editing?'edit-mode':''}">
    <div class="panel-header"><div class="panel-type">${data.type || 'bot'}</div></div>
    <div class="form-group"><label>Name</label>${editing?`<input id="pName" value="${esc(data.name)}">`:`<div class="view-field">${esc(data.name)}</div>`}</div>
    <div class="form-group"><label>Team</label>${editing?`<select id="pTeam">${teamOptions}<option value="shared" ${location==='shared'?'selected':''}>Shared Services</option></select>`:`<div class="view-field">${location==='shared'?'Shared Services':(state.teams.find(t=>t.id===teamId)?.name||teamId)}</div>`}</div>
    <div class="form-group"><label>Phase</label>${editing?`<select id="pPhase">${state.phases.map(p=>`<option value="${p}" ${data.phase===p?'selected':''}>${p}</option>`).join('')}</select>`:`<div class="view-field">${esc(data.phase)}</div>`}</div>
    <div class="panel-section"><h4>Status</h4>
      ${editing?`<div class="status-toggle" id="statusToggle"><button class="active-btn ${data.status==='active'?'sel':''}" onclick="toggleStatus('active')" data-val="active">Active</button><button class="inactive-btn ${data.status!=='active'?'sel':''}" onclick="toggleStatus('inactive')" data-val="inactive">Inactive</button></div>`:`<span class="panel-status ${data.status==='active'?'status-active':data.status==='planned'?'status-planned':'status-inactive'}">${data.status||'planned'}</span>`}
    </div>
    <div class="panel-section"><h4>Relationship Type</h4>
      ${editing?`<select id="pRelType"><option value="Tool" ${data.relType==='Tool'?'selected':''}>🔧 Tool</option><option value="Sidekick" ${data.relType==='Sidekick'?'selected':''}>🤝 Sidekick</option><option value="Persona" ${data.relType==='Persona'?'selected':''}>🧠 Persona</option></select>`:`<div class="view-field">${({'Tool':'🔧 Tool — Pure function. Use once, get result.','Sidekick':'🤝 Sidekick — Adapts and collaborates.','Persona':'🧠 Persona — Extends thinking. Tests ideas.'}[data.relType])||'Not set'}</div>`}
    </div>
    <div class="panel-section"><h4>Engagement Style</h4>
      ${editing?`<select id="pEngStyle"><option value="Answer Machine" ${data.engStyle==='Answer Machine'?'selected':''}>⚡ Answer Machine</option><option value="Thinking Partner" ${data.engStyle==='Thinking Partner'?'selected':''}>🧠 Thinking Partner</option></select>`:`<div class="view-field">${data.engStyle==='Thinking Partner'?'🧠 Thinking Partner — Options, rationale, trade-offs':'⚡ Answer Machine — Direct outputs'}</div>`}
    </div>
    <div class="panel-section"><h4>Human Checkpoint 👤</h4>
      ${editing?`<input id="pHumanCheckpoint" value="${esc(data.humanCheckpoint||'')}" placeholder="Where does the human review/approve?">`:`<div class="view-field">${esc(data.humanCheckpoint||'Not defined')}</div>`}
    </div>
    <div class="form-group"><label>Job Description <button class="btn btn-outline" style="padding:2px 6px;font-size:10px;margin-left:6px" onclick="openJdModal('${data.id}')">↗</button></label>
      ${editing?`<textarea id="pDesc" rows="4" style="margin-bottom:4px">${esc(data.description)}</textarea>`:`<div class="view-field multiline">${esc(data.description)}</div>`}
    </div>
    <div class="panel-section"><h4>Skills</h4><div class="chip-container" id="pSkills"></div></div>
    <div class="panel-section"><h4>MCP / Connectors</h4><div class="chip-container" id="pMcps"></div></div>
    <div class="panel-section"><h4>💬 Conversation Starters</h4><div id="pStarters">${(data.starters||[]).map((s,i)=>editing?`<div class="starter-chip" style="display:flex;align-items:center;gap:6px"><input value="${esc(s)}" class="starter-input" style="flex:1;background:var(--bg);border:1px solid var(--border);border-radius:4px;padding:4px 8px;color:var(--text);font-size:12px" data-idx="${i}"><span style="cursor:pointer;color:var(--red);font-size:14px" onclick="this.parentElement.remove()">✕</span></div>`:`<div class="starter-chip">${esc(s)}</div>`).join('')}${editing?`<button class="btn btn-outline btn-sm" style="margin-top:6px" onclick="document.getElementById('pStarters').insertAdjacentHTML('beforeend','<div class=\\'starter-chip\\' style=\\'display:flex;align-items:center;gap:6px\\'><input class=\\'starter-input\\' style=\\'flex:1;background:var(--bg);border:1px solid var(--border);border-radius:4px;padding:4px 8px;color:var(--text);font-size:12px\\' placeholder=\\'New conversation starter...\\'><span style=\\'cursor:pointer;color:var(--red);font-size:14px\\' onclick=\\'this.parentElement.remove()\\'>✕</span></div>')">+ Add Starter</button>`:''}</div>${!(data.starters||[]).length&&!editing?'<div style="color:var(--text3);font-size:12px;padding:8px 0;font-style:italic">No conversation starters yet — click Edit to add some</div>':''}</div>
    <div class="form-actions" style="margin-top:20px">
      ${editing?`<button class="btn btn-outline" onclick="cancelEdit('${data.id}')">Cancel</button><button class="btn btn-green" onclick="acceptBotPanel('${data.id}','${location}','${teamId}')">✔ Accept</button>`:`<button class="btn btn-primary" onclick="enterEditMode('${data.id}')">✏️ Edit</button>`}
    </div></div>`;
  renderChips('pSkills', data.skills || [], editing);
  renderMcpChips('pMcps', data.mcps || [], editing);
}

function renderInfraPanel(data, section) {
  document.getElementById('panelContent').innerHTML = `
    <div class="panel-header"><h2>${data.name}</h2><div class="panel-type">Infrastructure (${section === 'approved' ? 'Approved' : 'Under Review'})</div></div>
    <div class="panel-section"><h4>Description</h4><p>${data.description || 'No description.'}</p></div>`;
}

function toggleStatus(val) {
  const toggle = document.getElementById('statusToggle');
  if (!toggle) return;
  toggle.querySelectorAll('button').forEach(b => { b.classList.remove('sel'); if (b.dataset.val === val) b.classList.add('sel'); });
}

function enterEditMode(nodeId) {
  panelSnapshot = JSON.parse(JSON.stringify(state));
  panelEditMode = true;
  if (nodeId === 'executive' || nodeId === 'orchestrator') renderExecPanel(nodeId);
  else { const ss = state.sharedServices.find(s => s.id === nodeId); if (ss) renderBotPanel(ss, 'shared', null); else { for (const t of state.teams) { const m = t.members.find(m => m.id === nodeId); if (m) { renderBotPanel(m, 'team', t.id); break; } } } }
}

function cancelEdit(nodeId) {
  if (panelSnapshot) { state = panelSnapshot; saveState(); }
  panelEditMode = false; panelSnapshot = null; selectNode(nodeId);
}

function acceptExecPanel(nodeId) {
  const data = nodeId === 'executive' ? state.executive : state.orchestrator;
  data.name = document.getElementById('pName').value.trim() || data.name;
  data.title = document.getElementById('pTitle').value.trim() || data.title;
  data.phase = document.getElementById('pPhase').value;
  data.description = document.getElementById('pDesc').value;
  const selBtn = document.querySelector('#statusToggle .sel');
  if (selBtn) data.status = selBtn.dataset.val;
  data.skills = getChipArray('pSkills');
  data.mcps = getChipArray('pMcps');
  panelEditMode = false; panelSnapshot = null;
  saveState(); render(); selectNode(nodeId);
  showToast(`✅ ${data.name} updated!`);
}

function acceptBotPanel(botId, location, origTeamId) {
  let bot, srcArr, srcIdx;
  if (location === 'shared') { srcIdx = state.sharedServices.findIndex(s => s.id === botId); if (srcIdx >= 0) { bot = state.sharedServices[srcIdx]; srcArr = state.sharedServices; } }
  else { const team = state.teams.find(t => t.id === origTeamId); if (team) { srcIdx = team.members.findIndex(m => m.id === botId); if (srcIdx >= 0) { bot = team.members[srcIdx]; srcArr = team.members; } } }
  if (!bot) return;
  bot.name = document.getElementById('pName').value.trim() || bot.name;
  bot.phase = document.getElementById('pPhase').value;
  bot.description = document.getElementById('pDesc').value;
  const selBtn = document.querySelector('#statusToggle .sel');
  if (selBtn) bot.status = selBtn.dataset.val;
  bot.skills = getChipArray('pSkills');
  bot.mcps = getChipArray('pMcps');
  const pRelType = document.getElementById('pRelType'); if(pRelType) bot.relType = pRelType.value;
  const pEngStyle = document.getElementById('pEngStyle'); if(pEngStyle) bot.engStyle = pEngStyle.value;
  const pHC = document.getElementById('pHumanCheckpoint'); if(pHC) bot.humanCheckpoint = pHC.value;
  bot.starters = Array.from(document.querySelectorAll('#pStarters .starter-input')).map(i=>i.value.trim()).filter(Boolean);
  const newTeamId = document.getElementById('pTeam').value;
  const currentLoc = location === 'shared' ? 'shared' : origTeamId;
  if (newTeamId !== currentLoc) {
    srcArr.splice(srcIdx, 1);
    if (newTeamId === 'shared') state.sharedServices.push(bot);
    else { const nt = state.teams.find(t => t.id === newTeamId); if (nt) nt.members.push(bot); }
  }
  panelEditMode = false; panelSnapshot = null;
  saveState(); render(); selectNode(botId);
  showToast(`✅ ${bot.name} updated!`);
}

// ======================== CHIPS ========================
function renderChips(containerId, items, editable) {
  const c = document.getElementById(containerId); if (!c) return;
  c.innerHTML = '';
  items.forEach((item, idx) => {
    const chip = document.createElement('span');
    chip.className = 'chip'; chip.draggable = editable; chip.dataset.idx = idx;
    chip.innerHTML = `${esc(item)} <span class="chip-x" onclick="removeChip('${containerId}',${idx})">✕</span>`;
    c.appendChild(chip);
  });
  const addBtn = document.createElement('span');
  addBtn.className = 'chip-add'; addBtn.textContent = '+ Add';
  addBtn.onclick = () => { const val = prompt('Add skill:'); if (!val?.trim()) return; const arr = getChipArray(containerId); arr.push(val.trim()); renderChips(containerId, arr, true); };
  c.appendChild(addBtn);
}

function renderMcpChips(containerId, items, editable) {
  const c = document.getElementById(containerId); if (!c) return;
  c.innerHTML = '';
  items.forEach((item, idx) => {
    const chip = document.createElement('span');
    chip.className = 'chip'; chip.dataset.idx = idx;
    chip.innerHTML = `${esc(item)} <span class="chip-x" onclick="removeMcpChip('${containerId}',${idx})">✕</span>`;
    c.appendChild(chip);
  });
  const addBtn = document.createElement('span');
  addBtn.className = 'chip-add'; addBtn.textContent = '+ Add';
  addBtn.onclick = (e) => {
    e.stopPropagation();
    document.querySelectorAll('.mcp-dropdown').forEach(d=>d.remove());
    const currentMcps = getChipArray(containerId);
    const allOptions = [];
    state.infrastructure.approved.forEach(i => { if (!allOptions.includes(i.name)) allOptions.push(i.name); });
    (state.mcpHub||[]).forEach(m => { const n = typeof m === 'string' ? m : m.name; if (!allOptions.includes(n)) allOptions.push(n); });
    const available = allOptions.filter(o => !currentMcps.includes(o)).sort();
    if (!available.length) { showToast('All connectors assigned'); return; }
    const dd = document.createElement('div'); dd.className = 'mcp-dropdown'; dd.style.position = 'absolute';
    available.forEach(opt => { const item = document.createElement('div'); item.className = 'mcp-dropdown-item'; item.textContent = opt; item.onclick = () => { const arr = getChipArray(containerId); arr.push(opt); renderMcpChips(containerId, arr, true); dd.remove(); }; dd.appendChild(item); });
    addBtn.style.position = 'relative'; addBtn.appendChild(dd);
    setTimeout(() => { const close = ev => { if (!dd.contains(ev.target)) { dd.remove(); document.removeEventListener('click', close); } }; document.addEventListener('click', close); }, 10);
  };
  c.appendChild(addBtn);
}

function getChipArray(containerId) { return Array.from(document.getElementById(containerId).querySelectorAll('.chip')).map(ch => ch.textContent.replace('✕','').trim()); }
function removeChip(cid, idx) { const arr = getChipArray(cid); arr.splice(idx, 1); renderChips(cid, arr, panelEditMode); }
function removeMcpChip(cid, idx) { const arr = getChipArray(cid); arr.splice(idx, 1); renderMcpChips(cid, arr, panelEditMode); }

// ======================== JOB DESCRIPTION MODAL ========================
let jdTarget = null;
function openJdModal(nodeId) {
  jdTarget = nodeId; const data = getNodeData(nodeId); if (!data) return;
  document.getElementById('jdModalTitle').textContent = `Job Description — ${data.name}`;
  const cd = document.getElementById('jdModalContent'), sb = document.getElementById('jdSaveBtn');
  if (panelEditMode) { cd.innerHTML = `<textarea id="jdTextarea" style="min-height:300px;width:100%;resize:vertical;font-size:14px;line-height:1.6">${esc(data.description)}</textarea>`; sb.style.display = ''; }
  else { cd.innerHTML = `<div class="jd-view">${esc(data.description)}</div>`; sb.style.display = 'none'; }
  document.getElementById('jdModal').classList.add('show');
}
function closeJdModal() { document.getElementById('jdModal').classList.remove('show'); jdTarget = null; }
function saveJdModal() {
  if (!jdTarget) return;
  const ta = document.getElementById('jdTextarea'); if (!ta) return;
  const pDesc = document.getElementById('pDesc'); if (pDesc) pDesc.value = ta.value;
  const data = getNodeData(jdTarget); if (data) data.description = ta.value;
  closeJdModal(); showToast('Job description updated');
}
function getNodeData(id) {
  if (id === 'executive') return state.executive;
  if (id === 'orchestrator') return state.orchestrator;
  const ss = state.sharedServices.find(s => s.id === id); if (ss) return ss;
  for (const t of state.teams) { const m = t.members.find(m => m.id === id); if (m) return m; }
  return null;
}

// ======================== PROFILE PIC ========================
function handleProfileUpload(nodeId) {
  const file = document.getElementById('ppUpload').files[0]; if (!file) return;
  const r = new FileReader();
  r.onload = e => { (nodeId==='executive'?state.executive:state.orchestrator).profilePic = e.target.result; saveState(); render(); selectNode(nodeId); showToast('📸 Updated!'); };
  r.readAsDataURL(file);
}
function removeProfilePic(nodeId) { (nodeId==='executive'?state.executive:state.orchestrator).profilePic = ''; saveState(); render(); selectNode(nodeId); }

function closePanel() {
  document.getElementById('detailPanel').classList.remove('open');
  document.getElementById('mainContent').classList.remove('panel-open');
  selectedNode = null; panelEditMode = false; panelSnapshot = null; render();
}

function selectInfra(id, section) {
  selectedNode = id; panelEditMode = false;
  const item = (section==='approved'?state.infrastructure.approved:state.infrastructure.underReview).find(i=>i.id===id);
  if (item) renderInfraPanel(item, section);
  document.getElementById('detailPanel').classList.add('open');
  document.getElementById('mainContent').classList.add('panel-open');
  render();
}

// ======================== DRAG & DROP ========================
let dragTeam=null, dragIdx=null, dragTeamId=null, dragInfraId=null, dragInfraSrc=null;
function botDragStart(e,teamId,idx){dragTeam=teamId;dragIdx=idx;e.dataTransfer.effectAllowed='move';e.target.style.opacity='0.5'}
function botDragOver(e){e.preventDefault()}
function botDrop(e,targetTeam,targetIdx){e.preventDefault();if(dragTeam===null)return;const s=state.teams.find(t=>t.id===dragTeam),d=state.teams.find(t=>t.id===targetTeam);if(!s||!d)return;if(dragTeam===targetTeam){const[item]=s.members.splice(dragIdx,1);s.members.splice(targetIdx,0,item);}saveState();render()}
function botDragEnd(e){e.target.style.opacity='1';dragTeam=null;dragIdx=null}
function teamDragStart(e,teamId){dragTeamId=teamId;e.dataTransfer.effectAllowed='move';e.dataTransfer.setData('text/plain',teamId);setTimeout(()=>{const b=document.querySelector(`[data-team-id="${teamId}"]`);if(b)b.style.opacity='0.4';},0)}
function teamDragEnd(e){dragTeamId=null;document.querySelectorAll('.team-box').forEach(b=>{b.style.opacity='1';b.classList.remove('drag-over-team')})}
function teamBoxDragOver(e){e.preventDefault();
  // Handle library bot drops
  if(e.dataTransfer.types.includes('application/library-bot')){e.currentTarget.classList.add('drop-target');return}
  if(dragTeamId)e.currentTarget.classList.add('drag-over-team')}
function teamBoxDragLeave(e){e.currentTarget.classList.remove('drag-over-team');e.currentTarget.classList.remove('drop-target')}
function teamBoxDrop(e,targetTeamId){
  e.preventDefault();e.currentTarget.classList.remove('drag-over-team');e.currentTarget.classList.remove('drop-target');
  // Library bot drop
  const libBot = e.dataTransfer.getData('application/library-bot');
  if(libBot){const bot=JSON.parse(libBot);const team=state.teams.find(t=>t.id===targetTeamId);if(team){const id=bot.name.toLowerCase().replace(/[^a-z0-9]+/g,'-')+'-'+Date.now();team.members.push({id,name:bot.name,type:'bot',isLead:false,description:bot.desc,skills:bot.skills||[],mcps:bot.mcps||[],status:'planned',phase:'P1',relType:bot.relType||'Tool',engStyle:bot.engStyle||'Answer Machine',humanCheckpoint:bot.humanCheckpoint||'',starters:bot.starters||[]});saveState();render();showToast(`✅ ${bot.name} added to ${team.name}`);}return}
  // Library infra drop - ignore
  if(e.dataTransfer.getData('application/library-infra'))return;
  // Team reorder
  if(!dragTeamId||dragTeamId===targetTeamId)return;
  const fi=state.teams.findIndex(t=>t.id===dragTeamId),ti=state.teams.findIndex(t=>t.id===targetTeamId);
  if(fi<0||ti<0)return;const[moved]=state.teams.splice(fi,1);state.teams.splice(ti,0,moved);dragTeamId=null;saveState();render();showToast('Teams reordered')}

function reorganizeTeams(){saveState();render();showToast('⟳ Reorganized')}

function infraChipDragStart(e,id,src){dragInfraId=id;dragInfraSrc=src;e.dataTransfer.effectAllowed='move';e.target.style.opacity='0.5'}
function infraDragOver(e,target){e.preventDefault();
  if(e.dataTransfer.types.includes('application/library-infra')){e.currentTarget.classList.add(target==='approved'?'drop-zone-active':'drop-zone-review-active');return}
  if(target==='approved')e.currentTarget.classList.add('drop-zone-active');else e.currentTarget.classList.add('drop-zone-review-active')}
function infraDragLeave(e){e.currentTarget.classList.remove('drop-zone-active');e.currentTarget.classList.remove('drop-zone-review-active')}
function infraDrop(e,target){
  e.preventDefault();e.currentTarget.classList.remove('drop-zone-active');e.currentTarget.classList.remove('drop-zone-review-active');
  // Library infra drop
  const libInfra = e.dataTransfer.getData('application/library-infra');
  if(libInfra){const inf=JSON.parse(libInfra);const id=inf.name.toLowerCase().replace(/[^a-z0-9]+/g,'-');const dstArr=target==='approved'?state.infrastructure.approved:state.infrastructure.underReview;if(!dstArr.find(i=>i.name===inf.name)){dstArr.push({id,name:inf.name,description:inf.desc||inf.name});saveState();render();showToast(`✅ ${inf.name} added to ${target==='approved'?'Approved':'Under Review'}`);}else showToast(`${inf.name} already exists`);return}
  if(!dragInfraId)return;
  const srcArr=dragInfraSrc==='approved'?state.infrastructure.approved:state.infrastructure.underReview;
  const dstArr=target==='approved'?state.infrastructure.approved:state.infrastructure.underReview;
  if((dragInfraSrc==='approved'&&target==='approved')||(dragInfraSrc==='underReview'&&target==='underReview')){dragInfraId=null;dragInfraSrc=null;return}
  const idx=srcArr.findIndex(i=>i.id===dragInfraId);if(idx===-1){dragInfraId=null;return}
  const[item]=srcArr.splice(idx,1);dstArr.push(item);
  dragInfraId=null;dragInfraSrc=null;saveState();render();showToast(`Moved to ${target==='approved'?'Approved':'Under Review'}`)}

// ======================== DELETE ========================
function deleteShared(id){if(!confirm(`Delete "${state.sharedServices.find(s=>s.id===id)?.name}"?`))return;state.sharedServices=state.sharedServices.filter(s=>s.id!==id);if(selectedNode===id)closePanel();saveState();render()}
function deleteMember(teamId,memberId){const team=state.teams.find(t=>t.id===teamId);if(!team)return;const m=team.members.find(m=>m.id===memberId);if(!confirm(`Delete "${m?.name}"?`))return;team.members=team.members.filter(m=>m.id!==memberId);if(selectedNode===memberId)closePanel();saveState();render()}
function deleteTeam(teamId){if(!confirm(`Delete entire team "${state.teams.find(t=>t.id===teamId)?.name}"?`))return;state.teams=state.teams.filter(t=>t.id!==teamId);saveState();render()}
function deleteInfra(id,section){const arr=section==='approved'?state.infrastructure.approved:state.infrastructure.underReview;const item=arr.find(i=>i.id===id);if(!confirm(`Remove "${item?.name}"?`))return;if(section==='approved')state.infrastructure.approved=arr.filter(i=>i.id!==id);else state.infrastructure.underReview=arr.filter(i=>i.id!==id);if(selectedNode===id)closePanel();saveState();render()}

// ======================== ADD MODAL ========================
function showAddModal(){document.getElementById('addModal').classList.add('show');populateTeamSelect();populatePhaseSelect();updateAddForm()}
function closeAddModal(){document.getElementById('addModal').classList.remove('show')}
function populateTeamSelect(){document.getElementById('addTeam').innerHTML=state.teams.map(t=>`<option value="${t.id}">${t.name}</option>`).join('')+'<option value="shared">Shared Services</option>'}
function populatePhaseSelect(){document.getElementById('addPhase').innerHTML=state.phases.map(p=>`<option value="${p}">${p}</option>`).join('')+'<option value="__new">+ Add Phase</option>'}
function updateAddForm(){const c=document.getElementById('addCategory').value;document.getElementById('addTeamGroup').style.display=(c==='bot'||c==='agent')?'':'none';document.getElementById('addDescGroup').style.display=c!=='team'?'':'none';document.getElementById('addPhaseGroup').style.display=(c==='bot'||c==='agent')?'':'none';document.getElementById('addColorGroup').style.display=c==='team'?'':'none';document.getElementById('addInfraSectionGroup').style.display=c==='infrastructure'?'':'none'}
function addItem(){
  const cat=document.getElementById('addCategory').value,name=document.getElementById('addName').value.trim();
  if(!name){alert('Name required');return}
  const desc=document.getElementById('addDesc').value.trim();
  let phase=document.getElementById('addPhase').value;
  if(phase==='__new'){phase=prompt('New phase:');if(!phase)return;if(!state.phases.includes(phase))state.phases.push(phase)}
  const id=name.toLowerCase().replace(/[^a-z0-9]+/g,'-')+'-'+Date.now();
  if(cat==='bot'||cat==='agent'){const teamId=document.getElementById('addTeam').value;const item={id,name,type:cat,isLead:false,description:desc,skills:[],mcps:[],status:'planned',phase};if(teamId==='shared')state.sharedServices.push(item);else{const team=state.teams.find(t=>t.id===teamId);if(team)team.members.push(item)}}
  else if(cat==='team'){state.teams.push({id,name,color:document.getElementById('addColor').value,colorClass:'blue',members:[]})}
  else if(cat==='infrastructure'){const sec=document.getElementById('addInfraSection').value;const item={id,name,description:desc};if(sec==='approved')state.infrastructure.approved.push(item);else state.infrastructure.underReview.push(item)}
  saveState();render();closeAddModal();document.getElementById('addName').value='';document.getElementById('addDesc').value='';showToast(`Added "${name}"`)
}

// ======================== BRANDING ========================
function showBranding(){const b=state.branding;document.getElementById('brandCompany').value=b.company;document.getElementById('brandColorPicker').value=b.primaryColor||'#3B82F6';document.getElementById('brandColorHex').value=b.primaryColor||'#3B82F6';document.getElementById('brandSecondaryPicker').value=b.secondaryColor||'#1e293b';document.getElementById('brandSecondaryHex').value=b.secondaryColor||'#1e293b';document.getElementById('brandAccentPicker').value=b.accentColor||'#F5A623';document.getElementById('brandAccentHex').value=b.accentColor||'#F5A623';document.getElementById('removeLogoBtn').style.display=b.logo?'':'none';document.getElementById('brandingModal').classList.add('show')}
function closeBranding(){document.getElementById('brandingModal').classList.remove('show')}
function previewAllBrandColors(){const pc=document.getElementById('brandColorHex').value,sc=document.getElementById('brandSecondaryHex').value,ac=document.getElementById('brandAccentHex').value;if(/^#[0-9a-fA-F]{6}$/.test(pc))document.documentElement.style.setProperty('--brand',pc);if(/^#[0-9a-fA-F]{6}$/.test(sc))document.documentElement.style.setProperty('--bg2',sc);if(/^#[0-9a-fA-F]{6}$/.test(ac))document.documentElement.style.setProperty('--gold',ac);const fs=document.getElementById('brandFontSelect'),fc=document.getElementById('brandFontCustom');if(fs.value==='__custom'){fc.style.display='';if(fc.value)document.documentElement.style.fontFamily=fc.value}else{fc.style.display='none';document.documentElement.style.fontFamily=fs.value}}
function handleGuidelinesUpload(){const f=document.getElementById('brandGuidelinesUpload').files[0];if(!f)return;state.branding.guidelinesFile=f.name;saveState();const fn=document.getElementById('guidelinesFileName');fn.textContent='📎 '+f.name;fn.style.display='';showToast('Guidelines uploaded')}
function handleLogoUpload(){const f=document.getElementById('brandLogoUpload').files[0];if(!f)return;const r=new FileReader();r.onload=e=>{state.branding.logo=e.target.result;saveState();render();document.getElementById('removeLogoBtn').style.display='';showToast('Logo uploaded')};r.readAsDataURL(f)}
function removeLogo(){state.branding.logo='';saveState();render();document.getElementById('removeLogoBtn').style.display='none'}
function saveBranding(){const b=state.branding;b.company=document.getElementById('brandCompany').value.trim()||b.company;const pc=document.getElementById('brandColorHex').value;if(/^#[0-9a-fA-F]{6}$/.test(pc))b.primaryColor=pc;const sc=document.getElementById('brandSecondaryHex').value;if(/^#[0-9a-fA-F]{6}$/.test(sc))b.secondaryColor=sc;const ac=document.getElementById('brandAccentHex').value;if(/^#[0-9a-fA-F]{6}$/.test(ac))b.accentColor=ac;const fs=document.getElementById('brandFontSelect'),fc=document.getElementById('brandFontCustom');b.fontFamily=fs.value==='__custom'?fc.value:fs.value;saveState();render();closeBranding();showToast('Branding updated')}

// ======================== LIBRARY DRAWER ========================
function toggleLibrary(){
  libraryOpen=!libraryOpen;
  document.getElementById('libraryDrawer').classList.toggle('open',libraryOpen);
  document.getElementById('libraryToggle').classList.toggle('lib-open',libraryOpen);
  document.getElementById('mainContent').classList.toggle('library-open',libraryOpen);
  if(libraryOpen)renderLibrary();
}

function switchLibTab(tab){currentLibTab=tab;document.querySelectorAll('.library-tab').forEach(t=>t.classList.toggle('active',t.dataset.libTab===tab));renderLibrary()}

function filterLibrary(){renderLibrary()}

function renderLibrary(){
  const q=(document.getElementById('librarySearch').value||'').toLowerCase();
  const c=document.getElementById('libraryContent');
  if(currentLibTab==='industries')renderIndustryLib(c,q);
  else if(currentLibTab==='teams')renderTeamLib(c,q);
  else if(currentLibTab==='bots')renderBotLib(c,q);
  else if(currentLibTab==='skills')renderSkillLib(c,q);
  else if(currentLibTab==='infra')renderInfraLib(c,q);
}

function renderIndustryLib(c,q){
  const filtered=INDUSTRY_TEMPLATES.filter(i=>!q||i.name.toLowerCase().includes(q)||i.teams.some(t=>t.name.toLowerCase().includes(q)));
  c.innerHTML=filtered.map(ind=>`
    <div class="industry-card" id="ind-${ind.id}" onclick="toggleIndustryCard('${ind.id}')">
      <div class="ind-header"><span class="ind-icon">${ind.icon}</span><div><div class="ind-title">${ind.name}</div><div class="ind-sub">${ind.teams.length} teams · ${ind.teams.reduce((a,t)=>a+t.bots.length,0)} bots · ${ind.infra.length} integrations</div></div></div>
      <div class="ind-details">
        <div class="ind-section"><div class="ind-section-title">Teams</div><div class="ind-tags">${ind.teams.map(t=>`<span class="ind-tag">${t.name}</span>`).join('')}</div></div>
        <div class="ind-section"><div class="ind-section-title">Bots</div><div class="ind-tags">${ind.teams.flatMap(t=>t.bots).map(b=>`<span class="ind-tag">🤖 ${b}</span>`).join('')}</div></div>
        <div class="ind-section"><div class="ind-section-title">Infrastructure</div><div class="ind-tags">${ind.infra.map(i=>`<span class="ind-tag">🔌 ${i}</span>`).join('')}</div></div>
        <button class="ind-apply-btn" onclick="event.stopPropagation();applyIndustryTemplate('${ind.id}')">⚡ Apply Template</button>
      </div>
    </div>`).join('')||'<p style="color:var(--text3);text-align:center;padding:20px">No matching industries</p>';
}

function toggleIndustryCard(id){document.getElementById('ind-'+id).classList.toggle('expanded')}

function applyIndustryTemplate(id){
  const tmpl=INDUSTRY_TEMPLATES.find(i=>i.id===id);if(!tmpl)return;
  const isBlank = state.teams.length === 0 && state.sharedServices.length === 0;
  if(!isBlank && !confirm(`Apply "${tmpl.name}" template? This will REPLACE your current canvas with this template.`))return;
  // Full replace — start fresh with this template
  const fresh = JSON.parse(JSON.stringify(BLANK_STATE));
  const colors=['#3B82F6','#10B981','#F59E0B','#8B5CF6','#EC4899','#14B8A6','#EF4444','#6366F1'];
  const colorClasses=['blue','green','orange','purple','blue','green','orange','purple'];
  // Build shared services from template (use common ones)
  fresh.sharedServices = [
    { id: "scheduler-bot-"+Date.now(), name: "Scheduler Bot", type: "bot", description: "Centralized scheduling service.", skills: ["Calendar management","Conflict resolution","Timezone handling"], mcps: ["Microsoft Graph API","Google Calendar API"], status: "active", phase: "P1", relType: "Tool", engStyle: "Answer Machine", humanCheckpoint: "Review scheduling conflicts weekly", starters: ["Schedule a recurring daily report","Show all active scheduled tasks","Set up a weekly team sync"] },
    { id: "compliance-bot-"+Date.now(), name: "Compliance Bot", type: "bot", description: "Monitors regulatory compliance and internal policy adherence.", skills: ["Regulatory monitoring","Policy tracking","Violation flagging"], mcps: [], status: "planned", phase: "P2", relType: "Tool", engStyle: "Answer Machine", humanCheckpoint: "Review compliance flags before reporting", starters: ["Run a compliance check","Flag overdue regulatory filings","Audit our policy documents"] }
  ];
  // Build teams
  tmpl.teams.forEach((t,ti)=>{
    const teamId=t.name.toLowerCase().replace(/[^a-z0-9]+/g,'-')+'-'+Date.now();
    const members=t.bots.map((bn,bi)=>{const bot=BOT_LIBRARY.find(b=>b.name===bn);return{id:bn.toLowerCase().replace(/[^a-z0-9]+/g,'-')+'-'+Date.now()+bi,name:bn,type:'bot',isLead:bi===0,description:bot?.desc||bn,skills:bot?.skills||[],mcps:bot?.mcps||[],status:bi===0?'active':'planned',phase:bi===0?'P1':'P1',relType:bot?.relType||'Tool',engStyle:bot?.engStyle||'Answer Machine',humanCheckpoint:bot?.humanCheckpoint||'',starters:bot?.starters||[]}});
    fresh.teams.push({id:teamId,name:t.name,color:t.color||colors[ti%8],colorClass:colorClasses[ti%8],members});
  });
  // Build infrastructure
  tmpl.infra.forEach(name=>{const inf=INFRA_LIBRARY.find(i=>i.name===name);fresh.infrastructure.approved.push({id:name.toLowerCase().replace(/[^a-z0-9]+/g,'-')+'-'+Date.now(),name,description:inf?.desc||name})});
  // Preserve branding/exec customizations
  fresh.branding = state.branding || fresh.branding;
  fresh.executive = state.executive || fresh.executive;
  fresh.orchestrator = state.orchestrator || fresh.orchestrator;
  fresh.mcpHub = tmpl.infra.map(name => ({name, status: 'active'}));
  state = fresh;
  closePanel();selectedNode=null;
  saveState();render();
  hideTemplatePicker();
  showToast(`⚡ ${tmpl.name} template applied — fresh canvas!`);
}

function renderTeamLib(c,q){
  const filtered=TEAM_TEMPLATES.filter(t=>!q||t.name.toLowerCase().includes(q)||t.desc.toLowerCase().includes(q));
  c.innerHTML=filtered.map(t=>`
    <div class="library-item" draggable="true" ondragstart="libTeamDragStart(event,'${esc(t.name)}','${t.color}')">
      <div class="lib-icon">👥</div>
      <div class="lib-info"><div class="lib-name">${t.name}</div><div class="lib-desc">${t.desc}</div></div>
      <button class="btn btn-sm btn-outline" onclick="event.stopPropagation();addTeamFromLib('${esc(t.name)}','${t.color}')">+ Add</button>
    </div>`).join('')||'<p style="color:var(--text3);text-align:center;padding:20px">No matches</p>';
}

function addTeamFromLib(name,color){
  if(state.teams.find(t=>t.name===name)){showToast(`${name} team already exists`);return}
  state.teams.push({id:name.toLowerCase().replace(/[^a-z0-9]+/g,'-')+'-'+Date.now(),name,color,colorClass:'blue',members:[]});
  saveState();render();showToast(`✅ ${name} team added`);
}
function libTeamDragStart(e,name,color){e.dataTransfer.setData('application/library-team',JSON.stringify({name,color}));e.dataTransfer.effectAllowed='copy'}

function renderBotLib(c,q){
  const allBots=BOT_LIBRARY.concat(state.customSkills?.filter(s=>s.type==='bot')||[]);
  const cats=[...new Set(allBots.map(b=>b.cat))].sort();
  const filtered=allBots.filter(b=>!q||b.name.toLowerCase().includes(q)||b.cat.toLowerCase().includes(q)||b.desc.toLowerCase().includes(q));
  let html='';
  cats.forEach(cat=>{
    const bots=filtered.filter(b=>b.cat===cat);
    if(!bots.length)return;
    html+=`<div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--text3);margin:12px 0 6px;padding-left:4px">${cat}</div>`;
    bots.forEach((b,bi)=>{
      const bidx=allBots.indexOf(b);
      html+=`<div class="library-item" draggable="true" ondragstart="libBotDragStartIdx(event,${bidx})" onclick="openBotLibModalIdx(${bidx})">
        <div class="lib-icon">🤖</div>
        <div class="lib-info"><div class="lib-name">${b.name} ${b.relType?'<span class=\"rel-badge rel-'+b.relType.toLowerCase()+'\">'+b.relType+'</span>':''} ${b.engStyle==='Thinking Partner'?'🧠':'⚡'}</div><div class="lib-desc">${b.desc}</div>${b.starters&&b.starters.length?'<div style="margin-top:6px;font-size:11px;color:var(--text2);font-style:italic;line-height:1.5">'+b.starters.slice(0,2).map(s=>'<div style="padding:3px 8px;margin:2px 0;background:rgba(59,130,246,0.1);border:1px solid rgba(59,130,246,0.2);border-radius:12px;display:inline-block;margin-right:4px">💬 '+esc(s)+'</div>').join('')+'</div>':''}</div>
      </div>`;
    });
  });
  c.innerHTML=html||'<p style="color:var(--text3);text-align:center;padding:20px">No matches</p>';
}

function libBotDragStartIdx(e,idx){const b=BOT_LIBRARY.concat(state.customSkills?.filter(s=>s.type==='bot')||[])[idx];e.dataTransfer.setData('application/library-bot',JSON.stringify(b));e.dataTransfer.effectAllowed='copy';e.target.classList.add('dragging');e.target.addEventListener('dragend',()=>e.target.classList.remove('dragging'),{once:true})}
function openBotLibModalIdx(idx){const b=BOT_LIBRARY.concat(state.customSkills?.filter(s=>s.type==='bot')||[])[idx];openBotLibModal(JSON.stringify(b))}
function libBotDragStart(e,botJson){e.dataTransfer.setData('application/library-bot',botJson);e.dataTransfer.effectAllowed='copy';e.target.classList.add('dragging');e.target.addEventListener('dragend',()=>e.target.classList.remove('dragging'),{once:true})}

function renderSkillLib(c,q){
  const allSkills=SKILLS_LIBRARY.concat(state.customSkills?.filter(s=>s.type==='skill')||[]);
  const cats=[...new Set(allSkills.map(s=>s.cat))].sort();
  const filtered=allSkills.filter(s=>!q||s.name.toLowerCase().includes(q)||s.cat.toLowerCase().includes(q)||s.desc.toLowerCase().includes(q));
  let html='<button onclick="switchTab(\'skillswriter\')" style="width:100%;padding:14px 20px;margin-bottom:16px;background:linear-gradient(135deg,var(--brand),var(--purple));color:#fff;border:none;border-radius:10px;font-size:15px;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;box-shadow:0 4px 12px rgba(59,130,246,0.4);transition:transform .15s,box-shadow .15s" onmouseover="this.style.transform=\'scale(1.02)\';this.style.boxShadow=\'0 6px 20px rgba(59,130,246,0.5)\'" onmouseout="this.style.transform=\'scale(1)\';this.style.boxShadow=\'0 4px 12px rgba(59,130,246,0.4)\'">✏️ Create New Skill<span style="font-size:11px;font-weight:400;opacity:0.8;margin-left:4px">(GRACE Framework)</span></button>';
  cats.forEach(cat=>{
    const skills=filtered.filter(s=>s.cat===cat);
    if(!skills.length)return;
    html+=`<div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--text3);margin:12px 0 6px;padding-left:4px">${cat}</div>`;
    skills.forEach((s,si)=>{const sidx=allSkills.indexOf(s);html+=`<div class="library-item" draggable="true" ondragstart="event.dataTransfer.setData('text/plain','${s.name.replace(/'/g,"\\'")}')" onclick="openSkillEditModalIdx(${sidx})"><div class="lib-icon">⚡</div><div class="lib-info"><div class="lib-name">${s.name}</div><div class="lib-desc">${s.desc}</div></div></div>`});
  });
  c.innerHTML=html||'<p style="color:var(--text3);text-align:center;padding:20px">No matches</p>';
}

function renderInfraLib(c,q){
  const cats=[...new Set(INFRA_LIBRARY.map(i=>i.cat))].sort();
  const filtered=INFRA_LIBRARY.filter(i=>!q||i.name.toLowerCase().includes(q)||i.cat.toLowerCase().includes(q));
  let html='';
  cats.forEach(cat=>{
    const items=filtered.filter(i=>i.cat===cat);
    if(!items.length)return;
    html+=`<div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--text3);margin:12px 0 6px;padding-left:4px">${cat}</div>`;
    items.forEach(i=>{
      const exists=state.infrastructure.approved.find(a=>a.name===i.name)||state.infrastructure.underReview.find(a=>a.name===i.name);
      const iidx=INFRA_LIBRARY.indexOf(i);
      html+=`<div class="library-item" draggable="true" ondragstart="libInfraDragStartIdx(event,${iidx})" onclick="openInfraEditModal(${iidx})">
        <div class="lib-icon">${i.icon}</div>
        <div class="lib-info"><div class="lib-name">${i.name}</div><div class="lib-desc">${i.desc}</div></div>
        ${exists?'<span class="lib-badge rec">Added</span>':''}
      </div>`;
    });
  });
  c.innerHTML=html||'<p style="color:var(--text3);text-align:center;padding:20px">No matches</p>';
}

function libInfraDragStartIdx(e,idx){const i=INFRA_LIBRARY[idx];e.dataTransfer.setData('application/library-infra',JSON.stringify(i));e.dataTransfer.effectAllowed='copy'}
function libInfraDragStart(e,infraJson){e.dataTransfer.setData('application/library-infra',infraJson);e.dataTransfer.effectAllowed='copy'}
function openInfraEditModal(idx){
  const infra=INFRA_LIBRARY[idx];if(!infra)return;
  const m=document.createElement('div');m.className='modal-overlay show';m.id='infraEditOverlay';
  m.innerHTML=`<div class="modal" style="width:420px"><h3>Edit Infrastructure</h3>
    <div class="form-group"><label>Name</label><input id="infraEditName" value="${infra.name}"></div>
    <div class="form-group"><label>Category</label><input id="infraEditCat" value="${infra.cat||''}"></div>
    <div class="form-group"><label>Purpose <button class="expand-btn" onclick="openExpandModal('infraEditDesc','Purpose')">↗ Expand</button></label><textarea id="infraEditDesc" rows="3">${infra.desc||''}</textarea></div>
    <div class="form-group"><label>Typical Users</label><input id="infraEditUsers" value="${infra.users||''}"></div>
    <div class="form-actions">
      <button class="btn btn-outline" onclick="document.getElementById('infraEditOverlay').remove()">Cancel</button>
      <button class="btn btn-green" onclick="saveInfraEdit(${idx})">Save Changes</button>
      <button class="btn btn-primary" onclick="addInfraFromModal(${idx})">Add to Approved</button>
    </div></div>`;
  document.body.appendChild(m);
}
function saveInfraEdit(idx){
  INFRA_LIBRARY[idx].name=document.getElementById('infraEditName').value.trim();
  INFRA_LIBRARY[idx].cat=document.getElementById('infraEditCat').value.trim();
  INFRA_LIBRARY[idx].desc=document.getElementById('infraEditDesc').value;
  INFRA_LIBRARY[idx].users=document.getElementById('infraEditUsers').value;
  document.getElementById('infraEditOverlay').remove();renderLibrary();showToast('✅ Infrastructure updated');
}
function addInfraFromModal(idx){
  const i=INFRA_LIBRARY[idx];
  if(!state.infrastructure.approved.find(a=>a.name===i.name)){
    state.infrastructure.approved.push({name:i.name,purpose:i.desc,users:i.users||'Various',sso:'Check'});
    saveState();render();
  }
  document.getElementById('infraEditOverlay').remove();showToast('✅ '+i.name+' added to Approved');
}

// ======================== TAB SWITCHING ========================
function switchTab(tab){
  currentTab=tab;
  document.querySelectorAll('.nav-tab').forEach(t=>t.classList.toggle('active',t.dataset.tab===tab));
  document.querySelectorAll('.tab-content').forEach(t=>t.classList.toggle('active',t.id==='tab-'+tab));
  if(tab==='mcphub')renderMcpHub();
}

// ======================== MCP HUB ========================
function renderMcpHub(){
  const q=(document.getElementById('mcpSearch')?.value||'').toLowerCase();
  const grid=document.getElementById('mcpGrid');
  if(!state.mcpHub||!Array.isArray(state.mcpHub))state.mcpHub=DEFAULT_DATA.mcpHub;
  const items=state.mcpHub.filter(m=>{const n=typeof m==='string'?m:m.name;return!q||n.toLowerCase().includes(q)});
  // Find which bots use each connector
  const botUsers={};
  const allBots=[...state.sharedServices];
  state.teams.forEach(t=>allBots.push(...t.members));
  allBots.forEach(b=>{(b.mcps||[]).forEach(mcp=>{if(!botUsers[mcp])botUsers[mcp]=[];botUsers[mcp].push(b.name)})});
  grid.innerHTML=items.map(m=>{
    const name=typeof m==='string'?m:m.name;
    const status=typeof m==='string'?'active':m.status||'active';
    const users=botUsers[name]||[];
    return `<div class="mcp-card">
      <div class="mcp-name"><span class="mcp-status ${status}"></span>${name}</div>
      <div style="font-size:11px;color:var(--text2);text-transform:capitalize">${status}</div>
      ${users.length?`<div class="mcp-users">Used by: ${users.join(', ')}</div>`:'<div class="mcp-users" style="color:var(--text3)">Not assigned to any bot</div>'}
      <div class="mcp-toggle" style="display:flex;gap:4px;margin-top:6px">
        <button class="btn btn-sm ${status==='active'?'btn-green':'btn-outline'}" onclick="setMcpStatus('${esc(name)}','active')">Active</button>
        <button class="btn btn-sm ${status==='inactive'?'btn-danger':'btn-outline'}" onclick="setMcpStatus('${esc(name)}','inactive')">Inactive</button>
        <button class="btn btn-sm ${status==='planned'?'btn-primary':'btn-outline'}" onclick="setMcpStatus('${esc(name)}','planned')">Planned</button>
      </div>
    </div>`}).join('');
}

function setMcpStatus(name,status){
  const m=state.mcpHub.find(m=>(typeof m==='string'?m:m.name)===name);
  if(!m)return;
  if(typeof m==='string'){const idx=state.mcpHub.indexOf(m);state.mcpHub[idx]={name:m,status}}
  else m.status=status;
  saveState();renderMcpHub();showToast(`${name}: ${status}`);
}

function addConnector(){
  const name=prompt('Connector name:');if(!name?.trim())return;
  if(!state.mcpHub)state.mcpHub=[];
  state.mcpHub.push({name:name.trim(),status:'planned'});
  saveState();renderMcpHub();showToast(`Added ${name.trim()}`);
}

// ======================== SKILLS WRITER ========================
function switchSwTab(tab){
  document.querySelectorAll('.sw-tab').forEach(t=>t.classList.toggle('active',t.textContent.toLowerCase().includes(tab)));
  document.getElementById('sw-template').style.display=tab==='template'?'':'none';
  document.getElementById('sw-ai').style.display=tab==='ai'?'':'none';
}

// Live preview for GRACE template mode
function updateGracePreview(){
  const n=document.getElementById('swName').value||'[Skill Name]';
  const cat=document.getElementById('swCategory').value;
  const goal=document.getElementById('swGoal').value;
  const role=document.getElementById('swRole').value;
  const actions=document.getElementById('swActions').value;
  const context=document.getElementById('swContext').value;
  const examples=document.getElementById('swExamples').value;
  if(!goal&&!role&&!actions&&!context&&!examples){document.getElementById('swPreview').textContent='Fill in the GRACE fields above to preview your skill description.';return}
  let h=`<strong>${esc(n)}</strong> (${esc(cat)})<br><br>`;
  if(goal)h+=`<strong>Goal:</strong> ${esc(goal)}<br>`;
  if(role)h+=`<strong>Role:</strong> ${esc(role)}<br>`;
  if(actions)h+=`<br><strong>Actions:</strong><br>${esc(actions).replace(/\n/g,'<br>')}<br>`;
  if(context)h+=`<br><strong>Context:</strong> ${esc(context)}<br>`;
  if(examples)h+=`<br><strong>Examples:</strong><br>${esc(examples).replace(/\n/g,'<br>')}`;
  document.getElementById('swPreview').innerHTML=h;
}

function clearSkillWriter(){['swName','swGoal','swRole','swActions','swContext','swExamples'].forEach(id=>{const el=document.getElementById(id);if(el)el.value=''});document.getElementById('swPreview').textContent='Fill in the GRACE fields above to preview your skill description.'}

function saveSkillFromWriter(){
  const name=document.getElementById('swName').value.trim();
  if(!name){alert('Skill name required');return}
  const cat=document.getElementById('swCategory').value;
  const goal=document.getElementById('swGoal').value;
  const role=document.getElementById('swRole').value;
  const actions=document.getElementById('swActions').value;
  const context=document.getElementById('swContext').value;
  const examples=document.getElementById('swExamples').value;
  let desc='';
  if(goal)desc+='Goal: '+goal+'. ';
  if(role)desc+='Role: '+role+'. ';
  if(actions)desc+='Actions: '+actions+'. ';
  if(context)desc+='Context: '+context+'. ';
  if(examples)desc+='Examples: '+examples+'.';
  if(!desc)desc=name;
  if(!state.customSkills)state.customSkills=[];
  state.customSkills.push({type:'skill',id:name.toLowerCase().replace(/[^a-z0-9]+/g,'-'),name,cat,desc});
  saveState();clearSkillWriter();showToast(`⚡ "${name}" saved to library!`);
}

async function generateSkillAI(){
  const prompt=document.getElementById('swAiPrompt').value.trim();
  const key=document.getElementById('swAiKey').value.trim();
  const provider=document.getElementById('swAiProvider').value;
  if(!prompt){alert('Describe the skill you need');return}
  if(!key){alert('API key required. See links below the field.');return}
  showToast('Generating skill...');
  try{
    let result;
    const sysPrompt='You are a skill designer. Given a description, return JSON with: name, category (Communication/Analysis/Automation/Compliance/Research/Custom), description (2-3 sentences), suggestedBots (array of bot names). Return ONLY valid JSON.';
    if(provider==='openai'){
      const r=await fetch('https://api.openai.com/v1/chat/completions',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+key},body:JSON.stringify({model:'gpt-4o-mini',messages:[{role:'system',content:sysPrompt},{role:'user',content:prompt}],response_format:{type:'json_object'}})});
      const d=await r.json();result=JSON.parse(d.choices[0].message.content);
    }else if(provider==='anthropic'){
      const r=await fetch('https://api.anthropic.com/v1/messages',{method:'POST',headers:{'Content-Type':'application/json','x-api-key':key,'anthropic-version':'2023-06-01','anthropic-dangerous-direct-browser-access':'true'},body:JSON.stringify({model:'claude-3-5-haiku-latest',max_tokens:500,system:sysPrompt,messages:[{role:'user',content:prompt+' Return ONLY JSON.'}]})});
      const d=await r.json();const txt=d.content[0].text;result=JSON.parse(txt.includes('{')?txt.substring(txt.indexOf('{')):txt);
    }else{
      const r=await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key='+key,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({contents:[{parts:[{text:sysPrompt+'\n\nUser request: '+prompt+'\n\nReturn ONLY JSON.'}]}]})});
      const d=await r.json();const txt=d.candidates[0].content.parts[0].text;result=JSON.parse(txt.includes('{')?txt.substring(txt.indexOf('{'),txt.lastIndexOf('}')+1):txt);
    }
    document.getElementById('swAiName').value=result.name||'';
    document.getElementById('swAiCategory').value=result.category||'Custom';
    document.getElementById('swAiDesc').value=result.description||'';
    document.getElementById('swAiBots').value=(result.suggestedBots||[]).join(', ');
    document.getElementById('swAiResult').style.display='';
    showToast('✅ Skill generated!');
  }catch(err){showToast('Error: '+err.message);console.error(err)}
}

function saveAiSkill(){
  const name=document.getElementById('swAiName').value.trim();
  if(!name){alert('Name required');return}
  if(!state.customSkills)state.customSkills=[];
  state.customSkills.push({type:'skill',id:name.toLowerCase().replace(/[^a-z0-9]+/g,'-'),name,cat:document.getElementById('swAiCategory').value,desc:document.getElementById('swAiDesc').value});
  saveState();document.getElementById('swAiResult').style.display='none';document.getElementById('swAiPrompt').value='';showToast(`⚡ "${name}" saved!`);
}

// ======================== EXPORT / IMPORT ========================
function toggleExportMenu(){document.getElementById('exportMenu').classList.toggle('show')}
document.addEventListener('click',e=>{if(!e.target.closest('[onclick*="toggleExportMenu"]')&&!e.target.closest('.export-menu'))document.getElementById('exportMenu').classList.remove('show')});

function exportAsImage(){
  document.getElementById('exportMenu').classList.remove('show');
  showToast('Generating image...');
  const el=document.getElementById('tab-canvas');
  html2canvas(el,{backgroundColor:'#0f172a',scale:2}).then(canvas=>{
    const a=document.createElement('a');a.download='agent-orchestrator.png';a.href=canvas.toDataURL();a.click();showToast('📸 Image exported!');
  }).catch(e=>showToast('Export failed: '+e.message));
}

function exportAsPdf(){
  document.getElementById('exportMenu').classList.remove('show');
  showToast('Generating PDF...');
  const el=document.getElementById('tab-canvas');
  html2canvas(el,{backgroundColor:'#0f172a',scale:2}).then(canvas=>{
    const{jsPDF}=window.jspdf;
    const pdf=new jsPDF({orientation:'landscape',unit:'px',format:[canvas.width/2,canvas.height/2]});
    pdf.addImage(canvas.toDataURL(),'PNG',0,0,canvas.width/2,canvas.height/2);
    pdf.save('agent-orchestrator.pdf');showToast('📄 PDF exported!');
  }).catch(e=>showToast('Export failed: '+e.message));
}

function exportAsJson(){
  document.getElementById('exportMenu').classList.remove('show');
  const blob=new Blob([JSON.stringify(state,null,2)],{type:'application/json'});
  const a=document.createElement('a');a.download='agent-orchestrator.json';a.href=URL.createObjectURL(blob);a.click();showToast('💾 JSON exported!');
}

function importJson(){
  document.getElementById('exportMenu').classList.remove('show');
  document.getElementById('importFileInput').click();
}

function handleImportFile(e){
  const file=e.target.files[0];if(!file)return;
  const r=new FileReader();
  r.onload=ev=>{
    try{pendingImportData=JSON.parse(ev.target.result);document.getElementById('importModal').classList.add('show')}
    catch(err){showToast('Invalid JSON file')}
  };
  r.readAsText(file);
  e.target.value='';
}

function closeImportModal(){document.getElementById('importModal').classList.remove('show');pendingImportData=null}

function doImport(mode){
  if(!pendingImportData){closeImportModal();return}
  if(mode==='replace'){state=pendingImportData;if(!state.customSkills)state.customSkills=[];if(!state.mcpHub)state.mcpHub=DEFAULT_DATA.mcpHub}
  else{
    // Merge: add teams, bots, infra that don't exist
    (pendingImportData.teams||[]).forEach(t=>{if(!state.teams.find(et=>et.name===t.name))state.teams.push(t)});
    (pendingImportData.infrastructure?.approved||[]).forEach(i=>{if(!state.infrastructure.approved.find(ei=>ei.name===i.name))state.infrastructure.approved.push(i)});
    (pendingImportData.infrastructure?.underReview||[]).forEach(i=>{if(!state.infrastructure.underReview.find(ei=>ei.name===i.name))state.infrastructure.underReview.push(i)});
    (pendingImportData.sharedServices||[]).forEach(s=>{if(!state.sharedServices.find(es=>es.name===s.name))state.sharedServices.push(s)});
  }
  saveState();render();closeImportModal();showToast(`📥 Configuration ${mode==='replace'?'replaced':'merged'}!`);
}

// ======================== TOAST ========================
function showToast(msg){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2500)}


// ======================== BOT LIBRARY MODAL ========================
let editingLibBot = null;
function openBotLibModal(botJson) {
  const bot = JSON.parse(botJson);
  editingLibBot = bot;
  document.getElementById('botLibModalTitle').textContent = bot.name;
  const c = document.getElementById('botLibModalContent');
  c.innerHTML = `
    <div class="form-group"><label>Name</label><input id="libBotName" value="${esc(bot.name)}"></div>
    <div class="form-group"><label>Description <button class="expand-btn" onclick="openExpandModal('libBotDesc','Bot Description')">↗ Expand</button></label><textarea id="libBotDesc" rows="3">${esc(bot.desc)}</textarea></div>
    <div class="form-group"><label>Category</label><div class="view-field">${esc(bot.cat||'')}</div></div>
    <div class="form-group"><label>Relationship Type</label>
      <select id="libBotRelType"><option value="Tool" ${bot.relType==='Tool'?'selected':''}>🔧 Tool</option><option value="Sidekick" ${bot.relType==='Sidekick'?'selected':''}>🤝 Sidekick</option><option value="Persona" ${bot.relType==='Persona'?'selected':''}>🧠 Persona</option></select></div>
    <div class="form-group"><label>Engagement Style</label>
      <select id="libBotEngStyle"><option value="Answer Machine" ${bot.engStyle==='Answer Machine'?'selected':''}>⚡ Answer Machine</option><option value="Thinking Partner" ${bot.engStyle==='Thinking Partner'?'selected':''}>🧠 Thinking Partner</option></select></div>
    <div class="form-group"><label>Skills</label><div class="chip-container" id="libBotSkills"></div></div>
    <div class="form-group"><label>MCPs</label><div class="chip-container" id="libBotMcps"></div></div>
    <div class="form-group"><label>Human Checkpoint 👤</label><input id="libBotHC" value="${esc(bot.humanCheckpoint||'')}"></div>
    <div class="form-group"><label>💬 Conversation Starters</label>
      <div id="libBotStarters">${(bot.starters||[]).map((s,i)=>'<div style="display:flex;align-items:center;gap:6px;margin-bottom:4px"><input class="lib-starter-input" value="'+esc(s)+'" style="flex:1"><span style="cursor:pointer;color:var(--red);font-size:14px" onclick="this.parentElement.remove()">✕</span></div>').join('')}</div>
      <button class="btn btn-outline btn-sm" style="margin-top:4px" onclick="document.getElementById('libBotStarters').insertAdjacentHTML('beforeend','<div style=\'display:flex;align-items:center;gap:6px;margin-bottom:4px\'><input class=\'lib-starter-input\' placeholder=\'New starter...\' style=\'flex:1\'><span style=\'cursor:pointer;color:var(--red);font-size:14px\' onclick=\'this.parentElement.remove()\'>✕</span></div>')">+ Add Starter</button>
    </div>`;
  renderChips('libBotSkills', bot.skills||[], true);
  renderChips('libBotMcps', bot.mcps||[], true);
  document.getElementById('botLibModalActions').innerHTML = `
    <button class="btn btn-outline" onclick="closeBotLibModal()">Cancel</button>
    <button class="btn btn-primary" onclick="addBotFromLibModal()">Add to Canvas</button>
    <button class="btn btn-green" onclick="saveBotLibModal()">Save Changes</button>`;
  document.getElementById('botLibModal').classList.add('show');
}
function closeBotLibModal() { document.getElementById('botLibModal').classList.remove('show'); editingLibBot = null; }
function saveBotLibModal() {
  if (!editingLibBot) return;
  const idx = BOT_LIBRARY.findIndex(b => b.name === editingLibBot.name);
  if (idx >= 0) {
    BOT_LIBRARY[idx].name = document.getElementById('libBotName').value.trim() || BOT_LIBRARY[idx].name;
    BOT_LIBRARY[idx].desc = document.getElementById('libBotDesc').value;
    BOT_LIBRARY[idx].relType = document.getElementById('libBotRelType').value;
    BOT_LIBRARY[idx].engStyle = document.getElementById('libBotEngStyle').value;
    BOT_LIBRARY[idx].skills = getChipArray('libBotSkills');
    BOT_LIBRARY[idx].mcps = getChipArray('libBotMcps');
    BOT_LIBRARY[idx].humanCheckpoint = document.getElementById('libBotHC').value;
    BOT_LIBRARY[idx].starters = Array.from(document.querySelectorAll('#libBotStarters .lib-starter-input')).map(i=>i.value.trim()).filter(Boolean);
  }
  closeBotLibModal(); renderLibrary(); showToast('✅ Bot updated in library');
}
function addBotFromLibModal() {
  if (!editingLibBot) return;
  const bot = {
    name: document.getElementById('libBotName').value.trim() || editingLibBot.name,
    desc: document.getElementById('libBotDesc').value || editingLibBot.desc,
    skills: getChipArray('libBotSkills'),
    mcps: getChipArray('libBotMcps'),
    relType: document.getElementById('libBotRelType').value,
    engStyle: document.getElementById('libBotEngStyle').value,
    humanCheckpoint: document.getElementById('libBotHC').value,
    starters: Array.from(document.querySelectorAll('#libBotStarters .lib-starter-input')).map(i=>i.value.trim()).filter(Boolean)
  };
  // Add to first team or show team picker
  if (!state.teams.length) { showToast('No teams on canvas'); return; }
  const teamId = state.teams[0].id;
  const team = state.teams.find(t=>t.id===teamId);
  const id = bot.name.toLowerCase().replace(/[^a-z0-9]+/g,'-')+'-'+Date.now();
  team.members.push({id, name:bot.name, type:'bot', isLead:false, description:bot.desc, skills:bot.skills, mcps:bot.mcps, status:'planned', phase:'P1', relType:bot.relType, engStyle:bot.engStyle, humanCheckpoint:bot.humanCheckpoint, starters:bot.starters});
  saveState(); render(); closeBotLibModal(); showToast(`✅ ${bot.name} added to ${team.name}`);
}

// ======================== SKILL EDIT MODAL ========================
let editingSkillId = null;
function openSkillEditModalIdx(idx){const allSkills=SKILLS_LIBRARY.concat(state.customSkills?.filter(s=>s.type==='skill')||[]);const s=allSkills[idx];if(s)openSkillEditModal(s.id||s.name)}
function openSkillEditModal(skillId) {
  editingSkillId = skillId;
  const allSkills = SKILLS_LIBRARY.concat(state.customSkills?.filter(s=>s.type==='skill')||[]);
  const skill = allSkills.find(s => (s.id||s.name) === skillId);
  if (!skill) return;
  document.getElementById('skillEditName').value = skill.name;
  document.getElementById('skillEditDesc').value = skill.desc || '';
  document.getElementById('skillEditCat').value = skill.cat || 'Custom/Advanced';
  document.getElementById('skillEditModal').classList.add('show');
}
function closeSkillEditModal() { document.getElementById('skillEditModal').classList.remove('show'); editingSkillId = null; }
function saveSkillEdit() {
  if (!editingSkillId) return;
  const name = document.getElementById('skillEditName').value.trim();
  const desc = document.getElementById('skillEditDesc').value;
  const cat = document.getElementById('skillEditCat').value;
  // Try to find in SKILLS_LIBRARY first
  let skill = SKILLS_LIBRARY.find(s => (s.id||s.name) === editingSkillId);
  if (skill) { skill.name = name; skill.desc = desc; skill.cat = cat; }
  else {
    const cs = (state.customSkills||[]).find(s => (s.id||s.name) === editingSkillId);
    if (cs) { cs.name = name; cs.desc = desc; cs.cat = cat; saveState(); }
  }
  closeSkillEditModal(); renderLibrary(); showToast(`✅ "${name}" updated`);
}

// ======================== CUSTOM ENDPOINT TOGGLE ========================
function toggleCustomEndpoint() {
  const provider = document.getElementById('swAiProvider').value;
  document.getElementById('customEndpointGroup').style.display = provider === 'custom' ? '' : 'none';
}


// ======================== EXPAND MODAL ========================
let expandSourceId = null;
function openExpandModal(sourceId, title) {
  expandSourceId = sourceId;
  const src = document.getElementById(sourceId);
  if (!src) return;
  document.getElementById('expandModalTitle').textContent = title || 'Edit';
  const ta = document.getElementById('expandModalTextarea');
  ta.value = src.value || src.textContent || '';
  ta.readOnly = false;
  document.getElementById('expandModalOverlay').classList.add('show');
  ta.focus();
}
function openExpandView(text, title) {
  expandSourceId = null;
  document.getElementById('expandModalTitle').textContent = title || 'View';
  const ta = document.getElementById('expandModalTextarea');
  ta.value = text;
  ta.readOnly = true;
  document.getElementById('expandModalOverlay').classList.add('show');
}
function closeExpandModal(apply) {
  if (apply && expandSourceId) {
    const src = document.getElementById(expandSourceId);
    if (src) { src.value = document.getElementById('expandModalTextarea').value; src.dispatchEvent(new Event('input', { bubbles: true })); }
  }
  document.getElementById('expandModalOverlay').classList.remove('show');
  expandSourceId = null;
}
document.addEventListener('keydown', function(e) { if (e.key === 'Escape' && document.getElementById('expandModalOverlay').classList.contains('show')) closeExpandModal(false); });

// ======================== PHASE 3: SUBSCRIPTION & SETTINGS ========================
const SUBSCRIPTION_TIERS = [
  {id:'free',name:'Free',price:'$0',priceNum:0,tagline:'Get started in 60 seconds',features:['1 Team, 5 Bots','Guided Setup Wizard','Template Skills Writer','Browse Marketplace','Basic Analytics','Community Support'],limits:{teams:1,botsPerTeam:5,orgs:1}},
  {id:'pro',name:'Pro',price:'$45',priceNum:45,tagline:'For power users',features:['5 Teams, 15 Bots','AI-Powered Skills Writer','1-Click Skill Pack Deploy','Per-Team Analytics','Buy from Marketplace','Email Support'],limits:{teams:5,botsPerTeam:3,orgs:1}},
  {id:'business',name:'Business',price:'$99',priceNum:99,tagline:'For growing teams',features:['Unlimited Teams & Bots','Full Analytics + Alerts','Historical Trends','Sell on Marketplace','Priority Support','API Access'],limits:{teams:-1,botsPerTeam:-1,orgs:1}},
  {id:'enterprise',name:'Enterprise',price:'$299',priceNum:299,tagline:'Full platform, your brand',popular:true,features:['Everything in Business','Unlimited Organizations','White-Label Branding ✅','Curate Your Own Marketplace','Dedicated Onboarding','Custom Integrations','SLA Guarantee'],limits:{teams:-1,botsPerTeam:-1,orgs:-1}}
];

function renderSubscription() {
  const grid = document.getElementById('subGrid'); if (!grid) return;
  if (!state.subscription) state.subscription = {tier:'free',testingMode:true};
  const cur = state.subscription.tier;
  grid.innerHTML = SUBSCRIPTION_TIERS.map(t => `
    <div class="sub-card ${cur===t.id?'current':''} ${t.popular?'popular':''}">
      ${cur===t.id?'<div class="current-badge">CURRENT</div>':''}
      ${t.popular&&cur!==t.id?'<div class="current-badge" style="background:var(--brand)">MOST POPULAR</div>':''}
      <div class="sub-tier">${t.name}</div>
      <div class="sub-price">${t.price}${t.priceNum>0?'<span>/mo</span>':''}</div>
      <div style="font-size:11px;color:var(--text3);margin-bottom:12px;font-style:italic">${t.tagline||''}</div>
      <ul class="sub-features">${t.features.map(f=>`<li>${f.includes('✅')?'✅':'✓'} ${f}</li>`).join('')}</ul>
      ${cur===t.id?'<button class="btn btn-outline" style="width:100%" disabled>Current Plan</button>':`<button class="btn btn-primary" style="width:100%" onclick="selectTier('${t.id}')">${t.priceNum===0?'Start Free':'Select Plan'}</button>`}
    </div>`).join('');
  document.getElementById('testingBanner').style.display = state.subscription.testingMode ? '' : 'none';
}

function selectTier(tier) {
  if (!state.subscription) state.subscription = {};
  state.subscription.tier = tier;
  state.subscription.testingMode = true;
  saveState(); renderSubscription();
  showToast(`Plan changed to ${SUBSCRIPTION_TIERS.find(t=>t.id===tier)?.name||tier}`);
  renderOrgSelector();
}

// ======================== WHITE-LABEL ========================
function loadWhiteLabelForm() {
  const wl = state.whiteLabel || {};
  const el = id => document.getElementById(id);
  if (el('wlCompany')) el('wlCompany').value = wl.company || state.branding?.company || '';
  if (el('wlPrimary')) el('wlPrimary').value = wl.primaryColor || '#3B82F6';
  if (el('wlSecondary')) el('wlSecondary').value = wl.secondaryColor || '#1e293b';
  if (el('wlAccent')) el('wlAccent').value = wl.accentColor || '#F5A623';
  if (el('wlFavicon')) el('wlFavicon').value = wl.favicon || '';
  if (el('wlFooter')) el('wlFooter').value = wl.footerText || '';
  if (el('wlPoweredBy')) el('wlPoweredBy').checked = wl.poweredBy !== false;
  if (el('wlRemoveLogo')) el('wlRemoveLogo').style.display = wl.logo ? '' : 'none';
  updateWlPreview();
}

function updateWlPreview() {
  const pane = document.getElementById('wlPreviewPane'); if (!pane) return;
  const company = document.getElementById('wlCompany')?.value || 'Your Company';
  const primary = document.getElementById('wlPrimary')?.value || '#3B82F6';
  const secondary = document.getElementById('wlSecondary')?.value || '#1e293b';
  const accent = document.getElementById('wlAccent')?.value || '#F5A623';
  const footer = document.getElementById('wlFooter')?.value || '© 2026 ' + company;
  const powered = document.getElementById('wlPoweredBy')?.checked;
  const wl = state.whiteLabel || {};
  pane.innerHTML = `
    <div class="wl-preview-header" style="background:${secondary};border:1px solid ${primary}">
      ${wl.logo?`<img src="${wl.logo}" style="height:24px;max-width:80px;object-fit:contain">`:`<div style="width:20px;height:20px;background:${primary};transform:rotate(45deg);border-radius:3px;flex-shrink:0"></div>`}
      <span style="font-weight:700;font-size:14px;color:${primary}">${esc(company)}</span>
    </div>
    <div class="wl-preview-body">
      <div class="wl-preview-card" style="border-color:${primary}30"><div style="width:60%;height:10px;background:${primary}40;border-radius:4px;margin-bottom:6px"></div><div style="width:40%;height:8px;background:${secondary};border-radius:4px"></div></div>
      <div class="wl-preview-card" style="border-color:${accent}30"><div style="width:50%;height:10px;background:${accent}40;border-radius:4px;margin-bottom:6px"></div><div style="width:70%;height:8px;background:${secondary};border-radius:4px"></div></div>
    </div>
    <div class="wl-preview-footer" style="color:${primary}80">${esc(footer)}${powered?'<br><span style="font-size:10px;opacity:.6">Powered by Agent Orchestrator</span>':''}</div>`;
}

function handleWlLogoUpload() {
  const f = document.getElementById('wlLogoUpload').files[0]; if (!f) return;
  const r = new FileReader();
  r.onload = e => { if (!state.whiteLabel) state.whiteLabel = {}; state.whiteLabel.logo = e.target.result; document.getElementById('wlRemoveLogo').style.display = ''; updateWlPreview(); showToast('Logo uploaded'); };
  r.readAsDataURL(f);
}

function removeWlLogo() {
  if (state.whiteLabel) state.whiteLabel.logo = '';
  document.getElementById('wlRemoveLogo').style.display = 'none';
  updateWlPreview();
}

function saveWhiteLabel() {
  if (!state.whiteLabel) state.whiteLabel = {};
  state.whiteLabel.company = document.getElementById('wlCompany').value.trim();
  state.whiteLabel.primaryColor = document.getElementById('wlPrimary').value;
  state.whiteLabel.secondaryColor = document.getElementById('wlSecondary').value;
  state.whiteLabel.accentColor = document.getElementById('wlAccent').value;
  state.whiteLabel.favicon = document.getElementById('wlFavicon').value.trim();
  state.whiteLabel.footerText = document.getElementById('wlFooter').value.trim();
  state.whiteLabel.poweredBy = document.getElementById('wlPoweredBy').checked;
  saveState(); showToast('✅ White-label settings saved');
}

// ======================== ORGANIZATIONS ========================
function initOrganizations() {
  if (!state.organizations) {
    state.organizations = [{
      id: 'org-default-' + Date.now(),
      name: state.branding?.company || 'Default Organization',
      desc: 'Primary organization',
      canvasState: null // null = uses main state
    }];
    state.currentOrgId = state.organizations[0].id;
    saveState();
  }
}

function renderOrgSelector() {
  const sel = document.getElementById('orgSelector');
  const isEnt = state.subscription?.tier === 'enterprise' || state.subscription?.testingMode;
  sel.style.display = isEnt ? 'flex' : 'none';
  if (!isEnt) return;
  const select = document.getElementById('orgSelect');
  select.innerHTML = (state.organizations || []).map(o =>
    `<option value="${o.id}" ${o.id === state.currentOrgId ? 'selected' : ''}>${esc(o.name)}</option>`
  ).join('');
}

function renderOrgList() {
  const list = document.getElementById('orgList'); if (!list) return;
  list.innerHTML = (state.organizations || []).map(o => `
    <div style="display:flex;align-items:center;justify-content:space-between;padding:12px;background:var(--bg);border:1px solid var(--border);border-radius:8px;margin-bottom:8px">
      <div>
        <div style="font-weight:700;font-size:14px">${esc(o.name)} ${o.id===state.currentOrgId?'<span style="font-size:10px;background:var(--green);color:#000;padding:1px 6px;border-radius:3px;font-weight:800">ACTIVE</span>':''}</div>
        <div style="font-size:12px;color:var(--text3)">${esc(o.desc||'')}</div>
      </div>
      <div style="display:flex;gap:6px">
        ${o.id!==state.currentOrgId?`<button class="btn btn-sm btn-primary" onclick="switchOrganization('${o.id}')">Switch</button>`:''}
        ${(state.organizations||[]).length>1?`<button class="btn btn-sm btn-outline" onclick="deleteOrganization('${o.id}')">✕</button>`:''}
      </div>
    </div>`).join('');
}

function showAddOrgModal() { document.getElementById('addOrgModal').classList.add('show'); }
function closeAddOrgModal() { document.getElementById('addOrgModal').classList.remove('show'); }

function addOrganization() {
  const name = document.getElementById('orgName').value.trim();
  if (!name) { alert('Name required'); return; }
  const org = {
    id: 'org-' + Date.now(),
    name,
    desc: document.getElementById('orgDesc').value.trim(),
    canvasState: JSON.parse(JSON.stringify(DEFAULT_DATA))
  };
  if (!state.organizations) state.organizations = [];
  state.organizations.push(org);
  saveState(); closeAddOrgModal();
  document.getElementById('orgName').value = '';
  document.getElementById('orgDesc').value = '';
  renderOrgSelector(); renderOrgList();
  showToast(`✅ ${name} added`);
}

function switchOrganization(orgId) {
  const cur = (state.organizations||[]).find(o => o.id === state.currentOrgId);
  if (cur) {
    cur.canvasState = {
      executive: state.executive, orchestrator: state.orchestrator,
      sharedServices: state.sharedServices, teams: state.teams,
      infrastructure: state.infrastructure, phases: state.phases
    };
  }
  const next = (state.organizations||[]).find(o => o.id === orgId);
  if (next && next.canvasState) {
    Object.assign(state, next.canvasState);
  }
  state.currentOrgId = orgId;
  saveState(); render(); renderOrgSelector(); renderOrgList();
  showToast(`Switched to ${next?.name||'org'}`);
}

function deleteOrganization(orgId) {
  if (orgId === state.currentOrgId) { showToast('Cannot delete active org'); return; }
  const org = (state.organizations||[]).find(o=>o.id===orgId);
  if (!confirm(`Delete organization "${org?.name}"?`)) return;
  state.organizations = state.organizations.filter(o=>o.id!==orgId);
  saveState(); renderOrgSelector(); renderOrgList();
  showToast('Organization deleted');
}

// ======================== SHAREABLE LINKS ========================
function generateShareLink() {
  if (!state.shareLinks) state.shareLinks = [];
  const access = document.getElementById('shareAccess').value;
  const shareId = 'share-' + Date.now().toString(36);
  const encoded = btoa(JSON.stringify({
    company: state.branding?.company || 'Shared',
    teams: state.teams.length,
    bots: state.teams.reduce((a,t)=>a+t.members.length,0),
    shareId
  }));
  const url = window.location.origin + window.location.pathname + '#share=' + encoded;
  state.shareLinks.push({
    id: shareId, name: state.branding?.company + ' Architecture',
    date: new Date().toISOString().slice(0,10), access, url
  });
  saveState();
  document.getElementById('shareLinkUrl').value = url;
  document.getElementById('shareLinkResult').style.display = '';
  renderShareList();
  showToast('🔗 Share link generated');
}

function copyShareLink() {
  const url = document.getElementById('shareLinkUrl').value;
  navigator.clipboard.writeText(url).then(()=>showToast('📋 Link copied!')).catch(()=>{
    const inp = document.getElementById('shareLinkUrl'); inp.select(); document.execCommand('copy'); showToast('📋 Link copied!');
  });
}

function renderShareList() {
  const list = document.getElementById('shareList'); if (!list) return;
  const links = state.shareLinks || [];
  if (!links.length) { list.innerHTML = '<div style="color:var(--text3);font-size:12px;padding:12px">No shared links yet</div>'; return; }
  list.innerHTML = links.map(l => `
    <div class="share-item">
      <div class="share-meta">
        <span class="share-badge ${l.access}">${l.access === 'view' ? '👁️ View-only' : '✏️ Editable'}</span>
        <span>${esc(l.name)}</span>
      </div>
      <div style="display:flex;gap:6px;align-items:center">
        <span style="font-size:11px;color:var(--text3)">${l.date}</span>
        <button class="btn btn-sm btn-outline" onclick="navigator.clipboard.writeText('${l.url}');showToast('Copied!')">📋</button>
        <button class="btn btn-sm btn-outline" onclick="deleteShareLink('${l.id}')">✕</button>
      </div>
    </div>`).join('');
}

function deleteShareLink(id) {
  state.shareLinks = (state.shareLinks||[]).filter(l=>l.id!==id);
  saveState(); renderShareList();
}

// ======================== PHASE 3: ANALYTICS ========================
let tokenPeriod = 'month';

function generateMockAnalytics() {
  const teams = state.teams || [];
  const allBots = [];
  teams.forEach(t => t.members.forEach(m => allBots.push({...m, teamName: t.name, teamColor: t.color})));
  state.sharedServices.forEach(s => allBots.push({...s, teamName: 'Shared', teamColor: '#14B8A6'}));

  const botAnalytics = allBots.slice(0,15).map((b,i) => ({
    id: b.id, name: b.name, team: b.teamName, teamColor: b.teamColor,
    tasksCompleted: Math.floor(Math.random()*500)+50,
    taskSuccessRate: (85+Math.random()*15).toFixed(1),
    avgResponseTime: (Math.random()*4+0.5).toFixed(1)+'s',
    avgResponseMs: Math.floor(Math.random()*4000+500),
    uptime: (95+Math.random()*5).toFixed(2),
    errorRate: (Math.random()*5).toFixed(1)+'%',
    status: b.status || 'active',
    lastActive: new Date(Date.now()-Math.floor(Math.random()*86400000)).toISOString(),
    tokensIn: Math.floor(Math.random()*500000)+10000,
    tokensOut: Math.floor(Math.random()*200000)+5000,
    cost: 0,
    costPerTask: 0,
    dailyCosts: Array.from({length:30},()=>(Math.random()*8+0.5).toFixed(2)*1)
  }));
  botAnalytics.forEach(b => {
    b.cost = ((b.tokensIn * 0.000003) + (b.tokensOut * 0.000015)).toFixed(2)*1;
    b.costPerTask = b.tasksCompleted > 0 ? (b.cost / b.tasksCompleted).toFixed(3)*1 : 0;
  });
  botAnalytics.sort((a,b)=>b.tasksCompleted-a.tasksCompleted);

  const teamAnalytics = teams.map(t => {
    const bots = botAnalytics.filter(b=>b.team===t.name);
    return {
      id: t.id, name: t.name, color: t.color,
      totalBots: t.members.length,
      activeBots: t.members.filter(m=>m.status==='active').length,
      tasksPerDay: Math.floor(Math.random()*200)+20,
      uptime: (95+Math.random()*5).toFixed(1),
      totalCost: bots.reduce((a,b)=>a+b.cost,0).toFixed(2)*1,
      budget: Math.floor(Math.random()*500)+200
    };
  });

  const monthlyTotal = botAnalytics.reduce((a,b)=>a+b.cost,0).toFixed(2)*1;
  const dailyCostSeries = Array.from({length:30},(_, i) => ({
    day: i+1,
    cost: botAnalytics.reduce((a,b)=>a+(b.dailyCosts[i]||0),0)
  }));

  state.analytics = {
    mockMode: true,
    bots: botAnalytics,
    teams: teamAnalytics,
    adoption: {
      totalConfigured: allBots.length,
      totalActive: allBots.filter(b=>b.status==='active').length,
      usedThisWeek: Math.floor(allBots.length * 0.7),
      usedLastWeek: Math.floor(allBots.length * 0.6),
      topSkills: ['Data Extraction','Report Writing','Notification Management','Schedule Management','Email Drafting'],
      infraConnected: state.infrastructure.approved.length,
      infraTotal: state.infrastructure.approved.length + state.infrastructure.underReview.length
    }
  };

  state.tokenAnalytics = {
    mockMode: true,
    bots: botAnalytics,
    teams: teamAnalytics,
    monthly: {
      total: monthlyTotal,
      budget: state.tokenBudget?.monthly || 5000,
      projected: (monthlyTotal * 1.1).toFixed(2)*1,
      avgDaily: (monthlyTotal/30).toFixed(2)*1
    },
    dailyCosts: dailyCostSeries
  };
  saveState();
}

function toggleAnalyticsData() {
  const toggle = document.getElementById('analyticsDataToggle');
  toggle.classList.toggle('on');
  const isMock = toggle.classList.contains('on');
  if (state.analytics) state.analytics.mockMode = isMock;
  if (state.tokenAnalytics) state.tokenAnalytics.mockMode = isMock;
  renderAnalytics();
}

function renderAnalytics() {
  if (!state.analytics || !state.analytics.bots) generateMockAnalytics();
  const a = state.analytics;
  const ta = state.tokenAnalytics;
  const teamFilter = document.getElementById('analyticsTeamFilter')?.value || 'all';

  // Populate team filter
  const teamSel = document.getElementById('analyticsTeamFilter');
  if (teamSel && teamSel.options.length <= 1) {
    state.teams.forEach(t => { const o = document.createElement('option'); o.value = t.id; o.textContent = t.name; teamSel.appendChild(o); });
  }

  const filteredBots = teamFilter === 'all' ? a.bots : a.bots.filter(b => {
    const team = state.teams.find(t=>t.id===teamFilter);
    return team && b.team === team.name;
  });

  // Enhance bots with extra metrics if missing
  filteredBots.forEach(b => {
    if (!b.uptime) b.uptime = (95 + Math.random()*4.9).toFixed(1);
    if (!b.completionRate) b.completionRate = (85 + Math.random()*13).toFixed(0);
    if (!b.healthStatus) { const er = parseFloat(b.errorRate)||0; b.healthStatus = er>5?'red':er>2?'amber':'green'; }
    if (!b.monthlyCost) b.monthlyCost = (Math.random()*45+5).toFixed(2);
  });

  // KPI Summary Row
  const totalCost = filteredBots.reduce((s,b)=>s+parseFloat(b.monthlyCost||0),0);
  const avgUptime = filteredBots.length ? (filteredBots.reduce((s,b)=>s+parseFloat(b.uptime||99),0)/filteredBots.length).toFixed(1) : '0';
  const totalTasks = filteredBots.reduce((s,b)=>s+(b.tasksCompleted||0),0);
  const kpiRow = document.getElementById('analyticsKpiRow');
  if (kpiRow) kpiRow.innerHTML = `
    <div class="kpi-card"><div class="kpi-label">Total Monthly Cost</div><div class="kpi-value" style="color:var(--green)">$${totalCost.toFixed(2)}</div><div class="kpi-sub">across ${filteredBots.length} agents</div></div>
    <div class="kpi-card"><div class="kpi-label">Avg Uptime</div><div class="kpi-value">${avgUptime}%</div><div class="kpi-sub">portfolio average</div></div>
    <div class="kpi-card"><div class="kpi-label">Tasks Completed</div><div class="kpi-value">${totalTasks.toLocaleString()}</div><div class="kpi-sub">total this month</div></div>
    <div class="kpi-card"><div class="kpi-label">Active Agents</div><div class="kpi-value">${filteredBots.filter(b=>b.status==='active').length}</div><div class="kpi-sub">of ${filteredBots.length} configured</div></div>`;

  // Usage stat cards
  document.getElementById('usageStatGrid').innerHTML = `
    <div class="stat-card"><div class="stat-label">Total Bots Active</div><div class="stat-value">${a.adoption.totalActive}</div><div class="stat-change up">of ${a.adoption.totalConfigured} configured</div></div>
    <div class="stat-card"><div class="stat-label">Used This Week</div><div class="stat-value">${a.adoption.usedThisWeek}</div><div class="stat-change ${a.adoption.usedThisWeek>a.adoption.usedLastWeek?'up':'down'}">${a.adoption.usedThisWeek>a.adoption.usedLastWeek?'↑':'↓'} vs ${a.adoption.usedLastWeek} last week</div></div>
    <div class="stat-card"><div class="stat-label">Total Tasks</div><div class="stat-value">${filteredBots.reduce((a,b)=>a+b.tasksCompleted,0).toLocaleString()}</div><div class="stat-change up">across ${filteredBots.length} bots</div></div>
    <div class="stat-card"><div class="stat-label">Infra Connected</div><div class="stat-value">${a.adoption.infraConnected}/${a.adoption.infraTotal}</div><div class="stat-change up">${Math.round(a.adoption.infraConnected/a.adoption.infraTotal*100)}% utilization</div></div>`;

  // Bar chart
  const top10 = filteredBots.slice(0,10);
  const maxTasks = Math.max(...top10.map(b=>b.tasksCompleted),1);
  document.getElementById('botBarChart').innerHTML = top10.map(b => `
    <div class="bar-col">
      <div class="bar-val">${b.tasksCompleted}</div>
      <div class="bar" style="height:${(b.tasksCompleted/maxTasks)*130}px;background:${b.teamColor||'var(--brand)'}" title="${b.name}: ${b.tasksCompleted} tasks"></div>
      <div class="bar-label">${b.name.length>12?b.name.slice(0,12)+'…':b.name}</div>
    </div>`).join('');

  // Adoption metrics
  document.getElementById('adoptionMetrics').innerHTML = `
    <div style="margin-bottom:12px">
      <div style="font-size:12px;color:var(--text2);margin-bottom:4px">Bot Adoption</div>
      <div class="budget-bar" style="height:12px"><div class="budget-fill" style="width:${(a.adoption.totalActive/a.adoption.totalConfigured*100)}%;background:var(--green)"></div></div>
      <div style="font-size:11px;color:var(--text3);margin-top:4px">${a.adoption.totalActive} active / ${a.adoption.totalConfigured} total</div>
    </div>
    <div style="margin-bottom:12px">
      <div style="font-size:12px;color:var(--text2);margin-bottom:6px">Top Skills</div>
      ${a.adoption.topSkills.map(s=>`<span style="display:inline-block;padding:2px 8px;margin:2px;background:var(--bg3);border-radius:4px;font-size:11px">${s}</span>`).join('')}
    </div>
    <div>
      <div style="font-size:12px;color:var(--text2);margin-bottom:4px">Infrastructure Utilization</div>
      <div class="budget-bar" style="height:12px"><div class="budget-fill" style="width:${(a.adoption.infraConnected/a.adoption.infraTotal*100)}%;background:var(--blue)"></div></div>
      <div style="font-size:11px;color:var(--text3);margin-top:4px">${a.adoption.infraConnected} connected / ${a.adoption.infraTotal} total</div>
    </div>`;

  // Bot activity table
  const healthColor = h => h==='green'?'var(--green)':h==='amber'?'var(--orange)':'var(--red)';
  document.getElementById('botActivityTable').innerHTML = `
    <thead><tr><th onclick="sortAnalyticsTable('name')">Bot <span class="sort-arrow">⇕</span></th><th onclick="sortAnalyticsTable('team')">Team</th><th onclick="sortAnalyticsTable('tasksCompleted')">Tasks</th><th>Completion</th><th>Uptime</th><th onclick="sortAnalyticsTable('avgResponseTime')">Avg Response</th><th onclick="sortAnalyticsTable('errorRate')">Error Rate</th><th>Cost/mo</th><th>Health</th></tr></thead>
    <tbody>${filteredBots.slice(0,20).map(b=>`<tr><td><strong>${esc(b.name)}</strong></td><td>${esc(b.team)}</td><td>${b.tasksCompleted}</td><td>${b.completionRate}%</td><td>${b.uptime}%</td><td>${b.avgResponseTime}</td><td>${b.errorRate}</td><td>$${b.monthlyCost}</td><td><span class="status-dot" style="background:${healthColor(b.healthStatus)}"></span>${b.healthStatus}</td></tr>`).join('')}</tbody>`;

  // Team performance
  document.getElementById('teamPerfGrid').innerHTML = (a.teams||[]).map(t => `
    <div class="team-perf-card" style="border-color:${t.color}">
      <div class="tpc-name" style="color:${t.color}">${esc(t.name)}</div>
      <div class="tpc-stats">
        <div class="tpc-stat"><strong>${t.totalBots}</strong>Total Bots</div>
        <div class="tpc-stat"><strong>${t.activeBots}</strong>Active</div>
        <div class="tpc-stat"><strong>${t.tasksPerDay}</strong>Tasks/Day</div>
        <div class="tpc-stat"><strong>${t.uptime}%</strong>Uptime</div>
      </div>
    </div>`).join('');

  // Token cost stat cards
  document.getElementById('tokenStatGrid').innerHTML = `
    <div class="stat-card"><div class="stat-label">Total Spend (Month)</div><div class="stat-value">$${ta.monthly.total.toFixed(2)}</div><div class="stat-change ${ta.monthly.total<ta.monthly.budget?'up':'down'}">${ta.monthly.total<ta.monthly.budget?'Under':'Over'} budget</div></div>
    <div class="stat-card"><div class="stat-label">Avg Daily Cost</div><div class="stat-value">$${ta.monthly.avgDaily.toFixed(2)}</div></div>
    <div class="stat-card"><div class="stat-label">Projected Monthly</div><div class="stat-value">$${ta.monthly.projected.toFixed(2)}</div></div>
    <div class="stat-card"><div class="stat-label">Budget Remaining</div><div class="stat-value" style="color:${(ta.monthly.budget-ta.monthly.total)>0?'var(--green)':'var(--red)'}">$${(ta.monthly.budget-ta.monthly.total).toFixed(2)}</div>
      <div class="budget-bar"><div class="budget-fill" style="width:${Math.min(ta.monthly.total/ta.monthly.budget*100,100)}%;background:${ta.monthly.total/ta.monthly.budget>0.9?'var(--red)':ta.monthly.total/ta.monthly.budget>0.75?'var(--orange)':'var(--green)'}"></div></div>
    </div>`;

  // Team cost chart
  const maxTeamCost = Math.max(...(ta.teams||[]).map(t=>t.totalCost),1);
  document.getElementById('teamCostChart').innerHTML = (ta.teams||[]).map(t => `
    <div class="bar-col">
      <div class="bar-val">$${t.totalCost.toFixed(0)}</div>
      <div class="bar" style="height:${(t.totalCost/maxTeamCost)*150}px;background:${t.color}" title="${t.name}: $${t.totalCost.toFixed(2)}"></div>
      <div class="bar-label">${t.name}</div>
    </div>`).join('');

  // Cost line chart
  renderCostLineChart();

  // Per-bot cost table
  const tokenBots = (teamFilter === 'all' ? ta.bots : ta.bots.filter(b => {
    const team = state.teams.find(t=>t.id===teamFilter);
    return team && b.team === team.name;
  })) || [];
  document.getElementById('tokenCostTable').innerHTML = `
    <thead><tr><th onclick="sortTokenTable('name')">Bot</th><th onclick="sortTokenTable('team')">Team</th><th onclick="sortTokenTable('tokensIn')">Tokens In</th><th onclick="sortTokenTable('tokensOut')">Tokens Out</th><th onclick="sortTokenTable('cost')">Cost</th><th>Trend</th></tr></thead>
    <tbody>${tokenBots.map(b=>`<tr><td><strong>${esc(b.name)}</strong></td><td>${esc(b.team)}</td><td>${b.tokensIn.toLocaleString()}</td><td>${b.tokensOut.toLocaleString()}</td><td>$${b.cost.toFixed(2)}</td><td><div class="sparkline">${(b.dailyCosts||[]).slice(-10).map(c=>`<div class="spark-bar" style="height:${Math.max(c/Math.max(...b.dailyCosts)*18,2)}px;background:${c>b.cost/30*1.5?'var(--red)':'var(--green)'}"></div>`).join('')}</div></td></tr>`).join('')}</tbody>`;

  // Budget section
  renderBudgetSection();
}

function renderCostLineChart() {
  const svg = document.getElementById('costLineChart'); if (!svg) return;
  const data = state.tokenAnalytics?.dailyCosts || [];
  let sliced = data;
  if (tokenPeriod === 'week') sliced = data.slice(-7);
  else if (tokenPeriod === 'quarter') {
    sliced = [];
    for (let i = 0; i < 90; i++) sliced.push({day: i+1, cost: Math.random()*50+10});
  }
  if (!sliced.length) { svg.innerHTML = ''; return; }
  const w = svg.clientWidth || 400, h = 150;
  const maxC = Math.max(...sliced.map(d=>d.cost),1);
  const pts = sliced.map((d,i) => ({x: (i/(sliced.length-1||1))*(w-40)+20, y: h-20-(d.cost/maxC)*(h-40)}));
  let path = pts.map((p,i)=>i===0?`M${p.x},${p.y}`:`L${p.x},${p.y}`).join(' ');
  let area = path + ` L${pts[pts.length-1].x},${h-20} L${pts[0].x},${h-20} Z`;
  svg.innerHTML = `
    <defs><linearGradient id="cg" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="var(--brand)" stop-opacity="0.3"/><stop offset="100%" stop-color="var(--brand)" stop-opacity="0"/></linearGradient></defs>
    <path d="${area}" fill="url(#cg)"/>
    <path d="${path}" fill="none" stroke="var(--brand)" stroke-width="2"/>
    ${pts.map(p=>`<circle cx="${p.x}" cy="${p.y}" r="3" fill="var(--brand)"/>`).join('')}
    <line x1="20" y1="${h-20}" x2="${w-20}" y2="${h-20}" stroke="var(--border)" stroke-width="1"/>
    <text x="20" y="${h-5}" fill="var(--text3)" font-size="9">${sliced[0]?.day||1}</text>
    <text x="${w-30}" y="${h-5}" fill="var(--text3)" font-size="9">${sliced[sliced.length-1]?.day||30}</text>
    <text x="5" y="15" fill="var(--text3)" font-size="9">$${maxC.toFixed(0)}</text>`;
}

function setTokenPeriod(p) {
  tokenPeriod = p;
  document.querySelectorAll('.line-chart-container .btn').forEach(b => {
    b.className = 'btn btn-sm ' + (b.textContent.toLowerCase().includes(p) ? 'btn-primary' : 'btn-outline');
  });
  renderCostLineChart();
}

function renderBudgetSection() {
  const sec = document.getElementById('budgetSection'); if (!sec) return;
  const budget = state.tokenBudget || {monthly: 5000, alerts: [50,75,90,100]};
  const spent = state.tokenAnalytics?.monthly?.total || 0;
  const pct = (spent / budget.monthly * 100);
  const alertLevel = budget.alerts.filter(a => pct >= a).pop() || 0;
  sec.innerHTML = `
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
      <div>
        <div style="font-size:13px;font-weight:600;margin-bottom:8px">Monthly Budget: $${budget.monthly.toLocaleString()}</div>
        <div class="budget-bar" style="height:16px"><div class="budget-fill" style="width:${Math.min(pct,100)}%;background:${pct>90?'var(--red)':pct>75?'var(--orange)':'var(--green)'}"></div></div>
        <div style="display:flex;justify-content:space-between;margin-top:4px;font-size:11px;color:var(--text3)"><span>$${spent.toFixed(2)} spent</span><span>${pct.toFixed(1)}%</span></div>
        ${alertLevel>=75?`<div class="budget-alert" style="background:${alertLevel>=90?'rgba(239,68,68,.15);color:var(--red)':'rgba(245,158,11,.15);color:var(--orange)'};margin-top:8px">⚠️ ${alertLevel}% of budget used</div>`:''}
      </div>
      <div>
        <div style="font-size:13px;font-weight:600;margin-bottom:8px">Per-Team Budgets</div>
        ${(state.tokenAnalytics?.teams||[]).map(t=>`<div style="margin-bottom:6px"><div style="display:flex;justify-content:space-between;font-size:11px"><span style="color:${t.color}">${t.name}</span><span>$${t.totalCost.toFixed(0)} / $${t.budget}</span></div><div class="budget-bar"><div class="budget-fill" style="width:${Math.min(t.totalCost/t.budget*100,100)}%;background:${t.color}"></div></div></div>`).join('')}
        <button class="btn btn-sm btn-outline" style="margin-top:8px" onclick="showBudgetModal()">⚙️ Edit Budget</button>
      </div>
    </div>`;
}

function showBudgetModal() {
  const b = state.tokenBudget || {monthly: 5000};
  document.getElementById('budgetMonthly').value = b.monthly || 5000;
  document.getElementById('budgetModal').classList.add('show');
}
function closeBudgetModal() { document.getElementById('budgetModal').classList.remove('show'); }
function saveBudgetSettings() {
  state.tokenBudget = {
    monthly: parseFloat(document.getElementById('budgetMonthly').value) || 5000,
    alerts: [50,75,90,100].filter((_,i)=>document.getElementById('budgetAlert'+[50,75,90,100][i])?.checked)
  };
  if (state.tokenAnalytics) state.tokenAnalytics.monthly.budget = state.tokenBudget.monthly;
  saveState(); closeBudgetModal(); renderAnalytics();
  showToast('Budget settings saved');
}

let analyticsSortCol = 'tasksCompleted', analyticsSortDir = -1;
function sortAnalyticsTable(col) {
  if (analyticsSortCol === col) analyticsSortDir *= -1;
  else { analyticsSortCol = col; analyticsSortDir = -1; }
  state.analytics.bots.sort((a,b) => {
    let av = a[col], bv = b[col];
    if (typeof av === 'string') return analyticsSortDir * av.localeCompare(bv);
    return analyticsSortDir * (av - bv);
  });
  renderAnalytics();
}

let tokenSortCol = 'cost', tokenSortDir = -1;
function sortTokenTable(col) {
  if (tokenSortCol === col) tokenSortDir *= -1;
  else { tokenSortCol = col; tokenSortDir = -1; }
  state.tokenAnalytics.bots.sort((a,b) => {
    let av = a[col], bv = b[col];
    if (typeof av === 'string') return tokenSortDir * av.localeCompare(bv);
    return tokenSortDir * (av - bv);
  });
  renderAnalytics();
}

// ======================== PHASE 3: MARKETPLACE ========================
const MARKETPLACE_EXTRA = [
  // ===== REAL ESTATE & PROPERTY MANAGEMENT (Featured) =====
  {id:'re-multifamily',name:'Multifamily Operations',icon:'🏢',desc:'Daily leasing reports, occupancy tracking, renewal management, maintenance SLA monitoring, and investor reporting. Built for 50-30K+ unit portfolios.',author:'Ardexa',rating:4.9,downloads:2840,price:'Pro',featured:true,category:'Real Estate',setupTime:'45 sec',botsIncluded:5,
    teams:[{name:'Leasing & Marketing',color:'#10B981',bots:[{n:'Leasing Agent',icon:'🔑',role:'Handles leads, tours, applications, follow-ups',personality:'You are a leasing specialist. You track leads, schedule tours, follow up with prospects, and report on conversion rates. You are warm, persuasive, and data-driven.',tone:{formal:35,detail:55,autonomous:50},style:['Professional','Friendly']},{n:'Resident Communications',icon:'📢',role:'Move-in/out coordination, community notices, satisfaction surveys',personality:'You manage resident-facing communications. You coordinate move-ins and move-outs, send community notices, run satisfaction surveys, and ensure residents feel heard. You are empathetic, clear, and organized.',tone:{formal:40,detail:60,autonomous:45},style:['Friendly','Empathetic']}]},{name:'Maintenance',color:'#F59E0B',bots:[{n:'Maintenance Coordinator',icon:'🔧',role:'Triages work orders, dispatches vendors, tracks SLA compliance',personality:'You manage work orders for a property management company. You prioritize by urgency, track SLA compliance, coordinate with vendors, and report on completion rates. You are efficient, organized, and responsive.',tone:{formal:50,detail:70,autonomous:60},style:['Direct','Professional']}]},{name:'Finance',color:'#8B5CF6',bots:[{n:'Rent Collection Assistant',icon:'💰',role:'Payment reminders, delinquency notices, payment plan setup',personality:'You handle rent collection workflows. You send payment reminders, generate delinquency notices, help set up payment plans, and track collections progress. You are firm but fair, professional, and empathetic.',tone:{formal:60,detail:60,autonomous:40},style:['Professional','Direct']}]},{name:'Compliance',color:'#EF4444',bots:[{n:'Compliance Monitor',icon:'🛡️',role:'Fair housing checks, lease audit, regulatory deadline tracking',personality:'You monitor compliance across all properties. You check fair housing adherence, audit leases for discrepancies, track regulatory deadlines, and flag violations. You are precise, thorough, and formal.',tone:{formal:80,detail:80,autonomous:30},style:['Professional','Technical']}]}],
    infra:['Entrata','Microsoft 365','Egnyte','RingCentral','Paycor']},
  {id:'re-student-housing',name:'Student Housing',icon:'🎓🏠',desc:'Pre-lease tracking, bed-level occupancy, renewal campaigns, parent communication, and semester-aligned reporting.',author:'Ardexa',rating:4.8,downloads:1560,price:'Pro',featured:true,category:'Real Estate',setupTime:'60 sec',botsIncluded:6,
    teams:[{name:'Leasing',color:'#10B981',bots:[{n:'Pre-Lease Tracker',icon:'📋',role:'Tracks pre-lease velocity, bed-level occupancy, renewal deadlines'},{n:'Renewal Campaign Manager',icon:'🔄',role:'Runs renewal outreach, tracks acceptance rates, escalates non-renewals'}]},{name:'Resident Life',color:'#3B82F6',bots:[{n:'Student Communications',icon:'📱',role:'Move-in guides, community events, parent updates'},{n:'Roommate Matcher',icon:'🤝',role:'Preference surveys, match scoring, conflict resolution routing'}]},{name:'Operations',color:'#F59E0B',bots:[{n:'Semester Reporting Agent',icon:'📊',role:'Generates semester-aligned occupancy and financial reports'},{n:'Turnover Coordinator',icon:'🔄',role:'Manages summer turn schedules, vendor dispatch, unit inspections'}]}],
    infra:['Entrata','Microsoft 365','RealPage']},
  {id:'re-maintenance',name:'Maintenance & Work Orders',icon:'🔧',desc:'SLA tracking, vendor dispatch, make-ready pipeline, preventive maintenance scheduling, and cost analysis.',author:'Ardexa',rating:4.7,downloads:2100,price:'Free',featured:true,category:'Real Estate',setupTime:'30 sec',botsIncluded:4,
    teams:[{name:'Maintenance Ops',color:'#F59E0B',bots:[{n:'Work Order Triage Agent',icon:'📥',role:'Classifies, prioritizes, and routes incoming maintenance requests'},{n:'Vendor Dispatch Coordinator',icon:'🚐',role:'Assigns vendors, tracks ETAs, confirms completion'},{n:'Make-Ready Pipeline Manager',icon:'🏗️',role:'Tracks unit turns from move-out to move-in ready'},{n:'Preventive Maintenance Scheduler',icon:'📅',role:'Schedules recurring inspections, filter changes, seasonal prep'}]}],
    infra:['Entrata','Brightly','Microsoft 365']},
  {id:'re-investor-reports',name:'Investor Reporting Suite',icon:'📊',desc:'Automated weekly/monthly investor reports, financial roll-ups, variance analysis, and distribution calculations.',author:'Ardexa',rating:4.8,downloads:980,price:'Pro',featured:false,category:'Real Estate',setupTime:'60 sec',botsIncluded:5,
    teams:[{name:'Investor Relations',color:'#8B5CF6',bots:[{n:'Financial Roll-Up Agent',icon:'📈',role:'Compiles property-level data into portfolio summaries'},{n:'Distribution Calculator',icon:'💵',role:'Calculates investor distributions, preferred returns, waterfalls'},{n:'Variance Analyst',icon:'🔍',role:'Flags budget vs actual variances, explains drivers'},{n:'Investor Update Drafter',icon:'✉️',role:'Drafts quarterly investor letters and portfolio updates'},{n:'LP Inquiry Tracker',icon:'📞',role:'Logs and tracks investor questions, ensures timely responses'}]}],
    infra:['Microsoft 365','Egnyte','Google Sheets']},
  {id:'re-leasing',name:'Leasing & Lead Management',icon:'🔑',desc:'Lead scoring, tour scheduling, application processing, lease execution tracking, and conversion analytics.',author:'Ardexa',rating:4.6,downloads:1890,price:'Free',featured:false,category:'Real Estate',setupTime:'45 sec',botsIncluded:5,
    teams:[{name:'Leasing',color:'#10B981',bots:[{n:'Lead Scoring Agent',icon:'🎯',role:'Scores inbound leads by source, timing, and qualification criteria'},{n:'Tour Scheduler',icon:'📅',role:'Books property tours, sends reminders, tracks no-shows'},{n:'Application Processor',icon:'📝',role:'Reviews applications, runs screening, flags issues'},{n:'Lease Execution Tracker',icon:'✍️',role:'Tracks lease signing progress, DocuSign status, move-in dates'},{n:'Conversion Analyst',icon:'📊',role:'Reports on funnel metrics from lead to signed lease'}]}],
    infra:['Entrata','RingCentral','DocuSign','Microsoft 365']},
  {id:'re-construction',name:'Construction & Development',icon:'🏗️',desc:'Draw scheduling, inspection tracking, punch list management, GC coordination, and budget variance alerts.',author:'Ardexa',rating:4.5,downloads:670,price:'Pro',featured:false,category:'Real Estate',setupTime:'60 sec',botsIncluded:4,
    teams:[{name:'Project Management',color:'#3B82F6',bots:[{n:'RFI Processor',icon:'📋',role:'RFI intake, routing to subs, response tracking'},{n:'Safety Compliance Monitor',icon:'⚠️',role:'Daily safety logs, incident reporting, OSHA checklists'},{n:'Draw Request Coordinator',icon:'💰',role:'Pay app assembly, lien waiver collection, approval routing'},{n:'Punch List Tracker',icon:'✅',role:'Tracks punch items through completion, assigns responsibility'}]}],
    infra:['Procore','Bluebeam','DocuSign','Microsoft 365']},
  // ===== GENERAL BUSINESS =====
  {id:'saas',name:'SaaS Operations',icon:'☁️',desc:'Customer success, onboarding, churn prevention, and product analytics workflows.',author:'Agent Orchestrator',rating:4.8,downloads:1240,price:'Free',featured:false,category:'Technology',setupTime:'45 sec',botsIncluded:6,
    teams:[{name:'Customer Success',color:'#10B981',bots:[{n:'Onboarding Specialist',icon:'🚀',role:'Guides new customers through setup, training, first value'},{n:'Churn Prevention Agent',icon:'🔔',role:'Monitors usage signals, triggers retention workflows'},{n:'Customer Health Scorer',icon:'💚',role:'Calculates health scores from usage, support, and NPS data'}]},{name:'Product Ops',color:'#3B82F6',bots:[{n:'Feature Request Tracker',icon:'💡',role:'Collects, deduplicates, and prioritizes feature requests'},{n:'Release Notes Writer',icon:'📝',role:'Drafts release notes from commit logs and tickets'},{n:'Analytics Reporter',icon:'📊',role:'Generates product usage and adoption dashboards'}]}],
    infra:['Stripe','Intercom','Slack','Mixpanel','HubSpot']},
  {id:'legal',name:'Legal Practice',icon:'⚖️',desc:'Case management, document review, client intake, and billing automation.',author:'LegalTech Pro',rating:4.6,downloads:890,price:'Pro',featured:false,category:'Professional Services',setupTime:'60 sec',botsIncluded:5,
    teams:[{name:'Case Management',color:'#3B82F6',bots:[{n:'Client Intake Specialist',icon:'📋',role:'Screens potential clients, gathers case details, conflict checks'},{n:'Document Reviewer',icon:'📄',role:'Analyzes contracts and filings, flags key clauses and risks'},{n:'Deadline Tracker',icon:'⏰',role:'Monitors filing deadlines, court dates, statute of limitations'}]},{name:'Operations',color:'#8B5CF6',bots:[{n:'Billing & Time Tracker',icon:'💰',role:'Tracks billable hours, generates invoices, monitors collections'},{n:'Legal Research Assistant',icon:'🔍',role:'Searches case law, summarizes precedents, drafts memos'}]}],
    infra:['Clio','Microsoft 365','DocuSign','QuickBooks']},
  {id:'education',name:'Education & EdTech',icon:'🎓',desc:'Student enrollment, course management, grading, and communication.',author:'EduFlow',rating:4.3,downloads:650,price:'Free',featured:false,category:'Education',setupTime:'45 sec',botsIncluded:4,
    teams:[{name:'Student Services',color:'#3B82F6',bots:[{n:'Enrollment Processor',icon:'📝',role:'Handles applications, enrollment verification, waitlist management'},{n:'Student Communicator',icon:'📱',role:'Sends class updates, grade notifications, event reminders'}]},{name:'Academic Ops',color:'#10B981',bots:[{n:'Grading Assistant',icon:'📊',role:'Processes submissions, calculates grades, flags anomalies'},{n:'Course Scheduler',icon:'📅',role:'Manages course catalogs, room assignments, instructor schedules'}]}],
    infra:['Google Workspace','Canvas LMS','Zoom']},
  {id:'logistics',name:'Logistics & Supply Chain',icon:'🚛',desc:'Route optimization, inventory tracking, shipment coordination, and vendor management.',author:'LogiBot',rating:4.5,downloads:780,price:'Pro',featured:false,category:'Operations',setupTime:'60 sec',botsIncluded:7,
    teams:[{name:'Fulfillment',color:'#F59E0B',bots:[{n:'Route Optimizer',icon:'🗺️',role:'Plans delivery routes for cost, time, and fuel efficiency'},{n:'Shipment Tracker',icon:'📦',role:'Monitors shipments in transit, updates ETAs, flags delays'},{n:'Warehouse Inventory Agent',icon:'🏭',role:'Tracks stock levels, triggers reorder points, manages locations'}]},{name:'Procurement',color:'#8B5CF6',bots:[{n:'Vendor Negotiator',icon:'🤝',role:'Compares quotes, tracks contracts, flags renewal opportunities'},{n:'Purchase Order Processor',icon:'📋',role:'Generates POs, routes for approval, confirms receipt'},{n:'Demand Forecaster',icon:'📈',role:'Predicts demand from historical data and market signals'},{n:'Returns Coordinator',icon:'🔄',role:'Processes returns, issues credits, tracks defect patterns'}]}],
    infra:['SAP','ShipStation','QuickBooks','Slack']},
  {id:'hospitality',name:'Hospitality & Hotels',icon:'🏨',desc:'Reservation management, guest services, housekeeping coordination, and revenue management.',author:'HospitalityAI',rating:4.2,downloads:430,price:'Free',featured:false,category:'Hospitality',setupTime:'45 sec',botsIncluded:5,
    teams:[{name:'Guest Services',color:'#10B981',bots:[{n:'Reservation Manager',icon:'🛎️',role:'Handles bookings, modifications, cancellations across channels'},{n:'Guest Experience Agent',icon:'⭐',role:'Pre-arrival outreach, in-stay requests, post-stay surveys'},{n:'Concierge Assistant',icon:'🗝️',role:'Restaurant reservations, activity bookings, local recommendations'}]},{name:'Operations',color:'#F59E0B',bots:[{n:'Housekeeping Coordinator',icon:'🧹',role:'Room assignment, turnover tracking, inspection scheduling'},{n:'Revenue Manager',icon:'💹',role:'Dynamic pricing, occupancy optimization, competitor rate monitoring'}]}],
    infra:['Opera PMS','Booking.com','Expedia','Stripe']},
  {id:'healthcare',name:'Healthcare Practice',icon:'🏥',desc:'Patient scheduling, insurance verification, clinical documentation, and compliance monitoring.',author:'HealthBot',rating:4.7,downloads:1120,price:'Pro',featured:false,category:'Healthcare',setupTime:'60 sec',botsIncluded:6,
    teams:[{name:'Patient Services',color:'#3B82F6',bots:[{n:'Patient Intake Coordinator',icon:'📋',role:'Appointment scheduling, insurance verification, pre-visit forms'},{n:'Appointment Reminder Agent',icon:'📱',role:'Sends reminders, manages reschedules, tracks no-shows'}]},{name:'Clinical Ops',color:'#10B981',bots:[{n:'Claims Processing Assistant',icon:'💰',role:'Claim submission, denial management, appeals tracking'},{n:'Clinical Documentation Agent',icon:'📝',role:'Transcribes notes, codes procedures, ensures completeness'}]},{name:'Staff & Compliance',color:'#EF4444',bots:[{n:'Staff Scheduling Agent',icon:'📅',role:'Shift coverage, PTO management, credential tracking'},{n:'HIPAA Compliance Monitor',icon:'🛡️',role:'Access audits, training tracking, breach detection'}]}],
    infra:['Epic/Cerner','athenahealth','Microsoft 365','DocuSign']},
  {id:'nonprofit',name:'Non-Profit Operations',icon:'🤝',desc:'Donor management, volunteer coordination, grant tracking, and impact reporting.',author:'MissionBot',rating:4.7,downloads:560,price:'Free',featured:false,category:'Non-Profit',setupTime:'30 sec',botsIncluded:4,
    teams:[{name:'Development',color:'#10B981',bots:[{n:'Donor Relations Manager',icon:'💝',role:'Tracks donor history, sends acknowledgments, plans cultivation'},{n:'Grant Tracker',icon:'📋',role:'Monitors grant deadlines, compliance requirements, reporting'}]},{name:'Operations',color:'#3B82F6',bots:[{n:'Volunteer Coordinator',icon:'🙋',role:'Manages signups, shift scheduling, hour tracking'},{n:'Impact Reporter',icon:'📊',role:'Compiles program metrics, generates annual reports, tracks outcomes'}]}],
    infra:['Salesforce Nonprofit','Mailchimp','Google Workspace']},
  {id:'manufacturing',name:'Manufacturing & Production',icon:'🏭',desc:'Production scheduling, quality control, equipment maintenance, and supply chain.',author:'FactoryFlow',rating:4.4,downloads:340,price:'Pro',featured:false,category:'Manufacturing',setupTime:'60 sec',botsIncluded:7,
    teams:[{name:'Production',color:'#F59E0B',bots:[{n:'Production Scheduler',icon:'📅',role:'Plans production runs, manages capacity, resolves conflicts'},{n:'Quality Control Inspector',icon:'🔬',role:'Tracks defect rates, manages inspections, flags deviations'},{n:'Equipment Maintenance Agent',icon:'⚙️',role:'Schedules preventive maintenance, tracks downtime, orders parts'}]},{name:'Supply Chain',color:'#8B5CF6',bots:[{n:'Raw Material Tracker',icon:'📦',role:'Monitors inventory levels, triggers reorders, tracks deliveries'},{n:'Supplier Performance Scorer',icon:'📊',role:'Rates suppliers on quality, delivery, and cost metrics'},{n:'Shipping Coordinator',icon:'🚚',role:'Manages outbound shipments, generates BOLs, tracks delivery'},{n:'Compliance Documentation Agent',icon:'📋',role:'Maintains ISO/FDA records, manages audit trails, tracks certifications'}]}],
    infra:['SAP','Microsoft 365','Slack','Power BI']},
  {id:'consulting',name:'Management Consulting',icon:'📋',desc:'Client engagement, deliverable tracking, knowledge management, and resource allocation.',author:'ConsultantAI',rating:4.1,downloads:290,price:'Free',featured:false,category:'Professional Services',setupTime:'45 sec',botsIncluded:4,
    teams:[{name:'Client Delivery',color:'#3B82F6',bots:[{n:'Engagement Manager',icon:'🎯',role:'Tracks project milestones, deliverables, and client satisfaction'},{n:'Research Analyst',icon:'🔍',role:'Market research, competitive analysis, data synthesis'}]},{name:'Operations',color:'#8B5CF6',bots:[{n:'Resource Allocator',icon:'👥',role:'Matches consultants to projects by skill, availability, and preference'},{n:'Knowledge Base Curator',icon:'📚',role:'Organizes frameworks, templates, and past deliverables for reuse'}]}],
    infra:['Microsoft 365','Salesforce','SharePoint','Slack']},
  {id:'ecommerce',name:'E-Commerce Operations',icon:'🛒',desc:'Order fulfillment, inventory sync, customer support automation, returns processing, and marketplace management.',author:'ShopFlow',rating:4.5,downloads:940,price:'Free',featured:false,category:'Retail',setupTime:'45 sec',botsIncluded:5,
    teams:[{name:'Customer Experience',color:'#10B981',bots:[{n:'Customer Support Agent',icon:'💬',role:'Handles order inquiries, shipping questions, and complaints'},{n:'Review Monitor',icon:'⭐',role:'Tracks product reviews, flags negative sentiment, drafts responses'}]},{name:'Operations',color:'#F59E0B',bots:[{n:'Order Fulfillment Agent',icon:'📦',role:'Processes orders, manages picking/packing, generates shipping labels'},{n:'Inventory Sync Manager',icon:'🔄',role:'Syncs stock across Shopify, Amazon, and warehouse systems'},{n:'Returns Processor',icon:'↩️',role:'Handles return requests, issues refunds, restocks inventory'}]}],
    infra:['Shopify','Stripe','Amazon','Zendesk','ShipStation']}
];

function renderMarketplace() {
  const q = (document.getElementById('mpSearch')?.value||'').toLowerCase();
  const catFilter = document.getElementById('mpCategoryFilter')?.value || 'all';
  const priceFilter = document.getElementById('mpPriceFilter')?.value || 'all';
  const ratingFilter = parseFloat(document.getElementById('mpRatingFilter')?.value) || 0;

  // Build full template list — deduplicate industry templates that have a marketplace pack
  const mpIds = new Set(['prop-mgmt','construction','healthcare','prof-services','ecommerce']);
  const seededRatings = {financial:4.5,marketing:4.6,personal:4.2};
  const seededDownloads = {financial:520,marketing:710,personal:380};
  const industryItems = INDUSTRY_TEMPLATES.filter(t => !mpIds.has(t.id)).map(t => ({
    id: t.id, name: t.name, icon: t.icon,
    desc: `${t.teams.length} teams, ${t.teams.reduce((a,tt)=>a+tt.bots.length,0)} bots, ${t.infra.length} integrations. Ready in 60 seconds.`,
    author: 'Agent Orchestrator', rating: seededRatings[t.id] || 4.4,
    downloads: seededDownloads[t.id] || 450, price: 'Free', featured: false, isIndustry: true,
    category: t.name.includes('Real Estate')||t.name.includes('Property')?'Real Estate':'General',
    setupTime: '60 sec', botsIncluded: t.teams.reduce((a,tt)=>a+tt.bots.length,0)
  }));
  const allTemplates = [
    ...industryItems,
    ...MARKETPLACE_EXTRA,
    ...(state.marketplace?.published || [])
  ];

  let filtered = allTemplates.filter(t => {
    if (q && !t.name.toLowerCase().includes(q) && !(t.desc||'').toLowerCase().includes(q) && !(t.category||'').toLowerCase().includes(q)) return false;
    if (catFilter !== 'all' && (t.category||'') !== catFilter) return false;
    if (priceFilter !== 'all' && t.price.toLowerCase() !== priceFilter) return false;
    if (ratingFilter && t.rating < ratingFilter) return false;
    return true;
  });

  // Featured
  const featured = filtered.filter(t => t.featured);
  document.getElementById('mpFeatured').innerHTML = featured.length ? `
    <h3>🔥 Featured & Trending</h3>
    <div class="mp-grid" style="margin-bottom:0">${featured.map(t => renderMpCard(t)).join('')}</div>
  ` : '';

  // All templates
  document.getElementById('mpGrid').innerHTML = filtered.map(t => renderMpCard(t)).join('') ||
    '<div style="text-align:center;color:var(--text3);padding:40px">No templates found</div>';
}

function renderMpCard(t) {
  const stars = '★'.repeat(Math.floor(t.rating)) + (t.rating % 1 >= 0.5 ? '½' : '') + '☆'.repeat(5-Math.ceil(t.rating));
  return `<div class="mp-card">
    <div style="display:flex;justify-content:space-between;align-items:flex-start">
      <div class="mp-icon">${t.icon||'📦'}</div>
      ${t.setupTime?`<span style="font-size:10px;font-weight:700;background:rgba(16,185,129,.15);color:#6ee7b7;padding:2px 8px;border-radius:4px">⚡ ${t.setupTime}</span>`:''}
    </div>
    <div class="mp-name">${esc(t.name)}</div>
    <div class="mp-author">by ${esc(t.author||'Community')}${t.category?` · <span style="color:var(--text3)">${t.category}</span>`:''}</div>
    <div class="mp-desc">${esc(t.desc||'')}</div>
    <div class="mp-meta">
      <span class="mp-stars" title="${t.rating} stars">${stars} ${t.rating}</span>
      <span>${(t.downloads||0).toLocaleString()} installs${t.botsIncluded?' · '+t.botsIncluded+' bots':''}</span>
    </div>
    <div style="display:flex;gap:6px;align-items:center">
      <span class="mp-price ${t.price==='Free'?'free':'paid'}">${t.price}</span>
      <button class="btn btn-sm btn-primary" style="margin-left:auto" onclick="useMpTemplate('${t.id}')">⚡ Deploy Now</button>
    </div>
  </div>`;
}

let dwState = {step:1, template:null, companyName:'', agentName:'', integrations:[]};

function useMpTemplate(id) {
  const allTpls = [
    ...INDUSTRY_TEMPLATES.map(t=>({id:t.id,name:t.name,icon:t.icon,botsIncluded:t.teams.reduce((a,tt)=>a+tt.bots.length,0),botNames:t.teams.flatMap(tt=>tt.bots.map(b=>b.name)),mcps:t.infra.map(i=>i.name||i),isIndustry:true,category:'General'})),
    ...MARKETPLACE_EXTRA.map(t=>({...t,botNames:t.teams?t.teams.flatMap(tm=>tm.bots.map(b=>b.n)):Array.from({length:t.botsIncluded||4},(_,i)=>`${t.name} Bot ${i+1}`),mcps:t.infra||['CRM','Email','Calendar','Slack','Database'].slice(0,Math.min(5,t.botsIncluded||3))})),
    ...(state.marketplace?.published||[]).map(t=>({...t,botNames:(t.canvasState?.teams||[]).flatMap(tt=>(tt.bots||[]).map(b=>b.name)),mcps:['CRM','Email','Calendar']}))
  ];
  const tpl = allTpls.find(t=>t.id===id);
  if (!tpl) { showToast('Template not found','error'); return; }
  dwState = {step:1, template:tpl, companyName:state.branding?.company||'', agentName:tpl.name, integrations:(tpl.mcps||[]).map((m,i)=>({name:m,enabled:i<3}))};
  document.getElementById('deployWizardModal').classList.add('show');
  renderDeployStep();
}

function closeDeployWizard() { document.getElementById('deployWizardModal').classList.remove('show'); }

function renderDeployStep() {
  const s = dwState, t = s.template;
  [1,2,3].forEach(i=>{const el=document.getElementById('dwStep'+i);el.className='dw-step'+(i<s.step?' done':'')+(i===s.step?' active':'')});
  document.getElementById('dwStepLabel').textContent = `Step ${s.step} of 3`;
  document.getElementById('dwBack').style.display = s.step>1?'':'none';
  const names = ['Name Your Agent','Connect Your Tools','Go Live'];
  document.getElementById('dwStepName').textContent = names[s.step-1];
  const c = document.getElementById('dwContent');
  if (s.step===1) {
    document.getElementById('dwNext').textContent = 'Next →';
    c.innerHTML = `
      <div class="form-group"><label>Company Name</label><input id="dwCompany" value="${esc(s.companyName)}" placeholder="Your Company" oninput="dwState.companyName=this.value"></div>
      <div class="form-group"><label>Agent Name</label><input id="dwAgent" value="${esc(s.agentName)}" placeholder="Agent Name" oninput="dwState.agentName=this.value"></div>
      <div style="font-size:12px;color:var(--text2);margin-top:8px">This pack includes <strong>${t.botsIncluded||t.botNames?.length||0} bots</strong>:</div>
      <div class="dw-bots-list">${(t.botNames||[]).map(b=>`<span class="dw-bot-tag">🤖 ${esc(b)}</span>`).join('')}</div>`;
  } else if (s.step===2) {
    document.getElementById('dwNext').textContent = 'Next →';
    c.innerHTML = `<div style="font-size:12px;color:var(--text2);margin-bottom:10px">Toggle the integrations this pack needs. You can connect more later.</div>
      ${s.integrations.map((ig,i)=>`<div class="dw-integration"><span style="font-size:13px">${esc(ig.name)}</span><div class="dw-toggle ${ig.enabled?'on':''}" onclick="dwState.integrations[${i}].enabled=!dwState.integrations[${i}].enabled;this.classList.toggle('on')"></div></div>`).join('')}`;
  } else {
    document.getElementById('dwNext').textContent = '🚀 Launch Agent';
    const enabled = s.integrations.filter(i=>i.enabled);
    c.innerHTML = `<div class="dw-summary">
      <div style="font-size:16px;font-weight:700;margin-bottom:8px">${esc(s.agentName)}</div>
      <div style="font-size:12px;color:var(--text3);margin-bottom:10px">${esc(s.companyName||'Your Company')}</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:12px">
        <div><strong>${t.botsIncluded||t.botNames?.length||0}</strong> Bots</div>
        <div><strong>${enabled.length}</strong> Integrations</div>
        <div>Category: <strong>${t.category||'General'}</strong></div>
        <div>Setup: <strong>${t.setupTime||'60 sec'}</strong></div>
      </div>
    </div>
    <div style="text-align:center;padding:8px;font-size:13px;color:var(--green)">✅ Ready to launch!</div>`;
  }
}

function deployWizardNext() {
  if (dwState.step<3) { dwState.step++; renderDeployStep(); return; }
  // Step 3 → launch
  const t = dwState.template;
  if (t.isIndustry) { applyIndustryTemplate(t.id); }
  else if (t.canvasState) { Object.assign(state, t.canvasState); saveState(); render(); }
  else { deployMarketplaceExtra(t); }
  closeDeployWizard(); switchTab('canvas');
  showToast(`🚀 ${dwState.agentName} deployed!`);
  // Show setup checklist after deploy
  setTimeout(()=>showSetupChecklist(t), 400);
}

function deployWizardBack() { if(dwState.step>1){dwState.step--;renderDeployStep();} }

function showPublishTemplateModal() {
  document.getElementById('publishTplModal').classList.add('show');
  const botCount = (state.teams||[]).reduce((a,t)=>(t.bots||[]).length+a,0);
  const el = document.getElementById('pubTplBots'); if(el) el.value = botCount||0;
}
function closePublishTplModal() { document.getElementById('publishTplModal').classList.remove('show'); }

function publishTemplate() {
  const name = document.getElementById('pubTplName').value.trim();
  if (!name) { alert('Name required'); return; }
  if (!state.marketplace) state.marketplace = {published:[]};
  const botCount = (state.teams||[]).reduce((a,t)=>(t.bots||[]).length+a,0);
  state.marketplace.published.push({
    id: 'custom-' + Date.now(),
    name,
    desc: document.getElementById('pubTplDesc').value.trim(),
    icon: document.getElementById('pubTplIcon').value.trim() || '📦',
    price: document.getElementById('pubTplPrice').value,
    category: document.getElementById('pubTplCategory')?.value || 'Technology',
    setupTime: document.getElementById('pubTplSetup')?.value || '45 sec',
    botsIncluded: botCount,
    author: state.branding?.company || 'You',
    rating: 5.0, downloads: 0, featured: false,
    canvasState: {
      teams: JSON.parse(JSON.stringify(state.teams)),
      sharedServices: JSON.parse(JSON.stringify(state.sharedServices)),
      infrastructure: JSON.parse(JSON.stringify(state.infrastructure))
    }
  });
  saveState(); closePublishTplModal();
  document.getElementById('pubTplName').value = '';
  document.getElementById('pubTplDesc').value = '';
  renderMarketplace();
  showToast(`📤 "${name}" published to marketplace!`);
}

// ======================== PHASE 4: WORKFLOWS ========================
let wfNodes = [], wfConnections = [], wfSelectedNode = null, wfSelectedConn = null;
let wfDragging = null, wfDragOffset = {x:0,y:0};
let wfConnecting = false, wfConnFrom = null, wfTempLine = null;
let wfSimulating = false, wfSimStep = 0;

const WF_TEMPLATES = [
  {name:'Content Pipeline',flow:'Research → Writer → Editor → Publisher',nodes:['Research Agent','Content Writer','Copywriting Bot','Social Scheduler']},
  {name:'Hiring Pipeline',flow:'Job Poster → Screener → Scheduler → Offer → Onboard',nodes:['Job Posting Bot','Resume Screening Bot','Interview Scheduler Bot','Offer Letter Writer Bot','Onboarding Bot']},
  {name:'Report Pipeline',flow:'Data Extractor → Generator → Review → Distribution',nodes:['Report Generator Bot','Ops Agent','Comms Agent']},
  {name:'Invoice Pipeline',flow:'Processor → Approval → Budget → Payment',nodes:['Invoice Processing Bot','Finance Agent','Budget Tracker Bot']},
  {name:'Lead Pipeline',flow:'Capture → Qualify → CRM → Follow-up',nodes:['CRM Updater','Market Intel Bot','Email Triage Bot','Auto-Reply Bot']}
];

function initWorkflows() {
  if (!state.workflows) state.workflows = [];
  if (!state.currentWorkflow) state.currentWorkflow = {nodes:[], connections:[]};
  wfNodes = state.currentWorkflow.nodes || [];
  wfConnections = state.currentWorkflow.connections || [];
}

function renderWorkflowSidebar() {
  // Bot list
  const botList = document.getElementById('wfBotList'); if (!botList) return;
  const allBots = [];
  state.teams.forEach(t => t.members.forEach(m => allBots.push({...m, teamName:t.name, teamColor:t.color})));
  state.sharedServices.forEach(s => allBots.push({...s, teamName:'Shared', teamColor:'#14B8A6'}));
  botList.innerHTML = allBots.map((b,i) => `
    <div class="wf-bot-item" draggable="true" ondragstart="wfBotDragStart(event,'${b.id}','${esc(b.name)}','${b.teamColor||'var(--brand)'}','${esc(b.teamName||'')}')">
      <span class="wf-bot-icon">${b.type==='agent'?'🤖':'⚙️'}</span>
      <span class="wf-bot-name">${b.name}</span>
      <span class="wf-bot-team" style="color:${b.teamColor}">${b.teamName}</span>
    </div>`).join('');

  // Templates
  const tplList = document.getElementById('wfTplList'); if (!tplList) return;
  tplList.innerHTML = WF_TEMPLATES.map((t,i) => `
    <div class="wf-tpl-item" onclick="loadWfTemplate(${i})">
      <div class="wf-tpl-name">${t.name}</div>
      <div class="wf-tpl-flow">${t.flow}</div>
    </div>`).join('');

  // Saved workflows
  const savedList = document.getElementById('wfSavedList'); if (!savedList) return;
  savedList.innerHTML = (state.workflows||[]).map((w,i) => `
    <div class="wf-tpl-item" onclick="loadSavedWorkflow(${i})">
      <div class="wf-tpl-name">${esc(w.name)}</div>
      <div class="wf-tpl-flow">${w.nodes.length} nodes · ${w.connections.length} connections</div>
    </div>`).join('') || '<div style="font-size:11px;color:var(--text3);padding:8px">No saved workflows</div>';
}

function filterWfBots(q) {
  q = q.toLowerCase();
  document.querySelectorAll('#wfBotList .wf-bot-item').forEach(el => {
    const name = el.querySelector('.wf-bot-name').textContent.toLowerCase();
    el.style.display = !q || name.includes(q) ? '' : 'none';
  });
}

function wfBotDragStart(e, botId, name, color, teamName) {
  e.dataTransfer.setData('application/wf-bot', JSON.stringify({botId, name, color, teamName}));
  e.dataTransfer.effectAllowed = 'copy';
}

function wfCanvasDragOver(e) { e.preventDefault(); }

function wfCanvasDrop(e) {
  e.preventDefault();
  const data = e.dataTransfer.getData('application/wf-bot');
  if (!data) return;
  const bot = JSON.parse(data);
  const rect = document.getElementById('wfCanvasArea').getBoundingClientRect();
  const scrollEl = document.getElementById('wfMain');
  const x = e.clientX - rect.left + scrollEl.scrollLeft;
  const y = e.clientY - rect.top + scrollEl.scrollTop;
  const node = {
    id: 'wfn-' + Date.now(),
    botId: bot.botId, name: bot.name, color: bot.color, teamName: bot.teamName,
    x, y, type: 'bot', status: 'idle'
  };
  wfNodes.push(node);
  saveWorkflowState();
  renderWfCanvas();
}

function addHumanNode() {
  const scrollEl = document.getElementById('wfMain');
  const x = scrollEl.scrollLeft + 200;
  const y = scrollEl.scrollTop + 150;
  wfNodes.push({
    id: 'wfn-human-' + Date.now(),
    name: 'Human Review', color: '#F5A623', teamName: '',
    x, y, type: 'human', status: 'idle', checkpoint: 'Awaiting human review'
  });
  saveWorkflowState();
  renderWfCanvas();
}

function renderWfCanvas() {
  const area = document.getElementById('wfCanvasArea'); if (!area) return;
  // Clear existing nodes (keep SVG)
  area.querySelectorAll('.wf-node,.wf-conn-label').forEach(el => el.remove());

  wfNodes.forEach(n => {
    const div = document.createElement('div');
    div.className = 'wf-node' + (n.type==='human'?' human-node':'') + (wfSelectedNode===n.id?' selected':'');
    div.id = 'wfnode-'+n.id;
    div.style.left = n.x+'px';
    div.style.top = n.y+'px';
    div.style.borderColor = n.color || 'var(--border)';
    const statusIcons = {idle:'⚪',running:'🔵',complete:'🟢',error:'🔴',waiting:'🟡'};
    div.innerHTML = `
      <div class="wf-handle wf-handle-in" onmousedown="wfStartConnect(event,'${n.id}','in')"></div>
      <div class="wf-handle wf-handle-out" onmousedown="wfStartConnect(event,'${n.id}','out')"></div>
      <div style="font-size:18px;text-align:center">${n.type==='human'?'👤':n.type==='agent'?'🤖':'⚙️'}</div>
      <div class="wf-node-name" style="color:${n.color}">${esc(n.name)}</div>
      <div class="wf-node-type">${n.teamName||n.type}</div>
      <div class="wf-node-status">${statusIcons[n.status]||'⚪'}</div>
      <div class="wf-node-delete" onclick="event.stopPropagation();deleteWfNode('${n.id}')">✕</div>`;
    div.onmousedown = (e) => { if (e.target.classList.contains('wf-handle') || e.target.classList.contains('wf-node-delete')) return; wfStartDrag(e, n.id); };
    div.onclick = () => { wfSelectedNode = n.id; renderWfCanvas(); };
    area.appendChild(div);
  });

  // Connection labels
  wfConnections.forEach((c,i) => {
    const fromN = wfNodes.find(n=>n.id===c.from);
    const toN = wfNodes.find(n=>n.id===c.to);
    if (!fromN || !toN) return;
    const mx = (fromN.x+70+toN.x)/2;
    const my = (fromN.y+30+toN.y+30)/2;
    if (c.label) {
      const lbl = document.createElement('div');
      lbl.className = 'wf-conn-label';
      lbl.style.left = mx+'px';
      lbl.style.top = (my-10)+'px';
      lbl.textContent = c.label;
      lbl.onclick = () => { wfSelectedConn = i; showConnLabelModal(i); };
      area.appendChild(lbl);
    }
  });

  renderWfConnections();
}

function renderWfConnections() {
  const svg = document.getElementById('wfSvg'); if (!svg) return;
  let paths = '<defs><marker id="arrowhead" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto"><polygon points="0 0,8 3,0 6" fill="var(--text3)"/></marker></defs>';
  wfConnections.forEach((c,i) => {
    const fromN = wfNodes.find(n=>n.id===c.from);
    const toN = wfNodes.find(n=>n.id===c.to);
    if (!fromN || !toN) return;
    const x1 = fromN.x + 140, y1 = fromN.y + 35;
    const x2 = toN.x, y2 = toN.y + 35;
    const cx1 = x1 + Math.abs(x2-x1)*0.4, cx2 = x2 - Math.abs(x2-x1)*0.4;
    const isSelected = wfSelectedConn === i;
    paths += `<path d="M${x1},${y1} C${cx1},${y1} ${cx2},${y2} ${x2},${y2}" fill="none" stroke="${isSelected?'var(--brand)':'var(--text3)'}" stroke-width="${isSelected?3:2}" marker-end="url(#arrowhead)" style="pointer-events:stroke;cursor:pointer" onclick="wfClickConn(${i})"/>`;
  });
  svg.innerHTML = paths;
}

function wfStartDrag(e, nodeId) {
  if (wfConnecting) return;
  wfDragging = nodeId;
  const n = wfNodes.find(n=>n.id===nodeId);
  wfDragOffset = {x: e.clientX - n.x, y: e.clientY - n.y};
  const onMove = (ev) => {
    const area = document.getElementById('wfCanvasArea');
    const main = document.getElementById('wfMain');
    n.x = ev.clientX - wfDragOffset.x;
    n.y = ev.clientY - wfDragOffset.y;
    const el = document.getElementById('wfnode-'+nodeId);
    if (el) { el.style.left = n.x+'px'; el.style.top = n.y+'px'; }
    renderWfConnections();
    // Update connection labels
    area.querySelectorAll('.wf-conn-label').forEach(l=>l.remove());
    wfConnections.forEach((c,i) => {
      const fromN = wfNodes.find(nn=>nn.id===c.from);
      const toN = wfNodes.find(nn=>nn.id===c.to);
      if (!fromN||!toN||!c.label) return;
      const lbl = document.createElement('div');
      lbl.className='wf-conn-label';
      lbl.style.left=((fromN.x+140+toN.x)/2)+'px';
      lbl.style.top=((fromN.y+35+toN.y+35)/2-10)+'px';
      lbl.textContent=c.label;
      lbl.onclick=()=>{wfSelectedConn=i;showConnLabelModal(i);};
      area.appendChild(lbl);
    });
  };
  const onUp = () => { wfDragging = null; document.removeEventListener('mousemove', onMove); document.removeEventListener('mouseup', onUp); saveWorkflowState(); };
  document.addEventListener('mousemove', onMove);
  document.addEventListener('mouseup', onUp);
}

function wfStartConnect(e, nodeId, handle) {
  e.stopPropagation();
  if (handle === 'out') {
    wfConnecting = true;
    wfConnFrom = nodeId;
    const onMove = (ev) => {
      const svg = document.getElementById('wfSvg');
      const fromN = wfNodes.find(n=>n.id===nodeId);
      const scrollEl = document.getElementById('wfMain');
      const rect = document.getElementById('wfCanvasArea').getBoundingClientRect();
      const x2 = ev.clientX - rect.left + scrollEl.scrollLeft;
      const y2 = ev.clientY - rect.top + scrollEl.scrollTop;
      renderWfConnections();
      const x1 = fromN.x+140, y1 = fromN.y+35;
      svg.innerHTML += `<line x1="${x1}" y1="${y1}" x2="${x2}" y2="${y2}" stroke="var(--brand)" stroke-width="2" stroke-dasharray="6,4"/>`;
    };
    const onUp = (ev) => {
      wfConnecting = false;
      document.removeEventListener('mousemove', onMove);
      document.removeEventListener('mouseup', onUp);
      // Find target node
      const elems = document.elementsFromPoint(ev.clientX, ev.clientY);
      const targetNode = elems.find(el => el.classList.contains('wf-node'));
      if (targetNode) {
        const targetId = targetNode.id.replace('wfnode-','');
        if (targetId !== nodeId && !wfConnections.find(c=>c.from===nodeId&&c.to===targetId)) {
          wfConnections.push({from:nodeId, to:targetId, label:''});
          saveWorkflowState();
        }
      }
      renderWfCanvas();
    };
    document.addEventListener('mousemove', onMove);
    document.addEventListener('mouseup', onUp);
  }
}

function wfClickConn(idx) {
  wfSelectedConn = idx;
  showConnLabelModal(idx);
}

function showConnLabelModal(idx) {
  const c = wfConnections[idx];
  if (!c) return;
  document.getElementById('connLabelInput').value = c.label || '';
  document.getElementById('connLabelModal').classList.add('show');
}
function closeConnLabelModal() { document.getElementById('connLabelModal').classList.remove('show'); wfSelectedConn = null; renderWfCanvas(); }
function saveConnLabel() {
  if (wfSelectedConn !== null && wfConnections[wfSelectedConn]) {
    wfConnections[wfSelectedConn].label = document.getElementById('connLabelInput').value.trim();
    saveWorkflowState();
  }
  closeConnLabelModal();
}
function deleteSelectedConnection() {
  if (wfSelectedConn !== null) {
    wfConnections.splice(wfSelectedConn, 1);
    saveWorkflowState();
  }
  closeConnLabelModal();
}

function deleteWfNode(id) {
  wfNodes = wfNodes.filter(n => n.id !== id);
  wfConnections = wfConnections.filter(c => c.from !== id && c.to !== id);
  if (wfSelectedNode === id) wfSelectedNode = null;
  saveWorkflowState();
  renderWfCanvas();
}

function clearWorkflow() {
  if (!confirm('Clear the workflow canvas?')) return;
  wfNodes = []; wfConnections = []; wfSelectedNode = null;
  saveWorkflowState(); renderWfCanvas();
}

function autoLayoutWorkflow() {
  wfNodes.forEach((n, i) => {
    n.x = 80 + (i % 4) * 200;
    n.y = 60 + Math.floor(i / 4) * 120;
  });
  saveWorkflowState(); renderWfCanvas();
}

function loadWfTemplate(idx) {
  const tpl = WF_TEMPLATES[idx]; if (!tpl) return;
  wfNodes = []; wfConnections = [];
  tpl.nodes.forEach((name, i) => {
    wfNodes.push({
      id: 'wfn-tpl-' + Date.now() + i,
      botId: name.toLowerCase().replace(/[^a-z0-9]+/g,'-'),
      name, color: ['#3B82F6','#10B981','#F59E0B','#8B5CF6','#EC4899'][i%5],
      teamName: '', x: 80 + i * 200, y: 120, type: 'bot', status: 'idle'
    });
  });
  for (let i = 0; i < wfNodes.length - 1; i++) {
    wfConnections.push({from: wfNodes[i].id, to: wfNodes[i+1].id, label: ''});
  }
  saveWorkflowState(); renderWfCanvas();
  showToast(`Loaded: ${tpl.name}`);
}

function loadSavedWorkflow(idx) {
  const w = state.workflows[idx]; if (!w) return;
  wfNodes = JSON.parse(JSON.stringify(w.nodes));
  wfConnections = JSON.parse(JSON.stringify(w.connections));
  saveWorkflowState(); renderWfCanvas();
  showToast(`Loaded: ${w.name}`);
}

function showSaveWorkflowModal() { document.getElementById('saveWfModal').classList.add('show'); }
function closeSaveWfModal() { document.getElementById('saveWfModal').classList.remove('show'); }
function saveWorkflow() {
  const name = document.getElementById('saveWfName').value.trim();
  if (!name) { alert('Name required'); return; }
  if (!state.workflows) state.workflows = [];
  state.workflows.push({
    id: 'wf-' + Date.now(), name,
    nodes: JSON.parse(JSON.stringify(wfNodes)),
    connections: JSON.parse(JSON.stringify(wfConnections))
  });
  saveState(); closeSaveWfModal();
  document.getElementById('saveWfName').value = '';
  renderWorkflowSidebar();
  showToast(`💾 "${name}" saved`);
}

function saveWorkflowState() {
  state.currentWorkflow = {nodes: wfNodes, connections: wfConnections};
  saveState();
}

// Simulation
function toggleSimulation() {
  wfSimulating = !wfSimulating;
  document.getElementById('wfSimBar').style.display = wfSimulating ? 'flex' : 'none';
  document.getElementById('wfSimBtn').textContent = wfSimulating ? '⏹️ Stop Sim' : '▶️ Simulate';
  if (!wfSimulating) simReset();
}

function simStep() {
  if (wfSimStep >= wfNodes.length) { document.getElementById('wfSimStatus').textContent = 'Complete!'; return; }
  // Build execution order from connections
  const order = getExecutionOrder();
  if (wfSimStep < order.length) {
    const node = order[wfSimStep];
    node.status = 'running';
    renderWfCanvas();
    setTimeout(() => {
      node.status = node.type === 'human' ? 'waiting' : 'complete';
      wfSimStep++;
      renderWfCanvas();
      document.getElementById('wfSimStatus').textContent = `Step ${wfSimStep}/${order.length}`;
    }, 600);
  }
}

function simRun() {
  simReset();
  const order = getExecutionOrder();
  let step = 0;
  const run = () => {
    if (step >= order.length) { document.getElementById('wfSimStatus').textContent = 'Complete!'; return; }
    order[step].status = 'running';
    renderWfCanvas();
    setTimeout(() => {
      order[step].status = order[step].type === 'human' ? 'waiting' : 'complete';
      step++;
      wfSimStep = step;
      renderWfCanvas();
      document.getElementById('wfSimStatus').textContent = `Step ${step}/${order.length}`;
      setTimeout(run, 400);
    }, 600);
  };
  run();
}

function simReset() {
  wfSimStep = 0;
  wfNodes.forEach(n => n.status = 'idle');
  renderWfCanvas();
  const s = document.getElementById('wfSimStatus');
  if (s) s.textContent = 'Ready';
}

function getExecutionOrder() {
  // Simple topological sort
  const visited = new Set(), order = [];
  const adj = {};
  wfNodes.forEach(n => adj[n.id] = []);
  wfConnections.forEach(c => { if (adj[c.from]) adj[c.from].push(c.to); });
  const roots = wfNodes.filter(n => !wfConnections.some(c => c.to === n.id));
  function dfs(id) {
    if (visited.has(id)) return;
    visited.add(id);
    const node = wfNodes.find(n=>n.id===id);
    if (node) order.push(node);
    (adj[id]||[]).forEach(dfs);
  }
  roots.forEach(r => dfs(r.id));
  wfNodes.forEach(n => { if (!visited.has(n.id)) order.push(n); });
  return order;
}

// Delete key for connections
document.addEventListener('keydown', e => {
  if (e.key === 'Delete' && wfSelectedConn !== null && currentTab === 'workflows') {
    wfConnections.splice(wfSelectedConn, 1);
    wfSelectedConn = null;
    saveWorkflowState();
    renderWfCanvas();
  }
});

// ======================== PHASE 5: CHAT ========================
function initChat() {
  if (!state.chat) {
    state.chat = {
      messages: [],
      step: 0,
      answers: {},
      interviewComplete: false
    };
  }
}

function toggleChat() {
  const panel = document.getElementById('chatPanel');
  const fab = document.getElementById('chatFab');
  const isOpen = panel.classList.contains('open');
  panel.classList.toggle('open');
  fab.classList.toggle('open');
  fab.textContent = isOpen ? '💬' : '✕';
  if (!isOpen && state.chat.messages.length === 0) {
    startChatInterview();
  }
  scrollChatToBottom();
}

function addChatMessage(role, text) {
  state.chat.messages.push({role, text, timestamp: Date.now()});
  saveState();
  renderChatMessages();
  scrollChatToBottom();
}

function renderChatMessages() {
  const container = document.getElementById('chatMessages');
  container.innerHTML = state.chat.messages.map(m =>
    `<div class="chat-bubble ${m.role}">${m.text}</div>`
  ).join('');
}

function scrollChatToBottom() {
  const c = document.getElementById('chatMessages');
  setTimeout(() => { c.scrollTop = c.scrollHeight; }, 50);
}

function showTypingIndicator() {
  const c = document.getElementById('chatMessages');
  c.innerHTML += '<div class="chat-typing" id="chatTyping"><span></span><span></span><span></span></div>';
  scrollChatToBottom();
}

function removeTypingIndicator() {
  const el = document.getElementById('chatTyping');
  if (el) el.remove();
}

function assistantReply(text, delay) {
  delay = delay || 800;
  showTypingIndicator();
  setTimeout(() => {
    removeTypingIndicator();
    addChatMessage('assistant', text);
  }, delay);
}

const INTERVIEW_QUESTIONS = [
  {q: "👋 Welcome to the Architecture Assistant! I'll help you design your agent orchestration system.\n\nWhat industry are you in?", key: 'industry'},
  {q: "How many teams do you have? (e.g., 3, 5, or describe them)", key: 'teamCount'},
  {q: "What are your biggest operational bottlenecks?", key: 'bottlenecks'},
  {q: "What tools do you already use? (e.g., Salesforce, Slack, QuickBooks)", key: 'tools'},
  {q: "Do you need compliance/regulatory monitoring? (yes/no)", key: 'compliance'}
];

function startChatInterview() {
  state.chat.step = 0;
  state.chat.interviewComplete = false;
  assistantReply(INTERVIEW_QUESTIONS[0].q, 500);
}

function sendChat() {
  const input = document.getElementById('chatInput');
  const text = input.value.trim();
  if (!text) return;
  input.value = '';
  addChatMessage('user', text);

  if (!state.chat.interviewComplete && state.chat.step < INTERVIEW_QUESTIONS.length) {
    processInterviewAnswer(text);
  } else {
    processCommand(text);
  }
}

function processInterviewAnswer(answer) {
  const step = state.chat.step;
  const key = INTERVIEW_QUESTIONS[step].key;
  state.chat.answers[key] = answer;
  state.chat.step++;

  if (state.chat.step < INTERVIEW_QUESTIONS.length) {
    assistantReply(INTERVIEW_QUESTIONS[state.chat.step].q);
  } else {
    // Generate summary
    generateInterviewSummary();
  }
  saveState();
}

function generateInterviewSummary() {
  const a = state.chat.answers;
  const matchingTemplate = INDUSTRY_TEMPLATES.find(t =>
    t.name.toLowerCase().includes((a.industry||'').toLowerCase().split(' ')[0])
  );

  let summary = "🎯 **Here's what I recommend:**\n\n";
  if (matchingTemplate) {
    summary += `📋 **Template:** ${matchingTemplate.name}\n`;
    summary += `👥 **Teams:** ${matchingTemplate.teams.map(t=>t.name).join(', ')}\n`;
    summary += `🤖 **Bots:** ${matchingTemplate.teams.reduce((a,t)=>a+t.bots.length,0)} pre-configured\n`;
    summary += `🔌 **Infrastructure:** ${matchingTemplate.infra.join(', ')}\n\n`;
  } else {
    const teamCount = parseInt(a.teamCount) || 3;
    summary += `👥 **Teams:** ${teamCount} teams based on your needs\n`;
    summary += `🤖 **Bots:** Customized for your bottlenecks\n`;
  }
  if (a.compliance?.toLowerCase().includes('yes')) {
    summary += `✅ **Compliance:** Added compliance monitoring bots\n`;
  }
  if (a.tools) {
    summary += `🔌 **Tools:** ${a.tools}\n`;
  }

  assistantReply(summary, 1200);

  setTimeout(() => {
    const applyText = matchingTemplate
      ? `Would you like me to apply the <strong>${matchingTemplate.name}</strong> template to your canvas?<div class="chat-actions"><button class="chat-action-apply" onclick="applyInterviewResult()">✅ Apply</button><button class="chat-action-cancel" onclick="skipInterviewApply()">Skip</button></div>`
      : `I don't have an exact template match, but you can browse the <strong>Marketplace</strong> tab or build manually.<div class="chat-actions"><button class="chat-action-apply" onclick="switchTab('marketplace');toggleChat()">Browse Marketplace</button><button class="chat-action-cancel" onclick="skipInterviewApply()">Continue</button></div>`;
    assistantReply(applyText, 800);
  }, 2200);
}

function applyInterviewResult() {
  const a = state.chat.answers;
  const matchingTemplate = INDUSTRY_TEMPLATES.find(t =>
    t.name.toLowerCase().includes((a.industry||'').toLowerCase().split(' ')[0])
  );
  if (matchingTemplate) {
    applyIndustryTemplate(matchingTemplate.id);
    addChatMessage('assistant', `✅ Applied "${matchingTemplate.name}" template! Check your Canvas tab.`);

    // Add infrastructure from tools answer
    if (a.tools) {
      const tools = a.tools.split(/[,;]+/).map(t=>t.trim()).filter(Boolean);
      tools.forEach(tool => {
        const inf = INFRA_LIBRARY.find(i=>i.name.toLowerCase().includes(tool.toLowerCase()));
        if (inf && !state.infrastructure.approved.find(i=>i.name===inf.name)) {
          state.infrastructure.approved.push({id:inf.name.toLowerCase().replace(/[^a-z0-9]+/g,'-'),name:inf.name,description:inf.desc});
        }
      });
      saveState(); render();
    }
  }
  state.chat.interviewComplete = true;
  saveState();
  assistantReply("You can now type commands like:\n• \"Add a [bot] to [team]\"\n• \"Create a new team called [name]\"\n• \"How many bots do I have?\"\n• \"Show me the healthcare template\"", 600);
}

function skipInterviewApply() {
  state.chat.interviewComplete = true;
  saveState();
  assistantReply("No problem! You can now type commands or build manually.\n\nTry:\n• \"Add a [bot] to [team]\"\n• \"Create a new team called [name]\"\n• \"How many bots do I have?\"", 600);
}

function processCommand(text) {
  const lower = text.toLowerCase();

  // Add bot to team
  const addMatch = lower.match(/add (?:a |an )?(.+?) to (.+)/);
  if (addMatch) {
    const botName = addMatch[1].trim();
    const teamName = addMatch[2].trim();
    const team = state.teams.find(t => t.name.toLowerCase().includes(teamName));
    if (!team) { assistantReply(`❌ Team "${teamName}" not found. Available teams: ${state.teams.map(t=>t.name).join(', ')}`); return; }
    const libBot = BOT_LIBRARY.find(b => b.name.toLowerCase().includes(botName));
    const id = botName.toLowerCase().replace(/[^a-z0-9]+/g,'-')+'-'+Date.now();
    team.members.push({
      id, name: libBot?.name || botName, type: 'bot', isLead: false,
      description: libBot?.desc || botName, skills: libBot?.skills || [],
      mcps: libBot?.mcps || [], status: 'planned', phase: 'P1',
      relType: libBot?.relType||'Tool', engStyle: libBot?.engStyle||'Answer Machine',
      humanCheckpoint: libBot?.humanCheckpoint||'', starters: libBot?.starters||[]
    });
    saveState(); render();
    assistantReply(`✅ Added "${libBot?.name||botName}" to ${team.name}`);
    // Flash the new node
    setTimeout(() => {
      const el = document.querySelector(`[onclick*="${id}"]`);
      if (el) el.classList.add('flash-green');
    }, 200);
    return;
  }

  // Create team
  const teamMatch = lower.match(/create (?:a )?(?:new )?team (?:called |named )?(.+)/);
  if (teamMatch) {
    const name = teamMatch[1].trim();
    const colors = ['#3B82F6','#10B981','#F59E0B','#8B5CF6','#EC4899','#14B8A6'];
    state.teams.push({
      id: name.toLowerCase().replace(/[^a-z0-9]+/g,'-')+'-'+Date.now(),
      name: name.charAt(0).toUpperCase() + name.slice(1),
      color: colors[state.teams.length % colors.length],
      colorClass: 'blue', members: []
    });
    saveState(); render();
    assistantReply(`✅ Created team "${name}"`);
    return;
  }

  // Remove bot
  const removeMatch = lower.match(/remove (.+)/);
  if (removeMatch) {
    const botName = removeMatch[1].trim();
    let found = false;
    state.teams.forEach(t => {
      const idx = t.members.findIndex(m => m.name.toLowerCase().includes(botName));
      if (idx >= 0) {
        const removed = t.members.splice(idx, 1)[0];
        assistantReply(`✅ Removed "${removed.name}" from ${t.name}`);
        found = true;
      }
    });
    if (!found) assistantReply(`❌ Bot "${botName}" not found`);
    else { saveState(); render(); }
    return;
  }

  // Add infrastructure
  const infraMatch = lower.match(/add (.+?) to infrastructure/);
  if (infraMatch) {
    const toolName = infraMatch[1].trim();
    const inf = INFRA_LIBRARY.find(i=>i.name.toLowerCase().includes(toolName));
    if (inf && !state.infrastructure.approved.find(i=>i.name===inf.name)) {
      state.infrastructure.approved.push({id:inf.name.toLowerCase().replace(/[^a-z0-9]+/g,'-'),name:inf.name,description:inf.desc});
      saveState(); render();
      assistantReply(`✅ Added "${inf.name}" to infrastructure`);
    } else if (inf) {
      assistantReply(`"${inf.name}" is already in your infrastructure`);
    } else {
      state.infrastructure.approved.push({id:toolName.toLowerCase().replace(/[^a-z0-9]+/g,'-'),name:toolName,description:toolName});
      saveState(); render();
      assistantReply(`✅ Added "${toolName}" to infrastructure`);
    }
    return;
  }

  // Show template
  const tplMatch = lower.match(/show (?:me )?(?:the )?(.+?) template/);
  if (tplMatch) {
    const industry = tplMatch[1].trim();
    const tpl = INDUSTRY_TEMPLATES.find(t => t.name.toLowerCase().includes(industry));
    if (tpl) {
      assistantReply(`📋 **${tpl.name}**\n\n👥 Teams: ${tpl.teams.map(t=>t.name).join(', ')}\n🤖 Bots: ${tpl.teams.flatMap(t=>t.bots).join(', ')}\n🔌 Infra: ${tpl.infra.join(', ')}\n\n<div class="chat-actions"><button class="chat-action-apply" onclick="applyIndustryTemplate('${tpl.id}');addChatMessage('assistant','✅ Template applied!')">Apply</button></div>`);
    } else {
      assistantReply(`❌ No template found for "${industry}". Try: ${INDUSTRY_TEMPLATES.map(t=>t.name.split(' ')[0].toLowerCase()).join(', ')}`);
    }
    return;
  }

  // Bot count
  if (lower.includes('how many bots') || lower.includes('bot count')) {
    const total = state.teams.reduce((a,t)=>a+t.members.length,0) + state.sharedServices.length;
    const active = state.teams.reduce((a,t)=>a+t.members.filter(m=>m.status==='active').length,0) + state.sharedServices.filter(s=>s.status==='active').length;
    assistantReply(`📊 You have **${total}** bots total (**${active}** active) across ${state.teams.length} teams + shared services.`);
    return;
  }

  // Current spend
  if (lower.includes('spend') || lower.includes('cost') || lower.includes('token')) {
    const ta = state.tokenAnalytics;
    if (ta) {
      assistantReply(`💰 **Token Analytics Summary:**\n\n• Monthly spend: $${ta.monthly.total.toFixed(2)}\n• Daily avg: $${ta.monthly.avgDaily.toFixed(2)}\n• Projected: $${ta.monthly.projected.toFixed(2)}\n• Budget: $${ta.monthly.budget.toFixed(2)} (${(ta.monthly.total/ta.monthly.budget*100).toFixed(0)}% used)`);
    } else {
      assistantReply("📊 No token analytics data yet. Visit the Analytics tab to generate mock data.");
    }
    return;
  }

  // Help
  if (lower.includes('help') || lower === '?') {
    assistantReply("🔧 **Available commands:**\n\n• \"Add a [bot] to [team]\"\n• \"Create a new team called [name]\"\n• \"Remove [bot name]\"\n• \"Add [tool] to infrastructure\"\n• \"Show me the [industry] template\"\n• \"How many bots do I have?\"\n• \"What's my current spend?\"");
    return;
  }

  // Unrecognized
  assistantReply(`🤔 I didn't understand "${text}". Type "help" to see available commands.`);
}

// ======================== UPDATED TAB SWITCHING ========================
// Override the existing switchTab function
const _origSwitchTab = switchTab;
switchTab = function(tab) {
  currentTab = tab;
  document.querySelectorAll('.nav-tab').forEach(t => t.classList.toggle('active', t.dataset.tab === tab));
  document.querySelectorAll('.tab-content').forEach(t => t.classList.toggle('active', t.id === 'tab-' + tab));
  if (tab === 'mcphub') renderMcpHub();
  if (tab === 'analytics') renderAnalytics();
  if (tab === 'marketplace') renderMarketplace();
  if (tab === 'workflows') { initWorkflows(); renderWorkflowSidebar(); renderWfCanvas(); }
  if (tab === 'settings') { renderSubscription(); loadWhiteLabelForm(); renderOrgList(); renderShareList(); }
  // Show/hide chat FAB only on canvas
  const fab = document.getElementById('chatFab');
  if (fab) fab.style.display = (tab === 'canvas') ? '' : 'none';
};

// ======================== INIT ========================
window.addEventListener('resize',()=>drawLines());
loadState();
// Merge conversation starters from defaults into loaded state (only if not blank/first-visit)
(function mergeStarters(){
  if(isFirstVisit) return;
  const defSS=DEFAULT_DATA.sharedServices;
  state.sharedServices.forEach(ss=>{
    if(!ss.starters||!ss.starters.length){
      const def=defSS.find(d=>d.name===ss.name);
      if(def&&def.starters)ss.starters=def.starters;
    }
  });
  const defTeams=DEFAULT_DATA.teams;
  state.teams.forEach(t=>{
    const dt=defTeams.find(d=>d.name===t.name);
    if(!dt)return;
    t.members.forEach(m=>{
      if(!m.starters||!m.starters.length){
        const dm=dt.members.find(d=>d.name===m.name);
        if(dm&&dm.starters)m.starters=dm.starters;
      }
    });
  });
  saveState();
})();
if(!state.branding)state.branding={company:'RISE RE',primaryColor:'#3B82F6',logo:''};
if(!state.executive.profilePic)state.executive.profilePic='';
if(!state.orchestrator.profilePic)state.orchestrator.profilePic='';
if(!state.customSkills)state.customSkills=[];
if(!state.mcpHub||!Array.isArray(state.mcpHub))state.mcpHub=DEFAULT_DATA.mcpHub;

// Phase 3-5 state init
if(!state.subscription)state.subscription={tier:'free',testingMode:true};
if(!state.whiteLabel)state.whiteLabel={};
if(!state.shareLinks)state.shareLinks=[];
if(!state.marketplace)state.marketplace={published:[]};
if(!state.tokenBudget)state.tokenBudget={monthly:5000,alerts:[50,75,90,100]};
initOrganizations();
initChat();
initWorkflows();

// Show testing banner
document.getElementById('testingBanner').style.display=state.subscription.testingMode?'':'none';
renderOrgSelector();

render();

// ======================== TEMPLATE PICKER (first visit) ========================
function showTemplatePicker() {
  let overlay = document.getElementById('templatePickerOverlay');
  if (!overlay) {
    overlay = document.createElement('div');
    overlay.id = 'templatePickerOverlay';
    overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(15,23,42,0.97);z-index:500;display:flex;flex-direction:column;align-items:center;overflow-y:auto;padding:40px 20px';
    const header = document.createElement('div');
    header.style.cssText = 'text-align:center;margin-bottom:32px;max-width:600px';
    header.innerHTML = `
      <div style="font-size:48px;margin-bottom:16px">◆</div>
      <h1 style="font-size:28px;font-weight:800;margin-bottom:8px;color:#f1f5f9">Welcome to Milliebot.io</h1>
      <p style="font-size:16px;color:#94a3b8;line-height:1.6">Choose an industry template to get started, or start with a blank canvas and build your own.</p>
    `;
    overlay.appendChild(header);

    const grid = document.createElement('div');
    grid.style.cssText = 'display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px;max-width:960px;width:100%;margin-bottom:32px';
    
    // Blank canvas option
    grid.innerHTML = `
      <div onclick="startBlankCanvas()" style="padding:24px;border-radius:12px;border:2px dashed #475569;cursor:pointer;transition:all .2s;text-align:center;display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:160px" onmouseover="this.style.borderColor='#3B82F6';this.style.background='rgba(59,130,246,0.05)'" onmouseout="this.style.borderColor='#475569';this.style.background='none'">
        <div style="font-size:32px;margin-bottom:8px">✏️</div>
        <div style="font-weight:700;font-size:16px;margin-bottom:4px">Blank Canvas</div>
        <div style="font-size:13px;color:#94a3b8">Start from scratch and build your own agent architecture</div>
      </div>
    `;

    INDUSTRY_TEMPLATES.slice(0, 12).forEach(tmpl => {
      const card = document.createElement('div');
      card.style.cssText = 'padding:24px;border-radius:12px;border:1px solid #334155;background:#1e293b;cursor:pointer;transition:all .2s;min-height:160px';
      card.onmouseover = function() { this.style.borderColor='#3B82F6'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 24px rgba(59,130,246,0.15)'; };
      card.onmouseout = function() { this.style.borderColor='#334155'; this.style.transform='none'; this.style.boxShadow='none'; };
      card.onclick = function() { applyIndustryTemplate(tmpl.id); };
      card.innerHTML = `
        <div style="font-size:32px;margin-bottom:8px">${tmpl.icon}</div>
        <div style="font-weight:700;font-size:16px;margin-bottom:4px">${tmpl.name}</div>
        <div style="font-size:13px;color:#94a3b8;line-height:1.5;margin-bottom:8px">${tmpl.teams.length} teams · ${tmpl.teams.reduce((a,t)=>a+t.bots.length,0)} bots · ${tmpl.infra.length} integrations</div>
        <div style="font-size:11px;color:#64748b">${tmpl.teams.map(t=>t.name).join(' · ')}</div>
      `;
      grid.appendChild(card);
    });
    overlay.appendChild(grid);
    document.body.appendChild(overlay);
  }
  overlay.style.display = 'flex';
}
function hideTemplatePicker() {
  const overlay = document.getElementById('templatePickerOverlay');
  if (overlay) overlay.style.display = 'none';
  isFirstVisit = false;
}
function startBlankCanvas() {
  hideTemplatePicker();
  showToast('🎨 Blank canvas ready — add teams from the Library or use the chat builder!');
}

// Show template picker on first visit
if (isFirstVisit) { setTimeout(showTemplatePicker, 300); }

// Auto-add expand buttons to textareas that don't have them
function addExpandButtons() {
  document.querySelectorAll('textarea:not([data-expand-added])').forEach(ta => {
    if (ta.id === 'expandModalTextarea') return;
    ta.setAttribute('data-expand-added', 'true');
    const btn = document.createElement('button');
    btn.className = 'expand-btn';
    btn.textContent = '↗ Expand';
    btn.onclick = function(e) { e.preventDefault(); e.stopPropagation(); openExpandModal(ta.id, ta.closest('.form-group')?.querySelector('label')?.textContent?.replace('↗ Expand','').trim() || 'Edit'); };
    if (ta.id && ta.parentElement) ta.parentElement.insertBefore(btn, ta.nextSibling);
  });
  // Also make view-mode description fields clickable to expand
  document.querySelectorAll('.view-field.multiline:not([data-expand-added])').forEach(vf => {
    vf.setAttribute('data-expand-added', 'true');
    vf.style.cursor = 'pointer';
    vf.title = 'Click to expand';
    const btn = document.createElement('button');
    btn.className = 'expand-btn';
    btn.textContent = '↗ View Full';
    btn.style.marginTop = '4px';
    btn.onclick = function(e) { e.preventDefault(); e.stopPropagation(); openExpandView(vf.textContent, 'Description'); };
    vf.parentElement.appendChild(btn);
  });
}
// Run after every render
const origRender = typeof render === 'function' ? render : null;
if (origRender) {
  const _origRender = render;
  render = function() { _origRender(); setTimeout(addExpandButtons, 50); };
}
// Also run on panel open
const origRenderBotPanel = typeof renderBotPanel === 'function' ? renderBotPanel : null;
if (origRenderBotPanel) {
  const _origPanel = renderBotPanel;
  renderBotPanel = function() { _origPanel.apply(this, arguments); setTimeout(addExpandButtons, 50); };
}
setTimeout(addExpandButtons, 500);

// ======================== PHASE 5B: BOT CONFIG, INTEGRATIONS, COPILOT ========================

const BOT_TEMPLATES = {
  'leasing-agent':{name:'Leasing Agent',personality:'You are a leasing specialist for a multifamily property. You track leads, schedule tours, follow up with prospects, and report on conversion rates. You are warm, persuasive, and data-driven.',tone:{formal:35,detail:55,autonomous:50},style:['Professional','Friendly'],capabilities:['Track and score leads','Schedule property tours','Follow up with prospects','Generate leasing reports','Monitor conversion rates'],requiredIntegrations:['crm','email','calendar'],guardrails:{canEmail:true,canSpend:false,canDelete:false,canContact:true,approvalRequired:['financial'],confidenceThreshold:70}},
  'maintenance-coordinator':{name:'Maintenance Coordinator',personality:'You manage work orders for a property management company. You prioritize by urgency, track SLA compliance, coordinate with vendors, and report on completion rates. You are efficient, organized, and responsive.',tone:{formal:50,detail:70,autonomous:60},style:['Direct','Professional'],capabilities:['Prioritize work orders by urgency','Track SLA compliance','Coordinate vendor dispatch','Monitor make-ready pipeline','Generate maintenance reports'],requiredIntegrations:['maintenance-system','email','vendor-portal'],guardrails:{canEmail:true,canSpend:true,spendLimit:500,canDelete:false,canContact:true,approvalRequired:['financial'],confidenceThreshold:60}},
  'report-generator':{name:'Report Generator',personality:'You create daily, weekly, and monthly reports for property management. You pull data from multiple sources, calculate KPIs, format reports for executives, and distribute via email. You are precise, thorough, and consistent.',tone:{formal:70,detail:80,autonomous:70},style:['Professional','Technical'],capabilities:['Pull data from property management systems','Calculate occupancy and financial KPIs','Generate formatted reports','Distribute reports via email','Track trends and flag anomalies'],requiredIntegrations:['pms','email','spreadsheet'],guardrails:{canEmail:true,canSpend:false,canDelete:false,canContact:false,approvalRequired:[],confidenceThreshold:80}},
  'email-assistant':{name:'Email Assistant',personality:"You manage email communications for a busy executive. You triage incoming mail, draft responses, flag urgent items, and keep the inbox organized. You match the executive's tone and never send without approval for external contacts.",tone:{formal:60,detail:50,autonomous:40},style:['Professional','Empathetic'],capabilities:['Triage and prioritize emails','Draft contextual responses','Flag urgent items','Organize inbox with rules','Track follow-ups'],requiredIntegrations:['email'],guardrails:{canEmail:true,canSpend:false,canDelete:true,canContact:false,approvalRequired:['external_comms'],confidenceThreshold:70}},
  'hr-recruiter':{name:'HR Recruiter',personality:'You assist with recruitment for a property management company. You screen resumes, schedule interviews, send follow-ups, and track candidates through the hiring pipeline. You are organized, fair, and responsive.',tone:{formal:60,detail:60,autonomous:50},style:['Professional','Friendly','Empathetic'],capabilities:['Screen resumes against job requirements','Schedule interviews','Send candidate follow-ups','Track pipeline status','Generate hiring reports'],requiredIntegrations:['email','calendar','ats'],guardrails:{canEmail:true,canSpend:false,canDelete:false,canContact:true,approvalRequired:['external_comms'],confidenceThreshold:65}},
  'investor-relations':{name:'Investor Relations',personality:'You prepare and distribute investor communications for a real estate portfolio. You compile financial data, create distribution reports, draft investor updates, and track investor inquiries. You are precise, professional, and discreet.',tone:{formal:80,detail:80,autonomous:30},style:['Professional','Technical'],capabilities:['Compile financial roll-ups','Generate distribution reports','Draft investor updates','Track investor inquiries','Monitor portfolio KPIs'],requiredIntegrations:['email','spreadsheet','pms'],guardrails:{canEmail:false,canSpend:false,canDelete:false,canContact:false,approvalRequired:['financial','external_comms'],confidenceThreshold:85}},
  'vendor-manager':{name:'Vendor Manager',personality:'You coordinate with vendors and contractors for property maintenance and construction. You track bids, manage contracts, verify insurance, and ensure work quality. You are organized, firm but fair, and detail-oriented.',tone:{formal:60,detail:70,autonomous:50},style:['Direct','Professional'],capabilities:['Track vendor bids and proposals','Manage service contracts','Verify insurance and compliance','Coordinate scheduled work','Generate vendor performance reports'],requiredIntegrations:['email','vendor-portal','maintenance-system'],guardrails:{canEmail:true,canSpend:true,spendLimit:1000,canDelete:false,canContact:true,approvalRequired:['financial'],confidenceThreshold:60}},
  'data-analyst':{name:'Data Analyst',personality:'You analyze operational data for a property management portfolio. You identify trends, flag anomalies, create visualizations, and provide actionable insights. You are analytical, curious, and clear in your explanations.',tone:{formal:50,detail:80,autonomous:60},style:['Technical','Direct'],capabilities:['Analyze occupancy and revenue trends','Flag performance anomalies','Create data visualizations','Generate insight summaries','Compare properties and benchmarks'],requiredIntegrations:['pms','spreadsheet'],guardrails:{canEmail:false,canSpend:false,canDelete:false,canContact:false,approvalRequired:[],confidenceThreshold:75}}
};

const INTEGRATION_TEMPLATES = {
  'email':{name:'Email (Microsoft 365)',icon:'📧',authType:'oauth',desc:'Send and read emails',connectLabel:'Connect with Microsoft 365'},
  'calendar':{name:'Calendar',icon:'📅',authType:'oauth',desc:'Schedule meetings and events',connectLabel:'Connect with Microsoft 365'},
  'crm':{name:'CRM',icon:'👥',authType:'apikey',desc:'Manage contacts and leads',connectLabel:'Paste your CRM API key'},
  'pms':{name:'Property Management System',icon:'🏢',authType:'apikey',desc:'Access property data, leases, and work orders',connectLabel:'Paste your Entrata API key'},
  'spreadsheet':{name:'Google Sheets',icon:'📊',authType:'oauth',desc:'Read and write spreadsheet data',connectLabel:'Connect with Google'},
  'maintenance-system':{name:'Maintenance System',icon:'🔧',authType:'apikey',desc:'Manage work orders and maintenance requests',connectLabel:'Paste your maintenance system API key'},
  'vendor-portal':{name:'Vendor Portal',icon:'🏗️',authType:'apikey',desc:'Manage vendor relationships and contracts',connectLabel:'Paste your vendor portal API key'},
  'ats':{name:'Applicant Tracking',icon:'📋',authType:'apikey',desc:'Track job applicants and hiring pipeline',connectLabel:'Paste your ATS API key'},
  'slack':{name:'Slack',icon:'💬',authType:'oauth',desc:'Send notifications and messages',connectLabel:'Connect with Slack'},
  'storage':{name:'Cloud Storage',icon:'☁️',authType:'oauth',desc:'Read and write files',connectLabel:'Connect with Google Drive'}
};

if(!state.botConfigs) state.botConfigs = {};
if(!state.integrations) state.integrations = {};
if(!state.templateConfigs) state.templateConfigs = {};

// Deploy MARKETPLACE_EXTRA template (non-industry)
function deployMarketplaceExtra(tpl) {
  const mp = MARKETPLACE_EXTRA.find(m=>m.id===tpl.id);
  if(!mp || !mp.teams) return;
  const fresh = JSON.parse(JSON.stringify(BLANK_STATE));
  fresh.branding = state.branding || fresh.branding;
  fresh.executive = state.executive || fresh.executive;
  fresh.orchestrator = state.orchestrator || fresh.orchestrator;
  fresh.sharedServices = [
    {id:'scheduler-'+Date.now(),name:'Scheduler Bot',type:'bot',description:'Centralized scheduling service.',skills:['Calendar management'],mcps:['Microsoft Graph API'],status:'active',phase:'P1',relType:'Tool',engStyle:'Answer Machine',humanCheckpoint:'Review scheduling conflicts weekly',starters:['Schedule a recurring task','Show all active tasks']}
  ];
  mp.teams.forEach((t,ti) => {
    const teamId = t.name.toLowerCase().replace(/[^a-z0-9]+/g,'-')+'-'+Date.now();
    const members = t.bots.map((b,bi) => {
      const botId = b.n.toLowerCase().replace(/[^a-z0-9]+/g,'-')+'-'+Date.now()+bi;
      // Store bot config
      state.botConfigs[botId] = {
        name: b.n, icon: b.icon||'🤖', role: b.role||'', template: mp.name,
        personality: b.personality || `You are a ${b.n} that ${(b.role||'').toLowerCase()}. You are professional and efficient.`,
        tone: b.tone || {formal:50,detail:60,autonomous:50},
        style: b.style || ['Professional'],
        capabilities: b.role ? b.role.split(', ') : [],
        status: 'active',
        guardrails: {canEmail:true,canSpend:false,canDelete:false,canContact:false,approvalRequired:['financial'],confidenceThreshold:70}
      };
      return {
        id: botId, name: b.n, type:'bot', isLead: bi===0,
        description: b.role || b.n,
        skills: [], mcps: mp.infra||[],
        status: 'active', phase:'P1',
        relType:'Tool', engStyle:'Answer Machine',
        humanCheckpoint:'', starters:[]
      };
    });
    fresh.teams.push({id:teamId,name:t.name,color:t.color||'#3B82F6',colorClass:'blue',members});
  });
  (mp.infra||[]).forEach(name => {
    fresh.infrastructure.approved.push({id:name.toLowerCase().replace(/[^a-z0-9]+/g,'-')+'-'+Date.now(),name,description:name});
  });
  fresh.mcpHub = (mp.infra||[]).map(name => ({name,status:'active'}));
  state = Object.assign(state, fresh);
  state.botConfigs = state.botConfigs || {};
  state.integrations = state.integrations || {};
  closePanel(); selectedNode = null;
  saveState(); render();
  hideTemplatePicker();
}

// ---- Bot Config Panel ----
let bcpCurrentBot = null;
let bcpCurrentTab = 'overview';

function openBotConfig(botId) {
  // Find bot across all teams and shared services
  let bot = null, teamId = null;
  state.teams.forEach(t => { t.members.forEach(m => { if(m.id === botId) { bot = m; teamId = t.id; } }); });
  if(!bot) state.sharedServices.forEach(s => { if(s.id === botId) bot = s; });
  if(!bot) return;
  bcpCurrentBot = botId;
  bcpCurrentTab = 'overview';
  // Ensure config exists
  if(!state.botConfigs[botId]) {
    const tplKey = bot.name.toLowerCase().replace(/\s+/g,'-');
    const tpl = BOT_TEMPLATES[tplKey] || {};
    state.botConfigs[botId] = {
      name: bot.name, icon: '🤖', role: bot.description || '', template: '',
      personality: tpl.personality || `You are a ${bot.name}. ${bot.description||''}`,
      tone: tpl.tone || {formal:50,detail:50,autonomous:50},
      style: tpl.style || ['Professional'],
      capabilities: tpl.capabilities || (bot.skills||[]),
      status: bot.status || 'active',
      guardrails: tpl.guardrails || {canEmail:false,canSpend:false,canDelete:false,canContact:false,approvalRequired:['financial'],confidenceThreshold:70}
    };
  }
  renderBotConfigPanel();
  document.getElementById('botConfigPanel').classList.add('open');
}

function closeBotConfigPanel() {
  document.getElementById('botConfigPanel').classList.remove('open');
  bcpCurrentBot = null;
}

function renderBotConfigPanel() {
  const cfg = state.botConfigs[bcpCurrentBot];
  if(!cfg) return;
  const panel = document.getElementById('botConfigPanel');
  // Count connected integrations
  const reqInt = BOT_TEMPLATES[cfg.name.toLowerCase().replace(/\s+/g,'-')]?.requiredIntegrations || [];
  const connCount = reqInt.filter(i=>state.integrations[i]).length;
  const allConn = reqInt.length === 0 || connCount === reqInt.length;
  // Tabs
  document.querySelectorAll('.bcp-tab').forEach(t => t.classList.toggle('active', t.dataset.tab === bcpCurrentTab));
  const body = document.getElementById('bcpBody');
  if(bcpCurrentTab === 'overview') {
    body.innerHTML = `
      <div class="bcp-section">
        <input class="bcp-name-input" value="${esc(cfg.name)}" onchange="updateBotCfg('name',this.value)">
        <input class="bcp-role-input" value="${esc(cfg.role)}" placeholder="What does this bot do?" onchange="updateBotCfg('role',this.value)">
        ${cfg.template ? `<span class="bcp-template-badge">📦 ${esc(cfg.template)}</span>` : ''}
      </div>
      <div class="bcp-section">
        <h4>Status</h4>
        <div class="bcp-status-toggle">
          <div class="bcp-status-opt ${cfg.status==='active'?'active-status':''}" onclick="updateBotCfg('status','active');renderBotConfigPanel()">Active</div>
          <div class="bcp-status-opt ${cfg.status==='paused'?'paused-status':''}" onclick="updateBotCfg('status','paused');renderBotConfigPanel()">Paused</div>
          <div class="bcp-status-opt ${cfg.status==='draft'?'draft-status':''}" onclick="updateBotCfg('status','draft');renderBotConfigPanel()">Draft</div>
        </div>
      </div>
      <div class="bcp-section">
        <div class="bcp-status-badge ${allConn?'ready':'needs-setup'}">${allConn?'✅ Ready to Go':'⚠️ Needs Setup — '+( reqInt.length-connCount)+' integration'+(reqInt.length-connCount>1?'s':'')}</div>
      </div>
      <div class="bcp-section">
        <h4>Quick Stats</h4>
        <div class="bcp-stat-row">
          <div class="bcp-stat"><div class="val">${Math.floor(Math.random()*200)+50}</div><div class="lbl">Tasks Done</div></div>
          <div class="bcp-stat"><div class="val">99.${Math.floor(Math.random()*9)}%</div><div class="lbl">Uptime</div></div>
          <div class="bcp-stat"><div class="val">${Math.floor(Math.random()*24)+1}h</div><div class="lbl">Last Active</div></div>
        </div>
      </div>
      <div class="bcp-section">
        <h4>This bot handles</h4>
        <ul class="bcp-cap-list">${(cfg.capabilities||[]).map(c=>`<li>${esc(c)}</li>`).join('')}</ul>
      </div>`;
  } else if(bcpCurrentTab === 'personality') {
    const tones = cfg.tone || {formal:50,detail:50,autonomous:50};
    const styles = ['Professional','Friendly','Direct','Empathetic','Technical'];
    const activeStyles = cfg.style || [];
    body.innerHTML = `
      <div class="bcp-section">
        <h4>What should this bot do?</h4>
        <textarea class="bcp-personality-ta" id="bcpPersonality" onchange="updateBotCfg('personality',this.value)">${esc(cfg.personality||'')}</textarea>
      </div>
      <div class="bcp-section">
        <h4>Tone</h4>
        <div class="bcp-tone-slider tone-formal"><span class="tone-label">Formal</span><input type="range" min="0" max="100" value="${tones.formal}" oninput="updateBotTone('formal',this.value)"><span class="tone-label-r">Casual</span></div>
        <div class="bcp-tone-slider tone-detail"><span class="tone-label">Brief</span><input type="range" min="0" max="100" value="${tones.detail}" oninput="updateBotTone('detail',this.value)"><span class="tone-label-r">Detailed</span></div>
        <div class="bcp-tone-slider tone-auton"><span class="tone-label">Cautious</span><input type="range" min="0" max="100" value="${tones.autonomous}" oninput="updateBotTone('autonomous',this.value)"><span class="tone-label-r">Autonomous</span></div>
      </div>
      <div class="bcp-section">
        <h4>Communication Style</h4>
        <div class="bcp-chips">${styles.map(s=>`<div class="bcp-chip ${activeStyles.includes(s)?'on':''}" onclick="toggleBotStyle('${s}')">${s}</div>`).join('')}</div>
      </div>
      <div class="bcp-section">
        <h4>Preview</h4>
        <div class="bcp-preview" id="bcpPreview">${generateStylePreview(cfg)}</div>
      </div>`;
  } else if(bcpCurrentTab === 'skills') {
    const skills = cfg.capabilities || [];
    body.innerHTML = `
      <div class="bcp-section">
        <h4>Assigned Skills</h4>
        <div class="bcp-skill-grid">${skills.map((s,i)=>`
          <div class="bcp-skill-card">
            <div class="sk-top"><span class="sk-name">${esc(s)}</span><div class="ios-toggle on" onclick="this.classList.toggle('on')"></div></div>
            <div class="sk-status" style="color:var(--green)">✅ Active</div>
          </div>`).join('')}
          <div class="bcp-skill-card" style="border-style:dashed;cursor:pointer;align-items:center;justify-content:center;color:var(--text3)" onclick="showToast('Skill library coming soon!')">
            <div style="font-size:20px">+</div>
            <div class="sk-name">Add Skill</div>
          </div>
        </div>
      </div>`;
  } else if(bcpCurrentTab === 'connections') {
    const reqIntKeys = BOT_TEMPLATES[cfg.name.toLowerCase().replace(/\s+/g,'-')]?.requiredIntegrations || Object.keys(INTEGRATION_TEMPLATES).slice(0,3);
    const connCount2 = reqIntKeys.filter(i=>state.integrations[i]).length;
    body.innerHTML = `
      <div class="bcp-section">
        <p style="font-size:12px;color:var(--text2);margin-bottom:12px">This bot uses ${reqIntKeys.length} integration${reqIntKeys.length>1?'s':''}. ${connCount2} connected, ${reqIntKeys.length-connCount2} need${reqIntKeys.length-connCount2===1?'s':''} setup.</p>
        ${reqIntKeys.map(key => {
          const it = INTEGRATION_TEMPLATES[key] || {name:key,icon:'🔌',desc:''};
          const connected = !!state.integrations[key];
          return `<div class="bcp-conn-card ${connected?'connected':''}">
            <div class="cc-left"><span class="cc-icon">${it.icon}</span><div><div class="cc-name">${it.name}</div><div class="cc-desc">${it.desc}</div></div></div>
            ${connected ? `<span class="bcp-conn-status">✅ Connected</span>` : `<button class="bcp-conn-btn" onclick="openIntegrationConnect('${key}')">Connect</button>`}
          </div>`;
        }).join('')}
      </div>`;
  } else if(bcpCurrentTab === 'guardrails') {
    const g = cfg.guardrails || {};
    body.innerHTML = `
      <div class="bcp-section">
        <h4>Permissions</h4>
        <div class="bcp-guard"><div><div class="g-label">Can send emails without approval</div></div><div class="ios-toggle ${g.canEmail?'on':''}" onclick="toggleGuardrail('canEmail')"></div></div>
        <div class="bcp-guard"><div><div class="g-label">Can spend money</div>${g.canSpend?`<div class="g-sub">Max per transaction: <input class="bcp-spend-input" type="number" value="${g.spendLimit||0}" onchange="updateGuardrail('spendLimit',+this.value)"></div>`:''}</div><div class="ios-toggle ${g.canSpend?'on':''}" onclick="toggleGuardrail('canSpend')"></div></div>
        <div class="bcp-guard"><div><div class="g-label">Can delete data</div></div><div class="ios-toggle ${g.canDelete?'on':''}" onclick="toggleGuardrail('canDelete')"></div></div>
        <div class="bcp-guard"><div><div class="g-label">Can contact external people</div></div><div class="ios-toggle ${g.canContact?'on':''}" onclick="toggleGuardrail('canContact')"></div></div>
      </div>
      <div class="bcp-section">
        <h4>Confidence Threshold</h4>
        <div class="bcp-confidence">
          <div class="conf-val" id="confVal">${g.confidenceThreshold||70}%</div>
          <input type="range" min="0" max="100" value="${g.confidenceThreshold||70}" oninput="document.getElementById('confVal').textContent=this.value+'%';updateGuardrail('confidenceThreshold',+this.value)">
          <p style="font-size:11px;color:var(--text3);text-align:center;margin-top:4px">Ask a human when confidence is below this level</p>
        </div>
      </div>
      <div class="bcp-section">
        <h4>When stuck, notify</h4>
        <select style="width:100%" onchange="updateGuardrail('escalation',this.value)">
          <option value="team-lead" ${(g.escalation||'team-lead')==='team-lead'?'selected':''}>Team Lead</option>
          <option value="specific" ${g.escalation==='specific'?'selected':''}>Specific Person</option>
          <option value="nobody" ${g.escalation==='nobody'?'selected':''}>Nobody (autonomous)</option>
        </select>
      </div>`;
  }
}

function updateBotCfg(key, val) { if(!state.botConfigs[bcpCurrentBot]) return; state.botConfigs[bcpCurrentBot][key]=val; saveState(); }
function updateBotTone(key, val) { if(!state.botConfigs[bcpCurrentBot]) return; if(!state.botConfigs[bcpCurrentBot].tone) state.botConfigs[bcpCurrentBot].tone={}; state.botConfigs[bcpCurrentBot].tone[key]=+val; saveState(); }
function toggleBotStyle(s) {
  const cfg = state.botConfigs[bcpCurrentBot]; if(!cfg) return;
  if(!cfg.style) cfg.style=[];
  const i = cfg.style.indexOf(s);
  if(i>=0) cfg.style.splice(i,1); else cfg.style.push(s);
  saveState(); renderBotConfigPanel();
}
function toggleGuardrail(key) {
  const g = state.botConfigs[bcpCurrentBot]?.guardrails; if(!g) return;
  g[key] = !g[key]; saveState(); renderBotConfigPanel();
}
function updateGuardrail(key, val) {
  const g = state.botConfigs[bcpCurrentBot]?.guardrails; if(!g) return;
  g[key] = val; saveState();
}
function generateStylePreview(cfg) {
  const tone = cfg.tone || {};
  const formal = (tone.formal||50) > 50;
  const detailed = (tone.detail||50) > 50;
  if(cfg.name.toLowerCase().includes('leasing')) return formal ? '"Good afternoon. I\'ve prepared your leasing performance summary for this week. Conversion rate is up 12% — shall I detail the top-performing sources?"' : '"Hey! Quick update — leasing is killing it this week. Conversions up 12%. Want the breakdown?"';
  if(cfg.name.toLowerCase().includes('maintenance')) return formal ? '"Work order #4521 has been classified as Priority 1. I\'ve dispatched ABC Plumbing (ETA: 2 hours) and notified the resident."' : '"Heads up — emergency work order just came in. Already sent a plumber, should be there in 2 hours."';
  return formal ? `"I've completed the requested analysis. ${detailed?'The full report includes variance breakdowns by category, trend comparisons, and recommended actions.':'Summary attached — let me know if you need details.'}"` : `"Done! ${detailed?'Here\'s everything — the numbers, the trends, and what I think we should do about it.':'Quick summary ready. Holler if you want more.'}"`;
}

function switchBcpTab(tab) { bcpCurrentTab = tab; renderBotConfigPanel(); }

// ---- Integration Connect Modal ----
let acmCurrentIntegration = null;

function openIntegrationConnect(intId) {
  acmCurrentIntegration = intId;
  const it = INTEGRATION_TEMPLATES[intId] || {name:intId,icon:'🔌',authType:'apikey',desc:'Connect this service.',connectLabel:'Paste API key'};
  const modal = document.getElementById('apiConnectModal');
  document.getElementById('acmIcon').textContent = it.icon;
  document.getElementById('acmTitle').textContent = it.name;
  document.getElementById('acmDesc').textContent = it.desc;
  const stepArea = document.getElementById('acmStepArea');
  if(it.authType === 'oauth') {
    stepArea.innerHTML = `<button class="acm-oauth-btn" onclick="simulateOAuthConnect()">🔗 ${esc(it.connectLabel)}</button>`;
  } else {
    stepArea.innerHTML = `
      <div class="acm-step"><div class="acm-step-num">Paste your API key</div><input class="acm-input" id="acmKeyInput" placeholder="Paste your API key here..."></div>
      <div class="acm-help-toggle" onclick="this.nextElementSibling.classList.toggle('show')">Where do I find this? ▾</div>
      <div class="acm-help-content"><strong>Step 1:</strong> Log in to ${esc(it.name)}<br><strong>Step 2:</strong> Go to Settings → API Keys<br><strong>Step 3:</strong> Create a new key and copy it here</div>`;
  }
  document.getElementById('acmResult').textContent = '';
  document.getElementById('acmResult').className = 'acm-result';
  document.getElementById('acmWiring').style.display = 'none';
  modal.classList.add('show');
}

function closeApiConnectModal() { document.getElementById('apiConnectModal').classList.remove('show'); acmCurrentIntegration = null; }

function testApiConnection() {
  const res = document.getElementById('acmResult');
  res.textContent = '🔄 Testing connection...';
  res.className = 'acm-result';
  setTimeout(() => {
    // Simulate success
    state.integrations[acmCurrentIntegration] = {connected:true,connectedAt:new Date().toISOString()};
    saveState();
    res.textContent = '✅ Connected successfully!';
    res.className = 'acm-result success';
    // Show wiring message
    const botCount = countBotsUsingIntegration(acmCurrentIntegration);
    const wiring = document.getElementById('acmWiring');
    wiring.textContent = `✅ Connected! ${botCount} bot${botCount!==1?'s':''} now ha${botCount!==1?'ve':'s'} access to ${INTEGRATION_TEMPLATES[acmCurrentIntegration]?.name || acmCurrentIntegration}.`;
    wiring.style.display = 'block';
    // Refresh panels
    if(bcpCurrentBot && bcpCurrentTab==='connections') renderBotConfigPanel();
    renderConfigureTab();
    // Update setup checklist if visible
    updateSetupChecklist();
  }, 1500);
}

function simulateOAuthConnect() {
  const res = document.getElementById('acmResult');
  res.textContent = '🔄 Connecting...';
  setTimeout(() => {
    state.integrations[acmCurrentIntegration] = {connected:true,connectedAt:new Date().toISOString()};
    saveState();
    res.textContent = '✅ Connected successfully!';
    res.className = 'acm-result success';
    const botCount = countBotsUsingIntegration(acmCurrentIntegration);
    const wiring = document.getElementById('acmWiring');
    wiring.textContent = `✅ Connected! ${botCount} bot${botCount!==1?'s':''} now ha${botCount!==1?'ve':'s'} access to ${INTEGRATION_TEMPLATES[acmCurrentIntegration]?.name || acmCurrentIntegration}.`;
    wiring.style.display = 'block';
    if(bcpCurrentBot && bcpCurrentTab==='connections') renderBotConfigPanel();
    renderConfigureTab();
    updateSetupChecklist();
  }, 1200);
}

function countBotsUsingIntegration(intId) {
  let count = 0;
  Object.values(state.botConfigs).forEach(cfg => {
    const tplKey = cfg.name.toLowerCase().replace(/\s+/g,'-');
    const reqs = BOT_TEMPLATES[tplKey]?.requiredIntegrations || [];
    if(reqs.includes(intId)) count++;
  });
  return Math.max(count, Math.floor(Math.random()*4)+1);
}

// ---- Setup Checklist ----
let sclTemplate = null;

function showSetupChecklist(tpl) {
  sclTemplate = tpl;
  const overlay = document.getElementById('sclOverlay');
  const checklist = document.getElementById('setupChecklist');
  overlay.classList.add('show');
  checklist.classList.add('show');
  updateSetupChecklist();
}

function closeSetupChecklist() {
  document.getElementById('sclOverlay').classList.remove('show');
  document.getElementById('setupChecklist').classList.remove('show');
  sclTemplate = null;
}

function updateSetupChecklist() {
  const checklist = document.getElementById('setupChecklist');
  if(!checklist.classList.contains('show') || !sclTemplate) return;
  const integrations = sclTemplate.mcps || sclTemplate.infra || [];
  const items = [
    {text:'Team created',done:true,action:null},
    {text:'Bots configured',done:true,action:null},
    ...integrations.slice(0,5).map(name => {
      const intKey = Object.keys(INTEGRATION_TEMPLATES).find(k => INTEGRATION_TEMPLATES[k].name.toLowerCase().includes(name.toLowerCase())) || name.toLowerCase().replace(/[^a-z]/g,'');
      return {text:`Connect ${name}`,done:!!state.integrations[intKey],action:()=>openIntegrationConnect(intKey)};
    }),
    {text:'Workflows ready',done:true,action:null}
  ];
  const doneCount = items.filter(i=>i.done).length;
  const pct = Math.round(doneCount/items.length*100);
  const allDone = doneCount === items.length;
  checklist.innerHTML = `
    <div class="bcp-close" style="position:absolute;top:12px;right:16px" onclick="closeSetupChecklist()">✕</div>
    <div class="scl-banner">${allDone?'🚀 All set! Your agent team is live.':'🎉 Your agent team is ready!'}</div>
    <div class="scl-progress"><div class="scl-progress-fill" style="width:${pct}%"></div></div>
    <div class="scl-progress-label">${doneCount} of ${items.length} steps complete</div>
    ${items.map(i=>`<div class="scl-item" ${i.action&&!i.done?`onclick="(${i.action.toString()})()"`:''}>
      <span class="scl-icon">${i.done?'✅':'⚠️'}</span>
      <span class="scl-text ${i.done?'done':'pending'}">${i.text}</span>
    </div>`).join('')}
    ${allDone?'<div class="scl-done-msg" style="display:block">🎊 All integrations connected — your bots are live!</div>':''}`;
}

// ---- Configure Tab ----
let cfgFilter = 'all';

function renderConfigureTab() {
  const grid = document.getElementById('cfgBotGrid');
  const filters = document.getElementById('cfgFilters');
  if(!grid) return;
  // Gather all bots
  const allBots = [];
  (state.teams||[]).forEach(t => {
    (t.members||[]).forEach(m => {
      const cfg = state.botConfigs[m.id] || {};
      const tplKey = m.name.toLowerCase().replace(/\s+/g,'-');
      const reqs = BOT_TEMPLATES[tplKey]?.requiredIntegrations || [];
      const allConn = reqs.length === 0 || reqs.every(r=>state.integrations[r]);
      allBots.push({id:m.id,name:cfg.name||m.name,icon:cfg.icon||'🤖',team:t.name,ready:allConn,status:cfg.status||m.status||'active'});
    });
  });
  (state.sharedServices||[]).forEach(s => {
    allBots.push({id:s.id,name:s.name,icon:'🔗',team:'Shared Services',ready:true,status:s.status||'active'});
  });
  const filtered = cfgFilter==='all'?allBots:cfgFilter==='ready'?allBots.filter(b=>b.ready):allBots.filter(b=>!b.ready);
  const readyCount = allBots.filter(b=>b.ready).length;
  const needsCount = allBots.length - readyCount;
  filters.innerHTML = `
    <div class="cfg-filter ${cfgFilter==='all'?'active':''}" onclick="cfgFilter='all';renderConfigureTab()">All (${allBots.length})</div>
    <div class="cfg-filter ${cfgFilter==='ready'?'active':''}" onclick="cfgFilter='ready';renderConfigureTab()">✅ Ready (${readyCount})</div>
    <div class="cfg-filter ${cfgFilter==='needs'?'active':''}" onclick="cfgFilter='needs';renderConfigureTab()">⚠️ Needs Setup (${needsCount})</div>`;
  grid.innerHTML = filtered.map(b => `
    <div class="cfg-bot-card" onclick="openBotConfig('${b.id}')">
      <div class="cfg-icon">${b.icon}</div>
      <div class="cfg-name">${esc(b.name)}</div>
      <div class="cfg-team">${esc(b.team)}</div>
      <div class="cfg-badge"><span class="bcp-status-badge ${b.ready?'ready':'needs-setup'}" style="font-size:10px;padding:3px 8px">${b.ready?'✅ Ready':'⚠️ Needs Setup'}</span></div>
    </div>`).join('') || '<p style="color:var(--text3);text-align:center;padding:40px">No bots yet. Deploy a template from the Marketplace to get started.</p>';
  // Integrations section
  const intGrid = document.getElementById('cfgIntGrid');
  if(intGrid) {
    intGrid.innerHTML = Object.entries(INTEGRATION_TEMPLATES).map(([key,it]) => {
      const connected = !!state.integrations[key];
      return `<div class="cfg-int-card ${connected?'connected':''}" onclick="openIntegrationConnect('${key}')">
        <span class="ci-icon">${it.icon}</span>
        <div class="ci-info"><div class="ci-name">${it.name}</div><div class="ci-status" style="color:${connected?'var(--green)':'var(--orange)'}">${connected?'✅ Connected':'Click to connect'}</div></div>
      </div>`;
    }).join('');
  }
}

function connectAllIntegrations() {
  const disconnected = Object.keys(INTEGRATION_TEMPLATES).filter(k=>!state.integrations[k]);
  if(!disconnected.length) { showToast('✅ All integrations already connected!'); return; }
  openIntegrationConnect(disconnected[0]);
  showToast(`Starting with ${INTEGRATION_TEMPLATES[disconnected[0]]?.name}... ${disconnected.length} to connect.`);
}

// ---- Workflow Node Popover ----
function showWfNodePopover(nodeId, x, y) {
  const node = wfNodes.find(n=>n.id===nodeId);
  if(!node) return;
  let pop = document.getElementById('wfPopover');
  if(!pop) {
    pop = document.createElement('div');
    pop.id = 'wfPopover';
    pop.className = 'wf-popover';
    document.body.appendChild(pop);
  }
  const cfg = state.botConfigs[nodeId] || {};
  pop.innerHTML = `
    <h4>${node.type==='agent'?'🤖':'👤'} ${esc(node.name)}</h4>
    <div class="wfp-row"><span class="wfp-label">Input</span><span>${esc(cfg.role||'Data from previous step')}</span></div>
    <div class="wfp-row"><span class="wfp-label">Output</span><span>${esc(cfg.capabilities?.[0]||'Processed result')}</span></div>
    <div class="wfp-row"><span class="wfp-label">Trigger</span><span>When previous step completes</span></div>
    <div class="wfp-link" onclick="openBotConfig('${nodeId}');document.getElementById('wfPopover').classList.remove('show')">Open Full Settings →</div>`;
  pop.style.left = (x - 140) + 'px';
  pop.style.top = (y + 20) + 'px';
  pop.classList.add('show');
}

// Close popover on click outside
document.addEventListener('click', e => {
  const pop = document.getElementById('wfPopover');
  if(pop && !pop.contains(e.target)) pop.classList.remove('show');
});

// ---- Add double-click handlers to existing nodes ----
const _origRender2 = render;
render = function() {
  _origRender2.apply(this, arguments);
  // Attach double-click to canvas bot nodes
  setTimeout(() => {
    document.querySelectorAll('.node').forEach(n => {
      if(n.dataset.dcBound) return;
      n.dataset.dcBound = '1';
      n.addEventListener('dblclick', e => {
        e.stopPropagation();
        const id = n.dataset?.id || n.getAttribute('data-id');
        if(id) openBotConfig(id);
        else {
          // Try to find bot by name
          const name = n.querySelector('.node-name')?.textContent;
          if(name) {
            let found = null;
            state.teams.forEach(t=>t.members.forEach(m=>{if(m.name===name && !found) found=m.id;}));
            state.sharedServices.forEach(s=>{if(s.name===name && !found) found=s.id;});
            if(found) openBotConfig(found);
          }
        }
      });
    });
  }, 100);
};

// ---- Millie Copilot ----
let mcMessages = [];
let mcOpen = false;

function toggleMillieCopilot() {
  mcOpen = !mcOpen;
  document.getElementById('millieCopilot').classList.toggle('open', mcOpen);
  if(mcOpen) {
    if(mcMessages.length === 0) {
      addMillieMsg('millie', getMillieWelcome());
    }
    updateMillieContext();
    updateMillieQuickActions();
    setTimeout(()=>{ document.getElementById('mcInput')?.focus(); }, 300);
    scrollMillieToBottom();
  }
}

function getMillieWelcome() {
  const tab = currentTab || 'canvas';
  const tabNames = {canvas:'the Canvas',analytics:'Analytics',marketplace:'the Marketplace',workflows:'Workflows',configure:'Configure',settings:'Settings',mcphub:'MCP Hub',skillswriter:'Skills Writer'};
  const suggestions = {
    canvas:['Add a bot to a team','Deploy a marketplace template','Check your analytics'],
    workflows:['Use a workflow template','Add a human review step','Run a simulation'],
    configure:['Connect all integrations','Check setup status','Review bot permissions'],
    marketplace:['Browse Real Estate packs','See what\'s popular','Publish your own template'],
    analytics:['View token spending','Check bot performance','Export a report'],
    settings:['Update branding','Manage subscription','Configure white-label']
  };
  const sugs = suggestions[tab] || suggestions.canvas;
  return `👋 Hey! I'm Millie, your setup assistant. I can see you're on **${tabNames[tab]||tab}**. Want me to help you get started?\n\nHere are some things I can do:\n• ${sugs[0]}\n• ${sugs[1]}\n• ${sugs[2]}`;
}

function updateMillieContext() {
  const ctx = document.getElementById('mcContext');
  if(!ctx) return;
  const tab = currentTab || 'canvas';
  const tabNames = {canvas:'Canvas',analytics:'Analytics',marketplace:'Marketplace',workflows:'Workflows',configure:'Configure',settings:'Settings',mcphub:'MCP Hub',skillswriter:'Skills Writer'};
  let extra = '';
  if(bcpCurrentBot && state.botConfigs[bcpCurrentBot]) extra = ' → ' + state.botConfigs[bcpCurrentBot].name;
  ctx.textContent = '📍 Currently on: ' + (tabNames[tab]||tab) + extra;
}

function updateMillieQuickActions() {
  const qa = document.getElementById('mcQuickActions');
  if(!qa) return;
  const tab = currentTab || 'canvas';
  const actions = {
    canvas:[{t:'Add a bot',a:"addMillieMsg('user','Add a bot');millieRespond('add bot')"},{t:'Deploy template',a:"addMillieMsg('user','Deploy a template');millieRespond('deploy')"},{t:'View analytics',a:"switchTab('analytics');addMillieMsg('action','Switched to Analytics')"}],
    workflows:[{t:'Use template',a:"addMillieMsg('user','Use a workflow template');millieRespond('workflow template')"},{t:'Add human review',a:"addMillieMsg('user','Add human review');millieRespond('human review')"},{t:'Run simulation',a:"addMillieMsg('user','Run simulation');millieRespond('simulate')"}],
    configure:[{t:'Connect all',a:"connectAllIntegrations();addMillieMsg('action','Starting integration setup...')"},{t:'Check status',a:"addMillieMsg('user','Check setup status');millieRespond('status')"},{t:'Test a bot',a:"addMillieMsg('user','Test a bot');millieRespond('test bot')"}],
    marketplace:[{t:'Real Estate',a:"document.getElementById('mpCategoryFilter').value='Real Estate';renderMarketplace();addMillieMsg('action','Filtered to Real Estate')"},{t:"What's popular?",a:"addMillieMsg('user',\"What's popular?\");millieRespond('popular')"},{t:'Publish mine',a:"addMillieMsg('user','Publish my template');millieRespond('publish')"}],
    analytics:[{t:'Token spending',a:"addMillieMsg('user','Show token spending');millieRespond('tokens')"},{t:'Bot performance',a:"addMillieMsg('user','Bot performance');millieRespond('performance')"},{t:'Export report',a:"addMillieMsg('user','Export report');millieRespond('export')"}],
    settings:[{t:'Update branding',a:"addMillieMsg('user','Update branding');millieRespond('branding')"},{t:'Subscription',a:"addMillieMsg('user','Manage subscription');millieRespond('subscription')"}]
  };
  const btns = actions[tab] || actions.canvas;
  qa.innerHTML = btns.map(b => `<button class="mc-quick-btn" onclick="${b.a}">${b.t}</button>`).join('');
}

function addMillieMsg(type, text) {
  mcMessages.push({type, text, time: Date.now()});
  renderMillieMessages();
  scrollMillieToBottom();
}

function renderMillieMessages() {
  const container = document.getElementById('mcMessages');
  if(!container) return;
  container.innerHTML = mcMessages.map(m => {
    if(m.type === 'action') return `<div class="mc-msg action">✅ ${esc(m.text)}</div>`;
    if(m.type === 'millie') return `<div class="mc-msg millie"><span class="mc-avatar">🔷</span> ${formatMillieText(m.text)}</div>`;
    return `<div class="mc-msg user">${esc(m.text)}</div>`;
  }).join('');
}

function formatMillieText(text) {
  return text.replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>').replace(/\n/g,'<br>').replace(/• /g,'&bull; ');
}

function scrollMillieToBottom() {
  setTimeout(() => {
    const c = document.getElementById('mcMessages');
    if(c) c.scrollTop = c.scrollHeight;
  }, 50);
}

function sendMillieMsg() {
  const input = document.getElementById('mcInput');
  const text = (input?.value||'').trim();
  if(!text) return;
  input.value = '';
  addMillieMsg('user', text);
  // Show typing
  const container = document.getElementById('mcMessages');
  const typing = document.createElement('div');
  typing.className = 'mc-typing';
  typing.innerHTML = '<span>•</span><span>•</span><span>•</span>';
  container.appendChild(typing);
  scrollMillieToBottom();
  setTimeout(() => {
    typing.remove();
    millieRespond(text.toLowerCase());
  }, 800 + Math.random()*600);
}

function millieRespond(input) {
  const tab = currentTab || 'canvas';
  let response = '';
  // Keyword matching
  if(input.includes('connect') || input.includes('api') || input.includes('setup') || input.includes('integration')) {
    const disconnected = Object.keys(INTEGRATION_TEMPLATES).filter(k=>!state.integrations[k]);
    if(disconnected.length === 0) response = '✅ All your integrations are already connected! Your bots have everything they need.';
    else response = `You have **${disconnected.length} integration${disconnected.length>1?'s':''} to connect**: ${disconnected.slice(0,3).map(k=>INTEGRATION_TEMPLATES[k]?.name).join(', ')}${disconnected.length>3?', and more':''}.\n\nSwitch to the **Configure** tab and click any integration to connect it. It only takes about 60 seconds each — just paste an API key or click to sign in.`;
  } else if(input.includes('add bot') || input.includes('new bot') || input.includes('create bot')) {
    response = "Great idea! Here's how to add a bot:\n\n**Option 1:** Open the 📚 Library panel (left side) → drag a bot onto any team\n**Option 2:** Deploy a marketplace template that includes pre-configured bots\n**Option 3:** Click any team's '+' button on the canvas\n\nEach bot comes with a personality, skills, and integrations pre-configured. You can customize everything later.";
  } else if(input.includes('workflow') || input.includes('template')) {
    response = "Head over to the **🔀 Workflows** tab to build automation flows.\n\nYou can:\n• Drag bots from the sidebar to create workflow steps\n• Connect them with arrows to define the flow\n• Set triggers like 'on schedule' or 'when email received'\n• Run simulations to test before going live\n\nWant me to switch you there now?";
  } else if(input.includes('help') || input.includes('how do i') || input.includes('what can')) {
    const helpByTab = {
      canvas: "On the **Canvas**, you can:\n• Drag bots between teams\n• Double-click any bot to configure it\n• Use the Library panel to add new bots and teams\n• Deploy marketplace templates for instant setup",
      workflows: "In **Workflows**, you can:\n• Build step-by-step automation flows\n• Connect bots with triggers and conditions\n• Add human review checkpoints\n• Run simulations before going live",
      configure: "In **Configure**, you can:\n• See all your bots' setup status at a glance\n• Connect integrations (API keys, OAuth)\n• Click any bot card to customize personality, tone, and permissions",
      marketplace: "In the **Marketplace**, you can:\n• Browse pre-built agent packages by industry\n• Deploy templates in 60 seconds\n• Publish your own custom templates\n• Filter by category, price, and rating",
      analytics: "In **Analytics**, you can:\n• Monitor token usage and costs\n• Track bot performance metrics\n• View task completion rates\n• Set budget alerts and thresholds"
    };
    response = helpByTab[tab] || "I can help you configure agents, connect integrations, build workflows, and customize bot behavior. What would you like to set up?";
  } else if(input.includes('formal') || input.includes('tone') || input.includes('personality') || input.includes('style')) {
    response = "To customize a bot's personality:\n\n1. **Double-click** any bot on the canvas (or find it in Configure)\n2. Go to the **Personality** tab\n3. Adjust the tone sliders — Formal↔Casual, Brief↔Detailed, Cautious↔Autonomous\n4. Toggle communication style chips\n5. Preview how the bot will sound\n\nThe personality text tells the bot exactly what to do and how to behave. It's pre-filled from the template but you can customize it.";
  } else if(input.includes('status') || input.includes('check')) {
    const totalBots = (state.teams||[]).reduce((a,t)=>(t.members||[]).length+a,0);
    const connInt = Object.keys(state.integrations).filter(k=>state.integrations[k]).length;
    const totalInt = Object.keys(INTEGRATION_TEMPLATES).length;
    response = `📊 **Current Status:**\n• **${totalBots}** bots configured across **${(state.teams||[]).length}** teams\n• **${connInt}/${totalInt}** integrations connected\n• Shared services: ${(state.sharedServices||[]).length} active\n\n${connInt<totalInt?'⚠️ Some integrations still need to be connected. Head to **Configure** to set them up.':'✅ Everything looks good!'}`;
  } else if(input.includes('popular') || input.includes('trending')) {
    response = "🔥 **Most Popular Packs:**\n\n1. **Multifamily Operations** (2,840 installs) — Full property management suite\n2. **Maintenance & Work Orders** (2,100 installs) — SLA tracking and vendor dispatch\n3. **Leasing & Lead Management** (1,890 installs) — Full funnel automation\n\nWant me to switch you to the Marketplace to check them out?";
  } else if(input.includes('deploy')) {
    response = "To deploy a template:\n\n1. Go to **🏪 Marketplace**\n2. Browse or search for a pack\n3. Click **⚡ Deploy Now**\n4. Name your agent and select integrations\n5. Click **🚀 Launch Agent**\n\nThe whole process takes about 60 seconds. All bots come pre-configured with personalities, skills, and workflows.";
  } else if(input.includes('publish')) {
    response = "You can publish your current canvas as a marketplace template!\n\n1. Go to **🏪 Marketplace**\n2. Click **📤 Publish Your Template**\n3. Add a name, description, and icon\n4. Set your price (Free or Pro)\n5. Click Publish\n\nYour template will include all teams, bots, and configurations.";
  } else if(input.includes('token') || input.includes('spend') || input.includes('cost')) {
    response = "Check the **📊 Analytics** tab for full token usage and cost breakdowns.\n\nYou can:\n• See monthly spend by bot\n• Set budget alerts (50%, 75%, 90%, 100%)\n• Track cost per task\n• Compare team efficiency";
  } else if(input.includes('performance') || input.includes('metric')) {
    response = "Bot performance metrics are in the **📊 Analytics** tab.\n\nKey metrics tracked:\n• Tasks completed per bot\n• Average response time\n• Error rate and retries\n• Human escalation frequency\n• Confidence score distribution";
  } else if(input.includes('export') || input.includes('report')) {
    response = "To export reports, go to **📊 Analytics** and use the export buttons at the top of each section.\n\nSupported formats:\n• PDF — for sharing with stakeholders\n• CSV — for spreadsheet analysis\n• Screenshot — for quick sharing";
  } else if(input.includes('branding') || input.includes('logo') || input.includes('white label')) {
    response = "Customize your branding in **⚙️ Settings**:\n\n• Upload your company logo\n• Set primary brand color\n• Enable white-label mode to hide 'Agent Orchestrator' branding\n• Customize the portal URL for your clients";
  } else if(input.includes('subscription') || input.includes('plan') || input.includes('upgrade')) {
    response = "Manage your subscription in **⚙️ Settings**:\n\n• **Free:** 3 bots, 5K tokens/month\n• **Pro:** Unlimited bots, 100K tokens/month, marketplace access\n• **Enterprise:** Custom limits, white-label, priority support\n\nYou're currently in testing mode — all features are available.";
  } else if(input.includes('test bot') || input.includes('test a bot')) {
    response = "To test a bot:\n\n1. Double-click the bot on the canvas to open its config\n2. Check the **Connections** tab — ensure all integrations show ✅\n3. Review **Guardrails** — set appropriate permissions\n4. Go to the **🔀 Workflows** tab\n5. Add the bot to a workflow and click **▶ Simulate**\n\nThe simulation will run through a mock scenario and show you how the bot would respond.";
  } else if(input.includes('human review') || input.includes('approval')) {
    response = "To add human review to a workflow:\n\n1. In the **🔀 Workflows** builder, add a new 'Human' node\n2. Connect it between bot steps\n3. Set the trigger: 'When confidence below X%' or 'Always review'\n\nYou can also set per-bot approval rules in the **Guardrails** tab of any bot's config.";
  } else if(input.includes('simulate') || input.includes('simulation')) {
    response = "Run a workflow simulation:\n\n1. Go to **🔀 Workflows**\n2. Build or select a workflow\n3. Click **▶ Simulate** in the toolbar\n4. Watch each step execute with mock data\n5. Review results and adjust\n\nSimulation uses test data — nothing touches your real systems.";
  } else {
    response = "I can help you with:\n\n• **Adding bots** — drag from Library or deploy a template\n• **Connecting integrations** — paste API keys or sign in with OAuth\n• **Building workflows** — create step-by-step automation\n• **Customizing personality** — tone, style, and behavior\n• **Setting guardrails** — permissions and approval rules\n• **Checking status** — see what's set up and what needs attention\n\nWhat would you like to do?";
  }
  addMillieMsg('millie', response);
  updateMillieContext();
  updateMillieQuickActions();
}

// ---- Wire into tab switching ----
const _origSwitchTab2 = switchTab;
switchTab = function(tab) {
  _origSwitchTab2(tab);
  if(tab === 'configure') renderConfigureTab();
  if(mcOpen) { updateMillieContext(); updateMillieQuickActions(); }
};

// Initial render of configure tab if active
if(currentTab === 'configure') renderConfigureTab();
</script>

<!-- Phase 5B: Bot Config Panel -->
<div class="bot-config-panel" id="botConfigPanel">
  <div class="bcp-header">
    <h3>🤖 Bot Configuration</h3>
    <span class="bcp-close" onclick="closeBotConfigPanel()">✕</span>
  </div>
  <div class="bcp-tabs">
    <div class="bcp-tab active" data-tab="overview" onclick="switchBcpTab('overview')">Overview</div>
    <div class="bcp-tab" data-tab="personality" onclick="switchBcpTab('personality')">Personality</div>
    <div class="bcp-tab" data-tab="skills" onclick="switchBcpTab('skills')">Skills</div>
    <div class="bcp-tab" data-tab="connections" onclick="switchBcpTab('connections')">Connections</div>
    <div class="bcp-tab" data-tab="guardrails" onclick="switchBcpTab('guardrails')">Guardrails</div>
  </div>
  <div class="bcp-body" id="bcpBody"></div>
</div>

<!-- Phase 5B: API Connect Modal -->
<div class="api-connect-modal" id="apiConnectModal">
  <div class="acm-card">
    <div class="acm-icon" id="acmIcon">🔌</div>
    <div class="acm-title" id="acmTitle">Connect Service</div>
    <div class="acm-desc" id="acmDesc">Connect this service to your bots.</div>
    <div id="acmStepArea"></div>
    <button class="acm-test-btn" onclick="testApiConnection()">🧪 Test Connection</button>
    <div class="acm-result" id="acmResult"></div>
    <div class="acm-wiring" id="acmWiring"></div>
    <p style="font-size:11px;color:var(--text3);margin-top:12px;text-align:center">This key will be securely stored and automatically shared with all bots that need this service.</p>
    <div class="acm-actions"><button class="btn btn-outline" onclick="closeApiConnectModal()">Close</button></div>
  </div>
</div>

<!-- Phase 5B: Setup Checklist -->
<div class="scl-overlay" id="sclOverlay" onclick="closeSetupChecklist()"></div>
<div class="setup-checklist" id="setupChecklist"></div>

<!-- Phase 5B: Millie Copilot -->
<button class="millie-fab" id="millieFab" onclick="toggleMillieCopilot()">💬</button>
<div class="millie-copilot" id="millieCopilot">
  <div class="mc-header">
    <h3>🔷 Millie — Your Setup Assistant</h3>
    <span class="bcp-close" onclick="toggleMillieCopilot()">✕</span>
  </div>
  <div class="mc-ctx" id="mcContext">📍 Currently on: Canvas</div>
  <div class="mc-messages" id="mcMessages"></div>
  <div class="mc-quick" id="mcQuickActions"></div>
  <div class="mc-input-area">
    <input id="mcInput" placeholder="Ask Millie anything..." onkeydown="if(event.key==='Enter')sendMillieMsg()">
    <button onclick="sendMillieMsg()">Send</button>
  </div>
</div>

<script>
// ======================== PHASE 7: HOME DASHBOARD ========================
(function initDashboard(){
  const feedData = [
    {time:'15:32',icon:'🏢',bot:'Leasing Agent',text:'Responded to 3 new leads from Zillow',color:'var(--blue)'},
    {time:'15:18',icon:'🔧',bot:'Maintenance Coordinator',text:'Dispatched vendor for Unit 204 HVAC',color:'var(--orange)'},
    {time:'14:55',icon:'💰',bot:'Rent Collection',text:'Sent 12 payment reminders (4 overdue)',color:'var(--green)'},
    {time:'14:41',icon:'📋',bot:'Compliance Monitor',text:'Flagged lease renewal missing fair housing addendum',color:'var(--purple)'},
    {time:'14:22',icon:'👋',bot:'Resident Comms',text:'Sent move-in package to 2 new residents',color:'var(--teal)'},
    {time:'14:05',icon:'📧',bot:'Email Responder',text:'Triaged 18 emails, escalated 3 to manager',color:'var(--blue)'},
    {time:'13:48',icon:'🔧',bot:'Maintenance Coordinator',text:'Closed WO #4421 — plumbing, 2.3 day SLA ✅',color:'var(--orange)'},
    {time:'13:30',icon:'🏢',bot:'Leasing Agent',text:'Scheduled 4 tours for this week',color:'var(--blue)'},
    {time:'13:12',icon:'💰',bot:'Rent Collection',text:'Set up payment plan for Unit 112',color:'var(--green)'},
    {time:'12:55',icon:'📋',bot:'Compliance Monitor',text:'Completed weekly OSHA checklist',color:'var(--purple)'},
    {time:'12:30',icon:'📧',bot:'Email Responder',text:'Auto-replied to 6 vendor inquiries',color:'var(--blue)'},
    {time:'12:08',icon:'🏢',bot:'Leasing Agent',text:'Updated 8 listings with new photos',color:'var(--blue)'},
    {time:'11:45',icon:'🔧',bot:'Maintenance Coordinator',text:'Created WO #4425 — elevator inspection due',color:'var(--orange)'},
    {time:'11:20',icon:'👋',bot:'Resident Comms',text:'Sent rent increase notice to 15 units',color:'var(--teal)'},
    {time:'10:58',icon:'💰',bot:'Rent Collection',text:'Processed 23 ACH payments ($47,200)',color:'var(--green)'},
    {time:'10:30',icon:'📋',bot:'Compliance Monitor',text:'Verified insurance certificates for 3 vendors',color:'var(--purple)'},
    {time:'09:45',icon:'📧',bot:'Email Responder',text:'Flagged 2 urgent maintenance requests from tenants',color:'var(--blue)'},
    {time:'09:15',icon:'🏢',bot:'Leasing Agent',text:'Generated weekly vacancy report — 97.2% occupancy',color:'var(--blue)'},
    {time:'08:30',icon:'🔧',bot:'Maintenance Coordinator',text:'Prioritized 7 open work orders by SLA deadline',color:'var(--orange)'},
  ];

  function renderFeed(filter){
    const list = document.getElementById('dashFeedList');
    if(!list) return;
    const agentFilter = document.getElementById('dashAgentFilter')?.value || 'All Agents';
    const items = agentFilter === 'All Agents' ? feedData : feedData.filter(f => agentFilter.includes(f.bot));
    list.innerHTML = items.map(f => `<div class="dash-feed-item" style="border-left-color:${f.color}">
      <span class="dash-feed-time">${f.time}</span>
      <span class="dash-feed-body">${f.icon} <strong>${f.bot}</strong> — ${f.text}</span>
    </div>`).join('');
  }
  window.filterDashFeed = renderFeed;

  // Draw sparklines
  function drawSparkline(id, data, color){
    const svg = document.getElementById(id);
    if(!svg) return;
    const max = Math.max(...data), min = Math.min(...data);
    const w=120, h=40, pad=4;
    const pts = data.map((v,i)=>{
      const x = pad + (i/(data.length-1))*(w-2*pad);
      const y = pad + (1-(v-min)/(max-min||1))*(h-2*pad);
      return `${x},${y}`;
    });
    svg.innerHTML = `<polyline points="${pts.join(' ')}" fill="none" stroke="${color}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>`;
  }

  // Init on tab switch
  const _origST7 = switchTab;
  switchTab = function(tab){
    _origST7(tab);
    if(tab === 'home') initHomeDash();
  };

  function initHomeDash(){
    renderFeed();
    drawSparkline('perfSparkline1',[1.8,1.5,1.3,1.4,1.1,1.2,1.2],'var(--brand)');
    // Mini sparkline in messages card
    const ms = document.getElementById('msgSparkline');
    if(ms) ms.innerHTML = '<svg viewBox="0 0 60 20" width="60" height="20" style="vertical-align:middle"><polyline points="2,16 12,12 22,14 32,8 42,10 52,4 58,6" fill="none" stroke="var(--green)" stroke-width="1.5" stroke-linecap="round"/></svg>';
  }

  // Millie copilot home context
  const tabNames_orig = {canvas:'Canvas',analytics:'Analytics',marketplace:'Marketplace',workflows:'Workflows',configure:'Configure',settings:'Settings',mcphub:'MCP Hub',skillswriter:'Skills Writer'};
  // Patch updateMillieQuickActions and updateMillieContext for home
  const _origQA = window.updateMillieQuickActions;
  window.updateMillieQuickActions = function(){
    const tab = currentTab || 'canvas';
    if(tab !== 'home') return _origQA?.();
    const qa = document.getElementById('mcQuickActions');
    if(!qa) return;
    qa.innerHTML = [
      {t:'What needs attention?',a:"addMillieMsg('user','What needs attention?');millieRespond('attention')"},
      {t:"Show me today's stats",a:"addMillieMsg('user','Show me today\\'s stats');millieRespond('stats')"},
      {t:'Deploy something new',a:"switchTab('marketplace');addMillieMsg('action','Switched to Marketplace')"},
      {t:'Review alerts',a:"addMillieMsg('user','Review alerts');millieRespond('alerts')"}
    ].map(b=>`<button class="mc-quick-btn" onclick="${b.a}">${b.t}</button>`).join('');
  };
  const _origCtx = window.updateMillieContext;
  window.updateMillieContext = function(){
    const tab = currentTab || 'canvas';
    if(tab !== 'home') return _origCtx?.();
    const ctx = document.getElementById('mcContext');
    if(ctx) ctx.textContent = '📍 Currently on: Home Dashboard';
  };

  // Patch millieRespond for home-specific queries
  const _origRespond = window.millieRespond;
  window.millieRespond = function(input){
    const lower = (input||'').toLowerCase();
    if(lower.includes('attention') || lower.includes('alert')){
      addMillieMsg('millie','Here\'s what needs attention right now:\n\n• 🔴 **Invoice Bot** — M365 connection failed 2h ago\n• 🟡 **Leasing Agent** — Setup only 60% complete\n• 🟡 **Stripe API key** expires in 3 days\n• 🔴 **Daily Report** workflow failed at 6 AM\n\nWant me to help fix any of these?');
      return;
    }
    if(lower.includes('stats') || lower.includes('today')){
      addMillieMsg('millie','📊 **Today\'s Stats:**\n\n• **12** agents running (10 healthy)\n• **1,247** messages handled (↑12% vs yesterday)\n• **8** workflows active\n• **94%** first-contact resolution\n• **4.7/5** satisfaction rating\n\nLooking good overall! The Invoice Bot connection issue is the main thing to address.');
      return;
    }
    if(_origRespond) return _origRespond(input);
  };

  // Welcome message on first open when on home
  const _origToggleMC = window.toggleMillieCopilot;
  window.toggleMillieCopilot = function(){
    _origToggleMC?.();
    if(currentTab === 'home' && mcMessages && mcMessages.length === 0){
      addMillieMsg('millie','👋 Welcome back! Here\'s what your agents have been up to. Anything you\'d like to check on?');
    }
  };

  // Set home as default on load
  setTimeout(()=>{
    switchTab('home');
  }, 100);
})();
</script>

<!-- Phase 6: Connection Detail Popover -->
<div class="conn-detail-pop" id="connDetailPop"></div>

<!-- Phase 6: Pre-Deploy Checklist -->
<div class="predeploy-overlay" id="predeployOverlay" onclick="if(event.target===this)closePreDeploy()">
  <div class="predeploy-modal" id="predeployModal"></div>
</div>

<script>
// ======================== PHASE 6: SECURITY, GUARDRAILS & VALIDATION ========================
(function initPhase6(){

// ---- State extensions ----
if(!state.auditLog) state.auditLog = [];
if(!state.orgProfile) state.orgProfile = {name:'RISE Real Estate',industry:'Real Estate',size:'1000+',logo:''};
if(!state.notifPrefs) state.notifPrefs = {keyRotation:true,failedConn:true,workflowErrors:true,weeklyDigest:false};
if(!state.securitySettings) state.securitySettings = {rotationDays:90};
if(!state.setupWizardPack) state.setupWizardPack = null;
if(!state.dismissedNudges) state.dismissedNudges = {};

// Seed audit log
if(state.auditLog.length === 0){
  const now = Date.now();
  state.auditLog = [
    {ts:now-86400000*3,event:'API key added',user:'Courtney G.',details:'Microsoft 365 (Email)',integration:'email'},
    {ts:now-86400000*2,event:'Integration connected',user:'Courtney G.',details:'Google Sheets via OAuth',integration:'spreadsheet'},
    {ts:now-86400000*2+3600000,event:'Bot accessed integration',user:'Leasing Agent',details:'Accessed Email (Microsoft 365)',integration:'email'},
    {ts:now-86400000,event:'API key added',user:'Courtney G.',details:'CRM integration',integration:'crm'},
    {ts:now-86400000+7200000,event:'Bot deployed',user:'Courtney G.',details:'Maintenance Coordinator activated',integration:''},
    {ts:now-43200000,event:'Workflow activated',user:'Courtney G.',details:'Lead Follow-Up workflow set to live',integration:''},
    {ts:now-7200000,event:'API key tested',user:'System',details:'Microsoft 365 — connection healthy',integration:'email'},
    {ts:now-3600000,event:'Bot accessed integration',user:'Report Generator',details:'Accessed Google Sheets',integration:'spreadsheet'},
    {ts:now-1800000,event:'Settings updated',user:'Courtney G.',details:'Key rotation policy set to 90 days',integration:''},
  ];
}

function addAuditEntry(event, details, integration){
  state.auditLog.push({ts:Date.now(),event,user:'Courtney G.',details,integration:integration||''});
  saveState();
}

// ---- Masked API Key Display ----
function maskedKey(key){
  if(!key || key.length < 4) return '••••••••••••';
  return '••••••••' + key.slice(-4);
}

// ---- Connection Status Logic ----
function getConnStatus(intKey){
  const conn = state.integrations[intKey];
  if(!conn || !conn.connected) return {status:'none',label:'Not Connected',color:'var(--text3)',cls:'csb-none'};
  const connAt = new Date(conn.connectedAt).getTime();
  const age = Date.now() - connAt;
  const dayMs = 86400000;
  if(conn.failed) return {status:'failed',label:'Failed',color:'var(--red)',cls:'csb-failed'};
  if(age > 30*dayMs) return {status:'attention',label:'Needs Attention',color:'var(--orange)',cls:'csb-attention'};
  return {status:'connected',label:'Connected',color:'var(--green)',cls:'csb-connected'};
}

function getConnStatusDot(intKey){
  const s = getConnStatus(intKey);
  const icons = {connected:'🟢',attention:'🟡',failed:'🔴',none:'⚪'};
  return icons[s.status]||'⚪';
}

function connAgeDays(intKey){
  const conn = state.integrations[intKey];
  if(!conn) return 0;
  return Math.floor((Date.now()-new Date(conn.connectedAt).getTime())/86400000);
}

// ---- Connection Detail Popover ----
function showConnDetail(intKey, evt){
  evt.stopPropagation();
  const pop = document.getElementById('connDetailPop');
  const it = INTEGRATION_TEMPLATES[intKey]||{name:intKey,icon:'🔌'};
  const conn = state.integrations[intKey];
  const s = getConnStatus(intKey);
  const connDate = conn?.connectedAt ? new Date(conn.connectedAt).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}) : 'N/A';
  const age = connAgeDays(intKey);
  pop.innerHTML = `
    <h4>${it.icon} ${it.name} <span class="vault-icon" title="Credentials encrypted at rest (AES-256)">🔒</span></h4>
    <div class="cdp-row"><span class="cdp-label">Status</span><span style="color:${s.color}">${s.label}</span></div>
    <div class="cdp-row"><span class="cdp-label">Connected</span><span>${connDate}</span></div>
    <div class="cdp-row"><span class="cdp-label">Key Age</span><span>${age} days</span></div>
    <div class="cdp-row"><span class="cdp-label">Last Tested</span><span>${conn ? 'Today' : 'Never'}</span></div>
    ${age>=80?`<div class="rotation-banner" style="margin-top:10px"><span class="rb-text">🔄 Key is ${age} days old. Rotate every 90 days.</span><button class="btn btn-sm btn-outline" onclick="rotateKey('${intKey}')">Rotate</button></div>`:''}
    <div class="cdp-actions">
      <button class="btn btn-sm btn-primary" onclick="testIntegrationNow('${intKey}')">🧪 Test Now</button>
      <button class="btn btn-sm btn-danger" onclick="deleteAndReconnect('${intKey}')">🗑️ Delete & Reconnect</button>
    </div>`;
  const rect = evt.target.getBoundingClientRect();
  pop.style.top = (rect.bottom + 8) + 'px';
  pop.style.left = Math.min(rect.left, window.innerWidth - 300) + 'px';
  pop.classList.add('show');
}
window.showConnDetail = showConnDetail;

document.addEventListener('click', e => {
  const pop = document.getElementById('connDetailPop');
  if(pop && !pop.contains(e.target) && !e.target.closest('.conn-status-badge')) pop.classList.remove('show');
});

function testIntegrationNow(intKey){
  showToast('🧪 Testing connection...');
  setTimeout(()=>{
    const conn = state.integrations[intKey];
    if(conn){ conn.connectedAt = new Date().toISOString(); conn.failed = false; }
    addAuditEntry('API key tested', (INTEGRATION_TEMPLATES[intKey]?.name||intKey)+' — connection healthy', intKey);
    saveState();
    showToast('✅ Connection healthy!');
    document.getElementById('connDetailPop').classList.remove('show');
    if(currentTab==='configure') renderConfigureTab();
  }, 1000);
}
window.testIntegrationNow = testIntegrationNow;

function deleteAndReconnect(intKey){
  delete state.integrations[intKey];
  addAuditEntry('API key deleted', (INTEGRATION_TEMPLATES[intKey]?.name||intKey)+' credentials removed', intKey);
  saveState();
  document.getElementById('connDetailPop').classList.remove('show');
  openIntegrationConnect(intKey);
}
window.deleteAndReconnect = deleteAndReconnect;

function rotateKey(intKey){
  deleteAndReconnect(intKey);
}
window.rotateKey = rotateKey;

// ---- Patch API Connect Modal for Enter-Once Flow ----
const _origTestApi = testApiConnection;
testApiConnection = function(){
  const res = document.getElementById('acmResult');
  const stepArea = document.getElementById('acmStepArea');
  // Show encrypt animation
  stepArea.innerHTML = `<div class="encrypt-anim"><div class="encrypt-spinner"></div><div class="encrypt-msg">🔒 Encrypting and storing securely...</div></div>`;
  res.textContent = '';
  setTimeout(()=>{
    state.integrations[acmCurrentIntegration] = {connected:true, connectedAt:new Date().toISOString()};
    addAuditEntry('API key added', (INTEGRATION_TEMPLATES[acmCurrentIntegration]?.name||acmCurrentIntegration)+' connected', acmCurrentIntegration);
    saveState();
    stepArea.innerHTML = `<div class="encrypt-anim"><div class="encrypt-success">✅ Securely stored</div></div>`;
    res.textContent = '🟢 Connected — key stored in encrypted vault';
    res.className = 'acm-result success';
    const botCount = countBotsUsingIntegration(acmCurrentIntegration);
    const wiring = document.getElementById('acmWiring');
    wiring.textContent = '✅ Connected! ' + botCount + ' bot'+(botCount!==1?'s':'')+' now ha'+(botCount!==1?'ve':'s')+' access.';
    wiring.style.display = 'block';
    if(bcpCurrentBot && bcpCurrentTab==='connections') renderBotConfigPanel();
    renderConfigureTab();
    updateSetupChecklist();
  }, 2000);
};

// ---- Bot Completeness Score ----
function calcBotCompleteness(botId){
  const cfg = state.botConfigs[botId];
  if(!cfg) return 0;
  let score = 0;
  if(cfg.name && cfg.name.trim()) score += 10;
  if(cfg.personality && cfg.personality.length > 20) score += 15;
  // Integrations
  const tplKey = cfg.name.toLowerCase().replace(/\s+/g,'-');
  const reqs = BOT_TEMPLATES[tplKey]?.requiredIntegrations || [];
  if(reqs.length === 0) score += 25;
  else { const connCount = reqs.filter(i=>state.integrations[i]).length; score += Math.round(25 * connCount / reqs.length); }
  // Response templates (capabilities as proxy)
  if(cfg.capabilities && cfg.capabilities.length >= 2) score += 20;
  else if(cfg.capabilities && cfg.capabilities.length >= 1) score += 10;
  // Escalation rules
  const g = cfg.guardrails;
  if(g && (g.escalation || g.approvalRequired?.length > 0)) score += 15;
  // Business hours (simulate as configured if status is active)
  if(cfg.status === 'active') score += 15;
  return Math.min(score, 100);
}

function completenessColor(pct){
  if(pct >= 80) return 'var(--green)';
  if(pct >= 50) return 'var(--orange)';
  return 'var(--red)';
}

function completenessRingSVG(pct, size){
  size = size || 36;
  const r = (size/2)-4;
  const c = 2*Math.PI*r;
  const fill = c * pct / 100;
  const color = completenessColor(pct);
  return `<div class="completeness-ring" style="width:${size}px;height:${size}px" title="${pct}% complete" onclick="event.stopPropagation()">
    <svg width="${size}" height="${size}" viewBox="0 0 ${size} ${size}"><circle cx="${size/2}" cy="${size/2}" r="${r}" fill="none" stroke="var(--bg3)" stroke-width="3"/>
    <circle cx="${size/2}" cy="${size/2}" r="${r}" fill="none" stroke="${color}" stroke-width="3" stroke-dasharray="${fill} ${c-fill}" stroke-linecap="round"/></svg>
    <span class="cr-text" style="color:${color}">${pct}%</span></div>`;
}
window.completenessRingSVG = completenessRingSVG;
window.calcBotCompleteness = calcBotCompleteness;

// ---- Patch Configure Tab to show completeness + vault + status badges ----
const _origRenderCfgTab = renderConfigureTab;
renderConfigureTab = function(){
  _origRenderCfgTab();
  // Add completeness rings to bot cards
  document.querySelectorAll('.cfg-bot-card').forEach(card => {
    const onclick = card.getAttribute('onclick')||'';
    const m = onclick.match(/openBotConfig\('([^']+)'\)/);
    if(!m) return;
    const botId = m[1];
    const pct = calcBotCompleteness(botId);
    // Insert ring after icon
    const icon = card.querySelector('.cfg-icon');
    if(icon && !card.querySelector('.completeness-ring')){
      icon.insertAdjacentHTML('afterend', completenessRingSVG(pct, 32));
    }
  });
  // Add vault icons and status badges to integration cards
  document.querySelectorAll('.cfg-int-card').forEach(card => {
    const onclick = card.getAttribute('onclick')||'';
    const m = onclick.match(/openIntegrationConnect\('([^']+)'\)/);
    if(!m) return;
    const intKey = m[1];
    const conn = state.integrations[intKey];
    if(!conn) return;
    const nameEl = card.querySelector('.ci-name');
    if(nameEl && !nameEl.querySelector('.vault-icon')){
      nameEl.insertAdjacentHTML('beforeend',' <span class="vault-icon">🔒</span>');
    }
    const statusEl = card.querySelector('.ci-status');
    if(statusEl){
      const s = getConnStatus(intKey);
      statusEl.innerHTML = `<span class="conn-status-badge ${s.cls}" onclick="showConnDetail('${intKey}',event)">${getConnStatusDot(intKey)} ${s.label}</span>`;
    }
  });
  // Show rotation banners
  const intGrid = document.getElementById('cfgIntGrid');
  if(intGrid){
    Object.keys(state.integrations).forEach(intKey => {
      const age = connAgeDays(intKey);
      if(age >= 80){
        const banner = document.createElement('div');
        banner.className = 'rotation-banner';
        banner.style.gridColumn = '1 / -1';
        banner.innerHTML = `<span class="rb-text">🔄 ${INTEGRATION_TEMPLATES[intKey]?.name||intKey} key is ${age} days old. Rotate every 90 days.</span><button class="btn btn-sm btn-outline" onclick="rotateKey('${intKey}')">Rotate Now</button>`;
        intGrid.prepend(banner);
      }
    });
  }
  // Best practice nudge
  if(!state.dismissedNudges['integration-service-account']){
    const section = document.querySelector('.cfg-int-section');
    if(section && !section.querySelector('.bp-nudge')){
      section.insertAdjacentHTML('afterbegin', `<div class="bp-nudge" id="nudgeIntSA"><span class="bp-text">💡 Use a service account, not your personal credentials, for production bots.</span><span class="bp-dismiss" onclick="dismissNudge('integration-service-account')">Got it</span></div>`);
    }
  }
};

function dismissNudge(id){
  state.dismissedNudges[id] = true;
  saveState();
  const el = document.getElementById('nudge-'+id.replace(/[^a-z0-9]/g,'')) || document.querySelector('.bp-nudge');
  if(el) el.style.opacity='0'; setTimeout(()=>{el?.remove()},300);
}
window.dismissNudge = dismissNudge;

// ---- Patch Bot Config Panel connections tab for masked keys + status badges ----
const _origRenderBCP = renderBotConfigPanel;
renderBotConfigPanel = function(){
  _origRenderBCP();
  if(bcpCurrentTab === 'connections'){
    // Replace "✅ Connected" with status badges
    document.querySelectorAll('.bcp-conn-status').forEach(el => {
      // Find parent card
      const card = el.closest('.bcp-conn-card');
      if(!card) return;
      // Try to extract integration key from the connect button nearby
      const btn = card.querySelector('.bcp-conn-btn');
      // If already connected, find which integration
      const nameEl = card.querySelector('.cc-name');
      if(!nameEl) return;
      const name = nameEl.textContent;
      const intKey = Object.keys(INTEGRATION_TEMPLATES).find(k => INTEGRATION_TEMPLATES[k].name === name);
      if(!intKey) return;
      const s = getConnStatus(intKey);
      el.outerHTML = `<span class="conn-status-badge ${s.cls}" onclick="showConnDetail('${intKey}',event)">${getConnStatusDot(intKey)} ${s.label}</span>`;
      // Add vault icon to name
      if(!nameEl.querySelector('.vault-icon')) nameEl.insertAdjacentHTML('beforeend',' <span class="vault-icon">🔒</span>');
    });
  }
  if(bcpCurrentTab === 'overview'){
    // Add completeness ring to overview
    const header = document.querySelector('.bcp-name-input');
    if(header && bcpCurrentBot && !document.querySelector('#bcpCompRing')){
      const pct = calcBotCompleteness(bcpCurrentBot);
      header.insertAdjacentHTML('afterend', `<div id="bcpCompRing" style="display:flex;align-items:center;gap:8px;margin:8px 0">${completenessRingSVG(pct,40)} <span style="font-size:12px;color:var(--text2)">${pct}% configured</span></div>`);
    }
    // Best practice nudge for personality
    if(!state.dismissedNudges['personality-tip']){
      const body = document.getElementById('bcpBody');
      if(body && !body.querySelector('.bp-nudge')){
        body.insertAdjacentHTML('afterbegin', `<div class="bp-nudge"><span class="bp-text">💡 Bots with personality descriptions respond 40% more naturally</span><span class="bp-dismiss" onclick="dismissNudge('personality-tip')">Got it</span></div>`);
      }
    }
  }
};

// ---- Workflow Linting ----
function lintWorkflow(){
  const warnings = [];
  const suggestions = [];
  if(!wfNodes || wfNodes.length === 0) return {warnings, suggestions};
  const hasErrorHandler = wfNodes.some(n => (n.name||'').toLowerCase().includes('error'));
  const hasHumanNode = wfNodes.some(n => n.type === 'human');
  wfNodes.forEach(n => {
    // Dead-end check
    const hasOutput = (wfConnections||[]).some(c => c.from === n.id);
    const hasInput = (wfConnections||[]).some(c => c.to === n.id);
    if(!hasOutput && hasInput) warnings.push({nodeId:n.id, msg:"This node's output goes nowhere"});
    // Email/SMS without approval
    const nm = (n.name||'').toLowerCase();
    if((nm.includes('email') || nm.includes('sms') || nm.includes('send')) && !hasHumanNode){
      warnings.push({nodeId:n.id, msg:'No human review before sending'});
    }
    // Missing config
    const cfg = state.botConfigs[n.id];
    if(n.type==='agent' && (!cfg || !cfg.personality || cfg.personality.length < 10)){
      warnings.push({nodeId:n.id, msg:'Node not fully configured'});
    }
  });
  if(!hasErrorHandler) suggestions.push('No error handler — failures will be silent');
  return {warnings, suggestions};
}

// Patch workflow render to add lint badges
const _origRenderWf = typeof renderWorkflowCanvas === 'function' ? renderWorkflowCanvas : null;
if(_origRenderWf){
  renderWorkflowCanvas = function(){
    _origRenderWf.apply(this, arguments);
    addLintBadges();
  };
}

function addLintBadges(){
  const lint = lintWorkflow();
  // Remove old badges
  document.querySelectorAll('.wf-lint-badge,.wf-lint-bar').forEach(e=>e.remove());
  // Add badges to nodes
  lint.warnings.forEach(w => {
    const nodeEl = document.querySelector(`.wf-node[data-id="${w.nodeId}"]`);
    if(nodeEl && !nodeEl.querySelector('.wf-lint-badge')){
      nodeEl.insertAdjacentHTML('beforeend', `<div class="wf-lint-badge" data-tip="${w.msg}">⚠️</div>`);
    }
  });
  // Lint summary bar
  const total = lint.warnings.length + lint.suggestions.length;
  if(total > 0){
    const toolbar = document.querySelector('.wf-toolbar');
    if(toolbar){
      toolbar.insertAdjacentHTML('afterend', `<div class="wf-lint-bar" style="position:absolute;top:50px;left:12px;z-index:10">⚠️ ${lint.warnings.length} warning${lint.warnings.length!==1?'s':''}, ${lint.suggestions.length} suggestion${lint.suggestions.length!==1?'s':''}</div>`);
    }
  }
}

// Re-lint when switching to workflows
const _origST6 = switchTab;
switchTab = function(tab){
  _origST6(tab);
  if(tab === 'workflows') setTimeout(addLintBadges, 200);
  if(tab === 'configure') renderConfigureTab();
};

// ---- Pre-Deploy Checklist ----
function showPreDeploy(botIdOrWorkflow){
  const overlay = document.getElementById('predeployOverlay');
  const modal = document.getElementById('predeployModal');
  const lint = lintWorkflow();
  const hasError = typeof wfNodes !== 'undefined' && wfNodes.some(n=>(n.name||'').toLowerCase().includes('error'));
  const hasHuman = typeof wfNodes !== 'undefined' && wfNodes.some(n=>n.type==='human');
  const items = [
    {icon:'✅',label:'All nodes configured',pass:lint.warnings.filter(w=>w.msg.includes('not fully')).length===0,required:true},
    {icon:'✅',label:'Test run completed successfully',pass:true,required:false},
    {icon:hasHuman?'✅':'⚠️',label:hasHuman?'Human approval step included':'No approval step',pass:hasHuman,required:false,tag:'recommended'},
    {icon:hasError?'✅':'⚠️',label:hasError?'Error handling included':'No error handler',pass:hasError,required:false,tag:'recommended'},
    {icon:'✅',label:'Business hours configured',pass:true,required:true},
  ];
  const allRequired = items.filter(i=>i.required).every(i=>i.pass);
  modal.innerHTML = `
    <h3>🚀 Pre-Deploy Checklist</h3>
    <p style="font-size:12px;color:var(--text2);margin-bottom:16px">Review these items before going live.</p>
    ${items.map(i=>`<div class="pd-item ${i.pass?'pass':i.required?'fail':'warn'}">
      <span class="pd-icon">${i.pass?'✅':i.required?'❌':'⚠️'}</span>
      <span class="pd-label">${i.label}</span>
      ${i.tag?`<span class="pd-tag ${i.tag}">${i.tag}</span>`:''}
      ${i.required && !i.pass?'<span class="pd-tag required">required</span>':''}
    </div>`).join('')}
    <div class="pd-actions">
      <button class="btn btn-outline" onclick="closePreDeploy()">Cancel</button>
      <button class="btn btn-outline" onclick="closePreDeploy();switchTab('workflows')">Fix Issues</button>
      <button class="btn btn-green ${allRequired?'':'disabled'}" onclick="closePreDeploy();showToast('🚀 Deployed successfully!')">Deploy ${allRequired?'':'(fix required items)'}</button>
    </div>`;
  overlay.classList.add('show');
}
window.showPreDeploy = showPreDeploy;

function closePreDeploy(){document.getElementById('predeployOverlay').classList.remove('show')}
window.closePreDeploy = closePreDeploy;

// ---- Setup Wizard Progress Bar ----
function renderSetupWizardBar(containerEl){
  if(!state.setupWizardPack) return;
  const pack = state.setupWizardPack;
  const steps = [];
  // Bots
  const allBots = [];
  (state.teams||[]).forEach(t=>(t.members||[]).forEach(m=>allBots.push(m)));
  allBots.slice(0,5).forEach(b => {
    const pct = calcBotCompleteness(b.id);
    steps.push({label:b.name+' configured',done:pct>=60,action:()=>openBotConfig(b.id)});
  });
  // Integrations
  Object.keys(INTEGRATION_TEMPLATES).slice(0,4).forEach(k => {
    steps.push({label:INTEGRATION_TEMPLATES[k].name+' connected',done:!!state.integrations[k],action:()=>openIntegrationConnect(k)});
  });
  const doneCount = steps.filter(s=>s.done).length;
  const pct = Math.round(doneCount/steps.length*100);
  const html = `<div class="setup-wizard-bar" onclick="this.querySelector('.swb-details').classList.toggle('show')">
    <div class="swb-header"><span class="swb-title">${pack.name||'Setup'} — ${pct}% complete</span><span class="swb-pct">${doneCount}/${steps.length}</span></div>
    <div class="swb-track"><div class="swb-fill" style="width:${pct}%"></div></div>
    <div class="swb-details">${steps.map(s=>`<div class="swb-detail-item" onclick="event.stopPropagation()">${s.done?'✅':'⚠️'} ${s.label}</div>`).join('')}</div>
  </div>`;
  containerEl.insertAdjacentHTML('afterbegin', html);
}

// ---- Patch Settings Tab: Add Phase 6 sections ----
function renderPhase6Settings(){
  const container = document.querySelector('#tab-settings .settings-container');
  if(!container || container.querySelector('.s6-section')) return;

  // Org Profile
  const orgHTML = `<div class="s6-section" id="s6OrgProfile">
    <h2>🏢 Organization Profile</h2>
    <div class="s6-org-card">
      <div class="org-logo-area" title="Click to upload logo">🏢</div>
      <div class="s6-org-fields">
        <div class="form-group"><label>Company Name</label><input value="${esc(state.orgProfile.name)}" onchange="state.orgProfile.name=this.value;saveState()"></div>
        <div class="form-group"><label>Industry</label><select onchange="state.orgProfile.industry=this.value;saveState()">
          <option ${state.orgProfile.industry==='Real Estate'?'selected':''}>Real Estate</option>
          <option ${state.orgProfile.industry==='Technology'?'selected':''}>Technology</option>
          <option ${state.orgProfile.industry==='Healthcare'?'selected':''}>Healthcare</option>
          <option ${state.orgProfile.industry==='Finance'?'selected':''}>Finance</option>
          <option ${state.orgProfile.industry==='Other'?'selected':''}>Other</option>
        </select></div>
        <div class="form-group"><label>Company Size</label><select onchange="state.orgProfile.size=this.value;saveState()">
          <option ${state.orgProfile.size==='1-10'?'selected':''}>1-10</option>
          <option ${state.orgProfile.size==='11-50'?'selected':''}>11-50</option>
          <option ${state.orgProfile.size==='51-200'?'selected':''}>51-200</option>
          <option ${state.orgProfile.size==='201-1000'?'selected':''}>201-1000</option>
          <option ${state.orgProfile.size==='1000+'?'selected':''}>1000+</option>
        </select></div>
      </div>
    </div>
  </div>`;

  // Security Settings
  const secHTML = `<div class="s6-section" id="s6Security">
    <h2>🔒 Security Settings</h2>
    <div class="s6-security-grid">
      <div class="s6-security-card">
        <h4>Vault Status</h4>
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px"><span style="font-size:20px">🔒</span><div><div style="font-weight:600;font-size:13px">Vault Active</div><div style="font-size:11px;color:var(--text3)">AES-256 encryption at rest</div></div></div>
        <div style="font-size:12px;color:var(--text2)">${Object.keys(state.integrations).filter(k=>state.integrations[k]?.connected).length} credentials stored securely</div>
      </div>
      <div class="s6-security-card">
        <h4>Key Rotation Policy</h4>
        <select style="width:100%;margin-bottom:8px" onchange="state.securitySettings.rotationDays=+this.value;saveState()">
          <option value="30" ${state.securitySettings.rotationDays===30?'selected':''}>Every 30 days</option>
          <option value="60" ${state.securitySettings.rotationDays===60?'selected':''}>Every 60 days</option>
          <option value="90" ${state.securitySettings.rotationDays===90?'selected':''}>Every 90 days (recommended)</option>
        </select>
        <div style="font-size:11px;color:var(--text3)">You'll be reminded before keys expire</div>
      </div>
    </div>
  </div>`;

  // Audit Log
  const auditHTML = `<div class="s6-section" id="s6AuditLog">
    <h2>📋 Audit Log</h2>
    <div class="audit-filters">
      <select id="auditTypeFilter" onchange="renderAuditTable()"><option value="">All Events</option><option value="API key">API Keys</option><option value="Bot">Bot Activity</option><option value="Workflow">Workflows</option><option value="Settings">Settings</option></select>
      <select id="auditIntFilter" onchange="renderAuditTable()"><option value="">All Integrations</option>${Object.entries(INTEGRATION_TEMPLATES).map(([k,v])=>`<option value="${k}">${v.name}</option>`).join('')}</select>
    </div>
    <div id="auditTableContainer"></div>
  </div>`;

  // User Management
  const usersHTML = `<div class="s6-section" id="s6Users">
    <h2>👥 User Management</h2>
    <table class="s6-user-table">
      <thead><tr><th>User</th><th>Email</th><th>Role</th><th>Status</th><th>Last Active</th></tr></thead>
      <tbody>
        <tr><td style="font-weight:600">Courtney Gordon</td><td>cgordon@risere.com</td><td><span class="s6-role-badge admin">Admin</span></td><td style="color:var(--green)">● Active</td><td>Just now</td></tr>
        <tr><td style="font-weight:600">Victoria Gordon</td><td>vgordon@risere.com</td><td><span class="s6-role-badge manager">Manager</span></td><td style="color:var(--green)">● Active</td><td>2 hours ago</td></tr>
        <tr><td style="font-weight:600">Alex Chen</td><td>achen@risere.com</td><td><span class="s6-role-badge viewer">Viewer</span></td><td style="color:var(--text3)">● Inactive</td><td>5 days ago</td></tr>
        <tr><td style="font-weight:600">Jasmine Gordon</td><td>jgordon@risere.com</td><td><span class="s6-role-badge manager">Manager</span></td><td style="color:var(--green)">● Active</td><td>Yesterday</td></tr>
      </tbody>
    </table>
    <button class="btn btn-primary btn-sm" style="margin-top:12px" onclick="showToast('User invite coming soon!')">+ Invite User</button>
  </div>`;

  // Notification Preferences
  const notifHTML = `<div class="s6-section" id="s6Notifs">
    <h2>🔔 Notification Preferences</h2>
    <div style="background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:16px">
      <div class="s6-notif-row"><span>🔄 Key rotation reminders</span><div class="ios-toggle ${state.notifPrefs.keyRotation?'on':''}" onclick="this.classList.toggle('on');state.notifPrefs.keyRotation=this.classList.contains('on');saveState()"></div></div>
      <div class="s6-notif-row"><span>🔴 Failed connection alerts</span><div class="ios-toggle ${state.notifPrefs.failedConn?'on':''}" onclick="this.classList.toggle('on');state.notifPrefs.failedConn=this.classList.contains('on');saveState()"></div></div>
      <div class="s6-notif-row"><span>⚠️ Workflow error notifications</span><div class="ios-toggle ${state.notifPrefs.workflowErrors?'on':''}" onclick="this.classList.toggle('on');state.notifPrefs.workflowErrors=this.classList.contains('on');saveState()"></div></div>
      <div class="s6-notif-row"><span>📊 Weekly performance digest</span><div class="ios-toggle ${state.notifPrefs.weeklyDigest?'on':''}" onclick="this.classList.toggle('on');state.notifPrefs.weeklyDigest=this.classList.contains('on');saveState()"></div></div>
    </div>
  </div>`;

  // Insert after existing sections
  container.insertAdjacentHTML('beforeend', orgHTML + secHTML + auditHTML + usersHTML + notifHTML);
  renderAuditTable();
}

function renderAuditTable(){
  const container = document.getElementById('auditTableContainer');
  if(!container) return;
  const typeFilter = document.getElementById('auditTypeFilter')?.value || '';
  const intFilter = document.getElementById('auditIntFilter')?.value || '';
  let entries = [...state.auditLog].sort((a,b)=>b.ts-a.ts);
  if(typeFilter) entries = entries.filter(e=>(e.event||'').includes(typeFilter));
  if(intFilter) entries = entries.filter(e=>e.integration===intFilter);
  container.innerHTML = `<table class="audit-table"><thead><tr><th>Timestamp</th><th>Event</th><th>User</th><th>Details</th></tr></thead><tbody>${entries.map(e=>{
    const d = new Date(e.ts);
    return `<tr><td>${d.toLocaleDateString('en-US',{month:'short',day:'numeric'})} ${d.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'})}</td><td>${esc(e.event)}</td><td>${esc(e.user)}</td><td>${esc(e.details)}</td></tr>`;
  }).join('')}</tbody></table>`;
}
window.renderAuditTable = renderAuditTable;

// Wire settings rendering into tab switch
const _origST6b = switchTab;
switchTab = function(tab){
  _origST6b(tab);
  if(tab==='settings') setTimeout(renderPhase6Settings, 50);
};

// ---- Setup Wizard — auto-enable after marketplace deploy ----
const _origCloseDeployWiz = typeof closeDeployWizard === 'function' ? closeDeployWizard : null;
if(_origCloseDeployWiz){
  const _origDWN = deployWizardNext;
  deployWizardNext = function(){
    _origDWN.apply(this, arguments);
    // After final step, set wizard pack
    if(state.setupWizardPack === null){
      state.setupWizardPack = {name:'Deployed Pack'};
      saveState();
    }
  };
}

// ---- Patch canvas bot nodes to show completeness ring ----
const _origRender6 = render;
render = function(){
  _origRender6.apply(this, arguments);
  setTimeout(()=>{
    document.querySelectorAll('.node').forEach(n => {
      if(n.querySelector('.completeness-ring')) return;
      const name = n.querySelector('.node-name')?.textContent;
      if(!name) return;
      let botId = null;
      (state.teams||[]).forEach(t=>(t.members||[]).forEach(m=>{if(m.name===name && !botId) botId=m.id;}));
      if(!botId) return;
      const pct = calcBotCompleteness(botId);
      n.insertAdjacentHTML('beforeend', `<div style="position:absolute;top:-8px;right:-8px">${completenessRingSVG(pct,28)}</div>`);
    });
  }, 150);
};

// Init
setTimeout(()=>{
  if(currentTab==='settings') renderPhase6Settings();
  if(currentTab==='configure') renderConfigureTab();
}, 200);

})();
</script>
</body>
</html>
